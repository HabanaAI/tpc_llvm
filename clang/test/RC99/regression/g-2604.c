
// RUN: %clang_cc1 "-triple" "tpc" "-emit-obj" "--mrelax-relocations" "-disable-free" "-disable-llvm-verifier" "-main-file-name" "resize_image_bicubic_u16.c" "-mrelocation-model" "static" "-mframe-pointer=all" "-fmath-errno" "-fno-rounding-math" "-mconstructor-aliases" "-instr-compress" "-Wfloat-conversion" "-Wmissing-braces" "-Wuninitialized" "-Werror=implicit-function-declaration" "-fembed-bitcode=bitcode" "-bfloat16" "-vlm" "280" "-slm" "2" "-mllvm" "-simplifycfg-sink-common=false" "-mllvm" "-enable-load-pre=false" "-max-tensors" "16"  "-mllvm" "-loop-unswitch-threshold=0" "-mllvm" "-dontAnalysis=1" "-target-cpu" "greco" "-instr-compress" "-fno-split-dwarf-inlining" "-debugger-tuning=gdb" "-D" "TPC_KERNEL_PATH=1" "-O2" "-Wno-unused-command-line-argument" "-Wall" "-std=rc++" "-fdeprecated-macro" "-ferror-limit" "19" "-fgnuc-version=4.2.1" "-fcxx-exceptions" "-fexceptions" "-fcolor-diagnostics" "-mllvm" "-emit-index-factors=false" "-mllvm" "-tpc-enable-iterative-scheduler=false" "-mllvm" "-tpc-disable-jmp-slot-utilization=true" "-faddrsig" "-x" "c++" -S  %s -o -

# 1 "<built-in>"
# 1 "tpc-defs.h" 1
//------------------------------------------------------------------------------
// tpc-defs.h
//
// This file contains definitions vital for TPC C/C++ compiler (the compiler
// crashes without them). Any code definitions that must be available without
// inclusion of any header file, but is not necessary for compiler functioning,
// should be placed into 'tpc-special.h'.
//------------------------------------------------------------------------------

#ifndef TPC_DEFS_H_INCLUDED
#define TPC_DEFS_H_INCLUDED

// Standard vector types
typedef unsigned char __attribute__((ext_vector_type(32)))
                      __attribute__((aligned(256)))           bool256;
typedef unsigned char __attribute__((ext_vector_type(16)))
                      __attribute__((aligned(256)))           bool128;
typedef unsigned char __attribute__((ext_vector_type(8)))
                      __attribute__((aligned(256)))           bool64;

typedef float         __attribute__((ext_vector_type(64)))    float64;
typedef int           __attribute__((ext_vector_type(64)))    int64;
typedef unsigned int  __attribute__((ext_vector_type(64)))    uint64;
typedef short         __attribute__((ext_vector_type(128)))   short128;
typedef unsigned short __attribute__((ext_vector_type(128)))  ushort128;
typedef char          __attribute__((ext_vector_type(256)))   char256;
typedef unsigned char __attribute__((ext_vector_type(256)))   uchar256;
typedef int           __attribute__((ext_vector_type(5)))     int5;
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 30 "tpc-defs.h"
typedef _BFloat16 bf16;
typedef _BFloat16 bfloat;
typedef _BFloat16     __attribute__((ext_vector_type(128)))   bfloat128;
#endif
# 34 "tpc-defs.h"
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 35 "tpc-defs.h"
typedef half          __attribute__((ext_vector_type(128)))   half128;
typedef char          __attribute__((__vector_size__(256)))   nibble512;
typedef unsigned char __attribute__((__vector_size__(256)))   unibble512;
typedef char nibble;
typedef unsigned char unibble;
#endif
# 41 "tpc-defs.h"
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 42 "tpc-defs.h"
typedef _Float8_143 minifloat;
typedef _Float8_152 minihalf;
typedef minifloat __attribute__((ext_vector_type(256)))  minifloat256;
typedef minihalf __attribute__((ext_vector_type(256)))   minihalf256;
#endif
# 47 "tpc-defs.h"

// OpenCL v1.1/1.2/2.0 s6.2.4.2 - as_type operators
// Reinterprets a data type as another data type of the same size

#define as_char(x)      __builtin_astype((x), char)
#define as_char256(x)   __builtin_astype((x), char256)

#define as_uchar(x)     __builtin_astype((x), unsigned char)
#define as_uchar256(x)  __builtin_astype((x), uchar256)

#define as_short(x)     __builtin_astype((x), short)
#define as_short128(x)  __builtin_astype((x), short128)

#define as_ushort(x)    __builtin_astype((x), unsigned short)
#define as_ushort128(x) __builtin_astype((x), ushort128)

#define as_int(x)       __builtin_astype((x), int)
#define as_int64(x)     __builtin_astype((x), int64)

#define as_uint(x)      __builtin_astype((x), unsigned int)
#define as_uint64(x)    __builtin_astype((x), uint64)

#define as_float(x)     __builtin_astype((x), float)
#define as_float64(x)   __builtin_astype((x), float64)

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 73 "tpc-defs.h"
#define as_bf16(x)      __builtin_astype((x), bf16)
#define as_bfloat(x)    __builtin_astype((x), bfloat)
#define as_bfloat128(x) __builtin_astype((x), bfloat128)
#endif
# 77 "tpc-defs.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 79 "tpc-defs.h"
#define as_half(x)      __builtin_astype((x), half)
#define as_half128(x)   __builtin_astype((x), half128)
#endif
# 82 "tpc-defs.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 84 "tpc-defs.h"
#define as_f8_143(x)      __builtin_astype((x), f8_143)
#define as_f8_152(x)      __builtin_astype((x), f8_152)
#define as_v256f8_143(x)  __builtin_astype((x), v256f8_143)
#define as_v256f8_152(x)  __builtin_astype((x), v256f8_152)
#endif
# 89 "tpc-defs.h"

// Structures mapped to registers

// float
typedef struct _float64_pair_t {
  float64 v1;
  float64 v2;
} float64_pair_t;
typedef struct _float64_pair_t float64_float64_pair_t;
typedef struct _float64_pair_t float128;

typedef struct _float256 {
  float64 v1;
  float64 v2;
  float64 v3;
  float64 v4;
} float256;

typedef struct _float64_int64_pair_t {
  float64 v1;
  int64 v2;
} float64_int64_pair_t;

typedef struct _float64_uint64_pair_t {
  float64 v1;
  uint64 v2;
} float64_uint64_pair_t;


// int
typedef struct _int64_float64_pair_t {
  int64 v1;
  float64 v2;
} int64_float64_pair_t;

typedef struct _int64_pair_t {
  int64 v1;
  int64 v2;
} int64_pair_t;
typedef struct _int64_pair_t int64_int64_pair_t;
typedef struct _int64_pair_t int128;

typedef struct _int64_uint64_pair_t {
  int64 v1;
  uint64 v2;
} int64_uint64_pair_t;


// uint
typedef struct _uint64_float64_pair_t {
  uint64 v1;
  float64 v2;
} uint64_float64_pair_t;

typedef struct _uint64_int64_pair_t {
  uint64 v1;
  int64 v2;
} uint64_int64_pair_t;

typedef struct _uint64_pair_t {
  uint64 v1;
  uint64 v2;
} uint64_pair_t;
typedef struct _uint64_pair_t uint64_uint64_pair_t;
typedef struct _uint64_pair_t uint128;

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 156 "tpc-defs.h"
// _BFloat16
typedef struct _bfloat128_pair_t {
  bfloat128 v1;
  bfloat128 v2;
} bfloat128_pair_t;
typedef struct _bfloat128_pair_t bfloat128_bfloat128_pair_t;
typedef struct _bfloat128_pair_t bfloat256;

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 165 "tpc-defs.h"
typedef struct _bfloat128_half128_pair_t {
  bfloat128 v1;
  half128 v2;
} bfloat128_half128_pair_t;
#endif
# 170 "tpc-defs.h"

typedef struct _bfloat128_short128_pair_t {
  bfloat128 v1;
  short128 v2;
} bfloat128_short128_pair_t;

typedef struct _bfloat128_ushort128_pair_t {
  bfloat128 v1;
  ushort128 v2;
} bfloat128_ushort128_pair_t;
#endif
# 181 "tpc-defs.h"

// half
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 184 "tpc-defs.h"
typedef struct _half128_bfloat128_pair_t {
  half128 v1;
  bfloat128 v2;
} half128_bfloat128_pair_t;

typedef struct _half128_pair_t {
  half128 v1;
  half128 v2;
} half128_pair_t;
typedef struct _half128_pair_t half128_half128_pair_t;
typedef struct _half128_pair_t half256;

typedef struct _half128_short128_pair_t {
  half128 v1;
  short128 v2;
} half128_short128_pair_t;

typedef struct _half128_ushort128_pair_t {
  half128 v1;
  ushort128 v2;
} half128_ushort128_pair_t;
#endif
# 206 "tpc-defs.h"

// short
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 209 "tpc-defs.h"
typedef struct _short128_bfloat128_pair_t {
  short128 v1;
  bfloat128 v2;
} short128_bfloat128_pair_t;
#endif
# 214 "tpc-defs.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 216 "tpc-defs.h"
typedef struct _short128_half128_pair_t {
  short128 v1;
  half128 v2;
} short128_half128_pair_t;
#endif
# 221 "tpc-defs.h"

typedef struct _short128_pair_t {
  short128 v1;
  short128 v2;
} short128_pair_t;
typedef struct _short128_pair_t short128_short128_pair_t;
typedef struct _short128_pair_t short256;

typedef struct _short128_ushort128_pair_t {
  short128 v1;
  ushort128 v2;
} short128_ushort128_pair_t;


// ushort
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 237 "tpc-defs.h"
typedef struct _ushort128_bfloat128_pair_t {
  ushort128 v1;
  bfloat128 v2;
} ushort128_bfloat128_pair_t;
#endif
# 242 "tpc-defs.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 244 "tpc-defs.h"
typedef struct _ushort128_half128_pair_t {
  ushort128 v1;
  half128 v2;
} ushort128_half128_pair_t;
#endif
# 249 "tpc-defs.h"

typedef struct _ushort128_short128_pair_t {
  ushort128 v1;
  short128 v2;
} ushort128_short128_pair_t;

typedef struct _ushort128_pair_t {
  ushort128 v1;
  ushort128 v2;
} ushort128_pair_t;
typedef struct _ushort128_pair_t ushort128_ushort128_pair_t;
typedef struct _ushort128_pair_t ushort256;


// char
typedef struct _char256_pair_t {
  char256 v1;
  char256 v2;
} char256_pair_t;
typedef struct _char256_pair_t char256_char256_pair_t;
typedef struct _char256_pair_t char512;

typedef struct _char256_uchar256_pair_t {
  char256 v1;
  uchar256 v2;
} char256_uchar256_pair_t;

// uchar
typedef struct _uchar256_char256_pair_t {
  uchar256 v1;
  char256 v2;
} uchar256_char256_pair_t;

typedef struct _uchar256_pair_t {
  uchar256 v1;
  uchar256 v2;
} uchar256_pair_t;
typedef struct _uchar256_pair_t uchar256_uchar256_pair_t;
typedef struct _uchar256_pair_t uchar512;

typedef struct _uint32_t_pair_t {
  unsigned int v1;
  unsigned int v2;
} uint32_t_pair_t;

typedef struct _uint16_t_pair_t {
  unsigned int v1;
  unsigned int v2;
} uint16_t_pair_t;

typedef struct _uint8_t_pair_t {
  unsigned int v1;
  unsigned int v2;
} uint8_t_pair_t;


typedef struct _int32_t_pair_t {
  int v1;
  int v2;
} int32_t_pair_t;

typedef struct _int256 {
  int64 v1;
  int64 v2;
  int64 v3;
  int64 v4;
} int256;

typedef struct _uint256 {
  uint64 v1;
  uint64 v2;
  uint64 v3;
  uint64 v4;
} uint256;

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 325 "tpc-defs.h"
typedef struct _minifloat256_pair_t {
  minifloat256 v1;
  minifloat256 v2;
} minifloat256_pair_t;
typedef struct _minifloat256_pair_t minifloat256_minifloat256_pair_t;
typedef struct _minifloat256_pair_t minifloat512;

typedef struct _minifloat256_minihalf256_pair_t {
  minifloat256 v1;
  minihalf256 v2;
} minifloat256_minihalf256_pair_t;

typedef struct _minifloat256_char256_pair_t {
  minifloat256 v1;
  char256 v2;
} minifloat256_char256_pair_t;

typedef struct _minifloat256_uchar256_pair_t {
  minifloat256 v1;
  uchar256 v2;
} minifloat256_uchar256_pair_t;

typedef struct _char256_minifloat256_pair_t {
  char256 v1;
  minifloat256 v2;
} char256_minifloat256_pair_t;

typedef struct _uchar256_minifloat256_pair_t {
  uchar256 v1;
  minifloat256 v2;
} uchar256_minifloat256_pair_t;

typedef struct _minihalf256_pair_t {
  minihalf256 v1;
  minihalf256 v2;
} minihalf256_pair_t;
typedef struct _minihalf256_pair_t minihalf256_minihalf256_pair_t;
typedef struct _minihalf256_pair_t minihalf512;

typedef struct _minihalf256_minifloat256_pair_t {
  minihalf256 v1;
  minifloat256 v2;
} minihalf256_minifloat256_pair_t;

typedef struct _minihalf256_char256_pair_t {
  minihalf256 v1;
  char256 v2;
} minihalf256_char256_pair_t;

typedef struct _minihalf256_uchar256_pair_t {
  minihalf256 v1;
  uchar256 v2;
} minihalf256_uchar256_pair_t;

typedef struct _char256_minihalf256_pair_t {
  char256 v1;
  minihalf256 v2;
} char256_minihalf256_pair_t;

typedef struct _uchar256_minihalf256_pair_t {
  uchar256 v1;
  minihalf256 v2;
} uchar256_minihalf256_pair_t;

typedef long squeeze_cntr;
#endif
# 391 "tpc-defs.h"

// Address space specifiers
#define __local__  __local
#define __global__ __global


// Internal functions.
void static inline __attribute__((always_inline)) __initialize();

// It would be nice to remove this definition some day.
typedef int tensor;




#ifndef NO_TPC_PRINTF
// Index needed for printf intrinsic.
register int5 __PrintfTensorIndex __asm__("i2");
#endif
# 410 "tpc-defs.h"

// Instruction switches
enum {
  // ABS
  SW_NO_SAT             = 0x1 << 0,
  // ADD
  SW_SAT                = 0x1 << 0,
  SW_CARRY              = 0x1 << 1,
  SW_NO_CARRY_GEN       = 0x1 << 2,
  // ASH
  /* SW_SAT - see previous definition */
  SW_RHU                = 0x1 << 1,
  // ASO / EVENT
  SW_INC                = 0x0 << 8,
  SW_DEC                = 0x1 << 8,
  SW_SPU                = 0x0 << 8,
  SW_VPU                = 0x2 << 8,
  // CACHE_INVALIDATE
  SW_SB                 = 0x1 << 0,
  SW_D                  = 0x1 << 1,
  SW_LU                 = 0x1 << 2,
  SW_RST_LU             = 0x1 << 3,
  SW_RST_D_PREF         = 0x1 << 4,
  SW_INV_LOG            = 0x1 << 6,
  // PREFETCH
  SW_L2                 = 0x1 << 3,
  // CALC_FP_SPECIAL
  SW_RECIP              = 0x0 << 0,
  SW_RSQRT              = 0x1 << 0,
  SW_SQRT               = 0x2 << 0,
  SW_LOG                = 0x3 << 0,
  SW_EXP                = 0x4 << 0,
  SW_TANH               = 0x5 << 0,
  SW_DIV                = 0x6 << 0,
  SW_POW                = 0x7 << 0,
  // CMP_EQ / SEL_EQ
  SW_MASK_EQ_ZERO       = 0x1 << 0,
  SW_SUP_NAN            = 0x1 << 2,
  // CONVERT
  // CONVERT_INT32 / CONVERT_UINT32
  // CONVERT_INT16 / CONVERT_UINT16
  // CONVERT_INT8  / CONVERT_UINT8
  // NEARBYINT
  SW_RHNE               = 0x0 << (0 + 16),
  SW_RZ                 = 0x1 << (0 + 16),
  SW_RU                 = 0x2 << (0 + 16),
  SW_RD                 = 0x3 << (0 + 16),
  SW_SR                 = 0x4 << (0 + 16),
  SW_CSR                = 0x5 << (0 + 16),
  SW_RHAZ               = 0x6 << (0 + 16),
  SW_SR_RNE             = 0x7 << (0 + 16),
  SW_CLIP_FP            = 0x1 << (4 + 16),
  SW_LINEAR             = 0x1 << 24,
  // GEN_ADDR
  SW_DT_INT8            = 0x0 << 0,
  SW_DT_INT16           = 0x1 << 0,
  SW_DT_INT32           = 0x2 << 0,
  SW_DT_UINT8           = 0x3 << 0,
  SW_DT_UINT16          = 0x4 << 0,
  SW_DT_UINT32          = 0x5 << 0,
  SW_DT_BF16            = 0x6 << 0,
  SW_DT_FP32            = 0x7 << 0,
  SW_DT_FP16            = 0x8 << 0,
  SW_DT_FP8_152         = 0x9 << 0,
  SW_DT_FP8_143         = 0xa << 0,
  SW_DT_INT64           = 0xb << 0,
  SW_DT_OVERRIDE        = 0x1 << 4,
  SW_PAD                = 0x1 << 6,
  // CACHE_FLUSH
  SW_NO_INV             = 0x1 << 0,
  // EXTRACT_EXP
  SW_BIASED             = 0x1 << 0,
  SW_PRE_LOG            = 0x1 << 1,
  // FIND_FIRST
  SW_FIND_ZERO          = 0x0 << 0,
  SW_FIND_ONE           = 0x1 << 0,
  SW_LSB                = 0x0 << 1,
  SW_MSB                = 0x1 << 1,
  // FORM_FP_NUMBER
  SW_ADD_BIAS           = 0x1 << (0 + 8),
  SW_FORCE_SIGN0        = 0x1 << (1 + 8),
  SW_FORCE_SIGN1        = 0x1 << (2 + 8),
  SW_EXP_IS_NUM         = 0x1 << (3 + 8),
  SW_SIGN_LSB           = 0x1 << (4 + 8),
  SW_PRE_SQRT_RSQRT     = (0x1 << (5 + 8)) | SW_FORCE_SIGN0,
  SW_POST_SQRT          = (0x2 << (5 + 8)) | SW_FORCE_SIGN0,
  SW_POST_RSQRT         = (0x3 << (5 + 8)) | SW_FORCE_SIGN0,
  SW_POST_RECIP         = (0x4 << (5 + 8)) | SW_ADD_BIAS,
  SW_PRE_LOG_FUNC       = (0x5 << (5 + 8)),
  // GET_LUT_ENTRY_AND_INTERVAL_START
  SW_LUT_TANH           = 0x1 << (5 + 8),
  SW_LUT_SQRT_RSQRT     = 0x2 << (5 + 8),
  SW_LUT_SIN_COS        = 0x3 << (5 + 8),
  SW_LUT_LOG            = 0x4 << (5 + 8),
#if 0 /* disabled by -frewrite-includes */
#if defined (__greco__) || defined (__gaudi2__) || defined (__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 505 "tpc-defs.h"
  SW_LUT_OPT            = 1 << 0,
  SW_LUT_EXP0           = 1 << 1,
#endif
# 508 "tpc-defs.h"
  // LD_L / ST_L
  SW_SLM                = 0x0 << 0,
  SW_MMIO               = 0x1 << 0,
  SW_LOCK               = 0x1 << 1,
  SW_UNLOCK             = 0x1 << 1,
  // LD_L_V / ST_L_V
  SW_AUTO_INC_1_V       = 0x1 << 0,
  SW_AUTO_INC_2_V       = 0x2 << 0,
  SW_AUTO_INC_4_V       = 0x3 << 0,
  // LD_G / ST_G
  SW_INC_1              = 0x1,
  SW_INC_2              = 0x2,
  SW_INC_4              = 0x3,
  SW_INC_8              = 0x4,
#if 0 /* disabled by -frewrite-includes */
#if defined(__greco__) // temporary until kernels fixed
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 523 "tpc-defs.h"
  SW_AUTO_INC           = 0x1 << 0,
  SW_AUTO_INC_1         = (0x0 << 2) | SW_AUTO_INC,
  SW_AUTO_INC_2         = (0x1 << 2) | SW_AUTO_INC,
  SW_AUTO_INC_4         = (0x2 << 2) | SW_AUTO_INC,
  SW_AUTO_INC_8         = (0x3 << 2) | SW_AUTO_INC,
#endif
# 529 "tpc-defs.h"
#if 0 /* disabled by -frewrite-includes */
#if defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 530 "tpc-defs.h"
  SW_EXC                = 0x1 << 9,
#endif
# 532 "tpc-defs.h"

  SW_BV64               = 0x1 << 4,
  SW_L0CS               = 0x1 << 5,
  SW_L0CD               = 0x1 << 5,
  SW_EV_HINT            = 0x1 << 6,
  SW_PD                 = 0x1 << (7 + 8),
  // LD_TNSR
  SW_UNPCK_16_TO_32     = 0x0 << 1,
  SW_UNPCK_8_TO_16      = 0x1 << 1,
  SW_UNPCK_8_TO_32      = 0x2 << 1,
  SW_UNPCK_4_TO_8       = 0x3 << 1,
  SW_UNPACK             = 0x1 << 4,
  /* SW_L0CS - see previous definition */
  // LOOKUP
  SW_BV32               = 0x0 << 0,
  SW_BV16               = 0x1 << 0,
  
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 549 "tpc-defs.h"
  SW_BV16_LOW           = 0x2 << 0,
  SW_BV16_HIGH          = 0x3 << 0,
  SW_BV8_0              = 0x4 << 0,
  SW_BV8_1              = 0x5 << 0,
  SW_BV8_2              = 0x6 << 0,
  SW_BV8_3              = 0x7 << 0,
  #else
# 556 "tpc-defs.h"
  SW_BV8_0              = 0x2 << 0,
  SW_BV8_1              = 0x3 << 0,
  #endif
# 559 "tpc-defs.h"
  SW_UPPER_HALF         = 0x1 << 2,
  SW_LUT_PTR            = 0x1 << 3,
  SW_X2                 = 0x1 << 4,
  SW_SBCD               = 0x1 << 5,
  // MAC / MADD
  /* SW_SAT - see previous definition */
  SW_NO_NEG             = 0x0 << 1,
  SW_NEG                = 0x1 << 1,
  SW_NEG_ZP             = 0x1 << 6,
  // MOV_DUAL_GROUP
  SW_WR_LOWER_GROUP     = 0x1 << (4 + 8),
  SW_WR_UPPER_GROUP     = 0x1 << (5 + 8),
  SW_WR_LOWER_GROUP0    = 0x1 << (0 + 16),
  SW_WR_UPPER_GROUP0    = 0x1 << (1 + 16),
  SW_WR_LOWER_GROUP1    = 0x1 << (2 + 16),
  SW_WR_UPPER_GROUP1    = 0x1 << (3 + 16),
  SW_WR_LOWER_GROUP2    = 0x1 << (4 + 16),
  SW_WR_UPPER_GROUP2    = 0x1 << (5 + 16),
  SW_WR_LOWER_GROUP3    = 0x1 << (6 + 16),
  SW_WR_UPPER_GROUP3    = 0x1 << (7 + 16),
  SW_PACK21             = 0x0 << 2,
  SW_PACK41             = 0x1 << 2,
  SW_UNPACK_EVEN_LANES  = 0x0 << 2,
  SW_UNPACK_ODD_LANES   = 0x1 << 2,
  // MOV_GROUP
  SW_GROUP0_EN          = 0x1 << 0,
  SW_GROUP1_EN          = 0x1 << 1,
  SW_DUAL_GROUP0_EN     = 0x1 << 2,
  SW_DUAL_GROUP1_EN     = 0x1 << 3,
  SW_DUAL_GROUP2_EN     = 0x1 << 4,
  SW_DUAL_GROUP3_EN     = 0x1 << 5,
  // MSAC
  /* SW_RHU - see previous definition */
  SW_NORMALIZE_AB       = 0x0 << 2,
  SW_NORMALIZE_C        = 0x1 << 2,
  // MUL
  SW_KEEP_RS            = 0x2 << 0,
  SW_KEEP_RS_FOR_ADD    = 0x3 << 0,
  SW_LOWER32            = 0x0 << 2,
  SW_UPPER32            = 0x1 << 2,
  // PACK
  SW_GROUP_0            = 0x0 << (0 + 8),
  SW_GROUP_1            = 0x1 << (0 + 8),
  SW_STRIDE_2           = 0x0 << (1 + 8),
  SW_STRIDE_4           = 0x1 << (1 + 8),
  // POPCNT
  SW_COUNT_ZEROS        = 0x0 << 0,
  SW_COUNT_ONES         = 0x1 << 0,
  // ST_TNSR_S
  SW_ST_TNSR_S_BV64     = 0x1 << 2,
  // ST_TNSR
  SW_PACK               = 0x1 << 2,
  SW_PCK_32_TO_16       = 0x0 << 4,
  SW_PCK_16_TO_8        = 0x1 << 4,
  SW_PCK_32_TO_8        = 0x2 << 4,
  SW_PCK_8_TO_4         = 0x3 << 4,
  // RMW_SEL
  RMW_DT_INT16          = 0x1 << 0,
  RMW_DT_INT32          = 0x2 << 0,
  RMW_DT_INT8           = 0x0 << 0,
  RMW_DT_UINT8          = 0x3 << 0,
  RMW_DT_UINT16         = 0x4 << 0,
  RMW_DT_UINT32         = 0x5 << 0,
  RMW_DT_BF16           = 0x6 << 0,
  RMW_DT_FP32           = 0x7 << 0,
  RMW_DT_FP16           = 0x8 << 0,
  RMW_DT_FP8_152        = 0x9 << 0,
  RMW_OP_ADD            = 0x0 << 4,
  RMW_OP_SUB            = 0x1 << 4,
  RMW_OP_MIN            = 0x2 << 4,
  RMW_OP_MAX            = 0x3 << 4,
  RMW_OP_MAX_0_ADD      = 0x4 << 4,
  RMW_TNSR_DT           = 0x1 << 7,
  
#if 0 /* disabled by -frewrite-includes */
#if defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 633 "tpc-defs.h"
  RMW_SET               = 0x1 << 8,
  #else
# 635 "tpc-defs.h"
  RMW_SET               = 0x1 << 6,
  #endif
# 637 "tpc-defs.h"
  // SUB
  /* SW_SAT - see previous definition */
  /* SW_NEG - see previous definition */
  SW_NO_BORROW_GEN      = 0x1 << 2,
  SW_BORROW             = 0x1 << 3,
  // UNPACK
  /* SW_GROUP_0 - see previous definition */
  /* SW_GROUP_1 - see previous definition */
  /* SW_STRIDE_2 - see previous definition */
  /* SW_STRIDE_4 - see previous definition */
  SW_GROUP_HALF_0       = 0x0 << (2 + 8),
  SW_GROUP_HALF_1       = 0x1 << (2 + 8),
  SW_UNPACK_LANE_0      = 0x0 << (3 + 8),
  SW_UNPACK_LANE_1      = 0x1 << (3 + 8),
  SW_UNPACK_LANE_2      = 0x2 << (3 + 8),
  SW_UNPACK_LANE_3      = 0x3 << (3 + 8),
  // UDIV_4STEP
  SW_X2_UDIV_4STEP      = 0x1 << 6,
  // UDIV
  SW_DIV_MODE_DIV       = 0x0 << 0,
  SW_DIV_MODE_MOD       = 0x1 << 0,
  SW_DIV_MODE_BOTH      = 0x2 << 0,
  // READ_LFSR / S_READ_LFSR
  SW_READ_ONLY          = 1,
  
#if 0 /* disabled by -frewrite-includes */
#if defined (__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 662 "tpc-defs.h"
  SW_PART_LOW           = 0x0 << 4,
  SW_PART_HIGH          = 0x1 << 4,
  
  SW_INC_DIM0           = 0x0 << 8,
  SW_INC_DIM1           = 0x1 << 8,
  SW_INC_DIM2           = 0x2 << 8,
  SW_INC_DIM3           = 0x3 << 8,
  SW_INC_DIM4           = 0x4 << 8,
  #endif
# 671 "tpc-defs.h"
};

// Instruction switches. Must agree with definitions in 'lib/Target/TPC/Utils/InstructionDB.h'.
enum {
  
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 676 "tpc-defs.h"
  SW_FP16_FTZ_IN     = 1U << 0,
  SW_CLIP_FP16       = 1U << 7,
  SW_UNPACK_LANE     = 1U << 11,
  #endif
# 680 "tpc-defs.h"
  SW_GROUP_HALF      = 1U << 10,
  SW_SUBTRACT_BIAS   = 1U << 0,
  SW_GROUP_RND32     = 0x03,
  SW_NO_ROUND        = 0,
  SW_PACK_DT         = 0x03 << 4,
  SW_GROUP_SOURCE    = 1 << 8,
  SW_ELEMENT_STRIDE  = 1 << 9,
  SW_LANE_0          = 0,
  SW_LANE_1          = 0x1,
  SW_LANE_2          = 0x2,
  SW_LANE_3          = 0x3,
  SW_LD_G_PARTIAL    = 1 << 7,
  SW_NUM_LANES_SRCB  = 1U << 6,
  SW_LOWER_LANES     = 2U << 6,
  SW_UPPER_LANES     = 3U << 6,
  SW_ALL_LANES_SRCB     = 0,
  SW_SINGLE_LANE_SRCB   = SW_NUM_LANES_SRCB,
#if 0 /* disabled by -frewrite-includes */
#if defined (__greco__) || defined (__gaudi2__) || defined (__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 698 "tpc-defs.h"
  SW_ANDN            = 1 << 1,
#endif
# 700 "tpc-defs.h"

#if 0 /* disabled by -frewrite-includes */
#if defined (__gaudi2__) || defined (__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 702 "tpc-defs.h"
  SW_DIRECT         = 1 << 6,
#endif
# 704 "tpc-defs.h"

#if 0 /* disabled by -frewrite-includes */
#if defined (__gaudi2__) | defined (__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 706 "tpc-defs.h"
  SW_CLIP_X2        = 0x080000,
  SW_IRF44_HIGH = 1,
#endif
# 709 "tpc-defs.h"

};


// Data types.
enum {
  SW_TYPE     = 0x0f,
  SW_FP32     = 0,
  SW_BF16     = 1,
  SW_INT32    = 2,
  SW_UINT32   = 3,
  SW_INT8     = 4,
  SW_UINT8    = 5,
  SW_BOOL     = 6,
  SW_INT16    = 7,
  SW_UINT16   = 8,
  SW_INT4     = 9,
  SW_UINT4    = 10,
  SW_FP16     = 11,
  SW_FP8_152  = 12,
  SW_FP8_143  = 13,
  SW_INT64    = 14
};

#define MkWrA(w0, w1, w2, w3)  (((w0) << 16) | ((w1) << 18) | ((w2) << 20) | ((w3) << 22))

#define MkWr(l, u)  (((l) ? SW_WR_LOWER_GROUP : 0) | ((u) ? SW_WR_UPPER_GROUP : 0))

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 738 "tpc-defs.h"
  #define MkRMW(dt, op, rmw, dl)  ((dt) | ((op) << 4) | ((rmw) << 8) | ((dl) << 7))
#else
# 740 "tpc-defs.h"
  #define MkRMW(dt, op, rmw, dl)  ((dt) | ((op) << 4) | ((rmw) << 6) | ((dl) << 7))
#endif
# 742 "tpc-defs.h"

inline unsigned MdgCtrlSingle(unsigned src_dual_group, unsigned dst_dual_group, unsigned write_lower_group, unsigned write_upper_group) {
  return (src_dual_group | (dst_dual_group << 2) | (write_lower_group << 4) | (write_upper_group << 5));
}

inline unsigned MdgCtrlAll(unsigned src_dual_group_0, unsigned src_dual_group_1, unsigned src_dual_group_2, unsigned src_dual_group_3) {
  return (src_dual_group_0 | (src_dual_group_1 << 2) | (src_dual_group_2 << 4) | (src_dual_group_3 << 6));
}

// CONVERT
// for FP32 to BF16/FP16, when using tpc-c, there is a switch of ALL_LANES,
// which translates the instruction into 2 assembly instructions
// SINGLE_LANE with LANE_SEL=0 and SINGLE_LANE with LANE_SEL=
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudib__) || defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 756 "tpc-defs.h"
#define v_convert_f32_to_bf16_all_vb(src, switches, income, predicate,         \
                                     polarity)                                 \
  v_bf16_mov_vb(v_convert_f32_to_bf16_all_b(src, switches,income,1,0),0,       \
                income,predicate, polarity                                     \
              )
#endif
# 762 "tpc-defs.h"

// Preloaded registers
#define LFSR              read_lfsr_b()
#define LFSR_NO_CHANGE    read_lfsr_b(SW_READ_ONLY)
#define S_LFSR            s_read_lfsr()
#define S_LFSR_NO_CHANGE  s_read_lfsr(SW_READ_ONLY)
#define V_LANE_ID_32      read_lane_id_4b_b()
#define V_LANE_ID_16      read_lane_id_2b_b()
#define V_LANE_ID_8       read_lane_id_1b_b()

#endif
# 773 "tpc-defs.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 775 "tpc-defs.h"
#define UPPER_HALF (1 << 2)
#if 0 /* disabled by -frewrite-includes */
#if defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 777 "tpc-defs.h"
#define LUT_PTR (1 << 3)
#define X2      (1 << 4)

#endif
# 781 "tpc-defs.h"
#endif
# 782 "tpc-defs.h"
# 1 "<built-in>" 2
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 1 "<built-in>" 2
# 1 "tpc-special.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Alexander Semenov <asemenov@unipro.ru>
* Dmytrey Salnikov <dmytro.salnikov@p-product.com>
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if defined(INCLUDE_TPC_SPECIAL_H) && !defined(TPC_SPECIAL_H_INCLUDED)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 15 "tpc-special.h"
#define TPC_SPECIAL_H_INCLUDED

#define __bool_true_false_are_defined 1
#ifndef __cplusplus
#   define bool        _Bool
#   define true        1
#   define false        0
#else /* __cplusplus */
# 23 "tpc-special.h"
#   define _Bool        bool
#endif /* __cplusplus */
# 25 "tpc-special.h"

// These are definitions previously defined in 'tpc-defs.h'. They are not part
// of compiler support library, just only definitions that are wanted to be
// available without inclusion of any header file.

#ifndef TPC_KERNEL_PATH
typedef enum _e_round_mode {
  e_round_half_ne = 0,
  e_round_zero = 1,
  e_round_up = 2,
  e_round_down = 3,
  e_round_stochastic = 4,
  e_round_half_az = 6
} e_round_mode;

typedef enum _e_negation { e_no_negation = 0, e_with_negation = 1 } e_negation;

typedef enum _e_aso_access_type {
  e_aso_prefetch = 0,
  e_aso_commit = 1
} e_aso_access_type;

typedef enum _e_return_bits {
  e_return_lower_32 = 0,
  e_return_upper_32 = 1
} e_return_bits;

typedef enum _e_group_source { e_group_0 = 0, e_group_1 = 1 } e_group_source;

typedef enum _e_element_stride {
  e_every_second_element = 0,
  e_every_forth_element = 1
} e_element_stride;

typedef enum _e_group_half {
  e_lower_half_group = 0,
  e_higher_half_group = 1
} e_group_half;

typedef enum _e_abc_int_norm_sel {
  e_normalize_ab = 0,
  e_normalize_c = 1
} e_abc_int_norm_sel;

typedef enum _e_access_type {
  e_access_slm = 0,
  e_access_mmio = 1
} e_access_type;

typedef enum _e_saturation { e_no_saturation = 0, e_saturate = 1 } e_saturation;

#endif /* TPC_KERNEL_PATH */
# 77 "tpc-special.h"

typedef enum _e_compare_value {
  e_compare_bit_0 = 0,
  e_compare_bit_1 = 1
} e_compare_value;

typedef enum _e_search_dir {
  e_start_from_lsb = 0,
  e_start_from_msb = 1
} e_search_dir;

typedef enum _e_mov_flavor {
  e_bits_0_31 = 0,
  e_bits_32_63 = 1,
  e_bits_64_95 = 2,
  e_bits_96_127 = 3,
  e_bits_128_159 = 4,
  e_bits_160_191 = 5,
  e_bits_192_223 = 6,
  e_bits_224_255 = 7,
  e_standard_mov = 8
} e_mov_flavor;

typedef enum _e_aso_op {
  e_aso_increment = 0,
  e_aso_decrement = 1
} e_aso_op;

typedef enum _e_count_type {
  e_count_zeros = 0,
  e_count_ones = 1
} e_count_type;

typedef enum _e_mul_behavior {
  e_mul_default = 0,
  e_doube_and_round = 1
} e_mul_behavior;

#ifdef __goya__
typedef enum _e_lookup_data_type {
  e_lookup_fp32 = 0,
  e_lookup_reserved = 1,
  e_lookup_fp16_low = 2,
  e_lookup_fp16_high = 3,
  e_lookup_int8_0 = 4,
  e_lookup_int8_1 = 5,
  e_lookup_int8_2 = 6,
  e_lookup_int8_3 = 7
} e_lookup_data_type;
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__) 
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 127 "tpc-special.h"
typedef enum _e_lookup_data_type {
  e_lookup_fp32 = 0,
  e_lookup_bv16 = 1
} e_lookup_data_type;
#else
# 132 "tpc-special.h"
#error "Undefined processor"
#endif
# 134 "tpc-special.h"

#ifdef __goya__
typedef enum _e_function_id
{
    e_fp32_tanh             = 0,
    e_fp32_rsqrt            = 1,
    e_fp32_log2             = 2,
    e_fp32_sqrt             = 16,
    e_fp32_rcp              = 17,
    e_fp32_sin_cos          = 18,
    e_fp32_pow2_128         = 19,
    e_fp16_tanh_128         = 20,
    e_i16_tanh_128          = 21,
    e_i16_sigmoid_128       = 22,
    e_i16_exp_nep_128       = 23,
    e_i16_rcp_128           = 24,
    e_i8_tanh_linear_128    = 25,
    e_i8_sigmoid_linear_128 = 26,
    e_i8_exp_linear_128     = 27,
    e_i8_tanh_128           = 28,
    e_fp32_pow2             = 32,
    e_fp16_tanh             = 33,
    e_i16_tanh              = 34,
    e_i16_sigmoid           = 35,
    e_i16_exp_nep           = 36,
    e_i16_rcp               = 37,
    e_i8_tanh_linear        = 38,
    e_i8_sigmoid_linear     = 39,
    e_i8_exp_linear         = 40,
    e_i16_gelu_minus_relu   = 41,
    e_fp16_rsqrt            = 48,
    e_fp16_log2             = 49,
    e_fp16_sqrt             = 50,
    e_fp16_rcp              = 51,
    e_fp16_sin_cos          = 52,
    e_fp16_pow2             = 53,
    e_i8_tanh               = 54
} e_function_id;
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 173 "tpc-special.h"
typedef enum _e_function_id {
  e_fp32_tanh = 0,
  e_fp32_rsqrt = 1,
  e_fp32_log2 = 2,
  e_i8_sqrt = 3,
  e_u16_sqrt = 4,
  e_u32_power4 = 5,
  e_i8_sqrt_c0 = 6,
  e_u16_sqrt_c0 = 7,
  e_fp32_sqrt = 128,
  e_fp32_rcp = 129,
  e_fp32_sin_cos = 130,
  e_bf16_rcp_scalar_m7 = 131,
  e_bf16_sin_cos_scalar_m7 = 132,
  e_bf16_sin_cos_linear_m6 = 133,
  e_bf16_sin_cos_poly2_m6_c2c1 = 134,
  e_bf16_sin_cos_poly2_m6_c0 = 135,
  e_bf16_log2_linear_interleaved_m5 = 136,
  e_fp32_pow2 = 256,
  e_bf16_tanh = 257,
  e_i16_tanh = 258,
  e_i16_sigmoid = 259,
  e_i16_exp_neg = 260,
  e_i16_rcp = 261,
  e_i8_tanh_linear = 262,
  e_i8_sigmoid_linear = 263,
  e_i8_exp_linear = 264,
  e_bf16_tanh_c0 = 265,
  e_i16_tanh_c0 = 266,
  e_i16_sigmoid_c0 = 267,
  e_i16_exp_neg_c0 = 268,
  e_i16_rcp_c0 = 269,
  e_i8_tanh_linear_c0 = 270,
  e_i8_sigmoid_linear_c0 = 271,
  e_i8_exp_linear_c0 = 272,
  e_bf16_tanh_linear_m4 = 273,
  e_bf16_tanh_poly2_m4_c2c1 = 274,
  e_bf16_tanh_poly2_m4_c0 = 275,
  e_bf16_sqrt_scalar_m6 = 276,
  e_bf16_log2_linear_m5 = 277,
  e_bf16_sin_cos_linear_m5 = 278,
  e_bf16_sin_cos_poly_m5_c2c1 = 279,
  e_bf16_sin_cos_poly2_m5_co = 280,
  e_bf16_rcp_m7_c0 = 288,
  e_bf16_rsqrt = 384,
  e_bf16_log2 = 385,
  e_bf16_sqrt = 386,
  e_f16_sqrt_poly_m2_c2c1 = 386, // sqrt_coeffs_fp16 table is same as sqrt_coeffs_bf16
  e_bf16_rcp = 387,
  e_bf16_sin_cos = 388,
  e_bf16_pow2 = 389,
  e_i8_tanh = 390,
  e_bf16_rsqrt_c0 = 391,
  e_bf16_log2_c0 = 392,
  e_bf16_sqrt_c0 = 393,
  e_f16_sqrt_poly_m2_c0 = 393, // sqrt_coeffs_fp16 table is same as sqrt_coeffs_bf16
  e_bf16_rcp_c0 = 394,
  e_bf16_sin_cos_c0 = 395,
  e_bf16_pow2_c0 = 396,
  e_i8_tanh_c0 = 397,
  e_bf16_rcp_scalar = 398,
  e_f16_rcp_poly_m3_c2c1 = 398, // recip_coeffs_fp16 table is same as recip_coeffs_bf16
  e_bf16_rcp_linear_m2 = 399,
  e_bf16_rcp_linear_m3 = 400,
  e_bf16_rcp_linear_m4 = 401,
  e_bf16_rcp_poly_m2_c2c1 = 402,
  e_bf16_rcp_poly_m3_c2c1 = 403,
  e_bf16_rcp_poly_m4_c2c1 = 404,
  e_bf16_rcp_poly_m2_c0 = 405,
  e_bf16_rcp_poly_m3_c0 = 406,
  e_bf16_rcp_poly_m4_c0 = 407,
  e_f16_rcp_poly_m3_c0 = 408,
  e_bf16_sqrt_linear_m2 = 409,
  e_bf16_sqrt_linear_m3 = 410,
  e_bf16_sqrt_linear_m4 = 411,
  e_bf16_sqrt_poly2_m2_c2c1 = 412,
  e_bf16_sqrt_poly2_m3_c2c1 = 413,
  e_bf16_sqrt_poly2_m4_c2c1 = 414,
  e_bf16_sqrt_poly2_m2_c0 = 415,
  e_bf16_sqrt_poly2_m3_c0 = 416,
  e_bf16_sqrt_poly2_m4_c0 = 417,
  e_bf16_tanh_linear_m2 = 418,
  e_bf16_tanh_linear_m3 = 419,
  e_bf16_tanh_poly2_m2_c2c1 = 421,
  e_bf16_tanh_poly2_m3_c2c1 = 422,
  e_bf16_tanh_poly2_m2_c0 = 424,
  e_bf16_tanh_poly2_m3_c0 = 425,
  e_bf16_log2ml_linear_m4 = 426,
  e_bf16_sin_cos_linear_m2 = 427,
  e_bf16_sin_cos_linear_m3 = 428,
  e_bf16_sin_cos_linear_m4 = 429,
  e_bf16_sin_cos_poly2_m2_c2c1 = 430,
  e_bf16_sin_cos_poly2_m2_c0 = 431,
  e_bf16_sin_cos_poly2_m3_c2c1 = 432,
  e_bf16_sin_cos_poly2_m3_c0 = 433,
  e_bf16_sin_cos_poly2_m4_c2c1 = 434,
  e_bf16_sin_cos_poly2_m4_c0 = 435,
  e_f16_rsqrt_poly_m3_c2c1 = 440,
  e_f16_rsqrt_poly_m3_c0 = 441,
  e_f16_pow2_poly_m2_c2c1 = 444,
  e_f16_pow2_poly_m2_c0 = 445,
} e_function_id;
#else
# 276 "tpc-special.h"
#error "Undefined processor"
#endif
# 278 "tpc-special.h"

typedef enum _e_func_variant {
  e_func_variant_default = 0,
  e_func_variant_tanh = 1,
  e_func_variant_sqrt_rsqrt = 2,
  e_func_variant_sin_cos = 3
} e_func_variant;

typedef struct _permute_t {
  unsigned int bitfielv4;
} permute_t;

typedef enum _e_fp_special_values {
  e_fp_nan = 0,
  e_fp_pos_inf = 1,
  e_fp_neg_inf = 2,
  e_fp_negative = 3,
  e_fp_zero = 4,
  e_fp_positive = 5,
  e_fp_denormalized = 6
} e_fp_special_values;

typedef struct _fp_special_values_t {
  unsigned int bitfielv4;
} fp_special_values_t;

typedef enum _e_prefetch_level {
  e_prefetch_l1 = 0,
  e_prefetch_l2 = 1,
  e_prefetch_l3 = 3,
} e_prefetch_level;

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 311 "tpc-special.h"
typedef enum _e_calc_fp_special {
  e_fp_recip = 0,
  e_fp_rsqrt = 1,
  e_fp_sqrt = 2,
  e_fp_log = 3,
  e_fp_exp = 4,
  e_fp_tanh = 5,
  e_fp_div = 6,
  e_fp_pow = 7
} e_calc_fp_special;

typedef enum _e_rmw_datatype {
  e_rmw_int8 = 0,
  e_rmw_int16 = 1,
  e_rmw_int32 = 2,
  e_rmw_uint8 = 3,
  e_rmw_uint16 = 4,
  e_rmw_uint32 = 5,
  e_rmw_bf16 = 6,
  e_rmw_fp32 = 7
} e_rmw_datatype;

typedef enum _e_rmw_op {
  e_rmw_add = 0,
  e_rmw_sub = 1,
  e_rmw_min = 2,
  e_rmw_max = 3
} e_rmw_op;

typedef enum _e_rmw_set {
  e_rmw_plain = 0,
  e_rmw_atomic = 1
} e_rmw_set;

typedef enum _e_tnsr_dt_location {
  e_tnsr_dt_srf = 0,
  e_tnsr_dt_desc = 1
} e_tnsr_dt_location;
#endif
# 350 "tpc-special.h"

#ifndef NO_TPC_PRINTF

#define PP_ARG(...) PP_ARG_(__VA_ARGS__, PP_DEFAULT())
#define PP_ARG_(...) PP_ARG_2(__VA_ARGS__)
#define PP_ARG_2(x,y,...) x,y
#ifdef __cplusplus
#  define PP_DEFAULT() false
#else
# 359 "tpc-special.h"
#  define PP_DEFAULT() (_Bool)0
#endif
# 361 "tpc-special.h"
#define PP_mediate(...) printf_2(__VA_ARGS__)
#define printf(...) PP_mediate(PP_ARG(__VA_ARGS__))

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 365 "tpc-special.h"
#define printf_2(x, y)                  \
  _Generic((y),                         \
    half           : printf_h(x,y),     \
    _BFloat16      : printf_bf(x,y),    \
    float          : printf_f(x, y),    \
    int            : printf_i(x, y),    \
    unsigned       : printf_ui(x, y),   \
    short          : printf_s(x, y),    \
    unsigned short : printf_us(x, y),   \
    char           : printf_c(x, y),    \
    unsigned char  : printf_uc(x, y),   \
    _Float8_143    : printf_f8(x,y),    \
    _Float8_152    : printf_h8(x,y),    \
    default        : printf_st(x))
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif  defined(__gaudib__) || defined(__greco__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 380 "tpc-special.h"
#define printf_2(x, y)                  \
  _Generic((y),                         \
    half           : printf_h(x,y),     \
    _BFloat16      : printf_bf(x,y),    \
    float          : printf_f(x, y),    \
    int            : printf_i(x, y),    \
    unsigned       : printf_ui(x, y),   \
    short          : printf_s(x, y),    \
    unsigned short : printf_us(x, y),   \
    char           : printf_c(x, y),    \
    unsigned char  : printf_uc(x, y),   \
    default        : printf_st(x))
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 393 "tpc-special.h"
#define printf_2(x, y)                  \
  _Generic((y),                         \
    _BFloat16      : printf_bf(x,y),    \
    float          : printf_f(x, y),    \
    int            : printf_i(x, y),    \
    unsigned       : printf_ui(x, y),   \
    short          : printf_s(x, y),    \
    unsigned short : printf_us(x, y),   \
    char           : printf_c(x, y),    \
    unsigned char  : printf_uc(x, y),   \
    default        : printf_st(x))
#else //dali
# 405 "tpc-special.h"
#define printf_2(x, y)                  \
  _Generic((y),                         \
    float          : printf_f(x, y),    \
    int            : printf_i(x, y),    \
    unsigned       : printf_ui(x, y),   \
    short          : printf_s(x, y),    \
    unsigned short : printf_us(x, y),   \
    char           : printf_c(x, y),    \
    unsigned char  : printf_uc(x, y),   \
    default        : printf_st(x))
#endif
# 416 "tpc-special.h"

#endif
# 418 "tpc-special.h"

//////////////////////////////////////////
// Tensor/program query functions
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 422 "tpc-special.h"
#define c_tensors_base                      0x400U
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 424 "tpc-special.h"
#define c_tensors_base                      0x0U
#endif
# 426 "tpc-special.h"

#define c_tensor_addr_pad_offset            0x8U
#define c_tensor_size_stride_arr_offset     0x10U
#define c_dim_stride_offset                 0x4U

#ifdef __goya__
#define c_tensor_desc_size                  0x4cU
#define c_tensor_size_stride_element_size   0xcU
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 435 "tpc-special.h"
#define c_tensor_desc_size                  0x38U
#define c_tensor_size_stride_element_size   0x8U
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__greco__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 438 "tpc-special.h"
#define c_tensor_desc_size 0x38U
#define c_tensor_size_stride_element_size 0x8U
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 441 "tpc-special.h"
#define c_tensor_desc_size 0x50U
#define c_tensor_size_stride_element_size 0x8U
#define c_tensor_addr_pref_stride_offset 0x038U
#else
# 445 "tpc-special.h"
#error "Undefined processor"
#endif
# 447 "tpc-special.h"

// Implementation of special functions are guarded by separate block. If a user
// defines 'TPC_SPECIAL_FUNCS_INCLUDED', he can use definitions of corresponding
// functions from any other header file included explicitly.
#ifndef TPC_SPECIAL_FUNCS_INCLUDED
#define TPC_SPECIAL_FUNCS_INCLUDED

////////////////////////////////// COMMON FP32 MACROS ////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 457 "tpc-special.h"
    #define v_f32_lookup_c0(a, f, t, i, p, o)   v_f32_lookup_1c(a, f, t, i, p, o)
    #define v_f32_lookup_c1c2(a, f, t, i, p, o)   v_f32_lookup_2c(a, f, t, i, p, o)
#endif
# 460 "tpc-special.h"

// LOOKUP_AND_MAC and CALC_REDUCED_VALUE are defined as macros due to their use
// of FUNC_ID and COEFF_TAB_SHIFT - constant integer values that needs to be
// known during compilation.
// LOOKUP_AND_MAC VPU ops = 4

#define LOOKUP_AND_MAC(INTERVALS, VALUE, RESULT)                               \
  {                                                                            \
    float64 C0 = v_f32_lookup_c0(INTERVALS, FUNC_ID, SW_BV32, 0, 1, 0);        \
    float64_pair_t C1C2;                                                       \
    C1C2 = v_f32_lookup_c1c2(INTERVALS, FUNC_ID, SW_BV32,                      \
                             (float64_pair_t){0}, 1, 0);                       \
                                                                               \
    RESULT = C1C2.v1;                                                          \
    RESULT = v_f32_mac_b(C1C2.v2, VALUE, RESULT, (false) << 1, 1, 0);          \
    C0 = v_f32_mac_b(RESULT, VALUE, C0, (false) << 1, 1, 0);                   \
    RESULT = C0;                                                               \
  }

// CALC_REDUCED_VALUE VPU ops = LOOKUP_AND_MAC VPU ops + 2 = 6
#define CALC_REDUCED_VALUE(INPUT_VAL, FUNC_VARIANT, RESULT)                                 \
{                                                                                           \
    uint64_float64_pair_t all_coeffs_tab;                                                   \
    all_coeffs_tab = v_f32_get_lut_entry_and_interval_start_b(INPUT_VAL, \
                                                              COEFF_TAB_SHIFT, (\
                                                              FUNC_VARIANT) << 13, (uint64_float64_pair_t){0}, 1, 0);                \
    uint64 intervals = all_coeffs_tab.v1;                                                   \
    float64 value = INPUT_VAL - all_coeffs_tab.v2;                                          \
    LOOKUP_AND_MAC(intervals, value, RESULT)                                                \
}

#define UNIT_VAL            0x3f800000
#define SIGNIFICAND_MASK    0x007fffff
#define EXPONENT_MASK       0x7f800000
#define NAN_FP32            0x7fffffff
#define PLUS_INF_FP32       0x7f800000
#define MINUS_INF_FP32      0xff800000
#define EXP_LOWER           0xc2aeac50
#define EXP_UPPER           0x42b17218
#define FLT_MIN             0x800000
#define FLT_MAX             0x7f7fffff
#define M_UNIT_EXP          0xc0800000

//////////////////////////////////////// EXP_F32 //////////////////////////////////////////////////
float64 v_exp_fast_f32(float64 input)
{
#define COEFF_TAB_SHIFT   17             // 23 - (m = 6)
    const int FUNC_ID = e_fp32_pow2;

    const float ln_2_1 =  0.693359375;
    const float ln_2_2 = -2.12194440e-4;
    const float log2_e =  1.44269502;

    float64 result = 0.5;
    result = v_f32_mac_b(input, log2_e, result, (false) << 1, 1, 0);

    int64 floor = v_convert_f32_to_i32_b(result, SW_RHNE, 0, 1, 0);
    result = v_convert_i32_to_f32_b(floor, SW_RHNE, 0, 1, 0);

    float64 x_reduced = input;
    x_reduced = v_f32_mac_b(result, ln_2_1, x_reduced, (true) << 1, 1, 0);
    x_reduced = v_f32_mac_b(result, ln_2_2, x_reduced, (true) << 1, 1, 0);
    x_reduced *= log2_e;

    bool256 x_red_geq_0 = from_bool64(v_f32_cmp_geq_b(x_reduced, 0.0f, 0, to_bool64((bool256){0}), 1, 0));
    int64 exponent = 0;
    exponent = v_f32_extract_exp_vb(x_reduced, false, exponent, to_bool64(x_red_geq_0), 0);
    exponent = v_i32_min_vb(-exponent, 24, 0, exponent, to_bool64(x_red_geq_0), 0);

    int64 pos_significand = 0;
    pos_significand = v_i32_and_vb(*((int64*)&x_reduced), SIGNIFICAND_MASK, 0, pos_significand, to_bool64(x_red_geq_0), 0);
    pos_significand = v_i32_or_vb(pos_significand, 1 << 23, 0, pos_significand, to_bool64(x_red_geq_0), 0);
    pos_significand = v_i32_shr_vb(pos_significand, exponent, 0, pos_significand, to_bool64(x_red_geq_0), 0);
    pos_significand = v_i32_or_vb(pos_significand, UNIT_VAL, 0, pos_significand, to_bool64(x_red_geq_0), 0);
    result = *((float64*)&pos_significand);

    result = v_f32_add_vb(x_reduced, 2.0f, 0, result, to_bool64(x_red_geq_0), 1);
    int64 neg_significand = 0;
    neg_significand = v_i32_and_vb(*((int64*)&result), SIGNIFICAND_MASK, 0, neg_significand, to_bool64(x_red_geq_0), 1);
    uint64 neg_add = 0;
    neg_add = v_u32_sel_eq_i32_vb(neg_significand, 0, 0, 1, 0, neg_add, to_bool64(x_red_geq_0), 1);

    CALC_REDUCED_VALUE(result, e_func_variant_default, result)

    exponent = v_f32_extract_exp_b(result, true, 0, 1, 0);
    exponent += floor - neg_add;
    result = v_f32_form_fp_num_ie_b((char256) exponent, result, result, SW_EXP_IS_NUM, 0, 1, 0);

    return result;
#undef COEFF_TAB_SHIFT
}

// exp_f32 VPU ops = exp_fast_f32 VPU ops + 3 = 26+3 = 29
float64 v_exp_f32(float64 input)
{

    float64 result = v_exp_fast_f32(input);

// ====================================
//  Processing special values: spec.exp values, +-inf, nan

    const int64 exp_lower = EXP_LOWER;
    const int64 exp_upper = EXP_UPPER;
    const int64 plus_inf  = PLUS_INF_FP32;

    result = v_f32_sel_leq_f32_b(input, *((float64*)&exp_lower), 0.0f, result, 0, 0, 1, 0);
    result = v_f32_sel_geq_f32_b(input, *((float64*)&exp_upper), *((float64*)&plus_inf), result, 0, 0, 1, 0);
    result = v_f32_sel_grt_u32_b(*((uint64*)&input) & NAN_FP32, PLUS_INF_FP32, input, result, 0, 0, 1, 0);
// ====================================
    return result;
}

/////////////////////////////////////// RECIP_F32 /////////////////////////////////////////////////

float64 v_reciprocal_fast_f32(float64 input)
{
  #define COEFF_TAB_SHIFT   16             // 23 - (m = 7)
    const int FUNC_ID = e_fp32_rcp;

    const char zero_exp = 0;
    float64 result = v_f32_form_fp_num_ie_b(zero_exp, input, input, SW_ADD_BIAS | SW_FORCE_SIGN0 | SW_EXP_IS_NUM, 0, 1, 0);
    CALC_REDUCED_VALUE(result, e_func_variant_default, result)

    int64 res_exp = (*((int64*)&result) & EXPONENT_MASK) - (*((int64*)&input) & EXPONENT_MASK);
    result = v_f32_form_fp_num_b(*((float64*)&res_exp), input, result, SW_ADD_BIAS, 0, 1, 0);

    float64 signed_zero = v_f32_sel_less_f32_b(input, 0.0f, -0.0f, 0.0f, 0, 0, 1, 0);
    result = v_f32_sel_leq_i32_b(res_exp, M_UNIT_EXP, signed_zero, result, 0, 0, 1, 0);

    return result;
#undef COEFF_TAB_SHIFT
}

float64 v_reciprocal_f32(float64 input)
{
    float64 result = v_reciprocal_fast_f32(input);

// ====================================
//  Processing special values: denorm, +-0. +-inf, nan
    float64 abs_x = v_f32_abs_b(input, 0, 0, 1, 0);
    float64 abs_result = v_f32_abs_b(result, 0, 0, 1, 0);
    const uint64 flt_min = FLT_MIN;
    const float64 flt_min_fp32 = *((float64*)&flt_min);
    const uint64 flt_max = FLT_MAX;
    const float64 flt_max_fp32 = *((float64*)&flt_max);
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    abs_result = v_f32_sel_less_f32_b(abs_x, flt_min_fp32, plus_inf_fp32, abs_result, 0, 0, 1, 0);
    abs_result = v_f32_sel_grt_f32_b(abs_x, flt_max_fp32, 0.0f, abs_result, 0, 0, 1, 0);

    abs_result = v_f32_sel_grt_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, abs_result, 0, 0, 1, 0);
    result = v_f32_form_fp_num_b(abs_result, input, abs_result, 0x0, 0, 1, 0);
// ====================================

    return result;
}

//////////////////////////// COMMON SQRT_F32 / RSQRT_F32/ /////////////////////////////////////
// BASE_SQRT_FUNC VPU Ops = CALC_REDUCED_VALUE + 3 = 6+3=9
#define BASE_SQRT_FUNC(INPUT_VAL, EXPONENT, RESULT)                                             \
{                                                                                               \
    EXPONENT = v_f32_extract_exp_b(INPUT_VAL, false, 0, 1, 0);                                           \
    RESULT = v_f32_form_fp_num_ie_b((char256) (EXPONENT&1), INPUT_VAL, INPUT_VAL, SW_EXP_IS_NUM|SW_ADD_BIAS, 0, 1, 0);    \
    CALC_REDUCED_VALUE(RESULT, e_func_variant_sqrt_rsqrt, RESULT)                               \
    EXPONENT -= v_i32_sel_less_i32_b(EXPONENT, 0, EXPONENT&1, 0, 0, 0, 1, 0);                         \
}



//////////////////////////////////////// SQRT_F32 /////////////////////////////////////////////////
float64 v_sqrt_fast_f32(float64 input)
{
#define COEFF_TAB_SHIFT   17                // 23 - (m = 6)
    const int FUNC_ID = e_fp32_sqrt;
    int64 exponent;
    float64 result;
    BASE_SQRT_FUNC(input, exponent, result)

    exponent = *((int64*)&result) + ((exponent >> 1) << 23);
    result = *((float64*)&exponent);
    result = v_f32_sel_eq_f32_b(input, 0.0f, 0.0f, result, 0, 0, 1, 0);
    return result;
#undef COEFF_TAB_SHIFT
}

float64 v_sqrt_f32(float64 input)
{
    float64 result = v_sqrt_fast_f32(input);

// ====================================
//  Processing special values: <0. +inf, nan
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, plus_inf_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_grt_u32_b(*((uint64*)&input), PLUS_INF_FP32, nan_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_f32_b(input, -0.0f, -0.0f, result, 0, 0, 1, 0);
// ====================================

    return result;
}

//////////////////////////////////////// RSQRT_F32 /////////////////////////////////////////////////
float64 v_rsqrt_fast_f32(float64 input)
{
#define COEFF_TAB_SHIFT   16             // 23 - (m = 7)
    const int FUNC_ID = e_fp32_rsqrt;
    int64 exponent;
    float64 result;
    BASE_SQRT_FUNC(input, exponent, result)

    exponent = *((int64*)&result) - ((exponent >> 1) << 23);
    result = *((float64*)&exponent);
    return result;
#undef COEFF_TAB_SHIFT
}

float64 v_rsqrt_f32(float64 input)
{
    float64 result = v_rsqrt_fast_f32(input);

// ====================================
//  Processing special values: <=0. +inf, nan
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);

    const uint64 minus_inf = MINUS_INF_FP32;
    const float64 minus_inf_fp32 = *((float64*)&minus_inf);

    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_eq_f32_b(input, 0.0f, plus_inf_fp32, result, 0, 0, 1, 0);
    //result = v_f32_sel_less_f32_b(input, 0.0f, nan_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, 0.0f, result, 0, 0, 1, 0);
    result = v_f32_sel_grt_u32_b(*((uint64*)&input), PLUS_INF_FP32, nan_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_f32_b(input, -0.0f, minus_inf_fp32, result, 0, 0, 1, 0);
// ====================================

    return result;
}

//////////////////////////////////////// LOG_F32 GAUDI ///////////////////////////////////////////

/*
float64 log_f32(float64 input)
{//  log32_Gaudi
    const float ln_2 = 0.69314718056;      // 0x3f317218
    int64 exponent = v_f32_extract_exp_b(input, false, 0, 1, 0);
    float64 fl_exponent = v_convert_i32_to_f32_b(exponent, SW_RHNE, 0, 1, 0) ;
    const char zero_exp = 0;
    float64 result = v_f32_form_fp_num_ie_b(zero_exp, input, input, SW_EXP_IS_NUM|SW_ADD_BIAS, 0, 1, 0);
    bool256 zero_exp_pred = from_bool64(v_i32_cmp_eq_b(exponent, 0, 0, to_bool64((bool256){0}), 1, 0));
    float64 tmp_result = result;

    const int COEFF_TAB_SHIFT = 16;             // 23 - (m = 7)
    const int FUNC_ID = e_fp32_log2;

    uint64_float64_pair_t all_coeffs_tab;
    all_coeffs_tab = v_f32_get_lut_entry_and_interval_start_b(result, COEFF_TAB_SHIFT, (e_func_variant_default) << 13, (uint64_float64_pair_t){0}, 1, 0);

    uint64 intervals = all_coeffs_tab.v1;
    intervals = v_u32_add_vb(intervals, 128, 0, intervals, to_bool64(zero_exp_pred), 1);
    float64 value = result - all_coeffs_tab.v2;
    LOOKUP_AND_MAC(intervals, value, result)

    float64 res_minus_one = tmp_result - 1.0f;
    result = v_f32_mul_vb(res_minus_one, result, 0, result, to_bool64(zero_exp_pred), 0);

    result += fl_exponent;
    result *= ln_2;

// ====================================
//  Processing special values: <=0, +-inf, nan
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64 minus_inf = MINUS_INF_FP32;
    const float64 minus_inf_fp32 = *((float64*)&minus_inf);
    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_less_f32_b(input, 0.0f, nan_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_f32_b(input, 0.0f, minus_inf_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, plus_inf_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_grt_i32_b(*((int64*)&input), PLUS_INF_FP32, nan_fp32, result, 0, 0, 1, 0);
// ====================================

    return result;
} //  log_f32_Gaudi
*/
//////////////////////////////////////// LOG_F32 CEPHES///////////////////////////////////////////
float64 v_log_fast_f32(float64 input)
{
    //  log32_cephes: log(1+x) = x - 0.5 x**2 + x**3 P(x)
    const float log2_e_m_1 = 0.44269504088896340735992; // log2(e) - 1.0
    const float ln_2 = 0.69314718056;                   // ln(2)        (0x3f317218)
    const float one_sqrt_2 = 0.70710677;                // 1/sqrt(2)    (0x3f3504f3)
#define poly_tab_size 9
    const float coeffs[poly_tab_size] = {
        7.0376836292E-2,
        -1.1514610310E-1,
        1.1676998740E-1,
        -1.2420140846E-1,
        1.4249322787E-1,
        -1.6668057665E-1,
        2.0000714765E-1,
        -2.4999993993E-1,
        3.3333331174E-1};

    int64 exponent = v_f32_extract_exp_b(input, false, 0, 1, 0) + 1;
    const char exp_126 = 126;
    float64 fraction = v_f32_form_fp_num_ie_b(exp_126, input, input, SW_EXP_IS_NUM, 0, 1, 0);
    float64 fl_exponent = v_convert_i32_to_f32_b(exponent, SW_RHNE, 0, 1, 0) ;

    float64 diff = fraction - one_sqrt_2;
    int64 diff_sign = v_i32_shr_b((*(int64 *) &diff), 31, 0, 0, 1, 0);
    exponent -= diff_sign;
    fl_exponent = v_convert_i32_to_f32_b(exponent, SW_RHNE, 0, 1, 0);
    float64 fl_diff_sign = v_convert_i32_to_f32_b(diff_sign, SW_RHNE, 0, 1, 0);
    fraction += fl_diff_sign * fraction - 1.0f;

    float64 x_sqr = fraction * fraction;
    float64 poly = coeffs[0];
    for (int i = 1; i < poly_tab_size; i++)
        poly = v_f32_mac_b(poly, fraction, coeffs[i], (false) << 1, 1, 0);

    float64 tailor = fraction * (x_sqr * poly);
    tailor -= 0.5 * x_sqr;

    float64 result = tailor * log2_e_m_1;
    result += fraction * log2_e_m_1;
    result += tailor;
    result += fraction;

    result += fl_exponent;
    result *= ln_2;

    return result;
#undef poly_tab_size
}

float64 v_log_f32(float64 input)
{
    float64 result = v_log_fast_f32(input);
// ====================================
//  Processing special values: <=0, +-inf, nan
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64 minus_inf = MINUS_INF_FP32;
    const float64 minus_inf_fp32 = *((float64*)&minus_inf);
    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_less_f32_b(input, 0.0f, nan_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_f32_b(input, 0.0f, minus_inf_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, plus_inf_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_grt_i32_b(*((int64*)&input), PLUS_INF_FP32, nan_fp32, result, 0, 0, 1, 0);
// ====================================

    return result;
} // log_f32_cephes

//   Special log values:
//     x < 0.0 -> return nan
//     x = -inf -> return nan
//   x = -0.0 -> return nan
//   x = 0.0 -> return -inf
//   x = +inf -> return +inf
//     x = nan -> return nan

////////////////////////////////// COMMON SIN_COS_F32 //////////////////////////////////////
// 23 + 4 = 27
#define SIN_COS_CALC(SIN_X_COND)                                               \
  const float four_by_pi = 1.27323949;  /* 4/pi = 0x3fa2f983 */                \
  const float pi4_1 = 7.85156250e-01;   /* pi/4 = 0x3f490000 */                \
  const float pi4_2 = 2.41875648498e-4; /* 0x397da000 */                       \
  const float pi4_3 = 3.7748949774e-8;  /* 0x3fa2f983*/                        \
                                                                               \
  float64 abs_x = v_f32_abs_b(input, 0, 0, 1, 0);                              \
  float64 fl_pi4_shift = abs_x * four_by_pi;                                   \
  int64 pi4_shift =                                                            \
      v_convert_f32_to_i32_b(fl_pi4_shift, SW_RD, 0, 1, 0);     \
  pi4_shift += pi4_shift & 1; /* Shift x in [-pi/4, +pi/4] */                  \
  fl_pi4_shift =                                                               \
      v_convert_i32_to_f32_b(pi4_shift, SW_RHNE, 0, 1, 0);                     \
  float64 reduced_x = abs_x;                                                   \
  reduced_x = v_f32_mac_b(fl_pi4_shift, pi4_1, reduced_x, (true) << 1, 1, 0);  \
  reduced_x = v_f32_mac_b(fl_pi4_shift, pi4_2, reduced_x, (true) << 1, 1, 0);  \
  reduced_x = v_f32_mac_b(fl_pi4_shift, pi4_3, reduced_x, (true) << 1, 1, 0);  \
  float64 abs_reduced_x = v_f32_abs_b(reduced_x, 0, 0, 1, 0);                  \
                                                                               \
  int64 pi2_shift =                                                            \
      (pi4_shift >> 1) & 3; /* remove shift by 2*pi: x in [0, 2*pi) */         \
  float64 fl_sign_shift =                                                      \
      v_convert_i32_to_f32_b(pi2_shift & 2, SW_RHNE, 0, 1, 0);                 \
  sign_res -= fl_sign_shift *                                                  \
              sign_res;       /* x>pi? -> shift by pi: cos(pi-x) = -cos(x) */  \
  pi2_shift -= pi2_shift & 2; /* remove shift by pi -> pi2_shift in [0, 1] */  \
                                                                               \
  const int COEFF_TAB_SHIFT = 17; /* 23 - (m = 6) */                           \
  const int FUNC_ID = e_fp32_sin_cos;                                          \
                                                                               \
  bool256 sin_x = from_bool64(v_i32_cmp_eq_b(pi2_shift, SIN_X_COND, 0,         \
                                             to_bool64((bool256){0}), 1, 0));  \
  uint64_float64_pair_t all_coeffs_tab;                                        \
  all_coeffs_tab = v_f32_get_lut_entry_and_interval_start_b(                   \
      abs_reduced_x, COEFF_TAB_SHIFT, (e_func_variant_sin_cos) << 13,          \
      (uint64_float64_pair_t){0}, 1, 0);                                       \
  uint64 intervals = all_coeffs_tab.v1;                                        \
  intervals = v_u32_add_vb(intervals, 64, 0, intervals,          \
                           to_bool64(sin_x), 1);                               \
  float64 value = abs_reduced_x - all_coeffs_tab.v2;                           \
  float64 result;                                                              \
  LOOKUP_AND_MAC(intervals, value, result)                                     \
                                                                               \
  result = v_f32_mul_vb(abs_reduced_x, result, 0, result, to_bool64(sin_x), 0);

#define PROCESS_SIN_COS_SPECIAL_VALUES                                         \
  const uint64 nan_int = NAN_FP32;                                             \
  const float64 nan_fp32 = *((float64 *)&nan_int);                             \
  const float sin_max_arg = s_convert_i32_to_f32(                              \
                  0xffffff, SW_RHNE, 0, 1, 0),                                 \
              sin_accuracy_limit = s_convert_i32_to_f32(                       \
                  0x2000, SW_RHNE, 0, 1, 0);                                   \
                                                                               \
  result = v_f32_sel_grt_f32_b(abs_x, sin_accuracy_limit, 0.0f, result, 0, 0,  \
                               1, 0);                                          \
  result =                                                                     \
      v_f32_sel_grt_f32_b(abs_x, sin_max_arg, nan_fp32, result, 0, 0, 1, 0);   \
  result = v_f32_sel_geq_u32_b(*((uint64 *)&abs_x), PLUS_INF_FP32, nan_fp32,   \
                               result, 0, 0, 1, 0);

//   Special sin/cos values:
// x = -inf -> return nan
// x -= -0.0 -> return +1.0
// x = +0.0 -> return +1.0
// x = +inf -> return nan
// x = nan -> return nan
// x > sin_max_arg (= 1 << 24 - 1) -> return nan
// x > sin_accuracy_limit (= 1 << 13) -> return 0.0f

//////////////////////////////////////// COS_F32 /////////////////////////////////////////////////
float64 v_cos_fast_f32(float64 input)
{
    float64 sign_res = 1.0f;
    SIN_COS_CALC(1)

    sign_res = v_f32_sel_grt_f32_vb(reduced_x, 0.0f, -sign_res, sign_res, 0, sign_res, to_bool64(sin_x), 0);
    result = v_f32_sel_less_f32_b(sign_res, 0.0f, -result, result, 0, 0, 1, 0);

    return result;
}

float64 v_cos_f32(float64 input)
{
    float64 abs_x = v_f32_abs_b(input, 0, 0, 1, 0);
    float64 result = v_cos_fast_f32(input);
// ====================================
//  Processing special values: +-inf, nan, sin/cos limits

    PROCESS_SIN_COS_SPECIAL_VALUES
// ====================================

    return result;
}

//////////////////////////////////////// SIN_F32 /////////////////////////////////////////////////
float64 v_sin_fast_f32(float64 input)
{
    float64 sign_res = v_f32_sel_grt_f32_b(input, 0.0f, 1.0f, -1.0f, 0, 0, 1, 0);
    SIN_COS_CALC(0)

    sign_res = v_f32_sel_less_f32_vb(reduced_x, 0.0f, -sign_res, sign_res, 0, sign_res, to_bool64(sin_x), 0);
    result = v_f32_sel_less_f32_b(sign_res, 0.0f, -result, result, 0, 0, 1, 0);
    return result;
}

float64 v_sin_f32(float64 input)
{
    float64 abs_x = v_f32_abs_b(input, 0, 0, 1, 0);
    float64 result = v_sin_fast_f32(input);
// ====================================
//  Processing special values: +-inf, nan, sin/cos limits

    PROCESS_SIN_COS_SPECIAL_VALUES
// ====================================

   return result;
}

//////////////////////////////////////// DIV_F32 /////////////////////////////////////////////////
float64 v_div_fast_f32(float64 input_x, float64 input_y)
{
    float64 result = input_x * v_reciprocal_fast_f32(input_y);

    return result;
}

float64 v_div_f32(float64 input_x, float64 input_y)
{
    float64    result = input_x * v_reciprocal_f32(input_y);

// ====================================
//  Processing special values: 0, +-inf, nan
    const uint64 flt_min = FLT_MIN;
    const float64 flt_min_fp32 = *((float64*)&flt_min);
    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);

    float64 abs_x = v_f32_abs_b(input_x, 0, 0, 1, 0);                                                           // 15
    float64 abs_y = v_f32_abs_b(input_y, 0, 0, 1, 0);                                                           // 16

// x == nan?
    result = v_f32_sel_grt_f32_b(abs_x, plus_inf_fp32, nan_fp32, result, 0, 0, 1, 0);                     // 17

// sign_x ^ sign_y; (sign_x ^ sign_y) | plus_inf
    int64 sign_res = (((*((int64*)&input_x)) >> 31 ) ^ ((*((int64*)&input_y)) >> 31 )) << 31;       // 18, 19, 20, 21
    const float64 sign_res_fp32 = *((float64*)&sign_res);

//x ==    +-inf?
    float64 inf_x_y = v_f32_or_b(sign_res_fp32 , plus_inf_fp32, 0, 0, 1, 0);                                   // 22
    bool256 inf_x = from_bool64(v_f32_cmp_eq_b(abs_x, plus_inf_fp32, 0, to_bool64((bool256){0}), 1, 0));                                        // 23
    result = v_f32_sel_eq_f32_vb(abs_y, plus_inf_fp32, nan_fp32, inf_x_y, 0, result, to_bool64(inf_x), 0);// 24

//x == +-0?
    bool256 zero_x = from_bool64(v_f32_cmp_less_b(abs_x, flt_min_fp32, 0, to_bool64((bool256){0}), 1, 0));                                      // 25
    result = v_f32_sel_less_f32_vb(abs_y, flt_min_fp32, nan_fp32, sign_res_fp32, 0, result, to_bool64(zero_x), 0);// 26
// ====================================

    return result;
}

// Simlified scalar division (x / y) Markstein's algorithm, very efficient in case of y is actually
// integer values. It assumes that rc (reciprocal of y) comes from outside
float s_div_fast_f32(float x, float y, float rc)
{
    float q = x * rc;

    // Lines below should be called if x isn't +INF or -INF. For simlicity corresponding cheking is missed
    x = s_f32_mac(y, q, x, SW_NEG, 1, 0);
    q = s_f32_mac(x, rc, q, SW_NO_NEG, 1, 0);

    return q;
}

//////////////////////////////////////// TANH_F32 /////////////////////////////////////////////////

float64 v_tanh_fast_abs_in_f32(float64 input, float64 abs_x)
{
#define COEFF_TAB_SHIFT   17 // 23 - (m = 6);
    const int FUNC_ID = e_fp32_tanh;

    int64 exponent = v_f32_extract_exp_b(input, false, 0, 1, 0);                                             // 1
    bool256 neg_exp = from_bool64(v_i32_cmp_less_b(exponent, 0, 0, to_bool64((bool256){0}), 1, 0));                                             // 2

    float64 result;
    CALC_REDUCED_VALUE(abs_x, e_func_variant_tanh, result)                                          // 3, 4, 5
                                                                                                    // 6, 7, 8
    result = v_f32_mul_vb(result, abs_x, 0, result, to_bool64(neg_exp), 0);                                   // 9

    bool256 greq_8 = from_bool64(v_f32_cmp_geq_b(abs_x, 8.0f, 0, to_bool64((bool256){0}), 1, 0));                                               // 10
    result = v_f32_sel_less_f32_vb(abs_x, 9.0f, 0.999999881f, result, 0, result, to_bool64(greq_8), 0);   // 11
    result = v_f32_sel_geq_f32_b(abs_x, 9.0f, 1.0f, result, 0, 0, 1, 0);                                  // 12

    result = v_f32_form_fp_num_b(result, input, result, 0x0, 0, 1, 0);                                   // 13
    return result;
#undef COEFF_TAB_SHIFT
}

float64 v_tanh_fast_f32(float64 input)
{
    float64 abs_x = v_f32_abs_b(input, 0, 0, 1, 0);                                                             // 1
    float64 result = v_tanh_fast_abs_in_f32(input, abs_x);                                            // 14

    return result;
}

float64 v_tanh_f32(float64 input)
{
    float64 abs_x = v_f32_abs_b(input, 0, 0, 1, 0);                                                             // 1
    float64 result = v_tanh_fast_abs_in_f32(input, abs_x);                                            // 15
// ====================================
//  Processing special values: nan
    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_grt_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, result, 0, 0, 1, 0);        // 16
// ====================================

    return result;
}

//////////////////////////////////////// POW2_F32 //////////////////////////////////////////////////

float64 v_pow2_fast_f32(float64 input)
{
  #define COEFF_TAB_SHIFT   17             // 23 - (m = 6);
    const int FUNC_ID = e_fp32_pow2;

    const float log2_1 =  0.0f;
    const float log2_2 =  1.0f;

    float64 result = 0.5f;
    result = v_f32_mac_b(input, log2_2, result, (false) << 1, 1, 0);

    int64 floor = v_convert_f32_to_i32_b(result, SW_RD, 0, 1, 0);
    result = v_convert_i32_to_f32_b(floor, SW_RHNE, 0, 1, 0);

    float64 x_reduced = input;
    x_reduced = v_f32_mac_b(result, log2_2, x_reduced, (true) << 1, 1, 0);
    x_reduced = v_f32_mac_b(result, log2_1, x_reduced, (true) << 1, 1, 0);
    x_reduced *= log2_2;

    bool256 x_red_geq_0 = from_bool64(v_f32_cmp_geq_b(x_reduced, 0.0f, 0, to_bool64((bool256){0}), 1, 0));
    int64 exponent = 0;
    exponent = v_f32_extract_exp_vb(x_reduced, false, exponent, to_bool64(x_red_geq_0), 0);
    exponent = v_i32_min_vb(-exponent, 24, 0, exponent, to_bool64(x_red_geq_0), 0);

    int64 pos_significand = 0;
    pos_significand = v_i32_and_vb(*((int64*)&x_reduced), SIGNIFICAND_MASK, 0, pos_significand, to_bool64(x_red_geq_0), 0);
    pos_significand = v_i32_or_vb(pos_significand, 1 << 23, 0, pos_significand, to_bool64(x_red_geq_0), 0);
    pos_significand = v_i32_shr_vb(pos_significand, exponent, 0, pos_significand, to_bool64(x_red_geq_0), 0);
    pos_significand = v_i32_or_vb(pos_significand, UNIT_VAL, 0, pos_significand, to_bool64(x_red_geq_0), 0);
    result = *((float64*)&pos_significand);

    result = v_f32_add_vb(x_reduced, 2.0f, 0, result, to_bool64(x_red_geq_0), 1);
    int64 neg_significand = 0;
    neg_significand = v_i32_and_vb(*((int64*)&result), SIGNIFICAND_MASK, 0, neg_significand, to_bool64(x_red_geq_0), 1);
    uint64 neg_add = 0;
    neg_add = v_u32_sel_eq_i32_vb(neg_significand, 0, 0, 1, 0, neg_add, to_bool64(x_red_geq_0), 1);

    CALC_REDUCED_VALUE(result, e_func_variant_default, result)

    exponent = v_f32_extract_exp_b(result, true, 0, 1, 0);
    exponent += floor - neg_add;
    result = v_f32_form_fp_num_ie_b((char256) exponent, result, result, SW_EXP_IS_NUM, 0, 1, 0);         // 27
    return result;
#undef COEFF_TAB_SHIFT
}

float64 v_pow2_f32(float64 input)
{
    float64 result = v_pow2_fast_f32(input);
// ====================================
//  Processing special values: spec.exp values, +-inf, nan

    const uint64 flt_max = FLT_MAX;
    const float64 flt_max_fp32 = *((float64*)&flt_max);
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);

    const float64 pow2_lower = -126.0f;
    const float64 pow2_upper = 128.0f;

    result = v_f32_sel_less_f32_b(input, pow2_lower, 0.0f, result, 0, 0, 1, 0);
    result = v_f32_sel_geq_f32_b(input, pow2_upper, plus_inf_fp32, result, 0, 0, 1, 0);

    result = v_f32_sel_less_f32_b(input, -flt_max_fp32, 0.0f, result, 0, 0, 1, 0);
    result = v_f32_sel_geq_f32_b(input, flt_max_fp32, plus_inf_fp32, result, 0, 0, 1, 0);

    result = v_f32_sel_grt_u32_b(*((uint64*)&input) & NAN_FP32, PLUS_INF_FP32, input, result, 0, 0, 1, 0);
// ====================================

    return result;
}

//////////////////////////////////////// LOG2_F32 CEPHES///////////////////////////////////////////
float64 v_log2_fast_f32(float64 input)
{
    //  log32_cephes: log(1+x) = x - 0.5 x**2 + x**3 P(x)
    const float log2_e_m_1 = 0.44269504088896340735992; // log2(e) - 1.0
    const float one_sqrt_2 = 0.70710677;         // 1/sqrt(2)    (0x3f3504f3)
#define poly_tab_size 9
    const float coeffs[poly_tab_size] = {
        7.0376836292E-2,
        -1.1514610310E-1,
        1.1676998740E-1,
        -1.2420140846E-1,
        1.4249322787E-1,
        -1.6668057665E-1,
        2.0000714765E-1,
        -2.4999993993E-1,
        3.3333331174E-1};

    int64 exponent = v_f32_extract_exp_b(input, false, 0, 1, 0) + 1;
    const char exp_126 = 126;
    float64 fraction = v_f32_form_fp_num_ie_b(exp_126, input, input, SW_EXP_IS_NUM, 0, 1, 0);            // 2
    float64 fl_exponent = v_convert_i32_to_f32_b(exponent, SW_RHNE, 0, 1, 0) ;                       // 3

    float64 diff = fraction - one_sqrt_2;
    int64 diff_sign = v_i32_shr_b((*(int64 *) &diff), 31, 0, 0, 1, 0);
    exponent -= diff_sign;
    fl_exponent = v_convert_i32_to_f32_b(exponent, SW_RHNE, 0, 1, 0) ;
    float64 fl_diff_sign = v_convert_i32_to_f32_b(diff_sign, SW_RHNE, 0, 1, 0) ;
    fraction += fl_diff_sign * fraction - 1.0f;

    float64 x_sqr = fraction * fraction;
    float64 poly = coeffs[0];
    for (int i = 1; i < poly_tab_size; i++)
        poly = v_f32_mac_b(poly, fraction, coeffs[i], (false) << 1, 1, 0);

    float64 tailor = fraction * (x_sqr * poly);
    tailor -= 0.5 * x_sqr;

    float64 result = tailor * log2_e_m_1;
    result += fraction * log2_e_m_1;
    result += tailor;
    result += fraction;

    result += fl_exponent;

    return result;
#undef poly_tab_size
}

float64 v_log2_f32(float64 input)
{
    float64 result = v_log2_fast_f32(input);
// ====================================
//  Processing special values: <=0, +-inf, nan
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64 minus_inf = MINUS_INF_FP32;
    const float64 minus_inf_fp32 = *((float64*)&minus_inf);
    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_less_f32_b(input, 0.0f, nan_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_f32_b(input, 0.0f, minus_inf_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, plus_inf_fp32, result, 0, 0, 1, 0);
    result = v_f32_sel_grt_i32_b(*((int64*)&input), PLUS_INF_FP32, nan_fp32, result, 0, 0, 1, 0);
// ====================================

    return result;
}

//////////////////////////////////////// POW_F32 //////////////////////////////////////////////////
float64 v_pow_fast_f32(float64 base, float64 exp)
{
    int64 exp_floor = v_convert_f32_to_i32_b(exp, SW_RD, 0, 1, 0);
    float64 exp_floor_fl = v_convert_i32_to_f32_b(exp_floor, SW_RHNE, 0, 1, 0);

    // predicate mask of all exp elements that are whole numbers
    bool256 p0 = from_bool64(v_f32_cmp_eq_b(exp, exp_floor_fl, 0, to_bool64((bool256){0}), 1, 0));
    // apply abs on all exp elements that are whole numbers
    float64 base_b = v_f32_form_fp_num_vb(base, base, base, SW_FORCE_SIGN0, base, to_bool64(p0), 0);

    float64 base_log2 = v_log2_fast_f32(base_b);
    float64 power = v_f32_mul_b(exp, base_log2, 0, 0, 1, 0);
    float64 result = v_pow2_fast_f32(power);

    // predicate mask of all exp elements that are whole odd numbers
    bool256 p1 = 0;
    p1 = from_bool64(v_i32_cmp_eq_vb((exp_floor & 0x00000001), 0x00000001, 0, to_bool64(p1), to_bool64(p0), 0));
    // return -result if base < 0 and exp is a whole odd number.
    result = v_f32_sel_less_f32_vb(base, 0.0f, -result, result, 0, result, to_bool64(p1), 0);

    return result;
}

float64 v_pow_f32(float64 base, float64 exp)
{
    int64 exp_floor = v_convert_f32_to_i32_b(exp, SW_RD, 0, 1, 0);
    float64 exp_floor_fl = v_convert_i32_to_f32_b(exp_floor, SW_RHNE, 0, 1, 0);

    // predicate mask of all exp elements that are whole numbers
    bool256 p0 = from_bool64(v_f32_cmp_eq_b(exp, exp_floor_fl, 0, to_bool64((bool256){0}), 1, 0));
    // apply abs on all exp elements that are whole numbers
    float64 base_b = v_f32_abs_vb(base, 0, base, to_bool64(p0), 0);

    float64 base_log2 = v_log2_f32(base_b);
    float64 power = v_f32_mul_b(exp, base_log2, 0, 0, 1, 0);
    float64 result = v_pow2_f32(power);

    // predicate mask of all exp elements that are whole odd numbers
    bool256 p1 = 0;
    p1 = from_bool64(v_i32_cmp_eq_vb((exp_floor & 0x00000001), 0x00000001, 0, to_bool64(p1), to_bool64(p0), 0));
    // return -result if base < 0 and exp is a whole odd number.
    result = v_f32_sel_less_f32_vb(base, 0.0f, -result, result, 0, result, to_bool64(p1), 0);
    // if exp = 0
    result = v_f32_sel_eq_f32_b(exp, 0.0f, 1.0f, result, 0, 0, 1, 0);                                     // 63
    // if exp = 1
    result = v_f32_sel_eq_f32_b(exp, 1.0f, base, result, 0, 0, 1, 0);                                     // 64


    const uint64 flt_max = FLT_MAX;
    const float64 flt_max_fp32 = *((float64*)&flt_max);
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);

    float64 abs_base = v_f32_abs_b(base, 0, 0, 1, 0);                                                           // 65
    float64 abs_exp  = v_f32_abs_b(exp, 0, 0, 1, 0);                                                            // 66

    bool256 pred0 = from_bool64(v_f32_cmp_leq_b(exp, -flt_max_fp32, 0, to_bool64((bool256){0}), 1, 0));
    result = v_f32_sel_grt_f32_vb(abs_base, 1.0f, 0.0f, result, 0, result, to_bool64(pred0), 0);
    result = v_f32_sel_less_f32_vb(abs_base, 1.0f, plus_inf_fp32, result, 0, result, to_bool64(pred0), 0);

    bool256 pred1 = from_bool64(v_f32_cmp_geq_b(exp, flt_max_fp32, 0, to_bool64((bool256){0}), 1, 0));
    result = v_f32_sel_grt_f32_vb(abs_base, 1.0f, plus_inf_fp32, result, 0, result, to_bool64(pred1), 0);
    result = v_f32_sel_less_f32_vb(abs_base, 1.0f, 0.0f, result, 0, result, to_bool64(pred1), 0);

    bool256 pred2 = from_bool64(v_f32_cmp_less_b(base, -flt_max_fp32, 0, to_bool64((bool256){0}), 1, 0));
    result = v_f32_sel_grt_f32_vb(exp, 0.0f, plus_inf_fp32, result, 0, result, to_bool64(pred2), 0);
    result = v_f32_sel_less_f32_vb(exp, 0.0f, 0.0f, result, 0, result, to_bool64(pred2), 0);

    bool256 pred3 = from_bool64(v_f32_cmp_geq_b(base, flt_max_fp32, 0, to_bool64((bool256){0}), 1, 0));
    pred3 = from_bool64(v_f32_cmp_grt_vb(abs_exp, 1.0f, 0, to_bool64(pred3), to_bool64(pred3), 0));
    result = v_f32_sel_grt_f32_vb(exp, 0.0f, plus_inf_fp32, result, 0, result, to_bool64(pred3), 0);
    result = v_f32_sel_less_f32_vb(exp, 0.0f, 0.0f, result, 0, result, to_bool64(pred3), 0);

    return result;
}

//quantized versions of special function is available only on Goya
#ifdef __goya__
/////////////////////////////////////// RECIP_I16 /////////////////////////////////////////////////
inline short128 v_recip_i16(short128 x, short expX)
{
    short128 shift = expX;
    short128 x00_shr;
    short128 x00_and;
    short128_pair_t y00 = {0};

    bool256 bRangeReduced = {0};

    short fourFlex = 4 << (-expX);
    short fourFlexMinusOne = fourFlex - 1;

    short intervalShift     = -4 - expX;
    unsigned short intervalStartMask = (1 << intervalShift) - 1;

    // if (x >= fourFlex)  // 4 << (-expX)
    //     x = x >> 2;
    char cmp_pred = ((-expX) < 13 ); // if exp >=  13, we get overflow,
                                     // so need to avoid this situations
    bRangeReduced = from_bool128(v_i16_cmp_geq_b(x, fourFlex, 0, to_bool128(bRangeReduced), cmp_pred, 0));

    x = v_i16_ash_vb(x, -2, 1 << 1, x, to_bool128(bRangeReduced), 0);
    x = v_i16_min_vb(x, fourFlexMinusOne, 0, x, to_bool128(bRangeReduced), 0);

    x00_shr = v_i16_shr_b(x, intervalShift, 0, 0, 1, 0);
    x00_and = v_i16_and_b(x, intervalStartMask, 0, 0, 1, 0);

    y00 = v_i16_lookup_c1c2(*(ushort128 *)&x00_shr, e_i16_rcp, e_lookup_fp16_low, y00, 1, 0);
    y00 = v_i16_lookup_c1c2(*(ushort128 *)&x00_shr, e_i16_rcp, e_lookup_fp16_high, y00, 1, 0);
    y00.v1 = v_i16_msac_b(y00.v2, x00_and, (char256)shift, 0, SW_NORMALIZE_AB | (1 << 1), y00.v1, 1, 0);

    y00.v2 = v_i16_lookup_c0(*(ushort128 *)&x00_shr, e_i16_rcp, e_lookup_fp16_low, y00.v2, 1, 0);
    y00.v2 = v_i16_lookup_c0(*(ushort128 *)&x00_shr, e_i16_rcp, e_lookup_fp16_high, y00.v2, 1, 0);
    y00.v2 = v_i16_msac_b(y00.v1, x00_and, (char256)shift, 0, SW_NORMALIZE_AB | (1 << 1), y00.v2, 1, 0);

    y00.v2 = v_i16_ash_vb(y00.v2, -2, 1 << 1, y00.v2, to_bool128(bRangeReduced), 0);

    return y00.v2;
}
//////////////////////////////////////// TANH_I16 /////////////////////////////////////////////////
// Maximal input exponentX is expected to be (-12)
// Valid input range (-8,8)
// Output exponent -15
inline short128 v_tanh_i16(
    short128 input,
    short tanhIntervalShift, // -3 - exponentX
    short tanhIntervalStartMask, // (1 << tanhIntervalShift)-1
    char tanhMSAC0diffABToC, // exponentTanhC2 + exponentX - exponentTanhC1
    char tanhMSAC1diffABToC // exponentTanhC1 + exponentX - exponentTanhC0
    )
{
    short128 absX = v_i16_abs_b(input, 0, 0, 1, 0);
    short128 interval = v_i16_shr_b(absX, tanhIntervalShift, 0, 0, 1, 0);

    absX &= tanhIntervalStartMask;

    short128_pair_t lookupResC1C2 = {0};
    lookupResC1C2 = v_i16_lookup_c1c2(*(ushort128*)&interval, e_i16_tanh, e_lookup_fp16_low, lookupResC1C2, 1, 0);
    lookupResC1C2 = v_i16_lookup_c1c2(*(ushort128*)&interval, e_i16_tanh, e_lookup_fp16_high, lookupResC1C2, 1, 0);

    short128 C0 = 0;
    C0 = v_i16_lookup_c0(*(ushort128*)&interval, e_i16_tanh, e_lookup_fp16_low, C0, 1, 0);
    C0 = v_i16_lookup_c0(*(ushort128*)&interval, e_i16_tanh, e_lookup_fp16_high, C0, 1, 0);

    short128 C1 = lookupResC1C2.v1;
    short128 C2 = lookupResC1C2.v2;
    // MSACs come here
    char256 shiftABToC = tanhMSAC0diffABToC;
    C1 = v_i16_msac_b(C2, absX, shiftABToC, 0, SW_NORMALIZE_AB | (1 << 1), C1, 1, 0);
    shiftABToC = tanhMSAC1diffABToC;
    C0 = v_i16_msac_b(C1, absX, shiftABToC, 0, SW_NORMALIZE_AB | (1 << 1), C0, 0, 1);

    bool256 isNegative = from_bool128(v_i16_cmp_less_b(input, 0, 0, to_bool128((bool256){0}), 1, 0));

    short128 zerosVec = 0;

    // If the input was negative, subtract the result from zero, negating the result
    C0 = v_i16_sub_vb(zerosVec, C0, 0, C0, to_bool128(isNegative), 0);

    return C0;
}

//////////////////////////////////////// SIGMOID_I16 //////////////////////////////////////////////
// Maximal input exponentX is expected to be (-12)
// Valid input range (-8,8)
// output exponent -15
inline short128 v_sigmoid_i16(
    short128 input,
    short sigmoidIntervalShift,     // -3 - exponentX
    short sigmoidIntervalStartMask, // (1 << tanhIntervalShift)-1
    char sigmoidMSAC0diffABToC,     // exponentSigmoidC2 + exponentX - exponentSigmoidC1
    char sigmoidMSAC1diffABToC      // exponentSigmoidC1 + exponentX - exponentSigmoidC0)
    )
{
    short128 absX = v_i16_abs_b(input, 0, 0, 1, 0);
    short128 interval = v_i16_shr_b(absX, sigmoidIntervalShift, 0, 0, 1, 0);

    absX &= sigmoidIntervalStartMask;
    short128_pair_t lookupResC1C2 = {0};
    lookupResC1C2 = v_i16_lookup_c1c2(*(ushort128*)&interval, e_i16_sigmoid, e_lookup_fp16_low, lookupResC1C2, 1, 0);
    lookupResC1C2 = v_i16_lookup_c1c2(*(ushort128*)&interval, e_i16_sigmoid, e_lookup_fp16_high, lookupResC1C2, 1, 0);

    short128 C0 = 0;
    C0 = v_i16_lookup_c0(*(ushort128*)&interval, e_i16_sigmoid, e_lookup_fp16_low, C0, 1, 0);
    C0 = v_i16_lookup_c0(*(ushort128*)&interval, e_i16_sigmoid, e_lookup_fp16_high, C0, 1, 0);

    short128 C1 = lookupResC1C2.v1;
    short128 C2 = lookupResC1C2.v2;
    // MSACs come here
    char256 shiftABToC = sigmoidMSAC0diffABToC;
    C1 = v_i16_msac_b(C2, absX, shiftABToC, 0, SW_NORMALIZE_AB | (1 << 1), C1, 1, 0);
    shiftABToC = sigmoidMSAC1diffABToC;
    C0 = v_i16_msac_b(C1, absX, shiftABToC, 0, SW_NORMALIZE_AB | (1 << 1), C0, 0, 1);

    bool256 isNegative = from_bool128(v_i16_cmp_less_b(input, 0, 0, to_bool128((bool256){0}), 1, 0));

    ushort128 quantizedOnes = 32768;
    ushort128 ushortC0 = v_u16_sub_vb(quantizedOnes, *(ushort128*)&C0, 0, *(ushort128*)&C0, to_bool128(isNegative), 0);
    return *(short128 *)&ushortC0;
}

//////////////////////////////////////// EXP_I8 //////////////////////////////////////////////////
// Maximal Input exponentX is -4
// valid input range (-8,0)
// Result is in under quantization factor of -7. Range (0,1)
inline char256 v_exp_i8(char256 x, char shift)
{
    char256 x00_abs;
    char256 x00_shr;
    char256 x00_and;
    char256_pair_t y00 = {0};

    char intervalShift = -3 - shift;
    char intervalStartMask = ((1 << intervalShift) - 1);

    //char256 norm_shift = (-7 + shift) - (-7);
    char256 norm_shift = shift;

    x00_abs = v_i8_abs_b(x, 0, 0, 1, 0);
    x00_shr = v_i8_shr_b(x00_abs, intervalShift, 0, 0, 1, 0);
    x00_and = v_i8_and_b(x00_abs, intervalStartMask, 0, 0, 1, 0);

    y00 = v_i8_lookup_c1c2(*(uchar256 *)&x00_shr, 40, e_lookup_int8_0, y00, 1, 0);
    y00 = v_i8_lookup_c1c2(*(uchar256 *)&x00_shr, 40, e_lookup_int8_1, y00, 1, 0);
    y00 = v_i8_lookup_c1c2(*(uchar256 *)&x00_shr, 40, e_lookup_int8_2, y00, 1, 0);
    y00 = v_i8_lookup_c1c2(*(uchar256 *)&x00_shr, 40, e_lookup_int8_3, y00, 1, 0);

    y00.v1 = v_i8_msac_b(y00.v2, x00_and, norm_shift, 0, SW_NORMALIZE_AB | (1 << 1), y00.v1, 1, 0);

    return y00.v1;
}
//////////////////////////////////////// EXP_I16 //////////////////////////////////////////////////
// Maximal input exponentX is -11
// valid input range (-16,0)
// Result is in under quantization factor of -15. Range (0,1)
inline short128 v_exp_i16(short128 x, short shift)
{
    short128 x00_abs;
    short128 x00_shr;
    short128 x00_and;
    short128_pair_t y00 = {0};

    short intervalShift = -2 - shift;
    short intervalStartMask = ((1 << intervalShift) - 1);

    //qC2 = -16 , qC1 =  -15, qc0 = -15

    // Exponent normalization ( (-16 + -11) - (-15)) = 15-27 = -12
    short128 shift_lp = -1 + shift;

    // Exponent normalization ( (-15 + -11) - (-15)) = 15-26 = -11
    short128 shift_hp = shift;

    //(C2 * x + C1) * x  + C0
    x00_abs = v_i16_abs_b(x, 0, 0, 1, 0);
    x00_shr = v_i16_shr_b(x00_abs, intervalShift, 0, 0, 1, 0);
    x00_and = v_i16_and_b(x00_abs, intervalStartMask, 0, 0, 1, 0);

    y00 = v_i16_lookup_c1c2(*(ushort128 *)&x00_shr, e_i16_exp_nep, e_lookup_fp16_low, y00, 1, 0);
    y00 = v_i16_lookup_c1c2(*(ushort128 *)&x00_shr, e_i16_exp_nep, e_lookup_fp16_high, y00, 1, 0);

    y00.v1 = v_i16_msac_b(y00.v2, x00_and, (char256)shift_lp, 0, SW_NORMALIZE_AB | (1 << 1), y00.v1, 1, 0);

    y00.v2 = v_i16_lookup_c0(*(ushort128 *)&x00_shr, e_i16_exp_nep, e_lookup_fp16_low, y00.v2, 1, 0);
    y00.v2 = v_i16_lookup_c0(*(ushort128 *)&x00_shr, e_i16_exp_nep, e_lookup_fp16_high, y00.v2, 1, 0);

    y00.v2 = v_i16_msac_b(y00.v1, x00_and, (char256)shift_hp, 0, SW_NORMALIZE_AB | (1 << 1), y00.v2, 1, 0);

    return y00.v2;
}

#endif //#ifdef __goya__
# 1475 "tpc-special.h"
//////////////////////////////////////// rcp_I16 /////////////////////////////////////////////////
// Maximal input exponentX is expected to be (-11)
// Valid input range (1,16)
// output exponent -15

///////////////////////////////////// EXP_CEPHES_F32 //////////////////////////////////////////////
float64 v_exp_cephes_fast_f32(float64 input)
{
    const float ln_2_1 =  0.693359375;
    const float ln_2_2 = -2.12194440e-4;
    const float log2_e =  1.44269504088896341;
    const float c1 = 1.9875691500E-4;
    const float64 c2 = 1.3981999507E-3;
    const float64 c3 = 8.3334519073E-3;
    const float64 c4 = 4.1665795894E-2;
    const float64 c5 = 1.6666665459E-1;
    const float64 c6 = 5.0000001201E-1;

    float64 z = 0.5;
    z = v_f32_mac_b(input, log2_e, z, (false) << 1, 1, 0);

    z = v_f32_nearbyint_b(z, SW_RD, 0, 1, 0);

    float64 x_reduced = input;
    x_reduced = v_f32_mac_b(z, ln_2_1, x_reduced, (true) << 1, 1, 0);
    x_reduced = v_f32_mac_b(z, ln_2_2, x_reduced, (true) << 1, 1, 0);

    float64 sqr_x = v_f32_mul_b(x_reduced, x_reduced, 0, 0, 1, 0);
    float64 result;
    result = v_f32_mac_b(x_reduced , c1 , c2, (false) << 1, 1, 0);
    result = v_f32_mac_b(result, x_reduced, c3, (false) << 1, 1, 0);
    result = v_f32_mac_b(result, x_reduced, c4, (false) << 1, 1, 0);
    result = v_f32_mac_b(result, x_reduced, c5, (false) << 1, 1, 0);
    result = v_f32_mac_b(result, x_reduced, c6, (false) << 1, 1, 0);

    float64 x_plus1 = 1.0;
    x_plus1 = v_f32_add_b(x_reduced, x_plus1, 0, 0, 1, 0);

    result = v_f32_mac_b(result, sqr_x, x_plus1, (false) << 1, 1, 0);

    int64 res_i32 = *(int64*)&result;

    int64 z_i32 = v_convert_f32_to_i32_b(z, SW_RD, 0, 1, 0);
    z_i32 = v_i32_shl_b(z_i32, 23, 0, 0, 1, 0);
    res_i32 = v_i32_add_b(res_i32, z_i32, 0, 0, 1, 0);

    result = *(float64*)&res_i32;

    return result;
}

float64 v_exp_cephes_f32(float64 input)
{
    float64 result = v_exp_cephes_fast_f32(input);
// ====================================
//  Processing special values: spec.exp values, +-inf, nan

    const float64 exp_lower = -87.336;
    const float64 exp_upper =  88.722;
    const int64 plus_inf  = PLUS_INF_FP32;

    result = v_f32_sel_leq_f32_b(input, exp_lower, 0.0f, result, 0, 0, 1, 0);
    result = v_f32_sel_geq_f32_b(input, exp_upper, *((float64*)&plus_inf), result, 0, 0, 1, 0);
    result = v_f32_sel_grt_u32_b(*((uint64*)&input) & NAN_FP32, PLUS_INF_FP32, input, result, 0, 0, 1, 0);
// ====================================

    return result;
}

//////////////////////////////////////// SIGMOID_F32 //////////////////////////////////////////////
inline
float64 v_sigmoid_f32(float64 input)
{//sigmoid(x) = 0.5 * (tanh(0.5*x)+1) instead of (div_f32(1.0, (1.0 + exp_cephes_f32(-input))));
    float64 x = v_f32_mul_b(input, 0.5f, 0, 0, 1, 0);                                                         // 1
    float64 res = 0.5f;
    x = v_tanh_f32(x);                                                                                // 17
    res = v_f32_mac_b(x, 0.5f, res, SW_NO_NEG, 1, 0); // 18

    return res;
}

///////////////////////////////////// ASIN CEPHES F32 /////////////////////////////////////////////
float64 v_asin_cephes_f32(float64 input)
{
    float64 x, abs_x;
    float64 z = 0, result = 0;

    const float64 c1 = 4.2163199048E-2;
    const float64 c2 = 2.4181311049E-2;
    const float64 c3 = 4.5470025998E-2;
    const float64 c4 = 7.4953002686E-2;
    const float64 c5 = 1.6666752422E-1;
    const float64 PIO2F = 1.5707963267948966192;

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0, 0, to_bool64((bool256){0}), 1, 0));

    abs_x = v_f32_abs_b(input, 0, 0, 1, 0);

    bool256 lt_one = from_bool64(v_f32_cmp_leq_b(abs_x, 1, 0, to_bool64((bool256){0}), 1, 0));
    bool256 gt_half = from_bool64(v_f32_cmp_grt_b(abs_x, 0.5, 0, to_bool64((bool256){0}), 1, 0));

    // Predicate is set for elements > 0.5 and <= 1.0
    bool256 pred0 = v_i1_and_b(lt_one, gt_half, 0, (bool256){0}, 1, 0);

    bool256 lt_half = from_bool64(v_f32_cmp_leq_b(abs_x, 0.5, 0, to_bool64((bool256){0}), 1, 0));
    bool256 gt_min_const = from_bool64(v_f32_cmp_geq_b(abs_x, 1.0e-4, 0, to_bool64((bool256){0}), 1, 0));

    // Predicate is set for elements >= 1.0e-4 and <= 0.5
    bool256 pred1 = v_i1_and_b(lt_half, gt_min_const, 0, (bool256){0}, 1, 0);

    bool256 ele_in_range = v_i1_or_b(pred0, pred1, 0, (bool256){0}, 1, 0);
    bool256 ele_lt_zero = v_i1_and_b(ele_in_range, lt_zero, 0, (bool256){0}, 1, 0);

    // 0.5 * (1.0 - a);
    z = v_f32_mov_vb(0.5, 0, z, to_bool64(pred0), 0);
    z = v_f32_mac_vb(abs_x, 0.5, z, (true) << 1, to_bool64(pred0), 0);
    x = v_sqrt_f32(z);

    x = v_f32_mov_vb(abs_x, 0, x, to_bool64(pred1), 0);
    z = v_f32_mul_vb(x, x, 0, z, to_bool64(pred1), 0);

    result = v_f32_mac_b(c1, z, c2, (0) << 1, 1, 0);
    result = v_f32_mac_b(result, z, c3, (0) << 1, 1, 0);
    result = v_f32_mac_b(result, z, c4, (0) << 1, 1, 0);
    result = v_f32_mac_b(result, z, c5, (0) << 1, 1, 0);
    float64 temp0 = v_f32_mul_b(z, x, 0, 0, 1, 0);
    result = v_f32_mac_b(result, temp0, x, (0) << 1, 1, 0);

    result = v_f32_add_vb(result, result, 0, result, to_bool64(pred0), 0);
    result = v_f32_sub_vb(PIO2F, result, 0 << 1, result, to_bool64(pred0), 0);

    // sign < 0
    result = v_f32_mul_vb(result, -1, 0, result, to_bool64(ele_lt_zero), 0);

    // abs(input) > 1.0
    result = v_f32_mov_vb(0, 0, result, to_bool64(lt_one), 1);

    // abs(input) < 1.0e-4
    result = v_f32_mov_vb(input, 0, result, to_bool64(gt_min_const), 1);

    return result;
}

///////////////////////////////////// ACOS CEPHES F32 /////////////////////////////////////////////
float64 v_acos_cephes_f32(float64 input)
{
    float64 x, acc = 0, scale_const = -2;
    const float PIF = 3.141592653589793238;
    const float PIO2F = 1.5707963267948966192;

    float64 abs_x = v_f32_abs_b(input, 0, 0, 1, 0);

    bool256 leq_one = from_bool64(v_f32_cmp_leq_b(abs_x, 1, 0, to_bool64((bool256){0}), 1, 0));
    bool256 gt_half = from_bool64(v_f32_cmp_grt_b(abs_x, 0.5, 0, to_bool64((bool256){0}), 1, 0));

    // Predicate is set if abs(input) is > 0.5 and <= 1.0
    bool256 pred0 = v_i1_and_b(leq_one, gt_half, 0, (bool256){0}, 1, 0);

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0, 0, to_bool64((bool256){0}), 1, 0));
    // Predicate is set if input element is < -0.5
    bool256 pred1 = v_i1_and_b(pred0, lt_zero, 0, (bool256){0}, 1, 0);

    // Calculate 0.5 * (1.0 - x) when 0.5 < abs(input) <= 1.0
    x = v_f32_mov_vb(0.5, 0, abs_x, to_bool64(pred0), 0);
    x = v_f32_mac_vb(abs_x, 0.5, x, (true) << 1, to_bool64(pred0), 0);

    x = v_sqrt_f32(x);
    x = v_f32_mov_vb(input, 0, x, to_bool64(gt_half), 1);

    // Call Arcsin implementation
    x = v_asin_cephes_f32(x);

    acc = v_f32_mov_vb(PIF, 0, acc, to_bool64(pred1), 0);
    acc = v_f32_mov_vb(PIO2F, 0, acc, to_bool64(gt_half), 1);

    scale_const = v_f32_mov_vb(1, 0, scale_const, to_bool64(gt_half), 1);
    scale_const = v_f32_mov_vb(2, 0, scale_const, to_bool64(pred1), 0);

    acc = v_f32_mac_b(scale_const, x, acc, (true) << 1, 1, 0);
    return acc;
}

///////////////////////////////////// ATAN_CEPHES_F32 /////////////////////////////////////////////

float64 v_atan_cephes_f32(float64 input)
{
    const float PI_2 = 1.5707963267948966192;  // pi/2
    const float PI_4 = 0.7853981633974483096;  // pi/4
    const float TAN_3PI_8 = 2.414213562373095; // tan(3pi/8)
    const float TAN_PI_8 = 0.4142135623730950; // tan(pi/8)

    const float C1 = 8.05374449538e-2;
    const float C2 = -1.38776856032e-1;
    const float C3 = 1.99777106478e-1;
    const float C4 = -3.33329491539e-1;

    float64 y, res;

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0.0, 0, to_bool64((bool256){0}), 1, 0));
    input = v_f32_abs_b(input, 0, 0, 1, 0);

    // if input > TAN_PI_8
    float64 minus_one = v_f32_sub_b(input, 1.0, 0 << 1, 0, 1, 0);
    float64 plus_one = v_f32_add_b(input, 1.0, 0, 0, 1, 0);
    float64 div_res = v_div_f32(minus_one, plus_one);

    y = v_f32_sel_grt_f32_b(input, TAN_PI_8, PI_4, 0, 0, 0, 1, 0);
    res = v_f32_sel_grt_f32_b(input, TAN_PI_8, div_res, input, 0, 0, 1, 0);

    // if input > TAN_3PI_8
    float64 neg_one = -1.0;
    div_res = v_div_f32(neg_one, input);

    y = v_f32_sel_grt_f32_b(input, TAN_3PI_8, PI_2, y, 0, 0, 1, 0);
    input = v_f32_sel_grt_f32_b(input, TAN_3PI_8, div_res, res, 0, 0, 1, 0);

    float64 z = v_f32_mul_b(input, input, 0, 0, 1, 0);
    res = v_f32_mac_b(C1, z, C2, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C3, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C4, (0) << 1, 1, 0);
    res = v_f32_mul_b(res, input, 0, 0, 1, 0);
    res = v_f32_mac_b(res, z, input, (0) << 1, 1, 0);

    y = v_f32_add_b(res, y, 0, 0, 1, 0);

    // if input < 0 -> y = -y
    y = v_f32_sub_vb(y, 0.0, 1 << 1, y, to_bool64(lt_zero), 0);

    return y;
}

///////////////////////////////////// TAN_CEPHES_F32 /////////////////////////////////////////////

float64 v_tan_cephes_f32(float64 input)
{
    const float DP1 = -0.78515625;
    const float DP2 = -2.4187564849853515625e-4;
    const float DP3 = -3.77489497744594108e-8;
    const float FOPI = 1.27323954473516;  /* 4/pi */
    const float lossth = 8192.0;
    const float low_range = 1.0e-4;

    const float C1 = 9.38540185543E-3;
    const float C2 = 3.11992232697E-3;
    const float C3 = 2.44301354525E-2;
    const float C4 = 5.34112807005E-2;
    const float C5 = 1.33387994085E-1;
    const float C6 = 3.33331568548E-1;

    float64 y, z, sqr_z;
    int64 j, j_and_1, j_and_2;

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0.0, 0, to_bool64((bool256){0}), 1, 0));
    input = v_f32_abs_b(input, 0, 0, 1, 0);

    float64 res = v_f32_mul_b(FOPI, input, 0, 0, 1, 0);
    y = v_f32_nearbyint_b(res, (1) << 16, 0, 1, 0);

    // convert res f32 to i32 to perform bitwise operation
    j = v_convert_f32_to_i32_b(res, (1 <<16), 0, 1, 0);

    // if (j & 1)
    j_and_1 = v_i32_and_b(j, 1, 0, 0, 1, 0);
    bool256 j_1 = from_bool64(v_i32_cmp_eq_b(j_and_1, 1, 0, to_bool64((bool256){0}), 1, 0));
    j = v_i32_add_vb(j, 1, 0, j, to_bool64(j_1), 0);
    y = v_f32_add_vb(y, 1, 0, y, to_bool64(j_1), 0);

    z = v_f32_mac_b(DP1, y, input, (0) << 1, 1, 0);
    z = v_f32_mac_b(DP2, y, z, (0) << 1, 1, 0);
    z = v_f32_mac_b(DP3, y, z, (0) << 1, 1, 0);

    sqr_z = v_f32_mul_b(z, z, 0, 0, 1, 0);

    bool256 leq_low = from_bool64(v_f32_cmp_leq_b(input, low_range, 0, to_bool64((bool256){0}), 1, 0));

    y = v_f32_mac_b(C1, sqr_z, C2, (0) << 1, 1, 0);
    y = v_f32_mac_b(y, sqr_z, C3, (0) << 1, 1, 0);
    y = v_f32_mac_b(y, sqr_z, C4, (0) << 1, 1, 0);
    y = v_f32_mac_b(y, sqr_z, C5, (0) << 1, 1, 0);
    y = v_f32_mac_b(y, sqr_z, C6, (0) << 1, 1, 0);
    y = v_f32_mul_b(y, z, 0, 0, 1, 0);
    y = v_f32_mac_b(y, sqr_z, z, (0) << 1, 1, 0);

    // if (input <= low_range), y = z
    y = v_f32_mov_vb(z, 0, y, to_bool64(leq_low), 0);

    float64 neg_inv_y = v_div_fast_f32(-1.0, y);

    // if (j & 2)
    j_and_2 = v_i32_and_b(j, 2, 0, 0, 1, 0);
    bool256 j_2 = from_bool64(v_i32_cmp_eq_b(j_and_2, 2, 0, to_bool64((bool256){0}), 1, 0));
    y = v_f32_mov_vb(neg_inv_y, 0, y, to_bool64(j_2), 0);

    // if (input < 0), input = -input
    y = v_f32_sub_vb(y, 0.0, 1 << 1, y, to_bool64(lt_zero), 0);

    // if (abs(input) > lossth), y = 0
    bool256 b_lossth = from_bool64(v_f32_cmp_grt_b(input, lossth, 0, to_bool64((bool256){0}), 1, 0));
    y = v_f32_mov_vb(0.0, 0, y, to_bool64(b_lossth), 0);

    return y;
}

///////////////////////////////////// ASINH_F32 /////////////////////////////////////////////
float64 v_asinh_f32(float64 input)
{
    float C1 = 2.0122003309E-2;
    float C2 = -4.2699340972E-2;
    float C3 = 7.4847586088E-2;
    float C4 = -1.6666288134E-1;

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0.0, 0, to_bool64((bool256){0}), 1, 0));
    input = v_f32_abs_b(input, 0, 0, 1, 0);

    float64 z = v_f32_mul_b(input, input, 0, 0, 1, 0);

    float64 res;
    res = v_f32_mac_b(C1, z, C2, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C3, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C4, (0) << 1, 1, 0);
    res = v_f32_mul_b(res, input, 0, 0, 1, 0);
    res = v_f32_mac_b(res, z, input, (0) << 1, 1, 0);

    z = v_f32_add_b(z, 1.0, 0, 0, 1, 0);
    z = v_sqrt_f32(z);
    z = v_f32_add_b(z, input, 0, 0, 1, 0);
    z = v_log_f32(z);

    bool256 geq_half = from_bool64(v_f32_cmp_geq_b(input, 0.5, 0, to_bool64((bool256){0}), 1, 0));
    res = v_f32_mov_vb(z, 0, res, to_bool64(geq_half), 0);

    // sign < 0
    res = v_f32_mul_vb(res, -1, 0, res, to_bool64(lt_zero), 0);

    return res;
}

///////////////////////////////////// ACOSH_F32 /////////////////////////////////////////////
float64 v_acosh_f32(float64 input)
{
    float C1 = 1.7596881071E-3;
    float C2 = -7.5272886713E-3;
    float C3 = 2.6454905019E-2;
    float C4 = -1.1784741703E-1;
    float C5 = 1.4142135263E0;
    float LOGE2F = 0.693147180559945309;

    bool256 lt_one = from_bool64(v_f32_cmp_less_b(input, 1.0, 0, to_bool64((bool256){0}), 1, 0));

    float64 z = v_f32_sub_b(input, 1.0, 0 << 1, 0, 1, 0);

    bool256 geq_half = from_bool64(v_f32_cmp_geq_b(z, 0.5, 0, to_bool64((bool256){0}), 1, 0));
    bool256 grt_limit = from_bool64(v_f32_cmp_grt_b(input, 1500, 0, to_bool64((bool256){0}), 1, 0));

    // if z < 0.5
    float64 res;
    res = v_f32_mac_b(C1, z, C2, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C3, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C4, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C5, (0) << 1, 1, 0);

    float64 sqrt_z = v_sqrt_fast_f32(z);

    res = v_f32_mul_b(res, sqrt_z, 0, 0, 1, 0);

    // if z >= 0.5
    float64 plus_one = v_f32_add_b(input, 1, 0, 0, 1, 0);
    z = v_f32_mul_b(z, plus_one, 0, 0, 1, 0);
    z = v_sqrt_f32(z);
    z = v_f32_add_b(z, input, 0, 0, 1, 0);
    z = v_log_f32(z);

    res = v_f32_mov_vb(z, 0, res, to_bool64(geq_half), 0);

    // if input > 1500
    z = v_log_f32(input);
    z = v_f32_add_b(z, LOGE2F, 0, 0, 1, 0);

    res = v_f32_mov_vb(z, 0, res, to_bool64(grt_limit), 0);

    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    res = v_f32_mov_vb(nan_fp32, 0, res, to_bool64(lt_one), 0);

    return res;
}

///////////////////////////////////// ATANH_F32 /////////////////////////////////////////////
float64 v_atanh_f32(float64 input)
{
    float C1 = 1.81740078349E-1;
    float C2 = 8.24370301058E-2;
    float C3 = 1.46691431730E-1;
    float C4 = 1.99782164500E-1;
    float C5 = 3.33337300303E-1;

    // if input < 0.5
    float64 z = v_f32_mul_b(input, input, 0, 0, 1, 0);
    float64 res = v_f32_mac_b(C1, z, C2, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C3, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C4, (0) << 1, 1, 0);
    res = v_f32_mac_b(res, z, C5, (0) << 1, 1, 0);
    res = v_f32_mul_b(res, input, 0, 0, 1, 0);
    res = v_f32_mac_b(res, z, input, (0) << 1, 1, 0);

    // if input >= 0.5
    float64 one_plus = v_f32_add_b(1, input, 0, 0, 1, 0);
    float64 one_minus = v_f32_sub_b(1, input, 0 << 1, 0, 1, 0);
    z = v_div_fast_f32(one_plus, one_minus);
    z = v_log_fast_f32(z);
    z = v_f32_mul_b(z, 0.5, 0, 0, 1, 0);

    float64 abs_in = v_f32_abs_b(input, 0, 0, 1, 0);
    bool256 geq_half = from_bool64(v_f32_cmp_geq_b(abs_in, 0.5, 0, to_bool64((bool256){0}), 1, 0));
    res = v_f32_mov_vb(z, 0, res, to_bool64(geq_half), 0);

    const uint64 inf_int  = PLUS_INF_FP32;
    const float64 inf_f = *((float64*)&inf_int);
    const uint64 nan_int = NAN_FP32;
    const float64 nan_f = *((float64*)&nan_int);

    bool256 geq_one = from_bool64(v_f32_cmp_geq_b(abs_in, 1.0, 0, to_bool64((bool256){0}), 1, 0));

    float64 gt_range = v_f32_sel_less_f32_b(input, 0, -inf_f, inf_f, 0, 0, 1, 0);
    gt_range = v_f32_sel_grt_f32_b(abs_in, 1.0, nan_f, gt_range, 0, 0, 1, 0);
    res = v_f32_mov_vb(gt_range, 0, res, to_bool64(geq_one), 0);

    return res;
}

///////////////////////////////////// SINH_F32 /////////////////////////////////////////////
float64 v_sinh_cephes_f32(float64 input)
{
    const float maxlogf = 88.0;

    const float C1 = 2.03721912945E-4;
    const float C2 = 8.33028376239E-3;
    const float C3 = 1.66667160211E-1;

    float64 abs_val, temp_1, temp_2, result_1, result_2, final_res = 0.0f;
    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0.0, 0, to_bool64((bool256){0}), 1, 0));

    abs_val = v_f32_abs_b(input, 0, 0, 1, 0);
    bool256 gt_one = from_bool64(v_f32_cmp_grt_b(abs_val, 1.0, 0, to_bool64((bool256){0}), 1, 0));

    // abs_val > 1.0

    result_1 = v_exp_cephes_f32(abs_val);
    temp_1 = v_f32_mul_vb(result_1, 0.5, 0, result_1, to_bool64(gt_one), 0);
    temp_2 = v_div_f32(0.5, result_1);
    result_1 = v_f32_sub_vb(temp_1, temp_2, 0 << 1, result_1, to_bool64(gt_one), 0);

    bool256 pred0 = v_i1_and_b(gt_one, lt_zero, 0, (bool256){0}, 1, 0);
    result_1 = v_f32_mul_vb(result_1, -1, 0, result_1, to_bool64(pred0), 0);

    // abs_val <= 1.0

    temp_1 = v_f32_mul_b(input, input, 0, 0, 1, 0);
    result_2 = v_f32_mac_b(C1, temp_1, C2, (0) << 1, 1, 0);
    result_2 = v_f32_mac_b(result_2, temp_1, C3, (0) << 1, 1, 0);
    result_2 = v_f32_mul_b(result_2, temp_1, 0, 0, 1, 0);
    result_2 = v_f32_mac_b(result_2, input, input, (0) << 1, 1, 0);

    final_res = v_f32_mov_vb(result_1, 0, final_res, to_bool64(gt_one), 0);
    final_res = v_f32_mov_vb(result_2, 0, final_res, to_bool64(gt_one), 1);

    const int64 plus_inf = PLUS_INF_FP32;
    const int64 minus_inf = MINUS_INF_FP32;

    // abs_val > maxlog

    bool256 gt_maxlog = from_bool64(v_f32_cmp_grt_b(abs_val, maxlogf, 0, to_bool64((bool256){0}), 1, 0));
    final_res = v_f32_sel_grt_f32_vb(input, 0.0, *((float64*)&plus_inf), *((float64*)&minus_inf), 0, final_res, to_bool64(gt_maxlog), 0);

    return final_res;
}
///////////////////////////////////// COSH_F32 /////////////////////////////////////////////
float64 v_cosh_cephes_f32(float64 input)
{
    const float maxlogf = 88.0;

    float64 recip, result;

    input = v_f32_abs_b(input, 0, 0, 1, 0);

    result = v_exp_cephes_f32(input);

    // z + ( 1 / z )

    recip = v_reciprocal_f32(result);
    result = v_f32_add_b(result, recip, 0, 0, 1, 0);

    result = v_f32_mul_b(result, 0.5, 0, 0, 1, 0);

    // v_f32_abs_b > maxlog

    bool256 gt_maxlog = from_bool64(v_f32_cmp_grt_b(input, maxlogf, 0, to_bool64((bool256){0}), 1, 0));

    const int64 plus_inf = PLUS_INF_FP32;

    result = v_f32_mov_vb(*(float64*)&plus_inf, 0, result, to_bool64(gt_maxlog), 0);

    return result;
}
///////////////////////////////////// MOD_F32 /////////////////////////////////////////////
float64 v_mod_f32(float64 input_x, float64 input_y)
{
    float64 abs_x = v_f32_abs_b(input_x, 0, 0, 1, 0);
    float64 abs_y = v_f32_abs_b(input_y, 0, 0, 1, 0);
    float64 div_result = v_div_f32(abs_x, abs_y);
    float64 round_result = v_f32_nearbyint_b(div_result, SW_RHNE, 0, 1, 0);
    float64 mul_result = v_f32_mul_b(round_result , abs_y, 0, 0, 1, 0);
    float64 result = v_f32_sub_b(abs_x, mul_result, 0 << 1, 0, 1, 0);

    bool256 bpredv = from_bool64(v_f32_cmp_less_b(result, 0.0, 0, to_bool64((bool256){0}), 1, 0));
    result = v_f32_add_vb(result, abs_y, 0, result, to_bool64(bpredv), 0);

    result = v_f32_form_fp_num_b(result, input_x, result, 0x0, 0, 1, 0);

    return result;
}

///////////////////////////////////// EXPM1_F32 /////////////////////////////////////////////
float64 v_expm1_f32(float64 input)
{
    const float boundval = 5e-1;

    const uint64 flt_min = FLT_MIN;
    const float64 flt_min_fp32 = *((float64*)&flt_min);
    float64 output = 0, temp1 = 0, temp2 = 0, temp3;

    // Checking boundary

    bool256 leq_bv = from_bool64(v_f32_cmp_leq_b(input, boundval, 0, to_bool64((bool256){0}), 1, 0));
    bool256 geq_bv = from_bool64(v_f32_cmp_geq_b(input, -boundval, 0, to_bool64((bool256){0}), 1, 0));
    bool256 pred0 =  v_i1_and_b(leq_bv, geq_bv, 0, (bool256){0}, 1, 0);

    // Cases within boundary

    output = v_f32_mul_vb(input, 0.5, 0, output, to_bool64(pred0), 0);
    output = v_tanh_f32(output);

    temp1 = v_f32_mul_vb(output, 2, 0, temp1, to_bool64(pred0), 0);
    temp2 = v_f32_sub_vb(1, output, 0 << 1, temp2, to_bool64(pred0), 0);
    output = v_div_f32(temp1, temp2);

    // Cases outside boundary

    temp3 =  v_exp_f32(input);
    output = v_f32_sub_vb(temp3, 1, 0 << 1, output, to_bool64(pred0), 1);

    // Special case of min float

    bool256 pred_fmin = from_bool64(v_f32_cmp_eq_b(input, flt_min_fp32, 0, to_bool64((bool256){0}), 1, 0));
    output = v_f32_mov_vb(input, 0, output, to_bool64(pred_fmin), 0);

    return output;
}

// Remove all pre-processor definitions
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 2037 "tpc-special.h"
    #undef v_f32_lookup_c0
    #undef v_f32_lookup_c1c2
#endif
# 2040 "tpc-special.h"
#undef PROCESS_SIN_COS_SPECIAL_VALUES
#undef SIN_COS_CALC
#undef LOOKUP_AND_MAC
#undef CALC_REDUCED_VALUE
#undef false
#undef true
#undef UNIT_VAL
#undef SIGNIFICAND_MASK
#undef EXPONENT_MASK
#undef NAN_FP32
#undef PLUS_INF_FP32
#undef MINUS_INF_FP32
#undef EXP_LOWER
#undef EXP_UPPER
#undef FLT_MIN
#undef FLT_MAX
#undef M_UNIT_EXP


#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 2060 "tpc-special.h"
#define INCLUDE_TPC_REDUCTION_CORE_H
////////////////////////////////////////////////////////////////////////////////////////////////////
/// F32
////////////////////////////////////////////////////////////////////////////////////////////////////

// float64 v_f32_reduce_add(float64 x);
#define REDUCE_DT 0
#define REDUCE_OP 0
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2068 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2069 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// float64 v_f32_reduce_mul(float64 x);
#define REDUCE_DT 0
#define REDUCE_OP 1
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2075 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2076 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// float64 v_f32_reduce_min(float64 x);
#define REDUCE_DT 0
#define REDUCE_OP 2
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2082 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2083 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// float64 v_f32_reduce_max(float64 x);
#define REDUCE_DT 0
#define REDUCE_OP 3
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2089 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2090 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// uint64_float64_pair_t v_f32_reduce_argmin(float64 x);
#define REDUCE_DT 0
#define REDUCE_OP 4
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2096 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2097 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// uint64_float64_pair_t v_f32_reduce_argmax(float64 x);
#define REDUCE_DT 0
#define REDUCE_OP 5
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2103 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2104 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

////////////////////////////////////////////////////////////////////////////////////////////////////
/// I32
////////////////////////////////////////////////////////////////////////////////////////////////////

// int64 v_i32_reduce_add(int64 x);
#define REDUCE_DT 1
#define REDUCE_OP 0
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2114 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2115 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// int64 v_i32_reduce_max(int64 x);
#define REDUCE_DT 1
#define REDUCE_OP 3
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2121 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2122 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP


// uint64_int64_pair_t v_i32_reduce_argmin(int64 x);
#define REDUCE_DT 1
#define REDUCE_OP 4
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2129 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2130 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// uint64_int64_pair_t v_i32_reduce_argmax(int64 x);
#define REDUCE_DT 1
#define REDUCE_OP 5
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2136 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2137 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

////////////////////////////////////////////////////////////////////////////////////////////////////
/// U32
////////////////////////////////////////////////////////////////////////////////////////////////////

// uint64 v_u32_reduce_add(uint64 x);
#define REDUCE_DT 2
#define REDUCE_OP 0
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2147 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2148 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

////////////////////////////////////////////////////////////////////////////////////////////////////
/// BF16
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudib__) || defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 2156 "tpc-special.h"

// bfloat128 v_bf16_reduce_add(bfloat128 x);
#define REDUCE_DT 3
#define REDUCE_OP 0
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2160 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2161 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// bfloat128 v_bf16_reduce_min(bfloat128 x);
#define REDUCE_DT 3
#define REDUCE_OP 2
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2167 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2168 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// bfloat128 v_bf16_reduce_max(bfloat128 x);
#define REDUCE_DT 3
#define REDUCE_OP 3
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2174 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2175 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP
#endif
# 2178 "tpc-special.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// F16
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__greco__) || defined(__gaudi2__) || defined(__doron1__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 2184 "tpc-special.h"
// half128 v_f16_reduce_min(half128 x);
#define REDUCE_DT 4
#define REDUCE_OP 2
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2187 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2188 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// half128 v_f16_reduce_max(half128 x);
#define REDUCE_DT 4
#define REDUCE_OP 3
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2194 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2195 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// half128 v_f16_reduce_add(half128 x);
#define REDUCE_DT 4
#define REDUCE_OP 0
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2201 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2202 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

#endif
# 2206 "tpc-special.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// I16
////////////////////////////////////////////////////////////////////////////////////////////////////

// short128 v_i16_reduce_min(short128 x);
#define REDUCE_DT 5
#define REDUCE_OP 2
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2214 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2215 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// short128 v_i16_reduce_max(short128 x);
#define REDUCE_DT 5
#define REDUCE_OP 3
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2221 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2222 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

////////////////////////////////////////////////////////////////////////////////////////////////////
/// U16
////////////////////////////////////////////////////////////////////////////////////////////////////

// ushort128 v_u16_reduce_add(ushort128 x);
#define REDUCE_DT 6
#define REDUCE_OP 0
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2232 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2233 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

////////////////////////////////////////////////////////////////////////////////////////////////////
/// I8
////////////////////////////////////////////////////////////////////////////////////////////////////

// char256 v_i8_reduce_min(char256 x);
#define REDUCE_DT 7
#define REDUCE_OP 2
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2243 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2244 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// char256 v_i8_reduce_max(char256 x);
#define REDUCE_DT 7
#define REDUCE_OP 3
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2250 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2251 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

////////////////////////////////////////////////////////////////////////////////////////////////////
/// U8
////////////////////////////////////////////////////////////////////////////////////////////////////

// uchar256 v_u8_reduce_min(uchar256 x);
#define REDUCE_DT 8
#define REDUCE_OP 2
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2261 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2262 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

// uchar256 v_u8_reduce_max(uchar256 x);
#define REDUCE_DT 8
#define REDUCE_OP 3
#if 0 /* expanded by -frewrite-includes */
#include "tpc-reduction_functions_core.h"
#endif /* expanded by -frewrite-includes */
# 2268 "tpc-special.h"
# 1 "tpc-reduction_functions_core.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Keren Luzon <kluzon@habana.ai>
******************************************************************************
*/
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(35, 0, 0) && defined(INCLUDE_TPC_REDUCTION_CORE_H)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 13 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// SHUFFLE MAP LOOKUP CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 19 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    42
    #define FUNC_ID_REDUCTION_16    29
    #define FUNC_ID_REDUCTION_8     30
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif (defined(__gaudi__) || defined(__gaudib__))
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 23 "tpc-reduction_functions_core.h"
#define FUNC_ID_REDUCTION_32 282
#define FUNC_ID_REDUCTION_16 140
#define FUNC_ID_REDUCTION_8 141
#else /* goya2/gaudi2/doron1 */
# 27 "tpc-reduction_functions_core.h"
    #define FUNC_ID_REDUCTION_32    287
    #define FUNC_ID_REDUCTION_16    140
    #define FUNC_ID_REDUCTION_8     141
#endif
# 31 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 33 "tpc-reduction_functions_core.h"
    #define v_f32_lookup_1c   v_f32_lookup_c0
    #define v_f32_lookup_2c   v_f32_lookup_c1c2
#endif
# 36 "tpc-reduction_functions_core.h"

#define shuffle_map_32bit_lookup                                                    \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c0, 1, 0);         \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_32, 0, c12, 1, 0);        \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;

#define shuffle_map_16bit_lookup                                                    \
    float128 c01 = {0};                                                             \
    float128 c23 = {0};                                                             \
    c01 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_16, 0, c01, 1, 0);        \
    c23 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_16, 0, c23, 1, 0);   \
    const uchar256 lut1 = (uchar256)c01.v1;                                         \
    const uchar256 lut2 = (uchar256)c01.v2;                                         \
    const uchar256 lut3 = (uchar256)c23.v1;                                         \
    const uchar256 lut4 = (uchar256)c23.v2;

#define shuffle_map_8bit_lookup                                                     \
    float64  c0  = 0;                                                               \
    float128 c12 = {0};                                                             \
    float128 c34 = {0};                                                             \
    c0  = v_f32_lookup_1c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c0, 1, 0);          \
    c12 = v_f32_lookup_2c(read_lane_id_4b_b(), FUNC_ID_REDUCTION_8, 0, c12, 1, 0);         \
    c34 = v_f32_lookup_2c(read_lane_id_4b_b() + 64, FUNC_ID_REDUCTION_8, 0, c34, 1, 0);    \
    const uchar256 lut1 = (uchar256)c0;                                             \
    const uchar256 lut2 = (uchar256)c12.v1;                                         \
    const uchar256 lut3 = (uchar256)c12.v2;                                         \
    const uchar256 lut4 = (uchar256)c34.v1;                                         \
    const uchar256 lut5 = (uchar256)c34.v2;

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION SWITCHES CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

// Switches for mov_dual_group_all
#define SW_MDG_ALL (SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 | \
                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 | \
                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 | \
                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3)

// Switches for mov_dual_group
#define SW_MDG (SW_WR_LOWER_GROUP | SW_WR_UPPER_GROUP)

// Switches for mov_group
#define SW_MG (SW_GROUP0_EN | SW_GROUP1_EN | \
                SW_DUAL_GROUP0_EN | SW_DUAL_GROUP1_EN | \
                SW_DUAL_GROUP2_EN | SW_DUAL_GROUP3_EN)

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION OP AND DATA-TYPE CONFIG
////////////////////////////////////////////////////////////////////////////////////////////////////

#define REDUCE_F32                  0 // f32
#define REDUCE_I32                  1 // i32
#define REDUCE_U32                  2 // u32
#define REDUCE_BF16                 3 // bf16
#define REDUCE_F16                  4 // f16
#define REDUCE_I16                  5 // i16
#define REDUCE_U16                  6 // u16
#define REDUCE_I8                   7 // i8
#define REDUCE_U8                   8 // u8

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32 || REDUCE_DT == REDUCE_I32 || REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 102 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_4b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 104 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_2b_b()
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 106 "tpc-reduction_functions_core.h"
    #define INIT_INDEX              read_lane_id_1b_b()
#endif
# 108 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_F32
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 110 "tpc-reduction_functions_core.h"
    #define T                       f32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                float64
    #define PAIR_VEC_TYPE           uint64_float64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 116 "tpc-reduction_functions_core.h"
    #define T                       i32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                int64
    #define PAIR_VEC_TYPE           uint64_int64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U32
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 122 "tpc-reduction_functions_core.h"
    #define T                       u32
    #define I                       u32
    #define B                       32bit
    #define VEC_TYPE                uint64
    #define PAIR_VEC_TYPE           uint64_uint64_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_BF16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 128 "tpc-reduction_functions_core.h"
    #define T                       bf16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                bfloat128
    #define PAIR_VEC_TYPE           ushort128_bfloat128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_F16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 134 "tpc-reduction_functions_core.h"
    #define T                       f16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                half128
    #define PAIR_VEC_TYPE           ushort128_half128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 140 "tpc-reduction_functions_core.h"
    #define T                       i16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                short128
    #define PAIR_VEC_TYPE           ushort128_short128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U16
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 146 "tpc-reduction_functions_core.h"
    #define T                       u16
    #define I                       u16
    #define B                       16bit
    #define VEC_TYPE                ushort128
    #define PAIR_VEC_TYPE           ushort128_ushort128_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_I8
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 152 "tpc-reduction_functions_core.h"
    #define T                       i8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                char256
    #define PAIR_VEC_TYPE           uchar256_char256_pair_t
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 158 "tpc-reduction_functions_core.h"
    #define T                       u8
    #define I                       u8
    #define B                       8bit
    #define VEC_TYPE                uchar256
    #define PAIR_VEC_TYPE           uchar256_uchar256_pair_t
#endif
# 164 "tpc-reduction_functions_core.h"

#define REDUCE_ADD                  0 // add
#define REDUCE_MUL                  1 // mul
#define REDUCE_MIN                  2 // min
#define REDUCE_MAX                  3 // max
#define REDUCE_ARGMIN               4 // argmin
#define REDUCE_ARGMAX               5 // argmax

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 173 "tpc-reduction_functions_core.h"
    #define OP                      _add
    #define NAME                    _add
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MUL
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 176 "tpc-reduction_functions_core.h"
    #define OP                      _mul
    #define NAME                    _mul
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 179 "tpc-reduction_functions_core.h"
    #define OP                      _min
    #define NAME                    _min
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 182 "tpc-reduction_functions_core.h"
    #define OP                      _max
    #define NAME                    _max
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMIN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 185 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_less_
    #define NAME                    _argmin
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 188 "tpc-reduction_functions_core.h"
    #define OP                      _sel2_grt_
    #define NAME                    _argmax
#endif
# 191 "tpc-reduction_functions_core.h"

////////////////////////////////////////////////////////////////////////////////////////////////////
/// REDUCTION CORE LOGIC
////////////////////////////////////////////////////////////////////////////////////////////////////

#define TOKENPASTE3(a, b, c)        a ## b ## c
#define TOKENPASTE4(a, b, c, d)     a ## b ## c ## d
#define TOKENPASTE5(a, b, c, d, e)  a ## b ## c ## d ## e

#define V_REDUCE_CORE(OP, T)        TOKENPASTE4(v_, T, _reduce, OP)
#define V_MOV_DUAL_GROUP(T)         TOKENPASTE3(v_, T, _mov_dual_group_b)
#define V_MOV_DUAL_GROUP_ALL(T)     TOKENPASTE3(v_, T, _mov_dual_group_all_b)
#define V_MOV_GROUP(T)              TOKENPASTE3(v_, T, _mov_group_b)
#define V_SHUFFLE(T)                TOKENPASTE3(v_, T, _shuffle_b)
#define SHUFFLE_MAP_LOOKUP(B)       TOKENPASTE3(shuffle_map_, B, _lookup)

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ADD || REDUCE_OP == REDUCE_MUL || REDUCE_OP == REDUCE_MIN || REDUCE_OP == REDUCE_MAX
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 208 "tpc-reduction_functions_core.h"
#define V_OP(OP, T)                 TOKENPASTE4(v_, T, OP, _b)

VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    VEC_TYPE t = 0;
    SHUFFLE_MAP_LOOKUP(B)

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 217 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 1, 0, SW_MDG, t, 1, 0);
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 3, 2, SW_MDG, t, 1, 0);
    #else
# 220 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t, 1, 0);
    #endif
# 222 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 228 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 2, 0, SW_MDG, t, 1, 0);
    #else
# 230 "tpc-reduction_functions_core.h"
    t = V_MOV_DUAL_GROUP_ALL(T)(x, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t, 1, 0);
    #endif
# 232 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Switch groups g0 <-> g1
    t = V_MOV_GROUP(T)(x, 0xFFFFFFFF, SW_MG, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 2 elements)
    t = V_SHUFFLE(T)(x, lut1, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + 1)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 4 elements)
    t = V_SHUFFLE(T)(x, lut2, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 3)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    // Shuffle elements (every 8 elements)
    t = V_SHUFFLE(T)(x, lut3, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 7)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 262 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t = V_SHUFFLE(T)(x, lut4, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 15)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 268 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 270 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t = V_SHUFFLE(T)(x, lut5, 0, t, 1, 0);

    // (dg0 + dg1 + dg2 + dg3) + (g0 + g1) + (0 + ... + 31)
    x = V_OP(OP, T)(x, t, 0, x, 1, 0);
    #endif
# 276 "tpc-reduction_functions_core.h"

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 279 "tpc-reduction_functions_core.h"
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 1, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 2, SW_MDG, x, 1, 0);
    x = V_MOV_DUAL_GROUP(T)(x, 0xFFFFFFFF, 0, 3, SW_MDG, x, 1, 0);
    #endif
# 283 "tpc-reduction_functions_core.h"

    return x;
}
#endif
# 287 "tpc-reduction_functions_core.h"

#if 0 /* disabled by -frewrite-includes */
#if REDUCE_OP == REDUCE_ARGMIN || REDUCE_OP == REDUCE_ARGMAX
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 289 "tpc-reduction_functions_core.h"
#define V_SEL_OP(OP, T, I)          TOKENPASTE5(v_, I, OP, T, _b)

PAIR_VEC_TYPE V_REDUCE_CORE(NAME, T)(VEC_TYPE x)
{
    PAIR_VEC_TYPE y = {0};
    PAIR_VEC_TYPE t = {0};
    y.v1 = INIT_INDEX;
    y.v2 = x;
    SHUFFLE_MAP_LOOKUP(B)

    // Shuffle elements (every 2 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut1, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut1, 0, t.v2, 1, 0);

    // (0 + 1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 4 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut2, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut2, 0, t.v2, 1, 0);

    // (0 + ... + 3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Shuffle elements (every 8 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut3, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut3, 0, t.v2, 1, 0);

    // (0 + ... + 7)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_BF16 || REDUCE_DT == REDUCE_F16 || REDUCE_DT == REDUCE_I16 || \
        REDUCE_DT == REDUCE_U16 || REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 322 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 16 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut4, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut4, 0, t.v2, 1, 0);

    // (0 + ... + 15)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 329 "tpc-reduction_functions_core.h"

    
#if 0 /* disabled by -frewrite-includes */
#if REDUCE_DT == REDUCE_I8 || REDUCE_DT == REDUCE_U8
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 331 "tpc-reduction_functions_core.h"
    // Shuffle elements (every 32 elements)
    t.v1 = V_SHUFFLE(I)(y.v1, lut5, 0, t.v1, 1, 0);
    t.v2 = V_SHUFFLE(T)(y.v2, lut5, 0, t.v2, 1, 0);

    // (0 + ... + 31)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);
    #endif
# 338 "tpc-reduction_functions_core.h"

    // Switch groups g0 <-> g1
    t.v1 = V_MOV_GROUP(I)(y.v1, 0xFFFFFFFF, SW_MG, t.v1, 1, 0);
    t.v2 = V_MOV_GROUP(T)(y.v2, 0xFFFFFFFF, SW_MG, t.v2, 1, 0);

    // (g0 + g1)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg1, dg2 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 348 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 1, 0, SW_MDG, t.v1, 1, 0);
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 3, 2, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 1, 0, SW_MDG, t.v2, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 3, 2, SW_MDG, t.v2, 1, 0);
    #else
# 353 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 1, 0, 3, 2, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 356 "tpc-reduction_functions_core.h"

    // (dg0 + dg1), (dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Switch dual groups dg0 <-> dg2, dg1 <-> dg3
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 362 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 2, 0, SW_MDG, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 2, 0, SW_MDG, t.v2, 1, 0);
    #else
# 365 "tpc-reduction_functions_core.h"
    t.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v1, 1, 0);
    t.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 2, 3, 0, 1, SW_MDG_ALL, t.v2, 1, 0);
    #endif
# 368 "tpc-reduction_functions_core.h"

    // (dg0 + dg1 + dg2 + dg3)
    y = V_SEL_OP(OP, T, I)(t.v2, y.v2, t.v1, y.v1, 0, y, 1, 0);

    // Broadcast group elements
    const uchar256 lutb = 0x80;
    y.v1 = V_SHUFFLE(I)(y.v1, lutb, 0, y.v1, 1, 0);
    y.v2 = V_SHUFFLE(T)(y.v2, lutb, 0, y.v2, 1, 0);

    // Broadcast dual groups
    
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 379 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 1, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 1, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 2, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 2, SW_MDG, y.v2, 1, 0);
    y.v1 = V_MOV_DUAL_GROUP(I)(y.v1, 0xFFFFFFFF, 0, 3, SW_MDG, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP(T)(y.v2, 0xFFFFFFFF, 0, 3, SW_MDG, y.v2, 1, 0);
    #else
# 386 "tpc-reduction_functions_core.h"
    y.v1 = V_MOV_DUAL_GROUP_ALL(I)(y.v1, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v1, 1, 0);
    y.v2 = V_MOV_DUAL_GROUP_ALL(T)(y.v2, 0xFFFFFFFF, 0, 0, 0, 0, SW_MDG_ALL, y.v2, 1, 0);
    #endif
# 389 "tpc-reduction_functions_core.h"

    return y;
}
#endif
# 393 "tpc-reduction_functions_core.h"

#undef T
#undef I
#undef B
#undef OP
#undef NAME
#undef INIT_INDEX
#undef VEC_TYPE
#undef PAIR_VEC_TYPE

#endif //__TPC_DROP_VERSION
# 404 "tpc-reduction_functions_core.h"
# 2269 "tpc-special.h" 2
#undef REDUCE_DT
#undef REDUCE_OP

#endif //__TPC_DROP_VERSION
# 2273 "tpc-special.h"

#endif // TPC_SPECIAL_FUNCS_INCLUDED
# 2275 "tpc-special.h"
#endif // TPC_SPECIAL_H_INCLUDED
# 2276 "tpc-special.h"
# 1 "<built-in>" 2
# 1 "/home/acherkasov/ws/kr.o2/src/kernels/goya2/image_processing/resize_image_bicubic_u16.c"
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Subhankar Paul <spaul@habana.ai>
******************************************************************************
*/

#define UINT16
    #define NCWH_LAYOUT
        #if 0 /* expanded by -frewrite-includes */
#include "resize_bicubic.h"
#endif /* expanded by -frewrite-includes */
# 15 "/home/acherkasov/ws/kr.o2/src/kernels/goya2/image_processing/resize_image_bicubic_u16.c"
# 1 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Murugan Vairavel <murugan@multicorewareinc.com>
* Subhankar Paul <spaul@habana.ai>
* Sergei Gorenko <sergei.gorenko@p-product.com>
******************************************************************************
*/
#if 0 /* expanded by -frewrite-includes */
#include "config_kernels_type.h"
#endif /* expanded by -frewrite-includes */
# 14 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
# 1 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h" 1
/*****************************************************************************
* Copyright (C) 2017 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Savchenko Oleg <oleg.savchenko@p-product.com>
* Mikhail Cherepanov <mcherepanov@unipro.ru>
* Gad Molkho <gmolkho@habana.ai>
* Nageshwar Ashok Singh <nageshwar.singh@pathpartnertech.com>
* Einat Bagelman <ebagelman@habana.ai>
******************************************************************************
*/
#ifndef _CONFIG_KERNELS_TYPE_H
#define _CONFIG_KERNELS_TYPE_H



// Type definitions ********************************************************************************
typedef long int            int32_t;
typedef short int           int16_t;
typedef char                int8_t;
typedef unsigned long int   uint32_t;
typedef unsigned short int  uint16_t;
typedef unsigned char       uint8_t;

#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(37, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 30 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
typedef struct _int32_t_pair_t
{
  int32_t v1; // numerator and Remainder
  int32_t v2; // Quotient initialized to zero
} int32_t_pair_t;
#endif
# 36 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

typedef struct _int16_t_pair_t
{
  int32_t v1; // numerator and Remainder
  int32_t v2; // Quotient initialized to zero
} int16_t_pair_t;

typedef struct _int8_t_pair_t
{
  int32_t v1; // Quotient
  int32_t v2; // Remainder
} int8_t_pair_t;

// Cache lines for devices
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 51 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#define NO_OF_CACHE_LINES 4
#endif
# 53 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 54 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#define NO_OF_CACHE_LINES 16
#endif
# 56 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 57 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#define NO_OF_CACHE_LINES 32
#endif
# 59 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"


// ***********************************************************************************************
// Cast workaround : f32->i32->i8, f32->i32->i16
// convert f32->i32->i16 sequence instead of f32->i16 is due to a HW bug found in Goya and
// Gaudi. Fixed in Goya2 onwards.
// https://jira.habana-labs.com/browse/H3-2033
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 67 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
    #define v_cast_f32_to_i8_v(y_f64, x_c256, y_i64, lane_sel)        \
        y_i64 = 0; /* unused */\
        x_c256 = v_convert_f32_to_i8_b(y_f64, lane_sel, SW_RHNE, x_c256);
    #define v_cast_f32_to_i16_v(y_f64, x_s128, y_i64, lane_sel)       \
        y_i64 = 0; /* unused */\
        x_s128 = v_convert_f32_to_i16_b(y_f64, lane_sel, SW_RHNE, x_s128);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 74 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
    #define v_cast_f32_to_i8_v(y_f64, x_c256, y_i64, lane_sel)        \
        y_i64 = v_convert_f32_to_i32_b(y_f64, SW_RHNE); \
        x_c256 = v_convert_int32_to_i8_b(y_i64, 0, lane_sel, SW_RHNE, x_c256);
    #define v_cast_f32_to_i16_v(y_f64, x_s128, y_i64, lane_sel)       \
        y_i64 = v_convert_f32_to_i32_b(y_f64, SW_RHNE); \
        x_s128 = v_convert_int32_to_i16_b(y_i64, 0, lane_sel, SW_RHNE, x_s128);
#endif
# 81 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#define v_cast_f32_to_u8_v(y_f64, x_c256, y_i64, lane_sel)            \
    y_i64 = v_convert_f32_to_i32_b(y_f64, SW_RHNE);     \
    x_c256 = v_convert_i32_to_u8_b(y_i64, lane_sel, SW_RHNE, x_c256);

#define v_cast_f32_to_u8_with_sat_v(y_f64, x_c256, y_i64, lane_sel)   \
    y_f64 = v_f32_max_b(y_f64, 0);\
    y_i64 = v_convert_f32_to_i32_b(y_f64, SW_RHNE);     \
    x_c256 = v_convert_i32_to_u8_b(y_i64, lane_sel, SW_RHNE, x_c256);

// ***********************************************************************************************

// ***********************************************************************************************
// Quantization function : Int8->F32, Int16->F32
//                       : F32->Int8, F32->Int16
#define v_gemmcast_i32_to_f32_v(y_f64, x, v_scale_to_f32, v_scale_mul_zp) \
                y_f64 = v_convert_i32_to_f32_b(x); \
                y_f64 = v_f32_mac_b(y_f64, v_scale_to_f32, v_scale_mul_zp, SW_NO_NEG);

#define v_gemmcast_u32_to_f32_v(y_f64, x, v_scale_to_f32, v_scale_mul_zp) \
                y_f64 = v_convert_i32_to_f32_b((int64)x); \
                y_f64 = v_f32_mac_b(y_f64, v_scale_to_f32, v_scale_mul_zp, SW_NO_NEG);

#define v_gemmcast_f32_to_i8_v(y_c256, x_f64, scale_to_int, zero_point, y_i32, lane_sel)\
        x_f64 = v_f32_mac_b(x_f64, scale_to_int, zero_point, SW_NO_NEG);\
        v_cast_f32_to_i8_v(x_f64, y_c256, y_i32, lane_sel);

#define v_gemmcast_f32_to_u8_v(y_c256, x_f64, scale_to_int, zero_point, y_i32, lane_sel)\
        x_f64 = v_f32_mac_b(x_f64, scale_to_int, zero_point, SW_NO_NEG);\
        v_cast_f32_to_u8_with_sat_v(x_f64, y_c256, y_i32, lane_sel);

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 113 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_flexcast_2xi32_to_2xf32_av(xf0, x, v_scale_to_f32) \
                xf0 = v_convert_i32_to_f32_x2_b(x); \
                xf0.v1 = v_f32_mul_b(xf0.v1, v_scale_to_f32); \
                xf0.v2 = v_f32_mul_b(xf0.v2, v_scale_to_f32);
#else
# 118 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_flexcast_2xi32_to_2xf32_av(xf0, x, v_scale_to_f32) \
                xf0.v1 = v_convert_i32_to_f32_b(x.v1); \
                xf0.v2 = v_convert_i32_to_f32_b(x.v2); \
                xf0.v1 = v_f32_mul_b(xf0.v1, v_scale_to_f32); \
                xf0.v2 = v_f32_mul_b(xf0.v2, v_scale_to_f32);
#endif
# 124 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

//adding 0.5 to simulate nearest even rounding
#define v_flexcast_f32_to_i16_v(v_result, y0, v_scale_to_int, y_i32, lane_sel) \
            y0 = v_f32_mac_b(y0, v_scale_to_int, 0, SW_NO_NEG); \
            v_cast_f32_to_i16_v(y0, v_result, y_i32, lane_sel);

//   ***********************************************************************************************
        // ACTIVATION_FUNCTION -> 0 - NO_ACTIVATION OR 1 - RELU
        #define NO_ACTIVATION  (0)
        #define RELU (1)

        // ROUND MODE
        #define ROUND_MODE_FLOOR (SW_RD)
        #define ROUND_MODE_CEIL  (SW_RU)
        #define ROUND_MODE_TRUNC (SW_RZ)
      //  #define ROUND_MODE_DEFAULT (e_round_default)



//  INT8  *****************************************************************
#if 0 /* disabled by -frewrite-includes */
#if defined(INT8)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 145 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 147 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
                #define DOUBLE_DEFINITION
        #endif
# 149 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 256

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 153 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_8
    #else
# 155 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_1b_b()
    #endif
# 157 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define bv_ucmp_less_v_s(a, b)\
                v_u8_cmp_less_b(a, b);

        //bool256 v_u8_cmp_geq_b(uchar256 a, uint8_t b);
        #define bv_cmp_geq_v_s(a, b)\
                v_u8_cmp_geq_b(a, b)

        #define bv_cmp_geq_v_v(a, b)\
                v_u8_cmp_geq_b(a, b)

        #define bv_cmp_geq_v_s_b(a, b, source, predicate, predicatePolarity)\
                v_u8_cmp_geq_b(a, b, 0, source, predicate, predicatePolarity)

        #define bv_ucmp_grt_v_s(a, b)\
                v_u8_cmp_grt_b(a, b)

        // scalar instructions
        #define s_mov_s_b(a, s, p, pp) \
                s_i8_mov(a, 0, s, p, pp)

        #define s_mov_s_vb(a, s, p, pp) \
                s_i8_mov_s_vb(a, s, p, pp)

        #define v_mov_s_vb(a, s, p, pp) \
                v_i8_mov_vb(a, 0, s, p, pp)

        #define v_mov_s_b(a, s, p, pp) \
                v_i8_mov_b(a, 0, s, p, pp)

        //int8_t s_i8_ld_g(__global__ void* a);
        #define s_ld_g_a(a) \
                s_i8_ld_g(a)

        #define s_ld_g_a_b(a, i, p, o) \
                s_i8_ld_g(a, 0, i, p, o)

        #define s_st_g_a_s(a, s) \
                s_i8_st_g(a, s)

        #define v_ld_g_a(a) \
                v_i8_ld_g(a)

        // SINGLE LOAD AND STORE INSTRUCTIONS
        // char256 v_i8_ld_tnsr_b(int5 a, tensor b);
        #define v_ld_tnsr_i(a, b) \
                v_i8_ld_tnsr_b(a, b)

        // char256 v_i8_ld_tnsr_b(int5 a, tensor b, 0, char256 source, bool predicate,
        //                                                                 bool predicatePolarity);
        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity)\
                v_i8_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_i_vb(a, b, source, predicate, predicatePolarity) \
                v_i8_ld_tnsr_vb(a, b, 0, source, predicate, predicatePolarity)

        //char256 v_i8_ld_tnsr_b(int5 a, int8_t b);
        #define v_ld_tnsr_reg_i_s(a, b) \
                v_i8_ld_tnsr_b(a, b)

        #define v_ld_tnsr_low_i(coords, tnsr) \
                v_i8_ld_tnsr_low_b(coords, tnsr)

        #define v_ld_tnsr_low_i_b(coords, tnsr, input, pred, o) \
                v_i8_ld_tnsr_low_b(coords, tnsr, 0, input, pred, o)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_i8_ld_tnsr_partial_b(coord, tnst, size, offset)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity) \
                v_i8_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                        polarity)

        //char256 v_i8_ld_tnsr_vb(int5 a, int8_t b, 0, char256 source, bool256 predicate,
        //                                                       bool predicatePolarity);
        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_i8_ld_tnsr_vb(a, b, 0, source, predicate, predicatePolarity)

        // char256 v_i8_ld_g(__global__ void* a, 0, char256 source, bool predicate,
        //                                                       bool predicatePolarity);
        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_i8_ld_g(a, 0, source, predicate, predicatePolarity)

        // void  v_i8_st_tnsr(int5 a, tensor b, char256 c);
        #define st_tnsr_i_v(a, b, c) \
                v_i8_st_tnsr(a, b, c)

        // void  v_i8_st_tnsr(int5 a, tensor b, char256 c, 0, bool predicate,
        //                                                       bool predicatePolarity);
        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_i8_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        // void v_i8_st_tnsr(int5 a, tensor b, char256 c);
        #define st_tnsr_low_i_v(a, b, c) \
                v_i8_st_tnsr_low(a, b, c)

        #define st_tnsr_low_i_v_b(coords, tnsr, c, predicate, predicatePolarity) \
                v_i8_st_tnsr_low(coords, tnsr, c, 0, predicate, predicatePolarity) \

        // void v_i8_st_tnsr(int5 a, int8_t b, char256 c);
        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_i8_st_tnsr(a, b, c)

        // void v_i8_st_tnsr(int5 a, int8_t b, char256 c, 0, bool predicate,
        //                                                      bool predicatePolarity);
        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_i8_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_i8_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_i8_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_i8_st_tnsr_partial(n, t, v, s, f, 0, p, o)


        // SINGLE ARITHMETIC INSTRUCTIONS
        // char256 v_i8_abs_b(char256 a);
        #define v_abs_v(a) \
                v_i8_abs_b(a)

        // char256 v_i8_add_b(char256 a, char256 b, e_saturation st, char256 source,
        //bool predicate, bool predicatePolarity);
        #define v_add_v_v(a, b, st) \
                v_i8_add_b(a, b, st)

        // char256 v_i8_add_b(char256 a, int8_t b, e_saturation st);
        #define v_add_v_s(a, b, st) \
                v_i8_add_b(a, b, st)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_i8_add_vb(a, b, SW_SAT, source, predicate, predicatePolarity)

        // char256 v_i8_sub_b(char256 a, char256 b, e_saturation st, char256 source,
        // bool predicate, bool predicatePolarity);
        #define v_sub_v_v(a, b, st) \
                v_i8_sub_b(a, b, st)

        // char256 v_i8_sub_b(char256 a, int8_t b, e_saturation st);
        #define v_sub_v_s( v, s, st)\
                v_i8_sub_b((v), (s), (st))

        // int8_t s_i8_ash(int8_t a, int8_t b, bool RHU << 1);
        #define s_ash_s_s(a, b, RHU)\
            s_i8_ash((a), (b), (RHU) << 1)

        // int32_t s_i8_mul(int8_t a, int8_t b);
        #define s_mul_s_s(a, b)\
                s_i8_mul(a, b)

        #define av_mul_v_v(a, b) \
                v_i8_mul_b(a, b)

        #define v_shl_v_v(a, b) \
                v_i8_shl_b(a, (char256)b)

        #define v_ash_v_v(a, b, rne) \
                v_i8_ash_b(a, b, rne << 1)

        // int256 v_i8_mac_vb(char256 a, int8_t b, int256 source, e_saturation st,
        // bool256 predicate, bool predicatePolarity);
        #define av_mac_v_s_vb(a, b, source, st, predicate, predicatePolarity )\
        v_i8_mac_vb(a, b, source, st, predicate, predicatePolarity)

        // int256 v_i8_mac_b(char256 a, int8_t b, int256 source, e_saturation st,
        //bool predicate, bool predicatePolarity);
        #define av_mac_v_s_b(a, b, source, st, predicate, predicatePolarity )\
        v_i8_mac_b(a, b, source, st, predicate, predicatePolarity)

        // int256 v_i8_mac_b(char256 a, char256 b, int256 source, e_saturation st,
        // bool predicate, bool predicatePolarity);
        #define av_mac_v_v_b(a, b, source, st, predicate, predicatePolarity )\
        v_i8_mac_b(a, b, source, st, predicate, predicatePolarity)

        // int256 v_i8_mac_b(char256 a, int8_t b, e_saturation st);
        #define av_mac_v_s(a, b, src, st )\
        v_i8_mac_b(a, b, src, st)

        // int32_t s_i8_mac(int8_t a, int8_t b, int32_t source, e_saturation st);
        #define s_mac_s_s(a, b, src, st )\
        s_i8_mac(a, b, src, st)

        // int256 v_i8_mac_b(char256 a, char256 b, int256 source, e_saturation st);
        #define av_mac_v_v(a, b, src, st )\
        v_i8_mac_b(a, b, src, st)

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 347 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        // int256 v_i8_mac_x2_zp_b(char256 a, char256 b, char256 c, char256 d,
        // char256 zp, int256 source, e_saturation st);
        #define av_mac_x2_zp_v_v_v_v_v(a, b, c, d, zp, src, sw )\
                v_i8_mac_x2_zp_b(a, b, c, d, zp, src, sw)

        #define av_mac_x2_v_s_v_s_b(a, b, c, d, src, sw, predicate, predicatePolarity) \
                src = v_i8_mac_x2_b(a, v_i8_mov_b(b), c, v_i8_mov_b(d),                \
                src, sw, predicate, predicatePolarity);

        #define av_mac_x2_v_s_v_s(a, b, c, d, src, sw) \
                src = v_i8_mac_x2_b(a, v_i8_mov_b(b), c, d, src, sw);

        #define av_mac_zp_v_v_v(a, b, zp, src, sw) \
                v_i8_mac_zp_b(a, b, zp, src, sw)

        #define av_mac_x2_v_v_v_v(a, b, c, d, src, sw) \
                v_i8_mac_x2_b(a, b, c, d, src, sw)
#else
# 365 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_mac_x2_v_s_v_s_b(a, b, c, d, src, sw, predicate, predicatePolarity) \
                src = v_i8_mac_b(a, b, src, sw, predicate, predicatePolarity);         \
                src = v_i8_mac_b(c, d, src, sw, predicate, predicatePolarity);

        #define av_mac_x2_v_s_v_s(a, b, c, d, src, sw) \
                src = v_i8_mac_b(a, b, src, sw); \
                src = v_i8_mac_b(c, d, src, sw);
#endif
# 373 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // SINGLE LOGICAL INSTRUCTIONS
        // char256 v_i8_min_b(char256 a, int8_t b);
        #define v_min_v_s(a, b) \
                v_i8_min_b(a, b)

        // char256 v_i8_min_b(char256 a, char256 b);
        #define v_min_v_v(a,b) \
                v_i8_min_b(a, b)

        // char256 v_i8_max_b(char256 a, int8_t b);
        #define v_max_v_s(a, b) \
                v_i8_max_b(a, b)

        // char256 v_i8_max_b(char256 a, char256 b);
        #define v_max_v_v(a,b) \
                v_i8_max_b(a, b)

        // char256 v_i8_max_b(char256 a, char256 b, 0, char256 source, bool predicate,
        //                                                  bool predicatePolarity);
        #define v_max_v_v_b(a,b,source,predicate,predicatePolarity) \
                v_i8_max_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_shuffle_v_v(a, b) \
            v_i8_shuffle_b(a, b, 0, a)

        // char256 v_i8_shuffle_vb(char256 a, uchar256 b, 0, char256 source, bool256 predicate,
        //                                                bool predicatePolarity);
        #define v_shuffle_v_v_vb(a, b, source, predicate, predicatePolarity) \
            v_i8_shuffle_vb(a, b, 0, source, predicate, predicatePolarity)

        #define v_shuffle_v_v_b(a, b, predicate, predicatePolarity) \
            v_i8_shuffle_b(a, b, 0, a, predicate, predicatePolarity)

        //char256 v_i8_sel_grt_i8_b(char256 a, char256 b, char256 c, char256 d);
        #define v_sel_grt_v_v_v_v(a, b, c, d) \
                v_i8_sel_grt_i8_b(a, b, c, d)

        #define v_sel_geq_v_v_v_v(a, b, c, d) \
                v_i8_sel_geq_i8_b(a, b, c, d)

        #define v_sel_less_v_v_v_v(a, b, c, d) \
                v_i8_sel_less_i8_b(a, b, c, d)

        #define v_sel_leq_v_v_v_v(a, b, c, d) \
                v_i8_sel_leq_i8_b(a, b, c, d)

        #define v_sel_eq_v_v_v_v(a, b, c, d) \
                v_i8_sel_eq_i8_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v(a, b, c, d) \
                v_i8_sel_neq_i8_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v_vb(a, b, c, d, e, f, g) \
                v_i8_sel_neq_i8_vb(a, b, c, d, 0, e, f, g)

        #define v_sel_grt_v_s_v_v(a, b, c, d) \
                v_i8_sel_grt_i8_b(a, b, c, d)

        #define v_sel_geq_v_s_v_v(a, b, c, d) \
                v_i8_sel_geq_i8_b(a, b, c, d)

        #define v_sel_less_v_s_v_v(a, b, c, d) \
                v_i8_sel_less_i8_b(a, b, c, d)

        #define v_sel_less_v_s_v_v_b(a, b, c, d, i, p, o) \
                v_i8_sel_less_i8_b(a, b, c, d, 0, i, p, o)

        #define v_sel_geq_v_s_v_v_b(a, b, c, d, i, p, o) \
                 v_i8_sel_geq_i8_b(a, b, c, d, 0, i, p, o)

        #define v_sel_leq_v_s_v_v(a, b, c, d) \
                v_i8_sel_leq_i8_b(a, b, c, d)

        #define v_sel_eq_v_s_v_v(a, b, c, d) \
                v_i8_sel_eq_i8_b(a, b, c, d)

        #define v_and_v_v(a, b) \
                v_i8_and_b(a, b)

        #define v_or_v_v(a, b) \
                v_i8_or_b(a, b)

        #define v_xor_v_v(a, b) \
                v_i8_xor_b(a, b)

        #define v_not_v(a) \
                v_i8_not_b(a)

        // bool256 v_i8_cmp_grt_b(char256 a, int8_t b);
        #define bv_cmp_grt_v_s(a, b) \
                v_i8_cmp_grt_b(a, b)

        #define bv_cmp_grt_v_v(a, b) \
                v_i8_cmp_grt_b(a, b)

        // bool256 v_i8_cmp_less_b(char256 a, int8_t b);
        #define bv_cmp_less_v_s(a, b)\
            v_i8_cmp_less_b((a), (b))

        #define bv_cmp_less_v_v(a, b)\
            v_i8_cmp_less_b((a), (b))

        // bool256 v_i8_cmp_leq_b(char256 a, int8_t b);
        #define bv_cmp_leq_v_s(a, b)\
            v_i8_cmp_leq_b((a), (b))

        #define bv_cmp_neq_v_v(a, b)\
            v_i8_cmp_neq_b(a, b)

        // char256 v_convert_int32_to_i8_b(int64 a, char256 b, char256 source,
        // e_round_mode round, int lane_sel, bool predicate, bool predicatePolarity);
#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 486 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v_b(a, b, source, round, lane_sel, predicate, predicatePolarity)\
        v_convert_int32_to_i8_b(a, b, lane_sel, round, \
                                source, predicate, predicatePolarity);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 490 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v_b(a, b, source, round, lane_sel, predicate, predicatePolarity)\
        v_convert_int32_to_i8_single_b(a, b, lane_sel, round, \
                                       source, predicate, predicatePolarity);
#endif
# 494 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // char256 v_convert_int32_to_i8_b(int64 a, int8_t b, char256 source,
        // e_round_mode round, int lane_sel, bool predicate, bool predicatePolarity);
#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 498 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s_b(a, b, source, round, lane_sel, predicate, predicatePolarity)\
        v_convert_int32_to_i8_b(a, b, lane_sel, round, \
                                source, predicate, predicatePolarity);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 502 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s_b(a, b, source, round, lane_sel, predicate, predicatePolarity)\
        v_convert_int32_to_i8_single_b(a, b, lane_sel, round, \
                                       source, predicate, predicatePolarity);
#endif
# 506 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // char256 v_convert_int32_to_i8_b(int64 a, int8_t b, char256 source, e_round_mode round,
#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 509 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s(a, b, source, round, lane_sel)\
        v_convert_int32_to_i8_b(a, b, lane_sel, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 512 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s(a, b, source, round, lane_sel)\
        v_convert_int32_to_i8_single_b(a, b, lane_sel, round, source);
#endif
# 515 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // char256 v_convert_int32_to_i8_b(int64 a, char256 b, char256 source, e_round_mode round,
#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 518 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v(a, b, source, round, lane_sel)\
        v_convert_int32_to_i8_b(a, b, lane_sel, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 521 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v(a, b, source, round, lane_sel)\
        v_convert_int32_to_i8_single_b(a, b, lane_sel, round, source);
#endif
# 524 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // int8_t s_convert_int32_to_i8(int32_t a, int8_t b, e_round_mode round);
        #define s_convert_high_to_low_s(a, b)\
        s_convert_int32_to_i8(a, b, SW_RZ)

        #define av_convert_f32_to_int_v(i, f32, i32, i8, RHU)\
        v_cast_f32_to_i8_v((f32).v1, (i), (i32), 0)\
        v_cast_f32_to_i8_v((f32).v2, (i), (i32), 1)\
        v_cast_f32_to_i8_v((f32).v3, (i), (i32), 2)\
        v_cast_f32_to_i8_v((f32).v4, (i), (i32), 3)

        #define v_cast_f32_to_8bit_v(y_f64, x_c256, y_i64, lane_sel)\
                v_cast_f32_to_i8_v(y_f64, x_c256, y_i64, lane_sel)

        #define av_convert_int_to_f32_v(u, i)\
        av_mov_v((u).acc_i32, 0);\
        (u).acc_i32 = v_i8_mac_b((i), 1, (u).acc_i32, SW_SAT);\
        (u).acc_f32.v1 = v_convert_i32_to_f32_b((u).acc_i32.v1, SW_RHNE);\
        (u).acc_f32.v2 = v_convert_i32_to_f32_b((u).acc_i32.v2, SW_RHNE);\
        (u).acc_f32.v3 = v_convert_i32_to_f32_b((u).acc_i32.v3, SW_RHNE);\
        (u).acc_f32.v4 = v_convert_i32_to_f32_b((u).acc_i32.v4, SW_RHNE);

        #define cast_f32_to_8bits_lin_order(t00, t10, t20, t30)\
                cast_f32_to_i8_lin_order(t00, t10, t20, t30)

        #define v_mov_s(a) \
                v_i8_mov_b(a)

        #define v_mov_v_vb(a, b, predicate, predicatePolarity) \
                v_i8_mov_vb(a, 0, b, predicate, predicatePolarity)

        #define v_mov_v_b(a, b, predicate, predicatePolarity)\
                v_i8_mov_b(a, 0, b, predicate, predicatePolarity)

        // char256 v_i8_mov_group_b(char256 a, uint32_t b, (
                //int dual_group_en << 2) | int group_en, char256 source);
        #define v_mov_group_v( a, b, source, group_en, dual_group_en) \
                v_i8_mov_group_b(a, b, (dual_group_en << 2) | group_en, source)

        #define v_mov_group_v_b( a, b, source, group_en, dual_group_en, p, o) \
                v_i8_mov_group_b(a, b, (dual_group_en << 2) | group_en, source, p, o)

        // COMPLEX LOGICAL INSTRUCTIONS
        #define v_ld_acc_i(acc, cords, tensor, dim) \
        acc.v1 = v_i32_ld_tnsr_b(cords, tensor); cords = i_i32_add(64, cords, dim, 0, cords);\
        acc.v2 = v_i32_ld_tnsr_b(cords, tensor); cords = i_i32_add(64, cords, dim, 0, cords);\
        acc.v3 = v_i32_ld_tnsr_b(cords, tensor); cords = i_i32_add(64, cords, dim, 0, cords);\
        acc.v4 = v_i32_ld_tnsr_b(cords, tensor); cords = i_i32_add(64, cords, dim, 0, cords);

        #define v_ld_l_acc(acc, vlm) \
        (acc).v1 = (vlm)[0];\
        (acc).v2 = (vlm)[1];\
        (acc).v3 = (vlm)[2];\
        (acc).v4 = (vlm)[3];

        #define st_l_acc(vlm, acc) \
        (vlm)[0] =  (acc).v1;\
        (vlm)[1] =  (acc).v2;\
        (vlm)[2] =  (acc).v3;\
        (vlm)[3] =  (acc).v4;

        //int64 v_i32_mov_b(int32_t a);
        #define v_32_mov_s(a)\
                v_i32_mov_b(a)

        // COMPLEX LOGICAL INSTRUCTIONS
        #define av_ld_f32_acc(acc, cords, tensor, step)                                            \
        (acc).v1 = v_f32_ld_tnsr_b((cords), (tensor)); (cords) = i_i32_add((step), (cords), 0b1, 0,\
                                                                                   (cords), 1, 0); \
        (acc).v2 = v_f32_ld_tnsr_b((cords), (tensor)); (cords) = i_i32_add((step), (cords), 0b1, 0,\
                                                                                   (cords), 1, 0); \
        (acc).v3 = v_f32_ld_tnsr_b((cords), (tensor)); (cords) = i_i32_add((step), (cords), 0b1, 0,\
                                                                                   (cords), 1, 0); \
        (acc).v4 = v_f32_ld_tnsr_b((cords), (tensor)); (cords) = i_i32_add((step), (cords), 0b1, 0,\
                                                                                   (cords), 1, 0);

        // LOAD PREDICATE TENSOR
        #define bv_ld_tnsr_i_av(acc, cords, tensor, step, dim)                                   \
        acc.v1 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords); \
        acc.v2 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords); \
        acc.v3 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords); \
        acc.v4 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords);

        // char256 v_i8_add_b(char256 a, char256 b, e_saturation st);
        #define av_add_av_av(acc0, acc1, acc2, SAT)  \
        acc0.v1 = v_i32_add_b(acc1.v1, acc2.v1, SAT);\
        acc0.v2 = v_i32_add_b(acc1.v2, acc2.v2, SAT);\
        acc0.v3 = v_i32_add_b(acc1.v3, acc2.v3, SAT);\
        acc0.v4 = v_i32_add_b(acc1.v4, acc2.v4, SAT);

        // char256 v_i8_sub_b(char256 a, char256 b, e_saturation st);
        #define av_sub_av_av(acc0, acc1, acc2, SAT)\
        acc0.v1 = v_i32_sub_b(acc1.v1, acc2.v1, SAT);\
        acc0.v2 = v_i32_sub_b(acc1.v2, acc2.v2, SAT);\
        acc0.v3 = v_i32_sub_b(acc1.v3, acc2.v3, SAT);\
        acc0.v4 = v_i32_sub_b(acc1.v4, acc2.v4, SAT);

        // int64 v_i32_add_b(int64 a, int32_t b, e_saturation st);
        #define av_add_av_s(acc_out, acc_in, scalar, SAT)\
        acc_out.v1 = v_i32_add_b(acc_in.v1, scalar, SAT);\
        acc_out.v2 = v_i32_add_b(acc_in.v2, scalar, SAT);\
        acc_out.v3 = v_i32_add_b(acc_in.v3, scalar, SAT);\
        acc_out.v4 = v_i32_add_b(acc_in.v4, scalar, SAT);

        // char256 v_i8_sub_b(char256 a, char256 b, e_saturation st);
        #define av_sub_av_av(acc0, acc1, acc2, SAT)  \
        acc0.v1 = v_i32_sub_b(acc1.v1, acc2.v1, SAT);\
        acc0.v2 = v_i32_sub_b(acc1.v2, acc2.v2, SAT);\
        acc0.v3 = v_i32_sub_b(acc1.v3, acc2.v3, SAT);\
        acc0.v4 = v_i32_sub_b(acc1.v4, acc2.v4, SAT);

        #define av_sub_v_av(acc_out, vec, acc_in, SAT)\
        acc_out.v1 = v_i32_sub_b(vec, acc_in.v1, SAT);\
        acc_out.v2 = v_i32_sub_b(vec, acc_in.v2, SAT);\
        acc_out.v3 = v_i32_sub_b(vec, acc_in.v3, SAT);\
        acc_out.v4 = v_i32_sub_b(vec, acc_in.v4, SAT);

        // int64 v_i32_sub_b(int64 a, int32_t b, e_saturation st);
        #define av_sub_av_s(acc_out, acc_in, scalar, SAT)\
        acc_out.v1 = v_i32_sub_b(acc_in.v1, scalar, SAT);\
        acc_out.v2 = v_i32_sub_b(acc_in.v2, scalar, SAT);\
        acc_out.v3 = v_i32_sub_b(acc_in.v3, scalar, SAT);\
        acc_out.v4 = v_i32_sub_b(acc_in.v4, scalar, SAT);

        #define av_i32_ash_av_av(acc0, acc1, acc2, RHU)    \
        acc0.v1 = v_i32_ash_b(acc1.v1, acc2.v1, RHU << 1); \
        acc0.v2 = v_i32_ash_b(acc1.v2, acc2.v2, RHU << 1); \
        acc0.v3 = v_i32_ash_b(acc1.v3, acc2.v3, RHU << 1); \
        acc0.v4 = v_i32_ash_b(acc1.v4, acc2.v4, RHU << 1);

        #define av_ash_av_s(acc0, acc1, shift, RHU)     \
        acc0.v1 = v_i32_ash_b(acc1.v1, shift, RHU << 1);\
        acc0.v2 = v_i32_ash_b(acc1.v2, shift, RHU << 1);\
        acc0.v3 = v_i32_ash_b(acc1.v3, shift, RHU << 1);\
        acc0.v4 = v_i32_ash_b(acc1.v4, shift, RHU << 1);

        #define av_max_av_av(acc0, acc1, acc2)  \
        acc0.v1 = v_i32_max_b(acc1.v1, acc2.v1);\
        acc0.v2 = v_i32_max_b(acc1.v2, acc2.v2);\
        acc0.v3 = v_i32_max_b(acc1.v3, acc2.v3);\
        acc0.v4 = v_i32_max_b(acc1.v4, acc2.v4);

        #define av_max_av_s(acc0, acc1, scalar)\
        acc0.v1 = v_i32_max_b(acc1.v1, scalar);\
        acc0.v2 = v_i32_max_b(acc1.v2, scalar);\
        acc0.v3 = v_i32_max_b(acc1.v3, scalar);\
        acc0.v4 = v_i32_max_b(acc1.v4, scalar);

        #define av_min_av_av(acc0, acc1, acc2)  \
        acc0.v1 = v_i32_min_b(acc1.v1, acc2.v1);\
        acc0.v2 = v_i32_min_b(acc1.v2, acc2.v2);\
        acc0.v3 = v_i32_min_b(acc1.v3, acc2.v3);\
        acc0.v4 = v_i32_min_b(acc1.v4, acc2.v4);

        #define av_min_av_s(acc0, acc1, scalar)\
        acc0.v1 = v_i32_min_b(acc1.v1, scalar);\
        acc0.v2 = v_i32_min_b(acc1.v2, scalar);\
        acc0.v3 = v_i32_min_b(acc1.v3, scalar);\
        acc0.v4 = v_i32_min_b(acc1.v4, scalar);

        #define av_sel_grt_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_grt_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_grt_i32_b(acc1.v2, acc2.v2, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_grt_i32_b(acc1.v3, acc2.v3, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_grt_i32_b(acc1.v4, acc2.v4, outTrue, outFalse);

        #define av_sel_grt_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_grt_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_grt_i32_b(acc1.v2, scalar, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_grt_i32_b(acc1.v3, scalar, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_grt_i32_b(acc1.v4, scalar, outTrue, outFalse);

        #define av_sel_geq_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_geq_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_geq_i32_b(acc1.v2, acc2.v2, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_geq_i32_b(acc1.v3, acc2.v3, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_geq_i32_b(acc1.v4, acc2.v4, outTrue, outFalse);

        #define av_sel_geq_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_geq_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_geq_i32_b(acc1.v2, scalar, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_geq_i32_b(acc1.v3, scalar, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_geq_i32_b(acc1.v4, scalar, outTrue, outFalse);

        #define av_sel_less_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_less_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_less_i32_b(acc1.v2, acc2.v2, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_less_i32_b(acc1.v3, acc2.v3, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_less_i32_b(acc1.v4, acc2.v4, outTrue, outFalse);

        #define av_sel_less_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_less_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_less_i32_b(acc1.v2, scalar, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_less_i32_b(acc1.v3, scalar, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_less_i32_b(acc1.v4, scalar, outTrue, outFalse);

        #define av_sel_leq_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_leq_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_leq_i32_b(acc1.v2, acc2.v2, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_leq_i32_b(acc1.v3, acc2.v3, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_leq_i32_b(acc1.v4, acc2.v4, outTrue, outFalse);

        #define av_sel_leq_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_leq_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_leq_i32_b(acc1.v2, scalar, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_leq_i32_b(acc1.v3, scalar, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_leq_i32_b(acc1.v4, scalar, outTrue, outFalse);

        #define av_sel_eq_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_eq_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_eq_i32_b(acc1.v2, acc2.v2, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_eq_i32_b(acc1.v3, acc2.v3, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_eq_i32_b(acc1.v4, acc2.v4, outTrue, outFalse);

        #define av_sel_eq_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_eq_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_eq_i32_b(acc1.v2, scalar, outTrue, outFalse); \
        acc0.v3 = v_i32_sel_eq_i32_b(acc1.v3, scalar, outTrue, outFalse); \
        acc0.v4 = v_i32_sel_eq_i32_b(acc1.v4, scalar, outTrue, outFalse);

        // char256 v_convert_int32_to_i8_b(int64 a, int8_t b, char256 source, e_round_mode round,
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 746 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s(acc, shift, source, round)                          \
        source = v_convert_int32_to_i8_b(acc.v1, shift, 0, round, source);\
        source = v_convert_int32_to_i8_b(acc.v2, shift, 1, round, source);\
        source = v_convert_int32_to_i8_b(acc.v3, shift, 2, round, source);\
        source = v_convert_int32_to_i8_b(acc.v4, shift, 3, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 752 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(32, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 753 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define av_convert_av_s(acc, shift, source, round)\
            source = v_convert_int32_to_i8_all_b(acc, shift, round, source)
        #else
# 756 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define av_convert_av_s(acc, shift, source, round)\
            source = v_convert_i32_to_i8_all_b(acc, shift, round, source, 1, 0)
        #endif
# 759 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#else
# 760 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_s() is not defined"
#endif
# 762 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 764 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s_vb(acc, shift, source, round, vb, b)                      \
        source = v_convert_int32_to_i8_vb(acc.v1, shift, 0, round, source,      \
                                                                        to_bool64(vb), b);\
        source = v_convert_int32_to_i8_vb(acc.v2, shift, 1, round, source,      \
                                                                        to_bool64(vb), b);\
        source = v_convert_int32_to_i8_vb(acc.v3, shift, 2, round, source,      \
                                                                        to_bool64(vb), b);\
        source = v_convert_int32_to_i8_vb(acc.v4, shift, 3, round, source,      \
                                                                        to_bool64(vb), b);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 774 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s_vb(acc, shift, source, round, vb, b)\
        source = v_convert_i32_to_i8_all_vb(acc, shift, round, source, vb, b)
#else
# 777 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_s_vb() is not defined"
#endif
# 779 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 781 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_v_vb(acc, shift, source, round, vb, b)                      \
        source = v_convert_int32_to_i8_vb(acc.v1, shift, 0, round, source,      \
                                                                        to_bool64(vb), b);\
        source = v_convert_int32_to_i8_vb(acc.v2, shift, 1, round, source,      \
                                                                        to_bool64(vb), b);\
        source = v_convert_int32_to_i8_vb(acc.v3, shift, 2, round, source,      \
                                                                        to_bool64(vb), b);\
        source = v_convert_int32_to_i8_vb(acc.v4, shift, 3, round, source,      \
                                                                        to_bool64(vb), b);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 791 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_v_vb(acc, shift, source, round, vb, b)\
        source = v_convert_i32_to_i8_all_vb(acc, shift, round, source, vb, b)
#else
# 794 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_v_vb() is not defined"
#endif
# 796 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 798 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_v(acc, shift, source, round)                          \
        source = v_convert_int32_to_i8_b(acc.v1, shift, 0, round, source);\
        source = v_convert_int32_to_i8_b(acc.v2, shift, 1, round, source);\
        source = v_convert_int32_to_i8_b(acc.v3, shift, 2, round, source);\
        source = v_convert_int32_to_i8_b(acc.v4, shift, 3, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 804 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(32, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 805 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define av_convert_av_v(acc, shift, source, round)\
            source = v_convert_int32_to_i8_all_b(acc, shift, round, source)
        #else
# 808 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define av_convert_av_v(acc, shift, source, round)\
            source = v_convert_i32_to_i8_all_b(acc, shift, round, source, 1, 0)
        #endif
# 811 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#else
# 812 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_v() is not defined"
#endif
# 814 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 816 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_v_first(acc, shift, source, round)                    \
        source = v_convert_int32_to_i8_b(acc.v1, shift, 0, round, 0);     \
        source = v_convert_int32_to_i8_b(acc.v2, shift, 1, round, source);\
        source = v_convert_int32_to_i8_b(acc.v3, shift, 2, round, source);\
        source = v_convert_int32_to_i8_b(acc.v4, shift, 3, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 822 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_v_first(acc, shift, source, round)                           \
        source = v_convert_int32_to_i8_single_b(acc.v1, shift, 0, round, 0);     \
        source = v_convert_int32_to_i8_single_b(acc.v2, shift, 1, round, source);\
        source = v_convert_int32_to_i8_single_b(acc.v3, shift, 2, round, source);\
        source = v_convert_int32_to_i8_single_b(acc.v4, shift, 3, round, source);
#endif
# 828 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // char256 v_convert_int32_to_i8_b(int64 a, char256 b, char256 source, e_round_mode round,
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 831 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_av(acc, shift, source, round)                                        \
        source = v_convert_int32_to_i8_b((acc).v1, (char256) shift.v1, 0, round, source);\
        source = v_convert_int32_to_i8_b((acc).v2, (char256) shift.v2, 1, round, source);\
        source = v_convert_int32_to_i8_b((acc).v3, (char256) shift.v3, 2, round, source);\
        source = v_convert_int32_to_i8_b((acc).v4, (char256) shift.v4, 3, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 837 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_av(acc, shift, source, round)                                       \
                                                                                                  \
        source = v_convert_int32_to_i8_single_b((acc).v1, (char256) shift.v1, 0, round, \
                                                                                          source);\
        source = v_convert_int32_to_i8_single_b((acc).v2, (char256) shift.v2, 1, round, \
                                                                                          source);\
        source = v_convert_int32_to_i8_single_b((acc).v3, (char256) shift.v3, 2, round, \
                                                                                          source);\
        source = v_convert_int32_to_i8_single_b((acc).v4, (char256) shift.v4, 3, round, \
                                                                                          source);
#endif
# 848 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define av_i32_mul_double_and_round_v_s(acc_out, acc_in, scale) \
        acc_out.v1 = v_i32_mul_round_b(acc_in.v1, scale); \
        acc_out.v2 = v_i32_mul_round_b(acc_in.v2, scale); \
        acc_out.v3 = v_i32_mul_round_b(acc_in.v3, scale); \
        acc_out.v4 = v_i32_mul_round_b(acc_in.v4, scale);

// TODO avoid tmp
// avoiding usage of tmp causes value mismatch, probably compiler bug?
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 858 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_s(acc_out, acc_in, scale, shift, tmp)\
        av_i32_mul_double_and_round_v_s(acc_out, acc_in, scale);\
        av_ash_av_s(acc_out, acc_out, shift, 1);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 862 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_s(acc_out, acc_in, scale, shift, tmp)\
        tmp = v_i32_mul_b((acc_in).v1, scale, SW_KEEP_RS); (acc_out).v1 = v_i32_ash_rhaz_b(tmp, shift, 4);\
        tmp = v_i32_mul_b((acc_in).v2, scale, SW_KEEP_RS); (acc_out).v2 = v_i32_ash_rhaz_b(tmp, shift, 4);\
        tmp = v_i32_mul_b((acc_in).v3, scale, SW_KEEP_RS); (acc_out).v3 = v_i32_ash_rhaz_b(tmp, shift, 4);\
        tmp = v_i32_mul_b((acc_in).v4, scale, SW_KEEP_RS); (acc_out).v4 = v_i32_ash_rhaz_b(tmp, shift, 4);
#else
# 868 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_i32_mul_and_ash_av_s() is not defined"
#endif
# 870 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 872 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_av(acc_out, acc_in, scale, shift, tmp)\
        (acc_out).v1 = (int64)v_i32_mul_round_b((int64)acc_in.v1, scale.v1);\
        (acc_out).v2 = (int64)v_i32_mul_round_b((int64)acc_in.v2, scale.v2);\
        (acc_out).v3 = (int64)v_i32_mul_round_b((int64)acc_in.v3, scale.v3);\
        (acc_out).v4 = (int64)v_i32_mul_round_b((int64)acc_in.v4, scale.v4);\
        (acc_out).v1 = (int64)v_i32_ash_b((int64)acc_out.v1, (char256)shift.v1, 2);\
        (acc_out).v2 = (int64)v_i32_ash_b((int64)acc_out.v2, (char256)shift.v2, 2);\
        (acc_out).v3 = (int64)v_i32_ash_b((int64)acc_out.v3, (char256)shift.v3, 2);\
        (acc_out).v4 = (int64)v_i32_ash_b((int64)acc_out.v4, (char256)shift.v4, 2);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 882 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_av(acc_out, acc_in, scale, shift, tmp)\
        tmp = v_i32_mul_b((int64)acc_in.v1, scale.v1, SW_KEEP_RS); acc_out.v1 = (int64)v_i32_ash_rhaz_b(tmp, (char256)shift.v1, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v2, scale.v2, SW_KEEP_RS); acc_out.v2 = (int64)v_i32_ash_rhaz_b(tmp, (char256)shift.v2, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v3, scale.v3, SW_KEEP_RS); acc_out.v3 = (int64)v_i32_ash_rhaz_b(tmp, (char256)shift.v3, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v4, scale.v4, SW_KEEP_RS); acc_out.v4 = (int64)v_i32_ash_rhaz_b(tmp, (char256)shift.v4, 4);
#else
# 888 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_i32_mul_and_ash_av_av() is not defined"
#endif
# 890 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#define av_i32_mul_and_ash_av_av_(acc_out, acc_in, scale, shift, tmp)\
        av_i32_mul_and_ash_av_av(acc_out, acc_in, scale, shift, tmp)

        #define av_f32_mul_v_v(acc_out, acc_in1, acc_in2) \
        (acc_out).v1 = v_f32_mul_b((acc_in1).v1, (acc_in2).v1); \
        (acc_out).v2 = v_f32_mul_b((acc_in1).v2, (acc_in2).v2); \
        (acc_out).v3 = v_f32_mul_b((acc_in1).v3, (acc_in2).v3); \
        (acc_out).v4 = v_f32_mul_b((acc_in1).v4, (acc_in2).v4);

        #define av_f32_mac_v_v(acc_out, acc_in1, acc_in2, acc_in3) \
        (acc_out).v1 = v_f32_mac_b((acc_in1).v1, (acc_in2).v1, acc_in3, SW_NO_NEG); \
        (acc_out).v2 = v_f32_mac_b((acc_in1).v2, (acc_in2).v2, acc_in3, SW_NO_NEG); \
        (acc_out).v3 = v_f32_mac_b((acc_in1).v3, (acc_in2).v3, acc_in3, SW_NO_NEG); \
        (acc_out).v4 = v_f32_mac_b((acc_in1).v4, (acc_in2).v4, acc_in3, SW_NO_NEG);

        #define av_f32_msu_av_s(acc_out, in, scale, acc) \
        (acc_out).v1 = v_f32_mac_b(in.v1, scale, acc, SW_NEG); \
        (acc_out).v2 = v_f32_mac_b(in.v2, scale, acc, SW_NEG); \
        (acc_out).v3 = v_f32_mac_b(in.v3, scale, acc, SW_NEG); \
        (acc_out).v4 = v_f32_mac_b(in.v4, scale, acc, SW_NEG);

        #define av_f32_mul_v_vs(acc_out, acc_in, scale) \
        (acc_out).v1 = v_f32_mul_b((acc_in).v1, (scale)); \
        (acc_out).v2 = v_f32_mul_b((acc_in).v2, (scale)); \
        (acc_out).v3 = v_f32_mul_b((acc_in).v3, (scale)); \
        (acc_out).v4 = v_f32_mul_b((acc_in).v4, (scale));

        #define av_f32_mac_v_vs(acc_out, acc_in, scale, zp) \
        (acc_out).v1 = v_f32_mac_b((acc_in).v1, (scale), (zp), SW_NO_NEG); \
        (acc_out).v2 = v_f32_mac_b((acc_in).v2, (scale), (zp), SW_NO_NEG); \
        (acc_out).v3 = v_f32_mac_b((acc_in).v3, (scale), (zp), SW_NO_NEG); \
        (acc_out).v4 = v_f32_mac_b((acc_in).v4, (scale), (zp), SW_NO_NEG);

        #define av_f32_mul_v_s(acc_out, acc_in, scale) \
        (acc_out).v1 = v_f32_mul_b((acc_in).v1, (scale)); \
        (acc_out).v2 = v_f32_mul_b((acc_in).v2, (scale)); \
        (acc_out).v3 = v_f32_mul_b((acc_in).v3, (scale)); \
        (acc_out).v4 = v_f32_mul_b((acc_in).v4, (scale));

        #define av_f32_sub_av_s(acc_out, acc_in, scale) \
        (acc_out).v1 = v_f32_sub_b((acc_in).v1, (scale), SW_NO_NEG); \
        (acc_out).v2 = v_f32_sub_b((acc_in).v2, (scale), SW_NO_NEG); \
        (acc_out).v3 = v_f32_sub_b((acc_in).v3, (scale), SW_NO_NEG); \
        (acc_out).v4 = v_f32_sub_b((acc_in).v4, (scale), SW_NO_NEG);

        #define av_f32_sub_av_av(acc_out, acc_in1, acc_in2) \
        (acc_out).v1 = v_f32_sub_b((acc_in1).v1, (acc_in2.v1), SW_NO_NEG); \
        (acc_out).v2 = v_f32_sub_b((acc_in1).v2, (acc_in2.v2), SW_NO_NEG); \
        (acc_out).v3 = v_f32_sub_b((acc_in1).v3, (acc_in2.v3), SW_NO_NEG); \
        (acc_out).v4 = v_f32_sub_b((acc_in1).v4, (acc_in2.v4), SW_NO_NEG);

        // int64 v_convert_i8_to_i32_b(char256 a);
        #define av_convert_to_i32_av(acc_in, acc_out) \
        acc_out.v1 = v_convert_i8_to_i32_b(acc_in.v1); \
        acc_out.v2 = v_convert_i8_to_i32_b(acc_in.v2); \
        acc_out.v3 = v_convert_i8_to_i32_b(acc_in.v3); \
        acc_out.v4 = v_convert_i8_to_i32_b(acc_in.v4);

        // char256 v_i8_unpack_b(char256 a, ((e_group_source group_source) << 8) | ((
        //                                    e_element_stride element_stride) << 9) |
        //                                  ((e_group_half group_half) << 10), char256 source);
        #define av_unpack_to_i32_v(input, acc_out) \
        acc_out.v1 = 0, acc_out.v2 = 0, acc_out.v3 = 0, acc_out.v4 = 0;\
        acc_out.v1 = v_i8_unpack_b(input, SW_GROUP_0 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_0, acc_out.v1, 1, 0);  \
        acc_out.v2 = v_i8_unpack_b(input, SW_GROUP_0 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_1, acc_out.v2, 1, 0); \
        acc_out.v3 = v_i8_unpack_b(input, SW_GROUP_1 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_0, acc_out.v3, 1, 0);  \
        acc_out.v4 = v_i8_unpack_b(input, SW_GROUP_1 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_1, acc_out.v4, 1, 0);

        // uchar256 v_u8_unpack_b(uchar256 a, ((e_group_source group_source) << 8) | ((
        //                                      e_element_stride element_stride) << 9) |
        //                                    ((e_group_half group_half) << 10), uchar256 source);
        #define av_u_unpack_convert_to_i32_av(input, acc_out1, acc_out2) \
        acc_out1.v1 = 0, acc_out1.v2 = 0, acc_out1.v3 = 0, acc_out1.v4 = 0;\
        acc_out1.v1 = v_u8_unpack_b(input, SW_GROUP_0 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_0, acc_out1.v1, 1, 0);  \
        acc_out1.v2 = v_u8_unpack_b(input, SW_GROUP_0 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_1, acc_out1.v2, 1, 0); \
        acc_out1.v3 = v_u8_unpack_b(input, SW_GROUP_1 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_0, acc_out1.v3, 1, 0);  \
        acc_out1.v4 = v_u8_unpack_b(input, SW_GROUP_1 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_1, acc_out1.v4, 1, 0); \
        acc_out2.v1 = (int64)acc_out1.v1; \
        acc_out2.v2 = (int64)acc_out1.v2; \
        acc_out2.v3 = (int64)acc_out1.v3; \
        acc_out2.v4 = (int64)acc_out1.v4;

        #define av_mov_zero(acc)  \
                acc.v1 = v_i32_mov_b(0);  \
                acc.v2 = v_i32_mov_b(0);  \
                acc.v3 = v_i32_mov_b(0);  \
                acc.v4 = v_i32_mov_b(0);

        #define av_mov_v(acc, vec)\
        acc.v1 = (vec); acc.v2 = (vec); acc.v3 = (vec); acc.v4 = \
                                                                                 (vec);

        #define av_mov_s(acc, scalar)\
        acc.v1 = v_i32_mov_b(scalar); acc.v2 = v_i32_mov_b(scalar); acc.v3 = v_i32_mov_b(scalar); \
                                                                      acc.v4 = v_i32_mov_b(scalar);

        #define av_mov_av(acc0, acc1)\
        acc0.v1 = (acc1.v1); acc0.v2 = (acc1.v2);  \
                                    acc0.v3 = (acc1.v3); acc0.v4 = (acc1.v4);


        #define s_i_mov_b(a, i, p, o) s_i8_mov(a, 0, i, p, o)

        typedef char256     VECTOR;
        typedef uchar256    UVECTOR;
        typedef int256      ACC_VECTOR;
        typedef float256    FLOAT_ACC_VECTOR;
        typedef char        SCALAR;
        typedef int         ACC_SCALAR;

        typedef VECTOR      VEC_INT;
        typedef ACC_VECTOR  ACC_VEC_INT;
        typedef SCALAR      INT;

        #define INT_MIN                     (-128)
        #define MIN_VAL                     INT_MIN
        #define INT_MAX                     127
        #define ABS_INT_MIN                 (128U)
        #define SIGNED_PAIR_T               int8_t_pair_t
        #define UNSIGNED_PAIR_T             uint8_t_pair_t
        #define PAIR_T                      SIGNED_PAIR_T
        #define SCALAR_T                    int8_t
        #define UNSIGNED_SCALAR_T           uint8_t
        #define INT_STEP                    7
        #define SIGN_MASK                   ((int8_t)((uint8_t)1<<INT_STEP))
        #define div_mod_i                   div_mod_i8
        #define s_abs_s(a)                  s_i8_abs(a)
        #define s_xor_s_s(a, b)             s_i8_xor(a, b)
        #define s_and_s_s(a, b)             s_i8_and(a, b)
        #define NEG_OP(a)                   s_i8_sub((int8_t)0, (a), SW_SAT)
        
#if 0 /* disabled by -frewrite-includes */
#if defined( __goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1030 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u8_udiv_step(a, s, 0, i)
        #endif
# 1032 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1033 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u8_udiv_4step(a, s, 0, i)
        #endif
# 1035 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1036 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u8_udiv_4step(a, s, SW_X2_UDIV_4STEP, i)
        #endif
# 1038 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1039 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u8_udiv_both(a, s, SW_DIV_MODE_BOTH, i)
        #endif
# 1041 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define INIT_ACC_VEC_INT(a) a.v1 = 0; a.v2 = 0; a.v3 = 0; a.v4 = 0

        #define v_mov_dual_group_v(a, b, src, src_dual, dst_dual, wr_lower_group, wr_upper_group) \
          v_i8_mov_dual_group_b(a, b, src_dual, dst_dual, MkWr(wr_lower_group, wr_upper_group), src)

        #define v_mov_dual_group_v_vb(a, b, src, src_dual, dst_dual, wr_lower_group,              \
                                                wr_upper_group, predicate, predicatePolarity)     \
          v_i8_mov_dual_group_vb(a, b, src_dual, dst_dual, MkWr(wr_lower_group,                   \
                                                wr_upper_group), src, predicate, predicatePolarity)

        #define v_mov_dual_group_v_b(a, b, src, src_dual, dst_dual, wr_lower_group,               \
                                                wr_upper_group, predicate, predicatePolarity)     \
          v_i8_mov_dual_group_b(a, b, src_dual, dst_dual, MkWr(wr_lower_group,                    \
                                                wr_upper_group), src, predicate, predicatePolarity)

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1058 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_mov_dual_group_all_v(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3) \
                v_i8_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src)

        #define v_mov_dual_group_all_v_b(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3, p, o) \
                v_i8_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src, p, o)
#endif //__gaudi__
# 1064 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        typedef struct _acc_vec_float
        {
            float64 v1;
            float64 v2;
            float64 v3;
            float64 v4;
        } acc_vec_float;

        typedef union {
             float256      acc_f32;
             ACC_VEC_INT   acc_i32;
             VEC_INT       y;
        } acc_union_t;

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1080 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_i32_to_f32_x4_av(acc_out, acc_in, RHU) \
            acc_out = v_convert_i32_to_f32_x4_b(acc_in, RHU);
#else
# 1083 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_i32_to_f32_x4_av(acc_out, acc_in, RHU) \
            (acc_out).v1 = v_convert_i32_to_f32_b((acc_in).v1, RHU); \
            (acc_out).v2 = v_convert_i32_to_f32_b((acc_in).v2, RHU); \
            (acc_out).v3 = v_convert_i32_to_f32_b((acc_in).v3, RHU); \
            (acc_out).v4 = v_convert_i32_to_f32_b((acc_in).v4, RHU);
#endif
# 1089 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define v_gemmcast_32bit_to_f32_v(y_f64, x, v_scale_to_f32, v_scale_mul_zp) \
            v_gemmcast_i32_to_f32_v(y_f64, x, v_scale_to_f32, v_scale_mul_zp)

        #define v_gemmcast_f32_to_8bit_v(y_c256, x_f64, scale_to_int, zero_point, y_i32, lane_sel)\
            v_gemmcast_f32_to_i8_v(y_c256, x_f64, scale_to_int, zero_point, y_i32, lane_sel)

#endif
# 1097 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"


//  UINT16  ****************************************************************
#if 0 /* disabled by -frewrite-includes */
#if defined(UINT16)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 1101 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 128

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1105 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_16
    #else
# 1107 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_2b_b()
    #endif
# 1109 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // scalar instructions
        #define s_mov_s_b(a, s, p, pp) \
                s_u16_mov(a, 0, s, p, pp)

        #define s_mov_s_vb(a, s, p, pp) \
                s_u16_mov_s_vb(a, s, p, pp)

        #define v_mov_s_vb(a, s, p, pp) \
                v_u16_mov_vb(a, 0, s, to_bool128(p), pp)

        #define v_mov_s_b(a, s, p, pp) \
                v_u16_mov_b(a, 0, s, p, pp)

        //uint16_t s_u16_ld_g(__global__ void* a);
        #define s_ld_g_a(a) \
                s_u16_ld_g(a)

        #define s_ld_g_a_b(a, i, p, o) \
                s_u16_ld_g(a, 0, i, p, o)

        #define s_st_g_a_s(a, s) \
                s_u16_st_g(a, s)

        #define s_add_s_s_b(a, b, i, p, o)\
                s_u16_add(a, b, 0, i, p, o)

        #define v_ld_g_a(a) \
                v_u16_ld_g(a)

        // SINGLE LOAD AND STORE INSTRUCTIONS
        // ushort128 v_u16_ld_tnsr_b(int5 a, tensor b);
        #define v_ld_tnsr_i(a, b) \
                v_u16_ld_tnsr_b(a, b)

        // ushort128 v_i16_ld_tnsr_b(int5 a, tensor b, 0, ushort128 source, bool predicate,
        //                                                  bool predicatePolarity);
        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity)\
                v_u16_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_u16_ld_tnsr_partial_b(coord, tnst, size, offset)

        //ushort128 v_i16_ld_tnsr_b(int5 a, int8_t b);
        #define v_ld_tnsr_reg_i_s(a, b) \
                v_u16_ld_tnsr_b(a, b)

        //ushort128 v_i16_ld_tnsr_vb(int5 a, int8_t b, 0, ushort128 source,
        //                               to_bool128(bool256 predicate), bool predicatePolarity);
        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_u16_ld_tnsr_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        //ushort128 v_u16_ld_g(__global__ void* a, 0, ushort128 source, bool predicate,
        //                                                                bool predicatePolarity);
        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_u16_ld_g(a, 0, source, predicate, predicatePolarity)

        // void  v_u16_st_tnsr(int5 a, tensor b, ushort128 c);
        #define st_tnsr_i_v(a, b, c) \
                v_u16_st_tnsr(a, b, c)

        // void  v_i16_st_tnsr(int5 a, tensor b, ushort128 c, 0, bool predicate,
        //                                                  bool predicatePolarity);
        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_u16_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        // void v_u16_st_tnsr(int5 a, int8_t b, ushort128 c);
        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_u16_st_tnsr(a, b, c)

        // void v_u16_st_tnsr(int5 a, int8_t b, ushort128 c, 0, bool predicate,
        //                                                                  bool predicatePolarity);
        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_u16_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_u16_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_u16_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_u16_st_tnsr_partial(n, t, v, s, f, 0, p, o)

        #define v_shl_v_v(a, b) \
                v_u16_shl_b(a, (short128)b)

        #define v_shr_v_v(a, b) \
                v_u16_shr_b(a, (short128)b)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_u16_add_vb(a, b, SW_SAT, source, to_bool128(predicate), predicatePolarity)

        #define v_shuffle_v_v(a, b) \
                v_u16_shuffle_b(a, b, 0, a)

        #define v_shuffle_v_v_b(a, b, p, o) \
                v_u16_shuffle_b(a, b, 0, a, p, o)

        #define v_mov_group_v( a, b, source, group_en, dual_group_en) \
                v_u16_mov_group_b(a, b, (dual_group_en << 2) | group_en, source)

        #define v_mov_group_v_b( a, b, source, group_en, dual_group_en, p, o) \
                v_u16_mov_group_b(a, b, (dual_group_en << 2) | group_en, source, p, o)

        #define av_f32_sub_av_av(acc_out, acc_in1, acc_in2) \
                (acc_out).v1 = v_f32_sub_b((acc_in1).v1, (acc_in2.v1), SW_NO_NEG); \
                (acc_out).v2 = v_f32_sub_b((acc_in1).v2, (acc_in2.v2), SW_NO_NEG);

        #define av_f32_sub_av_s(acc_out, acc_in, scale) \
                (acc_out).v1 = v_f32_sub_b((acc_in).v1, (scale), SW_NO_NEG); \
                (acc_out).v2 = v_f32_sub_b((acc_in).v2, (scale), SW_NO_NEG);

        #define av_f32_mul_v_v(acc_out, acc_in1, acc_in2) \
                (acc_out).v1 = v_f32_mul_b((acc_in1).v1, (acc_in2).v1); \
                (acc_out).v2 = v_f32_mul_b((acc_in1).v2, (acc_in2).v2);

        #define av_f32_mul_v_s(acc_out, acc_in, scale) \
                (acc_out).v1 = v_f32_mul_b((acc_in).v1, scale); \
                (acc_out).v2 = v_f32_mul_b((acc_in).v2, scale);

        #define av_f32_mac_v_vs(acc_out, acc_in, scale, zp) \
                (acc_out).v1 = v_f32_mac_b((acc_in).v1, (scale), (zp), SW_NO_NEG); \
                (acc_out).v2 = v_f32_mac_b((acc_in).v2, (scale), (zp), SW_NO_NEG);

        #define v_add_v_v(a, b, st) \
                v_u16_add_b(a, b, st)

        #define v_add_v_v_b(a, b, source, predicate, predicatePolarity) \
                v_u16_add_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_not_v(a) \
        v_u16_not_b(a)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity) \
                v_u16_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                        polarity)

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 1249 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        //int128  av_mac_acc32_v_v (ushort128 a, ushort b, int128 src, e_saturation st)
        #define av_mac_acc32_v_s(a, b, src, st )\
                v_u16_mac_acc32_b(a, b, src, st)

        //int128  av_mac_acc32_v_v (ushort128 a, ushort128 b, int128 src, e_saturation st)
        #define av_mac_acc32_v_v(a, b, src, st )\
                v_u16_mac_acc32_b(a, b, src, st)

        #define v_mov_dual_group_all_v(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3) \
                v_u16_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src)

        #define v_mov_dual_group_all_v_b(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3, p, o) \
                v_u16_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src, p, o)
#endif
# 1263 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        typedef ushort128  VECTOR;
        typedef uint16_t   SCALAR;
        typedef uint128    ACC_VECTOR;
        typedef int128     SIGNED_ACC_VECTOR;
        typedef float128   FLOAT_ACC_VECTOR;

        #define MAX_POSITIVE            (65535U)
        #define UNSIGNED_PAIR_T         uint16_t_pair_t
        #define PAIR_T                  UNSIGNED_PAIR_T
        #define SCALAR_T                uint16_t
        #define UNSIGNED_SCALAR_T       uint16_t
        #define INT_STEP                15
        #define div_mod_i               div_mod_u16
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1278 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u16_udiv_step(a, s, 0, i)
        #endif
# 1280 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined( __gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1281 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u16_udiv_4step(a, s, 0, i)
        #endif
# 1283 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 1284 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u16_udiv_4step(a, s, SW_X2_UDIV_4STEP, i)
        #endif
# 1286 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1287 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u16_udiv_both(a, s, SW_DIV_MODE_BOTH, i)
        #endif
# 1289 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"


#endif
# 1292 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

//  INT16  *****************************************************************
#if 0 /* disabled by -frewrite-includes */
#if defined(INT16)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1295 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1297 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
                #define DOUBLE_DEFINITION
        #endif
# 1299 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 128

        #define VECTOR_SIZE_LOG_2 7

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1305 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_16
    #else
# 1307 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_2b_b()
    #endif
# 1309 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define bv_ucmp_less_v_s(a, b)\
                from_bool128(v_u16_cmp_less_b(a, b));

        //bool256 from_bool128(v_u16_cmp_geq_b(ushort128 a, uint16_t b));
        #define bv_cmp_geq_v_s(a, b)\
                from_bool128(v_u16_cmp_geq_b(a, b))

        #define bv_cmp_geq_v_v(a, b)\
                from_bool128(v_u16_cmp_geq_b(a, b))

        #define bv_cmp_geq_v_s_b(a, b, source, predicate, predicatePolarity) \
                from_bool128(v_u16_cmp_geq_b(a, b, 0, to_bool128(source),    \
                predicate, predicatePolarity))

        #define bv_ucmp_grt_v_s(a, b)\
                from_bool128(v_u16_cmp_grt_b(a, b))

        // scalar instructions
        #define s_mov_s_b(a, s, p, pp) \
                s_i16_mov(a, 0, s, p, pp)

        #define s_mov_s_vb(a, s, p, pp) \
                s_i16_mov_s_vb(a, s, p, pp)

        #define v_mov_s_vb(a, s, p, pp) \
                v_i16_mov_vb(a, 0, s, to_bool128(p), pp)

        #define v_mov_s_b(a, s, p, pp) \
                v_i16_mov_b(a, 0, s, p, pp)

        //int16_t s_i16_ld_g(__global__ void* a);
        #define s_ld_g_a(a) \
                s_i16_ld_g(a)

        #define s_ld_g_a_b(a, i, p, o) \
                s_i16_ld_g(a, 0, i, p, o)

        #define s_st_g_a_s(a, s) \
                s_i16_st_g(a, s)

        #define v_ld_g_a(a) \
                v_i16_ld_g(a)

        // SINGLE LOAD AND STORE INSTRUCTIONS
        // short128 v_i16_ld_tnsr_b(int5 a, tensor b);
        #define v_ld_tnsr_i(a, b) \
                v_i16_ld_tnsr_b(a, b)

        // short128 v_i16_ld_tnsr_b(int5 a, tensor b, 0, short128 source, bool predicate,
        //                                                  bool predicatePolarity);
        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity)\
                v_i16_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_i_vb(a, b, source, predicate, predicatePolarity) \
                v_i16_ld_tnsr_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_i16_ld_tnsr_partial_b(coord, tnst, size, offset)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity) \
                v_i16_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                        polarity)

        //short128 v_i16_ld_tnsr_b(int5 a, int8_t b);
        #define v_ld_tnsr_reg_i_s(a, b) \
                v_i16_ld_tnsr_b(a, b)

        //short128 v_i16_ld_tnsr_vb(int5 a, int8_t b, 0, short128 source,
        //                    to_bool128(bool256 predicate),              bool predicatePolarity);
        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_i16_ld_tnsr_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        //short128 v_i16_ld_g(__global__ void* a, 0, short128 source, bool predicate,
        //                                                                bool predicatePolarity);
        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_i16_ld_g(a, 0, source, predicate, predicatePolarity)

        // void  v_i16_st_tnsr(int5 a, tensor b, short128 c);
        #define st_tnsr_i_v(a, b, c) \
                v_i16_st_tnsr(a, b, c)

        // void  v_i8_st_tnsr(int5 a, tensor b, char256 c, 0, bool predicate,
        //                                                  bool predicatePolarity);
        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_i16_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        // void v_i16_st_tnsr(int5 a, int8_t b, short128 c);
        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_i16_st_tnsr(a, b, c)

        // void v_i16_st_tnsr(int5 a, int8_t b, short128 c, 0, bool predicate,
        //                                                                  bool predicatePolarity);
        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_i16_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_i16_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_i16_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_i16_st_tnsr_partial(n, t, v, s, f, 0, p, o)

        // SINGLE ARITHMETIC INSTRUCTIONS
        // short128 v_i16_abs_b(short128 a);
        #define v_abs_v(a) \
                v_i16_abs_b(a)

        // short128 v_i16_add_b(short128 a, short128 b, e_saturation st, short128 source,
        //                                               bool predicate, bool predicatePolarity);
        #define v_add_v_v(a, b, st) \
                v_i16_add_b(a, b, st)

        #define v_add_v_v_b(a, b, source, predicate, predicatePolarity) \
                v_i16_add_b(a, b, 0, source, predicate, predicatePolarity)

        // short128 v_i16_add_b(short128 a, int16_t b, e_saturation st);
        #define v_add_v_s(a, b, st) \
                v_i16_add_b(a, b, st)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_i16_add_vb(a, b, SW_SAT, source, to_bool128(predicate), predicatePolarity)

        // short128 v_i16_sub_b(short128 a, short128 b, e_saturation st, short128 source,
        //bool predicate, bool predicatePolarity);
        #define v_sub_v_v(a, b, st) \
                v_i16_sub_b(a, b, st)

        // short128 v_i16_sub_b(short128 a, int16_t b, e_saturation st);
        #define v_sub_v_s(v, s, st)\
            v_i16_sub_b((v), (s), (st))

        // int16_t s_i16_ash(int16_t a, int16_t b, bool RHU << 1);
        #define s_ash_s_s(a, b, RHU)\
            s_i16_ash((a), (b), (RHU) << 1)

        #define s_add_s_s_b(a, b, i, p, o)\
                s_i16_add(a, b, 0, i, p, o)

        //int128 v_i16_mul_vb(short128 a, int16_t b, 0,int128 source, to_bool128(bool256 predicate),
        //                                                  bool predicatePolarity);
        #define av_mul_v_s_vb(a, b, source, predicate, predicatePolarity )\
                v_i16_mul_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        // int128 v_i16_mac_vb(short128 a, int16_t b, int128 source, e_saturation st, to_bool128(
        //                                             bool256 predicate), bool predicatePolarity);
        #define av_mac_v_s_vb(a, b, source, st, predicate, predicatePolarity )\
        v_i16_mac_vb(a, b, source, st, to_bool128(predicate), predicatePolarity)

        // int128 v_i16_mac_b(short128 a, int16_t b, int128 source, e_saturation st,
        //bool predicate, bool predicatePolarity);
        #define av_mac_v_s_b(a, b, source, st, predicate, predicatePolarity )\
        v_i16_mac_b(a, b, source, st, predicate, predicatePolarity)

        // int128 v_i16_mac_b(short128 a, short128 b, int128 source, e_saturation st,
        //bool predicate, bool predicatePolarity);
        #define av_mac_v_v_b(a, b, source, st, predicate, predicatePolarity )\
        v_i16_mac_b(a, b, source, st, predicate, predicatePolarity)

        // int128 v_i16_mac_b(short128 a, int16_t b, e_saturation st);
        #define av_mac_v_s(a, b, src, st )\
        v_i16_mac_b(a, b, src, st)

        // int128 v_i16_mac_b(short128 a, int16_t b, e_saturation st);
        #define av_mac_v_v(a, b, src, st )\
        v_i16_mac_b(a, b, src, st)

        // int32_t s_i8_mac(int8_t a, int8_t b, int32_t source, e_saturation st);
        #define s_mac_s_s(a, b, src, st )\
        s_i16_mac(a, b, src, st)

        #define av_mac_x2_v_s_v_s_b(a, b, c, d, src, sw, predicate, predicatePolarity) \
                src = v_i16_mac_b(a, b, src, sw, predicate, predicatePolarity); \
                src = v_i16_mac_b(c, d, src, sw, predicate, predicatePolarity);

        #define av_mac_x2_v_s_v_s(a, b, c, d, src, sw) \
                src = v_i16_mac_b(a, b, src, sw); \
                src = v_i16_mac_b(c, d, src, sw);

        // int32_t s_i16_mul(int8_t a, int8_t b);
        #define s_mul_s_s(a, b)\
                s_i16_mul(a, b)

        #define av_mul_v_v(a, b)\
                v_i16_mul_b(a, b)

        #define av_mul_v_s(a, b)\
                v_i16_mul_b(a, b)

        // SINGLE LOGICAL INSTRUCTIONS

        // short128 v_i16_min_b(short128 a, int16_t b);
        #define v_min_v_s(a, b) \
                v_i16_min_b(a, b)

        // short128 v_i16_min_b(short128 a, short128 b);
        #define v_min_v_v(a,b) \
                v_i16_min_b(a, b)

        // short128 v_i16_max_b(short128 a, int16_t b);
        #define v_max_v_s(a, b) \
                v_i16_max_b(a, b)

        // short128 v_i16_max_b(short128 a, short128 b);
        #define v_max_v_v(a,b) \
                v_i16_max_b(a, b)

        // short128 v_i16_max_b(short128 a, short128 b, 0, short128 source, bool predicate,
        //                                                  bool predicatePolarity);
        #define v_max_v_v_b(a,b,source,predicate,predicatePolarity) \
                v_i16_max_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_shuffle_v_v(a, b) \
            v_i16_shuffle_b(a, b, 0, a)

        // short128 v_i16_shuffle_vb(short128 a, uchar256 b, 0, short128 source,
        //                               to_bool128(bool256 predicate),  bool predicatePolarity);
        #define v_shuffle_v_v_vb(a, b, source, predicate, predicatePolarity) \
            v_i16_shuffle_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        //short128 v_i16_sel_grt_i16_b(short128 a, short128 b, short128 c, short128 d);
        #define v_sel_grt_v_v_v_v(a, b, c, d) \
                v_i16_sel_grt_i16_b(a, b, c, d)

        #define v_sel_geq_v_v_v_v(a, b, c, d) \
                v_i16_sel_geq_i16_b(a, b, c, d)

        #define v_sel_less_v_v_v_v(a, b, c, d) \
                v_i16_sel_less_i16_b(a, b, c, d)

        #define v_sel_less_v_v_v_v(a, b, c, d) \
                v_i16_sel_less_i16_b(a, b, c, d)

        #define v_sel_leq_v_v_v_v(a, b, c, d) \
                v_i16_sel_leq_i16_b(a, b, c, d)

        #define v_sel_eq_v_v_v_v(a, b, c, d) \
                v_i16_sel_eq_i16_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v(a, b, c, d) \
                v_i16_sel_neq_i16_b(a, b, c, d)

        #define v_sel_grt_v_s_v_v(a, b, c, d) \
                v_i16_sel_grt_i16_b(a, b, c, d)

        #define v_sel_geq_v_s_v_v(a, b, c, d) \
                v_i16_sel_geq_i16_b(a, b, c, d)

        #define v_sel_less_v_s_v_v(a, b, c, d) \
                v_i16_sel_less_i16_b(a, b, c, d)

        #define v_sel_less_v_s_v_v_b(a, b, c, d, i, p, o) \
                v_i16_sel_less_i16_b(a, b, c, d, 0, i, p, o)

        #define v_sel_geq_v_s_v_v_b(a, b, c, d, i, p, o) \
                 v_i16_sel_geq_i16_b(a, b, c, d, 0, i, p, o)

        #define v_sel_leq_v_s_v_v(a, b, c, d) \
                v_i16_sel_leq_i16_b(a, b, c, d)

        #define v_sel_eq_v_s_v_v(a, b, c, d) \
                v_i16_sel_eq_i16_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v_vb(a, b, c, d, e, f, g) \
                v_i16_sel_neq_i16_vb(a, b, c, d, 0, e, to_bool128(f), g)

        #define v_and_v_v(a, b) \
                v_i16_and_b(a, b)

        #define v_or_v_v(a, b) \
                v_i16_or_b(a, b)

        #define v_xor_v_v(a, b) \
                v_i16_xor_b(a, b)

        #define v_not_v(a) \
                v_i16_not_b(a)

        #define v_shl_v_v(a, b) \
                v_i16_shl_b(a, (short128)b)

        #define v_shr_v_v(a, b) \
                v_i16_shr_b(a, (short128)b)

        #define v_ash_v_v(a, b, rne) \
                v_i16_ash_b(a, (char256)b, rne << 1)

        // bool256 from_bool128(v_i16_cmp_grt_b(short128 a, int16_t b));
        #define bv_cmp_grt_v_s(a, b) \
                from_bool128(v_i16_cmp_grt_b(a, b))

        #define bv_cmp_grt_v_v(a, b) \
                from_bool128(v_i16_cmp_grt_b(a, b))

        // bool256 from_bool128(v_i16_cmp_less_b(short128 a, int16_t b));
        #define bv_cmp_less_v_s(a, b)\
            from_bool128(v_i16_cmp_less_b((a), (b)))

        #define bv_cmp_less_v_v(a, b)\
            from_bool128(v_i16_cmp_less_b((a), (b)))

        // bool256 from_bool128(v_i16_cmp_leq_b(short128 a, int16_t b));
        #define bv_cmp_leq_v_s(a, b)\
            from_bool128(v_i16_cmp_leq_b((a), (b)))

        #define bv_cmp_neq_v_v(a, b)\
                from_bool128(v_i16_cmp_neq_b(a, b))

        // short128 v_convert_int32_to_i16_b(int64 a, char256 b, short128 source,
        //e_round_mode round, int lane_sel, bool predicate, bool predicatePolarity);
#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1623 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v_b(a, b, source, round, lane_sel, predicate, predicatePolarity)\
        v_convert_int32_to_i16_b(a, b, lane_sel, round, source, \
                                 predicate, predicatePolarity);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1627 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v_b(a, b, source, round, lane_sel, predicate, predicatePolarity)\
        v_convert_int32_to_i16_single_b(a, b, lane_sel, round, source, \
                                 predicate, predicatePolarity);
#endif
# 1631 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // short128 v_convert_int32_to_i16_b(int64 a, int8_t b, short128 source,
        //e_round_mode round, int lane_sel, bool predicate, bool predicatePolarity);
#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1635 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s_b(a, b, source, round, lane_sel, predicate, predicatePolarity)\
        v_convert_int32_to_i16_b(a, b, lane_sel, round, source,\
                                  predicate, predicatePolarity);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1639 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s_b(a, b, source, round, lane_sel, predicate, predicatePolarity)\
        v_convert_int32_to_i16_single_b(a, b, lane_sel, round, source, \
                                 predicate, predicatePolarity);
#endif
# 1643 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // short128 v_convert_int32_to_i16_b(int64 a, int16_t b, short128 source,
        //e_round_mode round, int lane_sel);
#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1647 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s(a, b, source, round, lane_sel)\
        v_convert_int32_to_i16_b(a, b, lane_sel, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1650 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s(a, b, source, round, lane_sel)\
        v_convert_int32_to_i16_single_b(a, b, lane_sel, round, source);
#endif
# 1653 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // char256 v_convert_int32_to_i16_b(int64 a, char256 b, char256 source,
        //e_round_mode round, int lane_sel);
#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1657 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v(a, b, source, round, lane_sel)\
        v_convert_int32_to_i16_b(a, b, lane_sel, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1660 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v(a, b, source, round, lane_sel)\
        v_convert_int32_to_i16_single_b(a, b, lane_sel, round, source);
#endif
# 1663 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define av_convert_f32_to_int_v(i, f32, i32, i8, RHU)\
        v_cast_f32_to_i16_v((f32).v1, (i), (i32), 0)\
        v_cast_f32_to_i16_v((f32).v2, (i), (i32), 1)

        #define av_convert_int_to_f32_v(u, i)\
        (u).acc_i32 = v_i16_mul_b((i), 1);\
        (u).acc_f32.v1 = v_convert_i32_to_f32_b((u).acc_i32.v1, SW_RHNE);\
        (u).acc_f32.v2 = v_convert_i32_to_f32_b((u).acc_i32.v2, SW_RHNE);

        #define v_mov_s(a) \
                v_i16_mov_b(a)

        #define v_mov_v(a) \
                (a)

        #define v_mov_v_vb(a, b, predicate, predicatePolarity) \
                v_i16_mov_vb(a, 0, b, to_bool128(predicate), predicatePolarity)

        #define v_mov_v_b(a, b, predicate, predicatePolarity)\
                v_i16_mov_b(a, 0, b, predicate, predicatePolarity)

        #define v_mov_group_v( a, b, source, group_en, dual_group_en) \
                v_i16_mov_group_b(a, b, (dual_group_en << 2) | group_en, source)

        // COMPLEX LOGICAL INSTRUCTIONS
        #define v_ld_acc_i(acc, cords, tensor, dim) \
        acc.v1 = v_i32_ld_tnsr_b(cords, tensor); cords = i_i32_add(64, cords, dim, 0, cords);\
        acc.v2 = v_i32_ld_tnsr_b(cords, tensor); cords = i_i32_add(64, cords, dim, 0, cords);

        #define v_ld_l_acc(acc, vlm) \
        (acc).v1 = (vlm)[0];\
        (acc).v2 = (vlm)[1];

        #define st_l_acc(vlm, acc) \
        (vlm)[0] =  (acc).v1;\
        (vlm)[1] =  (acc).v2;

        #define av_ld_f32_acc(acc, cords, tensor, step)                                            \
        (acc).v1 = v_f32_ld_tnsr_b((cords), (tensor)); (cords) = i_i32_add((step), (cords), 0b1, 0,\
                                                       (cords), 1, 0);                             \
        (acc).v2 = v_f32_ld_tnsr_b((cords), (tensor)); (cords) = i_i32_add((step),                 \
                                                       (cords), 0b1, 0, (cords), 1, 0);

        // LOAD PREDICATE TENSOR
        #define bv_ld_tnsr_i_av(acc, cords, tensor, step, dim) \
        acc.v1 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords); \
        acc.v2 = v_i1_ld_tnsr_b(cords, tensor);

        // short128 v_i16_add_b(short128 a, short128 b, e_saturation st);
        #define av_add_av_av(acc0, acc1, acc2, SAT)\
        acc0.v1 = v_i32_add_b(acc1.v1, acc2.v1, SAT);\
        acc0.v2 = v_i32_add_b(acc1.v2, acc2.v2, SAT);

        // int64 v_i32_add_b(int64 a, int32_t b, e_saturation st);
        #define av_add_av_s(acc_out, acc_in, scalar, SAT)\
        acc_out.v1 = v_i32_add_b(acc_in.v1, scalar, SAT);\
        acc_out.v2 = v_i32_add_b(acc_in.v2, scalar, SAT);

        // int64 v_i32_sub_b(int64 a, int32_t b, e_saturation st);
        #define av_sub_av_s(acc_out, acc_in, scalar, SAT)\
        acc_out.v1 = v_i32_sub_b(acc_in.v1, scalar, SAT);\
        acc_out.v2 = v_i32_sub_b(acc_in.v2, scalar, SAT);

        // short128 v_i16_sub_b(short128 a, short128 b, e_saturation st);
        #define av_sub_av_av(acc0, acc1, acc2, SAT)\
        acc0.v1 = v_i32_sub_b(acc1.v1, acc2.v1, SAT);\
        acc0.v2 = v_i32_sub_b(acc1.v2, acc2.v2, SAT);

        #define av_sub_v_av(acc_out, vec, acc_in, SAT)\
        acc_out.v1 = v_i32_sub_b(vec, acc_in.v1, SAT);\
        acc_out.v2 = v_i32_sub_b(vec, acc_in.v2, SAT);

        #define av_i32_ash_av_av(acc0, acc1, acc2, RHU)           \
        acc0.v1 = v_i32_ash_b(acc1.v1, acc2.v1, RHU << 1); \
        acc0.v2 = v_i32_ash_b(acc1.v2, acc2.v2, RHU << 1);

        #define av_ash_av_s(acc0, acc1, shift, RHU) \
        acc0.v1 = v_i32_ash_b(acc1.v1, shift, RHU << 1);   \
        acc0.v2 = v_i32_ash_b(acc1.v2, shift, RHU << 1);

        #define av_max_av_av(acc0, acc1, acc2)\
        acc0.v1 = v_i32_max_b(acc1.v1, acc2.v1);\
        acc0.v2 = v_i32_max_b(acc1.v2, acc2.v2);

        #define av_max_av_s(acc0, acc1, scalar)\
        acc0.v1 = v_i32_max_b(acc1.v1, scalar);\
        acc0.v2 = v_i32_max_b(acc1.v2, scalar);

        #define av_min_av_av(acc0, acc1, acc2)\
        acc0.v1 = v_i32_min_b(acc1.v1, acc2.v1);\
        acc0.v2 = v_i32_min_b(acc1.v2, acc2.v2);

        #define av_min_av_s(acc0, acc1, scalar)\
        acc0.v1 = v_i32_min_b(acc1.v1, scalar);\
        acc0.v2 = v_i32_min_b(acc1.v2, scalar);

        #define av_sel_grt_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_grt_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_grt_i32_b(acc1.v2, acc2.v2, outTrue, outFalse);

        #define av_sel_grt_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_grt_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_grt_i32_b(acc1.v2, scalar, outTrue, outFalse);

        #define av_sel_geq_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_geq_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_geq_i32_b(acc1.v2, acc2.v2, outTrue, outFalse);

        #define av_sel_geq_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_geq_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_geq_i32_b(acc1.v2, scalar, outTrue, outFalse);

        #define av_sel_less_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_less_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_less_i32_b(acc1.v2, acc2.v2, outTrue, outFalse);

        #define av_sel_less_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_less_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_less_i32_b(acc1.v2, scalar, outTrue, outFalse);

        #define av_sel_leq_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_leq_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_leq_i32_b(acc1.v2, acc2.v2, outTrue, outFalse);

        #define av_sel_leq_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_leq_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_leq_i32_b(acc1.v2, scalar, outTrue, outFalse);

        #define av_sel_eq_av_av_v_v(acc0, acc1, acc2, outTrue, outFalse)   \
        acc0.v1 = v_i32_sel_eq_i32_b(acc1.v1, acc2.v1, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_eq_i32_b(acc1.v2, acc2.v2, outTrue, outFalse);

        #define av_sel_eq_av_s_v_v(acc0, acc1, scalar, outTrue, outFalse) \
        acc0.v1 = v_i32_sel_eq_i32_b(acc1.v1, scalar, outTrue, outFalse); \
        acc0.v2 = v_i32_sel_eq_i32_b(acc1.v2, scalar, outTrue, outFalse);

        // int64 v_convert_i16_to_i32_b(short128 a);
        #define av_convert_to_i32_av(acc_in, acc_out)   \
        acc_out.v1 = v_convert_i16_to_i32_b(acc_in.v1); \
        acc_out.v2 = v_convert_i16_to_i32_b(acc_in.v2);

        // short128 v_i16_unpack_b(short128 a, ((e_group_source group_source) << 8) | ((
        //                                       e_element_stride element_stride) << 9) |
        //                                     ((e_group_half group_half) << 10), short128 source);
        #define av_unpack_to_i32_v(input, acc_out) \
        acc_out.v1 = 0, acc_out.v2 = 0; \
        acc_out.v1 = v_i16_unpack_b(input, SW_GROUP_0 | ((\
                SW_STRIDE_2)) | SW_GROUP_HALF_0, acc_out.v1, 1, 0); \
        acc_out.v2 = v_i16_unpack_b(input, SW_GROUP_1 | ((\
                SW_STRIDE_2)) | SW_GROUP_HALF_0, acc_out.v2, 1, 0);

        // ushort128 v_u16_unpack_b(ushort128 a, ((e_group_source group_source) << 8) | ((
        //                                        e_element_stride element_stride) << 9) |
        //                                      ((e_group_half group_half) << 10), ushort128 source)
        #define av_u_unpack_convert_to_i32_av(input, acc_out1, acc_out2) \
        acc_out1.v1 = 0, acc_out1.v2 = 0; \
        acc_out1.v1 = v_u16_unpack_b(input, SW_GROUP_0 | ((\
                SW_STRIDE_2)) | SW_GROUP_HALF_0, acc_out1.v1 , 1, 0); \
        acc_out1.v2 = v_u16_unpack_b(input, SW_GROUP_1 | ((\
                SW_STRIDE_2)) | SW_GROUP_HALF_0, acc_out1.v2 , 1, 0); \
        acc_out2.v1 = (int64)acc_out1.v1;\
        acc_out2.v2 = (int64)acc_out1.v2;

        // char256 v_convert_int32_to_i8_b(int64 a, int8_t b, char256 source, e_round_mode round,
        //int lane_sel);
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1830 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s(acc, shift, source, round)\
        source = v_convert_int32_to_i16_b(acc.v1, shift, 0, round, source);\
        source = v_convert_int32_to_i16_b(acc.v2, shift, 1, round, source);

#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1835 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(32, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1836 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s(acc, shift, source, round)\
        source = v_convert_int32_to_i16_all_b(acc, shift, round, source)
        #else
# 1839 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s(acc, shift, source, round)\
        source = v_convert_i32_to_i16_all_b(acc, shift, round, source, 1, 0)
        #endif
# 1842 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#else
# 1843 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_s() is not defined"
#endif
# 1845 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1847 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s_vb(acc, shift, source, round, vb, b)                            \
        source = v_convert_int32_to_i16_vb(acc.v1, shift, 0, round, source,           \
                                                                              to_bool64(vb), b);\
        source = v_convert_int32_to_i16_vb(acc.v2, shift, 1, round, source,           \
                                                                              to_bool64(vb), b);
        #define av_convert_av_v_vb(acc, shift, source, round, vb, b)                            \
        source = v_convert_int32_to_i16_vb(acc.v1, shift, 0, round, source,           \
                                                                              to_bool64(vb), b);\
        source = v_convert_int32_to_i16_vb(acc.v2, shift, 1, round, source,           \
                                                                              to_bool64(vb), b);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1858 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s_vb(acc, shift, source, round, vb, b)                            \
        source = v_convert_int32_to_i16_single_vb(acc.v1, shift, 0, round, source,    \
                                                                              to_bool64(vb), b);\
        source = v_convert_int32_to_i16_single_vb(acc.v2, shift, 1, round, source,    \
                                                                              to_bool64(vb), b);
        #define av_convert_av_v_vb(acc, shift, source, round, vb, b)                            \
        source = v_convert_int32_to_i16_single_vb(acc.v1, shift, 0, round, source,    \
                                                                              to_bool64(vb), b);\
        source = v_convert_int32_to_i16_single_vb(acc.v2, shift, 1, round, source,    \
                                                                              to_bool64(vb), b);
#else
# 1869 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_s_vb() is not defined"
#endif
# 1871 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"


#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1874 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_v(acc, shift, source, round)\
        source = v_convert_int32_to_i16_b(acc.v1, shift, 0, round, source);\
        source = v_convert_int32_to_i16_b(acc.v2, shift, 1, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1878 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(32, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1879 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define av_convert_av_v(acc, shift, source, round)\
            source = v_convert_int32_to_i16_all_b(acc, shift, round, source)
        #else
# 1882 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define av_convert_av_v(acc, shift, source, round)\
            source = v_convert_i32_to_i16_all_b(acc, shift, round, source, 1, 0)
        #endif
# 1885 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#else
# 1886 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_v() is not defined"
#endif
# 1888 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1890 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define EXP_I16 exp_i16_128_entries
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__)  || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1892 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define EXP_I16 exp_i16
#endif
# 1894 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1896 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_v_first(acc, shift, source, round)                         \
        source = v_convert_int32_to_i16_b(acc.v1, shift, 0, round, 0);         \
        source = v_convert_int32_to_i16_b(acc.v2, shift, 1, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1900 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_v_first(acc, shift, source, round)\                        \
        source = v_convert_int32_to_i16_single_b(acc.v1, shift, 0, round, 0);  \
        source = v_convert_int32_to_i16_single_b(acc.v2, shift, 1, round, source);
#else
# 1904 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_v_first() is not defined"
#endif
# 1906 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // char256 v_convert_int32_to_i8_b(int64 a, char256 b, char256 source, e_round_mode round,
        //int lane_sel);
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1910 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_av(acc, shift, source, round)\
        source = \
           v_convert_int32_to_i16_b(acc.v1, (char256) shift.v1, 0, round, source);\
        source = \
            v_convert_int32_to_i16_b(acc.v2, (char256) shift.v2, 1, round, source);

#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 1917 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_av(acc, shift, source, round)\
        source = \
           v_convert_int32_to_i16_single_b(acc.v1, (char256) shift.v1, 0, round, source);\
        source = \
           v_convert_int32_to_i16_single_b(acc.v2, (char256) shift.v2, 1, round, source);
#else
# 1923 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_av() is not defined"
#endif
# 1925 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define av_i32_mul_double_and_round_v_s(acc_out, acc_in, scale) \
        acc_out.v1 = v_i32_mul_round_b(acc_in.v1, scale); \
        acc_out.v2 = v_i32_mul_round_b(acc_in.v2, scale);

        #define av_f32_mul_v_v(acc_out, acc_in1, acc_in2) \
        (acc_out).v1 = v_f32_mul_b((acc_in1).v1, (acc_in2).v1); \
        (acc_out).v2 = v_f32_mul_b((acc_in1).v2, (acc_in2).v2);

        #define av_f32_mul_v_vs(acc_out, acc_in, scale) \
        (acc_out).v1 = v_f32_mul_b((acc_in).v1, (scale)); \
        (acc_out).v2 = v_f32_mul_b((acc_in).v2, (scale));

        #define av_f32_mac_v_vs(acc_out, acc_in, scale, zp) \
        (acc_out).v1 = v_f32_mac_b((acc_in).v1, (scale), (zp), SW_NO_NEG); \
        (acc_out).v2 = v_f32_mac_b((acc_in).v2, (scale), (zp), SW_NO_NEG);

        #define av_f32_mul_v_s(acc_out, acc_in, scale) \
        (acc_out).v1 = v_f32_mul_b((acc_in).v1, (scale)); \
        (acc_out).v2 = v_f32_mul_b((acc_in).v2, (scale));

        #define av_mov_zero(acc)\
        acc.v1 = 0;   acc.v2 = 0;

        #define av_mov_v(acc, vec)\
        acc.v1 = (vec);   acc.v2 = (vec);

        #define av_mov_s(acc, scalar)\
        acc.v1 = v_i32_mov_b(scalar); acc.v2 = v_i32_mov_b(scalar);

        #define av_mov_av(acc0, acc1)\
        acc0.v1 = (acc1.v1); acc0.v2 = (acc1.v2);

        #define s_i_mov_b(a, i, p, o) s_i16_mov(a, 0, i, p, o)

        typedef short128  VECTOR;
        typedef ushort128 UVECTOR;
        typedef int128    ACC_VECTOR;
        typedef float128  FLOAT_ACC_VECTOR;
        typedef short     SCALAR;
        typedef int       ACC_SCALAR;
        typedef ushort128 UINTVECTOR;

        typedef VECTOR     VEC_INT;
        typedef ACC_VECTOR ACC_VEC_INT;
        typedef SCALAR     INT;

        #define INT_MIN                     (-32768)
        #define MIN_VAL                     INT_MIN
        #define INT_MAX                     (32767)
        #define ABS_INT_MIN                  (32768U)
        #define SIGNED_PAIR_T               int16_t_pair_t
        #define UNSIGNED_PAIR_T             uint16_t_pair_t
        #define PAIR_T                      SIGNED_PAIR_T
        #define SCALAR_T                    int16_t
        #define UNSIGNED_SCALAR_T           uint16_t
        #define INT_STEP                    15
        #define SIGN_MASK                   ((int16_t)((uint16_t)1<<INT_STEP))
        #define div_mod_i                   div_mod_i16
        #define s_abs_s(a)                  s_i16_abs(a)
        #define s_xor_s_s(a, b)             s_i16_xor(a, b)
        #define s_and_s_s(a, b)             s_i16_and(a, b)
        #define NEG_OP(a)                   s_i16_sub((int16_t)0, (a), SW_SAT)
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1989 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u16_udiv_step(a, s, 0, i)
        #endif
# 1991 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1992 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u16_udiv_4step(a, s, 0, i)
        #endif
# 1994 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1995 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u16_udiv_4step(a, s, SW_X2_UDIV_4STEP, i)
        #endif
# 1997 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1998 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u16_udiv_both(a, s, SW_DIV_MODE_BOTH, i)
        #endif
# 2000 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define INIT_ACC_VEC_INT(a) a.v1 = 0; a.v2 = 0

        #define v_mov_dual_group_v(a, b, src, src_dual, dst_dual, wr_lower_group, wr_upper_group) \
        v_i16_mov_dual_group_b(a, b, src_dual, dst_dual, MkWr(wr_lower_group, wr_upper_group), src)

        #define v_mov_dual_group_v_vb(a, b, src, src_dual, dst_dual, wr_lower_group,   \
                                         wr_upper_group, predicate, predicatePolarity) \
                v_i16_mov_dual_group_vb(a, b, src_dual, dst_dual, MkWr(wr_lower_group, \
                                wr_upper_group), src, to_bool128(predicate), predicatePolarity)

#ifdef __gaudi__
        #define v_mov_dual_group_all_v(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3) \
                v_i16_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src)
#endif //__gaudi__
# 2015 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        typedef struct _acc_vec_float
        {
            float64 v1;
            float64 v2;
        } acc_vec_float;

        typedef union {
             float128      acc_f32;
             ACC_VEC_INT   acc_i32;
             VEC_INT       y;
        } acc_union_t;

#if 0 /* disabled by -frewrite-includes */
#if defined __goya2__
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2029 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_i32_to_f32_x2_av(acc_out, acc_in, RHU) \
            (acc_out) = v_convert_i32_to_f32_x2_b((acc_in), (RHU));
#else
# 2032 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_i32_to_f32_x2_av(acc_out, acc_in, RHU) \
            (acc_out).v1 = v_convert_i32_to_f32_b((acc_in).v1, RHU); \
            (acc_out).v2 = v_convert_i32_to_f32_b((acc_in).v2, RHU);
#endif  //__goya2__
# 2036 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#endif
# 2038 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"



//  INT32  *****************************************************************
#if 0 /* disabled by -frewrite-includes */
#if defined(INT32)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2043 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2045 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
                #define DOUBLE_DEFINITION
        #endif
# 2047 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 64

        #define VECTOR_SIZE_LOG_2 6

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2053 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_32
    #else
# 2055 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_4b_b()
    #endif
# 2057 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define bv_cmp_grt_v_v(a, b)\
                from_bool64(v_i32_cmp_grt_b(a, b))

        #define bv_cmp_less_v_v(a, b)\
                from_bool64(v_i32_cmp_less_b(a, b))

        #define bv_cmp_eq_v_v(a, b)\
                from_bool64(v_i32_cmp_eq_b(a, b))

        // scalar instructions
        #define b_cmp_eq_s_s(a, b)\
                s_i32_cmp_eq(a, b)

        #define b_cmp_neq_s_s(a, b)\
                s_i32_cmp_neq(a, b)

        #define b_cmp_grt_s_s(a, b)\
                s_i32_cmp_grt(a, b)

        #define s_mov_s_b(a, s, p, pp) \
                s_i32_mov(a, 0, s, p, pp)

        #define s_mov_s_vb(a, s, p, pp) \
                s_i32_mov_s_vb(a, s, p, pp)

        #define v_mov_s_vb(a, s, p, pp) \
                v_i32_mov_vb(a, 0, s, to_bool64(p), pp)

        #define v_mov_s_b(a, s, p, pp) \
                v_i32_mov_b(a, 0, s, p, pp)

        #define v_mov_v_vb(a, b, predicate, predicatePolarity) \
                v_i32_mov_vb(a, 0, b, to_bool64(predicate), predicatePolarity)

        #define v_mov_v_b(a, b, predicate, predicatePolarity)\
                v_i32_mov_b(a, 0, b, predicate, predicatePolarity)

        //int32_t s_i32_ld_g(__global__ void* a);
        #define s_ld_g_a(a) \
                s_i32_ld_g(a)

        #define s_ld_g_a_b(a, i, p, o) \
                s_i32_ld_g(a, 0, i, p, o)

        #define s_st_g_a_s(a, s) \
                s_i32_st_g(a, s)

        #define st_g_a_s_b(a, b, c, d) \
                s_i32_st_g(a, b, 0, c, d)

        #define v_ld_g_a(a) \
                v_i32_ld_g(a)

        //int64 v_i32_add_b(int64 a, int32_t b, e_saturation st);
        #define v_add_v_s(a, b, st) \
                v_i32_add_b(a, b, st)

        //int64 v_i32_sub_b(int64 a, int32_t b, e_saturation st);
        #define v_sub_v_s(a, b, st) \
                v_i32_sub_b(a, b, st)

        #define av_mul_v_v(a, b)\
                v_i32_mul_b(a, b)

        // SINGLE LOAD AND STORE INSTRUCTIONS
        // int64 v_i32_ld_tnsr_b(int5 a, tensor b);
        #define v_ld_tnsr_i(a, b) \
                v_i32_ld_tnsr_b(a, b)

        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity) \
                v_i32_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        //int64 v_i32_ld_tnsr_b(int5 a, int8_t b);
        #define v_ld_tnsr_reg_i_s(a, b) \
                v_i32_ld_tnsr_b(a, b)

        //int64 v_i32_ld_tnsr_vb(int5 a, int8_t b, 0, int64 source, to_bool64(bool256 predicate),
        //                                                                 bool predicatePolarity);
        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_i32_ld_tnsr_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        #define v_ld_tnsr_low_i(coords, tnsr) \
                v_i32_ld_tnsr_low_b(coords, tnsr)

        #define v_ld_tnsr_low_i_b(coords, tnsr, input, pred, o) \
                v_i32_ld_tnsr_low_b(coords, tnsr, 0, input, pred, o)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_i32_ld_tnsr_partial_b(coord, tnst, size, offset)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity) \
                v_i32_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                        polarity)

        //int64 v_i32_ld_g(__global__ void* a, 0, int64 source, bool predicate,
        //                                                                bool predicatePolarity);
        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_i32_ld_g(a, 0, source, predicate, predicatePolarity)

        #define bv_ld_tnsr_i_av(acc, cords, tensor, step, dim) \
                acc.v1 = v_i1_ld_tnsr_b(cords, tensor);

        #define v_ld_tnsr_i_vb(a, b, source, predicate, predicatePolarity) \
                v_i32_ld_tnsr_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        // void  v_i32_st_tnsr(int5 a, tensor b, int64 c);
        #define st_tnsr_i_v(a, b, c) \
                v_i32_st_tnsr(a, b, c)

        //void  v_i32_st_tnsr(int5 a, tensor b, int64 c, 0, bool predicate,
        //                                                  bool predicatePolarity);
        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_i32_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        // void v_i32_st_tnsr(int5 a, int8_t b, int64 c);
        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_i32_st_tnsr(a, b, c)

        // void v_i32_st_tnsr_low(int5 a, tensor b, int64 c);
        #define st_tnsr_low_i_v(a, b, c) \
                v_i32_st_tnsr_low(a, b, c)

        #define st_tnsr_low_i_v_b(coords, tnsr, c, predicate, predicatePolarity)    \
                v_i32_st_tnsr_low(coords, tnsr, c, 0, predicate, predicatePolarity) \

        // void v_i32_st_tnsr(int5 a, int8_t b, int64 c, 0, bool predicate,
        //                                                                  bool predicatePolarity);
        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_i32_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_i32_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_i32_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_i32_st_tnsr_partial(n, t, v, s, f, 0, p, o)

        #define v_mov_s(a) \
                v_i32_mov_b(a)

        #define v_mov_v(a) \
                (a)

        #define b_cmp_less_s_s(a, b)\
                s_i32_cmp_less(a, b)

        // SINGLE ARITHMETIC INSTRUCTIONS

        // int64 v_i32_abs_b(int64 a);
        #define v_abs_v(a) \
                v_i32_abs_b(a)

        // int64 v_i32_add_b(int64 a, int64 b, e_saturation st, int64 source, bool predicate,
        //                                                  bool predicatePolarity);
        #define v_add_v_v(a, b, st) \
                v_i32_add_b(a, b, st)

        #define v_add_v_v_b(a, b, source, predicate, predicatePolarity) \
                v_i32_add_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_i32_add_vb(a, b, SW_SAT, source, to_bool64(predicate), predicatePolarity)

        #define st_tnsr_rmw_i_v(a, b, c, rmw_op, rmw, tnsr_dt_location)\
        v_i32_st_tnsr_rmw(a, b, c, MkRMW(\
                e_rmw_int32, \
                rmw_op, \
                rmw, \
                tnsr_dt_location\
        ), 0, 1, 0);

        #define st_tnsr_rmw_i_v_b(a, b, c, rmw_op, rmw, tnsr_dt_location, predicate, predicatePolarity)\
                v_i32_st_tnsr_rmw(a, b, c, MkRMW(\
                    e_rmw_int32, \
                    rmw_op, \
                    rmw, \
                    tnsr_dt_location), 0, \
                    predicate, predicatePolarity\
                );

        // int64 v_i32_sub_b(int64 a, int64 b, e_saturation st, int64 source, bool predicate,
        //                                                  bool predicatePolarity);
        #define v_sub_v_v(a, b, st) \
                v_i32_sub_b(a, b, st)

        // int32_t s_i32_ash(int32_t a, int32_t b, bool RHU << 1);
        #define s_ash_s_s(a, b, RHU)\
                s_i32_ash((a), (b), (RHU) << 1)

        #define v_shl_v_v(a, b) \
                v_i32_shl_b(a, b)

        #define v_shr_v_v(a, b) \
                v_i32_shr_b(a, b)

        #define v_ash_v_v(a, b, rne) \
                v_i32_ash_b(a, (char256)b, rne << 1)

        // SINGLE LOGICAL INSTRUCTIONS
        #define s_add_s_s_b(a, b, i, p, o)\
                s_i32_add(a, b, 0, i, p, o)

        // int64 v_i32_min_b(int64 a, int32_t b);
        #define v_min_v_s(a, b) \
                v_i32_min_b(a, b)

        // int64 v_i32_min_b(int64 a, int64 b);
        #define v_min_v_v(a,b) \
                v_i32_min_b(a, b)

        // int64 v_i32_max_b(int64 a, int32_t b);
        #define v_max_v_s(a, b) \
                v_i32_max_b(a, b)

        // int64 v_i32_max_b(int64 a, int64 b);
        #define v_max_v_v(a,b) \
                v_i32_max_b(a, b)

        // int64 v_i32_max_b(int64 a, int64 b, 0, int64 source, bool predicate,
        //                                                  bool predicatePolarity);
        #define v_max_v_v_b(a,b,source,predicate,predicatePolarity) \
                v_i32_max_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_mov_dual_group_v(a, b, src, src_dual, dst_dual, wr_lower_group, wr_upper_group) \
            v_i32_mov_dual_group_b(a, b, src_dual, dst_dual, MkWr(wr_lower_group, wr_upper_group), src)

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2288 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_mov_dual_group_all_v(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, \
                  wr_0, wr_1, wr_2, wr_3) \
                v_i32_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, \
                  src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src, 1, 0)
#endif //__gaudi__
# 2293 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define v_mov_group_v(a, b, src, grp_en, dual_grp_en) \
            v_i32_mov_group_b(a, b, (dual_grp_en << 2) | grp_en, src)

        #define v_shuffle_v_v(a, b) \
               v_i32_shuffle_b(a, b, 0, a)

        //int64 v_i16_shuffle_vb(int64 a, uchar256 b, 0, int64 source, to_bool128(bool256 predicate)
        //                                                                 bool predicatePolarity);
        #define v_shuffle_v_v_vb(a, b, source, predicate, predicatePolarity) \
            v_i32_shuffle_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        //int64 v_i32_sel_grt_i32_b(int64 a, int64 b, int64 c, int64 d);
        #define v_sel_grt_v_v_v_v(a, b, c, d) \
                v_i32_sel_grt_i32_b(a, b, c, d)

        #define v_sel_geq_v_v_v_v(a, b, c, d) \
                v_i32_sel_geq_i32_b(a, b, c, d)

        #define v_sel_less_v_v_v_v(a, b, c, d) \
                v_i32_sel_less_i32_b(a, b, c, d)

        #define v_sel_less_v_v_v_v_vb(a, b, c, d, i, p, o) \
                v_i32_sel_less_i32_vb(a, b, c, d, 0, i, to_bool64(p), o)

        #define v_sel_leq_v_v_v_v(a, b, c, d) \
                v_i32_sel_leq_i32_b(a, b, c, d)

        #define v_sel_eq_v_v_v_v(a, b, c, d) \
                v_i32_sel_eq_i32_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v(a, b, c, d) \
                v_i32_sel_neq_i32_b(a, b, c, d)

        #define v_sel_grt_v_s_v_v(a, b, c, d) \
                v_i32_sel_grt_i32_b(a, b, c, d)

        #define v_sel_geq_v_s_v_v(a, b, c, d) \
                v_i32_sel_geq_i32_b(a, b, c, d)

        #define v_sel_less_v_s_v_v(a, b, c, d) \
                v_i32_sel_less_i32_b(a, b, c, d)

        #define v_sel_less_v_s_v_v_b(a, b, c, d, i, p ,o) \
                v_i32_sel_less_i32_b(a, b, c, d, 0, i, p, o)

        #define v_sel_geq_v_s_v_v_b(a, b, c, d, i, p, o) \
                 v_i32_sel_geq_i32_b(a, b, c, d, 0, i, p, o)

        #define v_sel_leq_v_s_v_v(a, b, c, d) \
                v_i32_sel_leq_i32_b(a, b, c, d)

        #define v_sel_eq_v_s_v_v(a, b, c, d) \
                v_i32_sel_eq_i32_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v_vb(a, b, c, d, e, f, g) \
                v_i32_sel_neq_i32_vb(a, b, c, d, 0, e, to_bool64(f), g)

        #define v_and_v_v(a, b) \
                v_i32_and_b(a, b)

        #define v_or_v_v(a, b) \
                v_i32_or_b(a, b)

        #define v_xor_v_v(a, b) \
                v_i32_xor_b(a, b)

        #define v_not_v(a) \
                v_i32_not_b(a)

        #define bv_cmp_neq_v_v(a, b)\
                from_bool64(v_i32_cmp_neq_b(a, b))

        // COMPLEX LOGICAL INSTRUCTIONS

        #define av_add_av_av(acc0, acc1, acc2, SAT)\
                acc0 = v_i32_add_b(acc1, acc2, SAT);

        #define av_add_av_s(acc_out, acc_in, scalar, SAT) \
                acc_out.v1 = v_i32_add_b(acc_in.v1, scalar, SAT)

        #define av_sub_av_av(acc_out, acc_in, acc2, SAT)\
                acc_out = v_i32_sub_b(acc_in, acc2, SAT);

        #define av_max_av_av(acc0, acc1, acc2)\
                acc0 = v_i32_max_b(acc1, acc2);

        #define av_max_av_s(acc0, acc1, scalar)\
                acc0 = v_i32_max_b(acc1, scalar);

        #define av_min_av_av(acc0, acc1, acc2)\
                acc0 = v_i32_min_b(acc1, acc2);

        #define av_min_av_s(acc0, acc1, scalar)\
                acc0 = v_i32_min_b(acc1, scalar);


        #define INIT_ACC_VEC_INT(a) a.v1 = 0

        #define s_i_mov_b(a, i, p, o)  s_i32_mov(a, 0, i, p, o)

        #define v_reduce_max_v(a) v_i32_reduce_max(a)
        #define v_reduce_min_v(a) v_i32_reduce_min(a)
        #define v_reduce_add_v(a) v_i32_reduce_add(a)


        typedef int64           VECTOR;
        typedef int128          ACC_VECTOR;
        typedef int             SCALAR;

        typedef VECTOR          VEC_INT;
        typedef ACC_VECTOR      ACC_VEC_INT;
        typedef SCALAR          INT;

        typedef int64_pair_t    VECTOR_PAIR;

        #define INT_MAX                     2147483647
        #define INT_MIN                     (-2147483648)
        #define ABS_INT_MIN                 (2147483648U)
        #define SIGNED_PAIR_T               int32_t_pair_t
        #define UNSIGNED_PAIR_T             uint32_t_pair_t
        #define PAIR_T                      SIGNED_PAIR_T
        #define SCALAR_T                    int32_t
        #define UNSIGNED_SCALAR_T           uint32_t
        #define INT_STEP                    31
        #define SIGN_MASK                   ((int32_t)((uint32_t)1<<INT_STEP))
        #define div_mod_i                   div_mod_i32
        #define s_abs_s(a)                  s_i32_abs(a)
        #define s_xor_s_s(a, b)             s_i32_xor(a, b)
        #define s_and_s_s(a, b)             s_i32_and(a, b)
        #define NEG_OP(a)                   s_i32_sub((int32_t)0, (a), SW_SAT)
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2425 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u32_udiv_step(a, s, 0, i)
        #endif
# 2427 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined( __gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2428 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u32_udiv_4step(a, s, 0, i)
        #endif
# 2430 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2431 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u32_udiv_4step(a, s, SW_X2_UDIV_4STEP, i)
        #endif
# 2433 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2434 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)      u32_udiv_both(a, s, SW_DIV_MODE_BOTH, i)
        #endif
# 2436 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#endif
# 2438 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

//  FLOAT32  *****************************************************************
#if 0 /* disabled by -frewrite-includes */
#if defined(FLOAT32)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2441 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2443 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
                #define DOUBLE_DEFINITION
        #endif
# 2445 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 64
        #define VECTOR_SIZE_LOG_2 6
        #define F_UINT_NUM_NUMBERS 4294967296.0

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2451 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_32
    #else
# 2453 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_4b_b()
    #endif
# 2455 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define v_fclass_b(a)\
                v_f32_fclass_b(a)

        #define v_not_v(a) \
                v_f32_not_b(a)

        #define s_add_s_s(a, b)\
                s_f32_add(a, b)

        #define s_add_s_s_b(a, b, i, p, o)\
                s_f32_add(a, b, 0, i, p, o)

        #define s_mov_s_b(a, s, p, pp) \
                s_f32_mov(a, 0, s, p, pp)

        #define b_cmp_geq_s_s(a, b)\
                s_f32_cmp_geq(a, b)

        #define b_cmp_grt_s_s(a, b)\
                s_f32_cmp_grt(a, b)

        #define b_cmp_geq_s_s_b(a, b, source, predicate, predicatePolarity)\
                s_f32_cmp_geq(a, b, 0, source, predicate, predicatePolarity)

        #define b_cmp_less_s_s(a, b)\
                s_f32_cmp_less(a, b)

        #define b_cmp_less_s_s_b(a, b, source, predicate, predicatePolarity)\
                s_f32_cmp_less(a, b, 0, source, predicate, predicatePolarity)

        #define b_cmp_eq_s_s(a, b)\
                s_f32_cmp_eq(a, b)

        #define b_cmp_neq_s_s(a, b)\
                s_f32_cmp_neq(a, b)

        #define b_cmp_eq_s_s_b(a, b, source, predicate, predicatePolarity)\
                s_f32_cmp_eq(a, b, 0, source, predicate, predicatePolarity)

        #define bv_ucmp_less_v_s(a, b)\
                from_bool64(v_u32_cmp_less_b(a, b));

        #define bv_cmp_geq_v_s(a, b)\
                from_bool64(v_f32_cmp_geq_b(a, b))

        //bool256 from_bool64(v_u32_cmp_geq_b(uint64 a, uint32_t b));
        #define bv_ucmp_geq_v_s(a, b) \
                from_bool64(v_u32_cmp_geq_b(a, b))

        #define bv_cmp_geq_v_v(a, b)\
                from_bool64(v_f32_cmp_geq_b(a, b))

        #define bv_cmp_grt_v_v(a, b)\
                from_bool64(v_f32_cmp_grt_b(a, b))

        #define bv_cmp_grt_v_vb(a, b, c, d, e, f)\
                from_bool64(v_f32_cmp_grt_b(a, b, c, d, e, f))

        #define bv_cmp_less_v_v(a, b)\
                from_bool64(v_f32_cmp_less_b(a, b))

        #define bv_cmp_less_v_vb(a, b, c, d, e, f)\
                from_bool64(v_f32_cmp_less_b(a, b, c, d, e, f))

        #define bv_cmp_less_v_s(a, b)\
                from_bool64(v_f32_cmp_less_b(a, b))

        #define bv_cmp_geq_v_s_b(a, b, source, predicate, predicatePolarity)\
              from_bool64(v_u32_cmp_geq_b(a, b, 0, to_bool64(source), predicate, predicatePolarity))

        #define bv_ucmp_grt_v_s(a, b)\
                from_bool64(v_u32_cmp_grt_b(a, b))

        #define bv_cmp_leq_v_v(a, b) \
                from_bool64(v_f32_cmp_leq_b(a, b))

        #define bv_cmp_eq_v_v(a, b) \
                from_bool64(v_f32_cmp_eq_b(a, b))

        #define v_ui_shr_v_v(a, b) \
                v_u32_shr_b(a, (int64)b)
        //float64 v_f32_add_b(float64 a, float b);
        #define v_add_v_s(a, b, st) \
                v_f32_add_b(a, b)

        // float64 v_f32_add_b(float64 a, float64 b);
        #define v_add_v_v(a, b, st) \
                v_f32_add_b(a, b)

        #define v_add_v_v_vb(a, b, source, predicate, predicatePolarity) \
                v_f32_add_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        #define v_uadd_v_v_vb(a, b, source, sw, predicate, predicatePolarity) \
                v_u32_add_vb(a, b, sw, source, to_bool64(predicate), predicatePolarity)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_f32_add_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        // float64 v_f32_sub_b(float64 a, float b, e_negation neg = 0 << 1);
        #define v_sub_v_s(a, b, not_used) \
                v_f32_sub_b(a, b, SW_NO_NEG)

        #define v_sub_v_s_vb(a, b, source, switches, predicate, predicatePolarity) \
                v_f32_sub_vb(a, b, switches << 1, source, to_bool64(predicate), predicatePolarity)

        #define v_sub_v_v_vb(a, b, source, switches, predicate, predicatePolarity) \
                v_f32_sub_vb(a, b, switches << 1, source, to_bool64(predicate), predicatePolarity)

        // float64 v_f32_sub_b(float64 a, float b, e_negation neg = 1 << 1);
        #define v_sub_neg_v_s(a, b, not_used) \
                v_f32_sub_b(a, b, SW_NEG)

        // float64 v_f32_sub_b(float64 a, float64 b, e_negation neg = 0 << 1);
        #define v_sub_v_v(a, b, not_used) \
                v_f32_sub_b(a, b, SW_NO_NEG)

        // float64 v_f32_sub_b(float64 a, float64 b, e_negation neg = 1 << 1);
        #define v_sub_neg_v_v(a, b, not_used) \
                v_f32_sub_b(a, b, SW_NEG)

        #define av_mov_zero(acc)\
                acc = 0;

        #define av_init_val(acc, val)\
                acc = v_mov_s(val);

        #define v_mov_s(a) \
                (a)

        #define v_mov_v(a) \
                (a)

        #define v_mov_s_vb(a, b, predicate, predicatePolarity) \
                v_f32_mov_vb(a, 0, b, to_bool64(predicate), predicatePolarity)

        #define v_mov_s_b(a, s, p, pp) \
                v_f32_mov_b(a, 0, s, p, pp)

        #define v_mov_v_vb(a, b, predicate, predicatePolarity) \
                v_f32_mov_vb(a, 0, b, to_bool64(predicate), predicatePolarity)

        #define v_mov_v_b(a, b, predicate, predicatePolarity)\
                v_f32_mov_b(a, 0, b, predicate, predicatePolarity)

        #define s_mul_s_s(a, b)\
                s_f32_mul(a, b)

        #define v_mul_v_v(a, b)\
                v_f32_mul_b(a, b)

        #define v_mul_v_v_vb(a, b, source, predicate, predicatePolarity) \
                v_f32_mul_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        // float64 v_f32_mul_vb(float64 a, float b, 0, float64 source, to_bool64(bool256 predicate),
        //                                                              bool predicatePolarity);
        #define v_mul_v_s_vb(a, b, source, predicate, predicatePolarity)\
            v_f32_mul_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        #define v_mul_v_s(a, b)\
                v_f32_mul_b(a, b)

        #define v_mul_v_s_b(a, b, source, predicate, predicatePolarity)\
            v_f32_mul_b(a, b, 0, source, predicate, predicatePolarity)

        // float64 mac equivalent for acc32
        #define av_mac_acc32(a, b, acc, neg) \
                v_f32_mac_b(a, b, acc, neg)

        // float64 v_f32_mac_b(float64 a, float64 b, float64 source, (e_negation neg) << 1);
        #define v_mac_v_v(a, b, source, neg) \
                v_f32_mac_b(a, b, source, neg)

        // float64 v_f32_mac_b(float64 a, float64 b, float64 source,
        //                    (e_negation neg) << 1, bool predicate, bool predicatePolarity);
        #define v_mac_v_v_b(a, b, source, neg, predicate, predicatePolarity) \
                v_f32_mac_b(a, b, source, neg, predicate, predicatePolarity)

        // float64 v_f32_mac_vb(float64 a, float64 b, float64 source, (e_negation neg) << 1,
        //                            to_bool64(bool256 predicate), bool predicatePolarity);
        #define v_mac_v_v_vb(a, b, source, neg, predicate, predicatePolarity) \
                v_f32_mac_vb(a, b, source, neg, to_bool64(predicate), predicatePolarity)

        // float64 v_f32_mac_b(float64 a, float b, float64 source, (e_negation neg) << 1);
        #define v_mac_v_s(a, b, source, neg) \
                v_f32_mac_b(a, b, source, neg)

        // float64 v_f32_max_b(float64 a, float b);
        #define v_max_v_s(a, b) \
                v_f32_max_b(a, b)

        #define v_mac_v_s_b(a, b, source, neg, predicate, predicatePolarity) \
                v_f32_mac_b(a, b, source, neg, predicate, predicatePolarity)

        // SINGLE LOAD AND STORE INSTRUCTIONS

        // float64 v_f32_ld_tnsr_b(int5 a, tensor b);
        #define v_ld_tnsr_i(a, b) \
                v_f32_ld_tnsr_b(a, b)

        #define v_ld_tnsr_b \
                v_f32_ld_tnsr_b

        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity) \
                v_f32_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_i_vb(a, b, source, predicate, predicatePolarity) \
                v_f32_ld_tnsr_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        //float64 v_f32_ld_tnsr_b(int5 a, int8_t b);
        #define v_ld_tnsr_reg_i_s(a, b) \
                v_f32_ld_tnsr_b(a, b)

        //float64 v_f32_ld_tnsr_vb(int5 a, int8_t b, 0, float64 source, to_bool64(bool256 predicate)
        //                                                                 bool predicatePolarity);
        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_f32_ld_tnsr_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        #define v_ld_tnsr_low_i(coords, tnsr) \
                v_f32_ld_tnsr_low_b(coords, tnsr)

        #define v_ld_tnsr_low_i_b(coords, tnsr, input, pred, o) \
                v_f32_ld_tnsr_low_b(coords, tnsr, 0, input, pred, o)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_f32_ld_tnsr_partial_b(coord, tnst, size, offset)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity) \
                v_f32_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                        polarity)

        #define v_ld_tnsr_b \
                v_f32_ld_tnsr_b

        //float64 v_f32_ld_g(__global__ void* a, float64 source, bool predicate,
        //                                                                bool predicatePolarity);
        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_f32_ld_g(a, 0, source, predicate, predicatePolarity)

        // void  v_f32_st_tnsr(int5 a, tensor b, float64 c);
        #define st_tnsr_i_v(a, b, c) \
                v_f32_st_tnsr(a, b, c)

        // void v_f32_st_tnsr(int5 a, tensor b, float64 c);
        #define st_tnsr_low_i_v(a, b, c) \
                v_f32_st_tnsr_low(a, b, c)

        // void v_f32_st_tnsr_low(int5 a, tensor b, float64 c, 0, bool predicate,
        //                                                               bool predicatePolarity);
        #define st_tnsr_low_i_v_b(coords, tnsr, c, predicate, predicatePolarity) \
                v_f32_st_tnsr_low(coords, tnsr, c, 0, predicate, predicatePolarity) \

        //void  v_f32_st_tnsr(int5 a, tensor b, float64 c, 0, bool predicate,
        //                                                  bool predicatePolarity);
        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_f32_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        // void v_f32_st_tnsr(int5 a, int8_t b, float64 c);
        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_f32_st_tnsr(a, b, c)

        // void v_f32_st_tnsr(int5 a, int8_t b, float64 c, 0, bool predicate,
        //                                                                  bool predicatePolarity);
        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_f32_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_f32_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_f32_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_f32_st_tnsr_partial(n, t, v, s, f, 0, p, o)

        #define v_st_tnsr_b \
                v_f32_st_tnsr

        #define s_ld_g_a(a) \
                s_f32_ld_g(a)

        #define s_ld_g_a_b(a, i, p, o) \
                s_f32_ld_g(a, 0, i, p, o)

        #define s_st_g_a_s(a, b) \
                s_f32_st_g(a, b)

        #define st_g_a_s_b(a, b, c, d) \
                s_f32_st_g(a, b, 0, c, d)

        #define v_ld_g_a(a) \
                v_f32_ld_g(a)

        // LOAD PREDICATE TENSOR
        #define bv_ld_tnsr_i_av(acc, cords, tensor, step, dim) \
            acc.v1 = v_i1_ld_tnsr_b(cords, tensor);

        #define INIT_ACC_VEC_INT(a) a.v1 = 0

        #define v_mov_dual_group_v(a, b, src, src_dual, dst_dual, wr_lower_group, wr_upper_group) \
         v_f32_mov_dual_group_b(a, b, src_dual, dst_dual, MkWr(wr_lower_group, wr_upper_group), src)

        #define v_mov_dual_group_v_vb(a, b, src, src_dual, dst_dual, wr_lower_group,             \
                                                   wr_upper_group, predicate, predicatePolarity) \
                v_f32_mov_dual_group_vb(a, b, src_dual, dst_dual, MkWr(wr_lower_group,           \
                                      wr_upper_group), src, to_bool64(predicate), predicatePolarity)

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 2764 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_mov_dual_group_all_v(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3) \
                v_f32_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src)
#endif //__gaudi__
# 2767 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define v_mov_group_v(a, b, src, grp_en, dual_grp_en) \
            v_f32_mov_group_b(a, b, (dual_grp_en << 2) | grp_en, src)

        #define v_shuffle_v_v(a, b) \
            v_f32_shuffle_b(a, b, 0, a)

        //float64 v_f32_shuffle_vb(float64 a, uchar256 b, 0, float64 source,
        //                         to_bool64(bool256 predicate), bool predicatePolarity);
        #define v_shuffle_v_v_vb(a, b, source, predicate, predicatePolarity) \
            v_f32_shuffle_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        #define av_add_av_s(acc0, acc1, scalar, SAT) \
            acc0.v1 = v_i32_add_b(acc1.v1, scalar, SAT)

        // SINGLE LOGICAL INSTRUCTIONS

        // float64 v_f32_min_b(float64 a, float b);
        #define v_min_v_s(a, b) \
                v_f32_min_b(a, b)

        // float64 v_f32_min_b(float64 a, float64 b);
        #define v_min_v_v(a,b) \
                v_f32_min_b(a, b)

        // float64 v_f32_max_b(float64 a, float b);
        #define v_max_v_s(a, b) \
                v_f32_max_b(a, b)

        // float64 v_f32_max_b(float64 a, float64 b);
        #define v_max_v_v(a,b) \
                v_f32_max_b(a, b)

        // float64 v_f32_max_b(float64 a, float64 b, 0, float64 source, bool predicate,
        //                                                  bool predicatePolarity);
        #define v_max_v_v_b(a,b,source,predicate,predicatePolarity) \
                v_f32_max_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_max_v_v_vb(a,b,source,predicate,predicatePolarity) \
                v_f32_max_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        //float64 v_f32_sel_grt_f32_b(float64 a, float64 b, float64 c, float64 d);
        #define v_sel_grt_v_v_v_v(a, b, c, d) \
                v_f32_sel_grt_f32_b(a, b, c, d)

        #define v_sel_grt_v_v_v_v_b(a, b, c, d, source, predicate, predicatePolarity) \
                v_f32_sel_grt_f32_b(a, b, c, d, 0, source, predicate, predicatePolarity)

        #define v_sel_geq_v_v_v_v(a, b, c, d) \
                v_f32_sel_geq_f32_b(a, b, c, d)

        #define v_sel_less_v_v_v_v(a, b, c, d) \
                v_f32_sel_less_f32_b(a, b, c, d)

        #define v_sel_less_v_v_v_v_vb(a, b, c, d, i, p, o) \
                v_f32_sel_less_f32_vb(a, b, c, d, 0, i, to_bool64(p), o)

        #define v_sel_leq_v_v_v_v(a, b, c, d) \
                v_f32_sel_leq_f32_b(a, b, c, d)

        #define v_sel_eq_v_v_v_v(a, b, c, d) \
                v_f32_sel_eq_f32_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v(a, b, c, d) \
                v_f32_sel_neq_f32_b(a, b, c, d)

        #define v_sel_neq_v_s_v_v(a, b, c, d) \
                v_f32_sel_neq_f32_b(a, b, c, d)

        #define v_sel_grt_v_s_v_v(a, b, c, d) \
                v_f32_sel_grt_f32_b(a, b, c, d)

        #define v_sel_geq_v_s_v_v(a, b, c, d) \
                v_f32_sel_geq_f32_b(a, b, c, d)

        #define v_sel_less_v_s_v_v(a, b, c, d) \
                v_f32_sel_less_f32_b(a, b, c, d)

        #define v_sel_less_v_s_v_v_b(a, b, c, d, i, p, o) \
                v_f32_sel_less_f32_b(a, b, c, d, 0, i, p, o)

         #define v_sel_geq_v_s_v_v_b(a, b, c, d, i, p, o) \
                v_f32_sel_geq_f32_b(a, b, c, d, 0, i, p, o)

        #define v_sel_leq_v_s_v_v(a, b, c, d) \
                v_f32_sel_leq_f32_b(a, b, c, d)

        #define v_sel_eq_v_s_v_v(a, b, c, d) \
                v_f32_sel_eq_f32_b(a, b, c, d)

        #define v_sel_neq_v_v_v_s(a, b, c, d) \
                v_f32_sel_neq_f32_b(a, b, c, d)

        #define v_sel_grt_v_v_v_s(a, b, c, d) \
                v_f32_sel_grt_f32_b(a, b, c, d)

        #define v_sel_geq_v_v_v_s(a, b, c, d) \
                v_f32_sel_geq_f32_b(a, b, c, d)

        #define v_sel_less_v_v_v_s(a, b, c, d) \
                v_f32_sel_less_f32_b(a, b, c, d)

        #define v_sel_leq_v_v_v_s(a, b, c, d) \
                v_f32_sel_leq_f32_b(a, b, c, d)

        #define v_sel_eq_v_v_v_s(a, b, c, d) \
                v_f32_sel_eq_f32_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v_vb(a, b, c, d, e, f, g) \
                v_f32_sel_neq_f32_vb(a, b, c, d, 0, e, to_bool64(f), g)

        #define bv_cmp_neq_v_v(a, b)\
                from_bool64(v_f32_cmp_neq_b(a, b))

        #define v_or_v_v(a, b) \
                v_f32_or_b(a, b)

        #define v_and_v_v(a, b) \
                v_f32_and_b(a, b)

        #define v_xor_v_v(a, b) \
                v_f32_xor_b(a, b)

        #define av_mac_acc_v_v(a, b, acc, neg) \
                v_f32_mac_b(a, b, acc, neg)

        // SPECIAL INSTRUCTIONS

        #define log_fast(a) \
            log_fast_f32(a)

        #define log(a) \
            log_f32(a)

        #define div_fast(a, b) \
            div_fast_f32(a, b)

        #define div(a, b) \
            div_f32(a, b)

        #define pow_fast(a, b) \
            pow_fast_f32(a, b)

        #define pow(a, b) \
            pow_f32(a, b)

        #define exp_fast(a) \
            exp_fast_f32(a)

        #define exp(a) \
            exp_f32(a)

        #define exp_dn_clamp(a) \
            exp_f32(a)

        #define reciprocal(a) \
            reciprocal_f32(a)

        #define sqrt(a) \
            sqrt_f32(a)

        #define sigmoid(a) \
            sigmoid_f32(a)

        // COMPLEX LOGICAL INSTRUCTIONS

        #define av_add_av_av(acc0, acc1, acc2, SAT)\
                acc0 = v_f32_add_b(acc1, acc2);

        #define av_sub_av_av(acc0, acc1, acc2, SAT)\
                acc0 = v_f32_sub_b(acc1, acc2, SAT << 1);

        #define av_max_av_av(acc0, acc1, acc2)\
                acc0 = v_f32_max_b(acc1, acc2);

        #define av_max_av_s(acc0, acc1, scalar)\
                acc0 = v_f32_max_b(acc1, scalar);

        #define av_min_av_av(acc0, acc1, acc2)\
                acc0 = v_f32_min_b(acc1, acc2);

        #define av_min_av_s(acc0, acc1, scalar)\
                acc0 = v_f32_min_b(acc1, scalar);


        #define v_abs_v(a) \
                v_f32_abs_b(a)

        #define v_nearbyint_v(a, b) \
                v_f32_nearbyint_b(a, b)

        #define s_nearbyint_s(a, b) \
                s_f32_nearbyint(a, b)

        // bool256 from_bool64(v_f32_cmp_grt_b(float64 a, float b));
        #define bv_cmp_grt_v_s(a, b) \
                from_bool64(v_f32_cmp_grt_b(a, b))

        //float64 v_f32_add_b(float64 a, float64 b, 0, float64 source,
        //                                        bool predicate, bool predicatePolarity);
        #define v_add_v_v_b(a, b, source, predicate, predicatePolarity) \
                v_f32_add_b(a, b, 0, source, predicate, predicatePolarity)

        #define st_tnsr_rmw_i_v(a, b, c, rmw_op, rmw, tnsr_dt_location)\
                v_f32_st_tnsr_rmw(a, b, c, MkRMW(\
                    e_rmw_fp32, \
                    rmw_op, \
                    rmw, \
                    tnsr_dt_location\
                ), 0, 1, 0);

        #define st_tnsr_rmw_i_v_b(a, b, c, rmw_op, rmw, tnsr_dt_location, predicate, predicatePolarity)\
                v_f32_st_tnsr_rmw(a, b, c, MkRMW(\
                    e_rmw_fp32, \
                    rmw_op, \
                    rmw, \
                    tnsr_dt_location), 0, \
                    predicate, predicatePolarity\
                );

        #define s_mac_s_s(a, b, source, neg) \
                s_f32_mac(a, b, source, neg)

        #define v_extract_exp_v(vec, bias) \
                v_f32_extract_exp_b(vec, bias)

        #define v_reduce_max_v(a) v_f32_reduce_max(a)
        #define v_reduce_min_v(a) v_f32_reduce_min(a)
        #define v_reduce_add_v(a) v_f32_reduce_add(a)

        typedef float64         VECTOR;
        typedef float64         ACC_VECTOR;
        typedef float           SCALAR;
        typedef float64_pair_t  VECTOR_PAIR;
        typedef VECTOR          VEC_INT;
        typedef uint64          UINTVECTOR;

        #define FLOAT_MIN      (-1.0/0.0) // -inf
        #define MIN_VAL         FLOAT_MIN
        #define MINUS_INF       0xff800000
        #define PLUS_INF        0x7f800000
        #define NAN             0x7fffffff

        #define mod(a, b) mod_f32(a, b)
#endif
# 3012 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"



//  UINT8  *****************************************************************
#if 0 /* disabled by -frewrite-includes */
#if defined(UINT8)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3017 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3019 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
                #define DOUBLE_DEFINITION
        #endif
# 3021 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 256
        #define SCALAR_T  uint8_t

        typedef uchar256        VECTOR;
        typedef uchar256        UVECTOR;
        typedef uint256         ACC_VECTOR;
        typedef int256          SIGNED_ACC_VECTOR;
        typedef float256        FLOAT_ACC_VECTOR;
        typedef unsigned char   SCALAR;
        typedef unsigned int    ACC_SCALAR;

        typedef VECTOR          VEC_INT;
        typedef ACC_VECTOR      ACC_VEC_INT;
        typedef SCALAR          INT;

        #define MAX_POSITIVE            (255U)
        #define UNSIGNED_PAIR_T         uint8_t_pair_t
        #define PAIR_T                  UNSIGNED_PAIR_T
        #define SCALAR_T                uint8_t
        #define UNSIGNED_SCALAR_T       uint8_t
        #define INT_STEP                7
        #define div_mod_i               div_mod_u8
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3045 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u8_udiv_step(a, s, 0, i)
        #endif
# 3047 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined( __gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3048 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u8_udiv_4step(a, s, 0, i)
        #endif
# 3050 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3051 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u8_udiv_4step(a, s, SW_X2_UDIV_4STEP, i)
        #endif
# 3053 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3054 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u8_udiv_both(a, s, SW_DIV_MODE_BOTH, i)
        #endif
# 3056 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3058 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_8
    #else
# 3060 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_1b_b()
    #endif
# 3062 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"


        typedef struct _acc_vec_float
        {
            float64 v1;
            float64 v2;
            float64 v3;
            float64 v4;
        } acc_vec_float;

        typedef union {
             float256      acc_f32;
             ACC_VEC_INT   acc_u32;
             VEC_INT       y;
        } acc_union_t;

        #define INT32_MAX       (2147483647)
        #define UINT_MIN        (0)
        #define UINT_MAX        (255)
        #define MIN_VAL         UINT_MIN

        #define INIT_ACC_VEC_INT(a) a.v1 = 0; a.v2 = 0; a.v3 = 0; a.v4 = 0

        // SINGLE LOAD AND STORE INSTRUCTIONS

        //uint8_t s_u8_ld_g(__global__ void* a);
        #define s_ld_g_a(a) \
                s_u8_ld_g(a)

        #define s_ld_g_a_b(a, i, p, o) \
                s_u8_ld_g(a, 0, i, p, o)

        // uchar256 v_u8_ld_tnsr_b(int5 a, tensor b);
        #define v_ld_tnsr_i(a, b) \
                v_u8_ld_tnsr_b(a, b)

        // uchar256 v_u8_ld_tnsr_b(int5 a, tensor b, 0, uchar256 source,
        //     bool predicate, bool predicatePolarity);
        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity)\
                v_u8_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_u8_ld_tnsr_partial_b(coord, tnst, size, offset)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                polarity) \
        v_u8_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                polarity)

        //uchar256 v_u8_ld_tnsr_b(int5 a, int8_t b);
        #define v_ld_tnsr_reg_i_s(a, b) \
                v_u8_ld_tnsr_b(a, b)

        //uchar256 v_u8_ld_tnsr_vb(int5 a, int8_t b, 0, uchar256 source, bool256 predicate,
        //                                                                bool predicatePolarity);
        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_u8_ld_tnsr_vb(a, b, 0, source, predicate, predicatePolarity)

        // uchar256 v_u8_ld_g(__global__ void* a);
        #define v_ld_g_a(a) \
                v_u8_ld_g(a)

        //uchar256 v_u8_ld_g(__global__ void* a, 0, uchar256 source, bool predicate,
        //                                                                bool predicatePolarity);
        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_u8_ld_g(a, 0, source, predicate, predicatePolarity)

        // LOAD PREDICATE TENSOR
        #define bv_ld_tnsr_i_av(acc, cords, tensor, step, dim) \
        acc.v1 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords); \
        acc.v2 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords); \
        acc.v3 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords); \
        acc.v4 = v_i1_ld_tnsr_b(cords, tensor);   cords = i_i32_add(step, cords, dim, 0, cords);

        // void  v_u8_st_tnsr(int5 a, tensor b, uchar256 c);
        #define st_tnsr_i_v(a, b, c) \
                v_u8_st_tnsr(a, b, c)

        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_u8_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        // void v_u8_st_tnsr(int5 a, int8_t b, uchar256 c);
        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_u8_st_tnsr(a, b, c)

        // void v_u8_st_tnsr(int5 a, int8_t b, uchar256 c, 0, bool predicate,
         //                                                                bool predicatePolarity);
        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_u8_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_u8_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_u8_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_u8_st_tnsr_partial(n, t, v, s, f, 0, p, o)

        // uint8_t s_convert_uint32_to_u8(uint32_t a, int8_t b, e_round_mode round);
        #define s_convert_high_to_low_s(a, b)\
                s_convert_uint32_to_u8(a, b, SW_RZ)

        //uchar256 v_u8_mov_b(uint8_t a);
        #define v_mov_s(a) \
                v_u8_mov_b(a)

        #define v_mov_s_vb(a, s, p, pp) \
                v_u8_mov_vb(a, 0, s, p, pp)

        #define v_mov_s_b(a, s, p, pp) \
                v_u8_mov_b(a, 0, s, p, pp)

        #define v_mov_vb(a, sw, out, pred, pp) \
                v_u8_mov_vb(a, sw, out, pred, pp)

        #define v_shuffle_v_v(a, b) \
                v_u8_shuffle_b(a, b, 0, a)

        #define v_shuffle_v_v_b(a, b, p, o) \
                v_u8_shuffle_b(a, b, 0, a, p, o)

        #define v_mov_group_v( a, b, source, group_en, dual_group_en) \
                v_u8_mov_group_b(a, b, (dual_group_en << 2) | group_en, source)

        #define v_mov_group_v_b( a, b, source, group_en, dual_group_en, p, o) \
                v_u8_mov_group_b(a, b, (dual_group_en << 2) | group_en, source, p, o)

        #define v_mov_dual_group_v(a, b, src, src_dual, dst_dual, wr_lower_group, wr_upper_group) \
                v_u8_mov_dual_group_b(a, b, src_dual, dst_dual, MkWr(wr_lower_group, wr_upper_group), src)

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3194 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_mov_dual_group_all_v(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3) \
                v_u8_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src)

        #define v_mov_dual_group_all_v_b(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3, p, o) \
                v_u8_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src, p, o)
#endif
# 3200 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define av_f32_sub_av_s(acc_out, acc_in, scale) \
                (acc_out).v1 = v_f32_sub_b((acc_in).v1, (scale), SW_NO_NEG); \
                (acc_out).v2 = v_f32_sub_b((acc_in).v2, (scale), SW_NO_NEG); \
                (acc_out).v3 = v_f32_sub_b((acc_in).v3, (scale), SW_NO_NEG); \
                (acc_out).v4 = v_f32_sub_b((acc_in).v4, (scale), SW_NO_NEG);

        #define av_f32_sub_av_av(acc_out, acc_in1, acc_in2) \
                (acc_out).v1 = v_f32_sub_b((acc_in1).v1, (acc_in2.v1), SW_NO_NEG); \
                (acc_out).v2 = v_f32_sub_b((acc_in1).v2, (acc_in2.v2), SW_NO_NEG); \
                (acc_out).v3 = v_f32_sub_b((acc_in1).v3, (acc_in2.v3), SW_NO_NEG); \
                (acc_out).v4 = v_f32_sub_b((acc_in1).v4, (acc_in2.v4), SW_NO_NEG);

        #define av_f32_mul_v_s(acc_out, acc_in, scale) \
                (acc_out).v1 = v_f32_mul_b((acc_in).v1, (scale)); \
                (acc_out).v2 = v_f32_mul_b((acc_in).v2, (scale)); \
                (acc_out).v3 = v_f32_mul_b((acc_in).v3, (scale)); \
                (acc_out).v4 = v_f32_mul_b((acc_in).v4, (scale));

        #define av_mov_s(acc, scalar)\
                acc.v1 = v_u32_mov_b(scalar); \
                acc.v2 = v_u32_mov_b(scalar); \
                acc.v3 = v_u32_mov_b(scalar); \
                acc.v4 = v_u32_mov_b(scalar);

        #define av_mov_av(acc_out, acc_in) \
                acc_out.v1 = (acc_in.v1); \
                acc_out.v2 = (acc_in.v2); \
                acc_out.v3 = (acc_in.v3); \
                acc_out.v4 = (acc_in.v4);

        //uint64 v_u32_mov_b(uint32_t a);
        #define v_32_mov_s(a)\
                v_u32_mov_b(a)

        // SINGLE LOGICAL INSTRUCTIONS
        // uchar256 v_u8_max_b(uchar256 a, uchar256 b);
        #define v_max_v_v(a,b) \
                v_u8_max_b(a, b)

        // uchar256 v_u8_max_b(uchar256 a, uint8_t b);
        #define v_max_v_s(a, b) \
                v_u8_max_b(a, b)

        // uchar256 v_u8_min_b(uchar256 a, uint8_t b);
        #define v_min_v_s(a, b) \
                v_u8_min_b(a, b)

        #define v_shl_v_v(a, b) \
                v_u8_shl_b(a, (char256)b)

        #define v_shr_v_v(a, b) \
                v_u8_shr_b(a, (char256)b)

        //uchar256 v_u8_sel_neq_u8_vb(uchar256 a, uchar256 b, uchar256 c,
        //         uchar256 d, 0, uchar256 source, bool256 predicate, bool predicatePolarity);
        #define v_sel_neq_v_v_v_v_vb(a, b, c, d, e, f, g) \
                v_u8_sel_neq_u8_vb(a, b, c, d, 0, e, f, g)

        // uchar256 v_u8_sel_grt_u8_vb(uchar256 a, uint8_t b, uchar256 c,
         //         uchar256 d, 0, uchar256 source, bool256 predicate, bool predicatePolarity);
        #define v_sel_grt_v_s_v_v(a, b, c, d) \
                v_u8_sel_grt_u8_b(a, b, c, d)

        #define v_sel_leq_v_s_v_v(a, b, c, d) \
                v_u8_sel_leq_u8_b(a, b, c, d)

        #define v_sel_less_v_s_v_v_b(a, b, c, d, i, p, o) \
                v_u8_sel_less_u8_b(a, b, c, d, 0, i, p, o)

        #define v_sel_geq_v_s_v_v_b(a, b, c, d, i, p, o) \
                 v_u8_sel_geq_u8_b(a, b, c, d, 0, i, p, o)

        //bool256 v_u8_cmp_neq_b(uchar256 a, uchar256 b);
        #define bv_cmp_neq_v_v(a, b)\
            v_u8_cmp_neq_b(a, b)

        #define v_cmp_less_b(a, b, sw, out, pred, pp) \
            v_u8_cmp_less_b(a, b, sw, out, pred, pp)

        //uchar256 v_u8_sel_neq_u8_b(uchar256 a, uchar256 b, uchar256 c, uchar256 d);
        #define v_sel_neq_v_v_v_v(a, b, c, d) \
                v_u8_sel_neq_u8_b(a, b, c, d)

        #define v_sel_leq_v_v_v_v(a, b, c, d) \
                v_u8_sel_leq_u8_b(a, b, c, d)

        #define v_sel_eq_v_v_v_v(a, b, c, d) \
                v_u8_sel_eq_u8_b(a, b, c, d)

        #define v_sel_grt_v_v_v_v(a, b, c, d) \
                v_u8_sel_grt_u8_b(a, b, c, d)

        #define v_sel_geq_v_v_v_v(a, b, c, d) \
                v_u8_sel_geq_u8_b(a, b, c, d)

        #define v_sel_less_v_v_v_v(a, b, c, d) \
                v_u8_sel_less_u8_b(a, b, c, d)

        //uchar256 v_u8_or_b(uchar256 a, uchar256 b);
        #define v_or_v_v(a, b) \
                v_u8_or_b(a, b)

        #define v_not_v(a) \
                v_u8_not_b(a)
        // SINGLE ARITHMETIC INSTRUCTIONS

        #define s_mov_s_b(a, s, p, pp) \
                s_u8_mov(a, 0, s, p, pp)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_u8_add_vb(a, b, SW_SAT, source, predicate, predicatePolarity)

        #define v_sub_b(a, b, sw, out, pred, pp) \
                v_u8_sub_b(a, b, sw, out, pred, pp)

        // uint32_t s_i8_mac(uint8_t a, uint8_t b, uint32_t source, e_saturation st);
        #define s_mac_s_s(a, b, src, st )\
                s_u8_mac(a, b, src, st)

        // uint256 v_u8_mac_b(uchar256 a, uint8_t b, uint256 source, e_saturation st);
        #define av_mac_v_s(a, b, src, st )\
                v_u8_mac_b(a, b, src, st)

        // uint256 v_u8_mac_b(uchar256 a, uchar256 b, uint256 source, e_saturation st);
        #define av_mac_v_v(a, b, src, st )\
                v_u8_mac_b(a, b, src, st)

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3329 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_mac_x2_zp_v_v_v_v_v(a, b, c, d, zp, src, sw )\
                v_u8_mac_x2_zp_b(a, b, c, d, zp, src, sw)

        // int256 av_u8_mac_acc32_v_s(uchar256 a, uchar256 b, int256 source, e_saturation st);
        #define av_mac_acc32_v_s(a, b, src, st )\
                v_u8_mac_acc32_b(a, b, src, st)

        #define av_mac_acc32_v_s_b(a, b, src, st, predicate, predicatePolarity )\
                v_u8_mac_acc32_b(a, b, src, st, predicate, predicatePolarity)

        // int256 av_u8_mac_acc32_v_s(uchar256 a, uchar256 b, int256 source, e_saturation st);
        #define av_mac_acc32_v_v(a, b, src, st )\
                v_u8_mac_acc32_b(a, b, src, st)

        // uint256 v_u8_mac_x2_zp_b(uchar256 a, uchar256 b, uchar256 c, uchar256 d,
        //                                      uint256 source, e_saturation st);
        #define av_mac_x2_zp_acc32_v_v_v_v_v(a, b, c, d, zp, src, st )\
                v_u8_mac_x2_zp_acc32_b(a, b, c, d, zp, src, st)

        #define av_mac_x2_v_s_v_s_b(a, b, c, d, src, sw, predicate, predicatePolarity) \
                src = v_u8_mac_x2_b(a, v_u8_mov_b(b), c, d, src, sw, predicate, predicatePolarity);

        #define av_mac_x2_v_s_v_s(a, b, c, d, src, st) \
                src = v_u8_mac_x2_b(a, v_u8_mov_b(b), c, d, src, st);

        #define av_mac_zp_acc32_v_v_v(a, b, zp, src, sw) \
                v_u8_mac_zp_acc32_b(a, b, zp, src, sw)

        #define av_mac_zp_v_v_v(a, b, zp, src, sw) \
                v_u8_mac_zp_b(a, b, zp, src, sw)

        #define v_convert_uint_to_f32_all_b(vOut, vIn, sw, pred, pp) \
                vOut = v_convert_u8_to_f32_all_b(vIn, sw, vOut, pred, pp);

        #define v_convert_f32_to_uint_all_b(vOut, vIn, sw, pred, pp) \
                vOut = v_convert_f32_to_u8_all_b(vIn, sw, vOut, pred, pp);

#else
# 3367 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_mac_x2_v_s_v_s_b(a, b, c, d, src, sw, predicate, predicatePolarity) \
                src = v_u8_mac_b(a, b, src, sw, predicate, predicatePolarity); \
                src = v_u8_mac_b(c, d, src, sw, predicate, predicatePolarity);

        #define av_mac_x2_v_s_v_s(a, b, c, d, src, sw) \
                src = v_u8_mac_b(a, b, src, sw); \
                src = v_u8_mac_b(c, d, src, sw);
#endif
# 3375 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define av_mac_v_v_b(a, b, src, st, prediction, rotation) \
                v_u8_mac_b(a, b, src, st, prediction, rotation)

        // uint256 v_u8_mac_b(uchar256 a, uint8_t b, uint256 source, e_saturation st,
        //     bool predicate, bool predicatePolarity);
        #define av_mac_v_s_b(a, b, source, st, predicate, predicatePolarity )\
                v_u8_mac_b(a, b, source, st, predicate, predicatePolarity)

        // uchar256 v_convert_uint32_to_u8_b(uint64 a, int8_t b, uchar256 source,
        //     e_round_mode round, int lane_sel);
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3387 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s(a, b, source, round, lane_sel)\
        v_convert_uint32_to_u8_b(a, b, lane_sel, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 3390 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_s(a, b, source, round, lane_sel)\
        v_convert_uint32_to_u8_single_b(a, b, lane_sel, round, source);
#else
# 3393 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "v_convert_v_s() is not defined"
#endif
# 3395 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // uchar256 v_convert_uint32_to_u8_b(uint64 a, char256 b, uchar256 source,
        //    e_round_mode round, int lane_sel);
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3399 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v(a, b, source, round, lane_sel)\
        v_convert_uint32_to_u8_b(a, b, lane_sel, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 3402 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define v_convert_v_v(a, b, source, round, lane_sel)\
        v_convert_uint32_to_u8_single_b(a, b, lane_sel, round, source);
#endif
# 3405 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define cast_f32_to_8bits_lin_order(t00, t10, t20, t30)\
                cast_f32_to_u8_lin_order(t00, t10, t20, t30)

        // COMPLEX ARITHMETIC INSTRUCTIONS

        // uint64 v_u32_add_b(uint64 a, uint32_t b, e_saturation st);
        #define av_add_av_s(acc0, acc1, scalar, SAT)\
                acc0.v1 = v_u32_add_b(acc1.v1, scalar, SAT);\
                acc0.v2 = v_u32_add_b(acc1.v2, scalar, SAT);\
                acc0.v3 = v_u32_add_b(acc1.v3, scalar, SAT);\
                acc0.v4 = v_u32_add_b(acc1.v4, scalar, SAT);

        // uint64 v_u32_sub_b(uint64 a, uint32_t b, e_saturation st);
        #define av_sub_av_s(acc0, acc1, scalar, SAT)\
                acc0.v1 = v_u32_sub_b(acc1.v1, scalar, SAT);\
                acc0.v2 = v_u32_sub_b(acc1.v2, scalar, SAT);\
                acc0.v3 = v_u32_sub_b(acc1.v3, scalar, SAT);\
                acc0.v4 = v_u32_sub_b(acc1.v4, scalar, SAT);

        #define av_ash_av_s(acc0, acc1, shift, RHU) \
                acc0.v1 = v_u32_ash_b(acc1.v1, shift, RHU << 1);   \
                acc0.v2 = v_u32_ash_b(acc1.v2, shift, RHU << 1);   \
                acc0.v3 = v_u32_ash_b(acc1.v3, shift, RHU << 1);   \
                acc0.v4 = v_u32_ash_b(acc1.v4, shift, RHU << 1);

        #define av_mov_v(acc, vec) \
                acc.v1 = (vec); \
                acc.v2 = (vec); \
                acc.v3 = (vec); \
                acc.v4 = (vec);

        // acc_u32.v1, v2, ... are guaranteed to be less than INT32_MAX because product is taken
        // with unity. Hence can be safely typecasted from UINT32 to INT32.
        #define av_convert_int_to_f32_v(u, i)\
            av_mov_v((u).acc_u32, 0);\
            (u).acc_u32 = v_u8_mac_b((i), 1, (u).acc_u32, SW_SAT);\
            (u).acc_f32.v1 = v_convert_i32_to_f32_b((int64)(u).acc_u32.v1, SW_RHNE);\
            (u).acc_f32.v2 = v_convert_i32_to_f32_b((int64)(u).acc_u32.v2, SW_RHNE);\
            (u).acc_f32.v3 = v_convert_i32_to_f32_b((int64)(u).acc_u32.v3, SW_RHNE);\
            (u).acc_f32.v4 = v_convert_i32_to_f32_b((int64)(u).acc_u32.v4, SW_RHNE);

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3448 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_i32_to_f32_x4_av(acc_out, acc_in, RHU) \
            acc_out = v_convert_i32_to_f32_x4_b(acc_in, RHU);
#else
# 3451 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_i32_to_f32_x4_av(acc_out, acc_in, RHU) \
            (acc_out).v1 = v_convert_i32_to_f32_b((int64)(acc_in).v1, RHU); \
            (acc_out).v2 = v_convert_i32_to_f32_b((int64)(acc_in).v2, RHU); \
            (acc_out).v3 = v_convert_i32_to_f32_b((int64)(acc_in).v3, RHU); \
            (acc_out).v4 = v_convert_i32_to_f32_b((int64)(acc_in).v4, RHU);
#endif
# 3457 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define av_convert_u32_to_f32_x4_av(acc_out, acc_in, sw)\
                (acc_out).v1 = v_convert_i32_to_f32_b((int64)(acc_in).v1, (sw)); \
                (acc_out).v2 = v_convert_i32_to_f32_b((int64)(acc_in).v2, (sw)); \
                (acc_out).v3 = v_convert_i32_to_f32_b((int64)(acc_in).v3, (sw)); \
                (acc_out).v4 = v_convert_i32_to_f32_b((int64)(acc_in).v4, (sw));

        #define av_f32_mul_v_vs(acc_out, acc_in, scale) \
                (acc_out).v1 = v_f32_mul_b((acc_in).v1, (scale)); \
                (acc_out).v2 = v_f32_mul_b((acc_in).v2, (scale)); \
                (acc_out).v3 = v_f32_mul_b((acc_in).v3, (scale)); \
                (acc_out).v4 = v_f32_mul_b((acc_in).v4, (scale));

        #define av_f32_mul_v_v(acc_out, acc_in1, acc_in2) \
                (acc_out).v1 = v_f32_mul_b((acc_in1).v1, (acc_in2).v1); \
                (acc_out).v2 = v_f32_mul_b((acc_in1).v2, (acc_in2).v2); \
                (acc_out).v3 = v_f32_mul_b((acc_in1).v3, (acc_in2).v3); \
                (acc_out).v4 = v_f32_mul_b((acc_in1).v4, (acc_in2).v4);

        // Convert f32 to i8 and then offset back to U8 range.
        // v_cast_f32_to_i8 will convert f32->i32 then i32->i8
        // Adding 128 w/o saturation will offset the I8 data back to U8 range.
        // The F32 data needs to be offset by -128 before this conversion.
        #define av_convert_f32_to_int_v(i, f32, i32, i8, RHU)\
                v_cast_f32_to_i8_v((f32).v1, (i8), (i32), 0)\
                v_cast_f32_to_i8_v((f32).v2, (i8), (i32), 1)\
                v_cast_f32_to_i8_v((f32).v3, (i8), (i32), 2)\
                v_cast_f32_to_i8_v((f32).v4, (i8), (i32), 3)\
                i = v_u8_add_b((uchar256)i8, 128, 0);

        #define v_cast_f32_to_8bit_v(y_f64, x_c256, y_i64, lane_sel)\
                v_cast_f32_to_u8_v(y_f64, x_c256, y_i64, lane_sel)

        #define av_f32_mac_v_vs(acc_out, acc_in, scale, zp) \
                (acc_out).v1 = v_f32_mac_b((acc_in).v1, (scale), zp, SW_NO_NEG); \
                (acc_out).v2 = v_f32_mac_b((acc_in).v2, (scale), zp, SW_NO_NEG); \
                (acc_out).v3 = v_f32_mac_b((acc_in).v3, (scale), zp, SW_NO_NEG); \
                (acc_out).v4 = v_f32_mac_b((acc_in).v4, (scale), zp, SW_NO_NEG);

        #define av_f32_mac_av_v(acc_out, acc_in1, acc_in2, acc_in3) \
          (acc_out).v1 = v_f32_mac_b((acc_in1).v1, (acc_in2), (acc_in3).v1, SW_NO_NEG);\
          (acc_out).v2 = v_f32_mac_b((acc_in1).v2, (acc_in2), (acc_in3).v2, SW_NO_NEG);\
          (acc_out).v3 = v_f32_mac_b((acc_in1).v3, (acc_in2), (acc_in3).v3, SW_NO_NEG);\
          (acc_out).v4 = v_f32_mac_b((acc_in1).v4, (acc_in2), (acc_in3).v4, SW_NO_NEG);
        #define av_f32_nearbyint_b(vOut, vIn, sw) \
                vOut.v1 = v_f32_nearbyint_b(vIn.v1, sw, vOut.v1); \
                vOut.v2 = v_f32_nearbyint_b(vIn.v2, sw, vOut.v2); \
                vOut.v3 = v_f32_nearbyint_b(vIn.v3, sw, vOut.v3); \
                vOut.v4 = v_f32_nearbyint_b(vIn.v4, sw, vOut.v4);

        
#if 0 /* disabled by -frewrite-includes */
#if !defined (ARG_GREATER_THAN_INT32_MAX)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3508 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            // acc_in.v1, v2, ... are guaranteed to be less than INT32_MAX. Hence can be safely
            // typecasted. For most U8 kernels, the values won't exceed INT32_MAX in real scenarios
            // and hence this definition is sufficient.

            #define av_i32_mul_double_and_round_v_s(acc_out, acc_in, scale) \
                    acc_out.v1 = (uint64)v_i32_mul_round_b((int64)acc_in.v1, scale); \
                    acc_out.v2 = (uint64)v_i32_mul_round_b((int64)acc_in.v2, scale); \
                    acc_out.v3 = (uint64)v_i32_mul_round_b((int64)acc_in.v3, scale); \
                    acc_out.v4 = (uint64)v_i32_mul_round_b((int64)acc_in.v4, scale);

            #define av_i32_add_av_s(acc_out, acc_in, s, st) \
                    (acc_out).v1 = (uint64)v_i32_add_b((int64)((acc_in).v1), s, st); \
                    (acc_out).v2 = (uint64)v_i32_add_b((int64)((acc_in).v2), s, st); \
                    (acc_out).v3 = (uint64)v_i32_add_b((int64)((acc_in).v3), s, st); \
                    (acc_out).v4 = (uint64)v_i32_add_b((int64)((acc_in).v4), s, st);
        #else
# 3524 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            // General case, where there is no guarantee that acc_in.v1, v2,.. are less than
            // INT32_MAX. Manually saturate vectors to INT32_MAX before typecasting.
            // Define ARG_GREATER_THAN_INT_MAX to use this version

            #define av_i32_mul_double_and_round_v_s(acc_out, acc_in, scale) \
                    acc_out.v1 = (uint64)v_i32_mul_round_b(\
                        (int64)v_u32_min_b(acc_in.v1, INT32_MAX), scale, 0, 0, 1, 0); \
                    acc_out.v2 = (uint64)v_i32_mul_round_b(\
                        (int64)v_u32_min_b(acc_in.v2, INT32_MAX), scale, 0, 0, 1, 0); \
                    acc_out.v3 = (uint64)v_i32_mul_round_b(\
                        (int64)v_u32_min_b(acc_in.v3, INT32_MAX), scale, 0, 0, 1, 0); \
                    acc_out.v4 = (uint64)v_i32_mul_round_b(\
                        (int64)v_u32_min_b(acc_in.v4, INT32_MAX), scale, 0, 0, 1, 0);

            #define av_i32_add_av_s(acc_out, acc_in, s, st) \
                    (acc_out).v1 = (uint64)v_i32_add_b(\
                        (int64)v_u32_min_b(acc_in.v1, INT32_MAX), s, st, 0, 1, 0); \
                    (acc_out).v2 = (uint64)v_i32_add_b(\
                        (int64)v_u32_min_b(acc_in.v2, INT32_MAX), s, st, 0, 1, 0); \
                    (acc_out).v3 = (uint64)v_i32_add_b(\
                        (int64)v_u32_min_b(acc_in.v3, INT32_MAX), s, st, 0, 1, 0); \
                    (acc_out).v4 = (uint64)v_i32_add_b(\
                        (int64)v_u32_min_b(acc_in.v4, INT32_MAX), s, st, 0, 1, 0);
        #endif
# 3548 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

// TODO avoid tmp
// avoiding usage of tmp causes value mismatch, probably compiler bug?
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3552 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_s(acc_out, acc_in, scale, shift, tmp)\
        av_i32_mul_double_and_round_v_s(acc_out, acc_in, scale);\
        av_ash_av_s(acc_out, acc_out, shift, 1);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 3556 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_s(acc_out, acc_in, scale, shift, tmp)\
        tmp = v_i32_mul_b((int64)acc_in.v1, scale, SW_KEEP_RS); acc_out.v1 = (uint64)v_i32_ash_rhaz_b(tmp, shift, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v2, scale, SW_KEEP_RS); acc_out.v2 = (uint64)v_i32_ash_rhaz_b(tmp, shift, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v3, scale, SW_KEEP_RS); acc_out.v3 = (uint64)v_i32_ash_rhaz_b(tmp, shift, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v4, scale, SW_KEEP_RS); acc_out.v4 = (uint64)v_i32_ash_rhaz_b(tmp, shift, 4);
#else
# 3562 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_i32_mul_and_ash_av_s() is not defined"
#endif
# 3564 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3566 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_av(acc_out, acc_in, scale, shift, tmp)\
        (acc_out).v1 = (uint64)v_i32_mul_round_b((int64)acc_in.v1, scale.v1);\
        (acc_out).v2 = (uint64)v_i32_mul_round_b((int64)acc_in.v2, scale.v2);\
        (acc_out).v3 = (uint64)v_i32_mul_round_b((int64)acc_in.v3, scale.v3);\
        (acc_out).v4 = (uint64)v_i32_mul_round_b((int64)acc_in.v4, scale.v4);\
        acc_out.v1 = (uint64)v_i32_ash_b((int64)acc_out.v1, (char256)shift.v1, 2);\
        acc_out.v2 = (uint64)v_i32_ash_b((int64)acc_out.v2, (char256)shift.v2, 2);\
        acc_out.v3 = (uint64)v_i32_ash_b((int64)acc_out.v3, (char256)shift.v3, 2);\
        acc_out.v4 = (uint64)v_i32_ash_b((int64)acc_out.v4, (char256)shift.v4, 2);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 3576 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_av(acc_out, acc_in, scale, shift, tmp)\
        tmp = v_i32_mul_b((int64)acc_in.v1, scale.v1, SW_KEEP_RS); acc_out.v1 = (uint64)v_i32_ash_rhaz_b(tmp, (char256)shift.v1, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v2, scale.v2, SW_KEEP_RS); acc_out.v2 = (uint64)v_i32_ash_rhaz_b(tmp, (char256)shift.v2, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v3, scale.v3, SW_KEEP_RS); acc_out.v3 = (uint64)v_i32_ash_rhaz_b(tmp, (char256)shift.v3, 4);\
        tmp = v_i32_mul_b((int64)acc_in.v4, scale.v4, SW_KEEP_RS); acc_out.v4 = (uint64)v_i32_ash_rhaz_b(tmp, (char256)shift.v4, 4);
#else
# 3582 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_i32_mul_and_ash_av_av() is not defined"
#endif
# 3584 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

// Without uint64 and int64 casts
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3587 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_av_(acc_out, acc_in, scale, shift, tmp)\
        (acc_out).v1 = v_i32_mul_round_b(acc_in.v1, scale.v1);\
        (acc_out).v2 = v_i32_mul_round_b(acc_in.v2, scale.v2);\
        (acc_out).v3 = v_i32_mul_round_b(acc_in.v3, scale.v3);\
        (acc_out).v4 = v_i32_mul_round_b(acc_in.v4, scale.v4);\
        acc_out.v1 = v_i32_ash_b(acc_out.v1, (char256)shift.v1, 2);\
        acc_out.v2 = v_i32_ash_b(acc_out.v2, (char256)shift.v2, 2);\
        acc_out.v3 = v_i32_ash_b(acc_out.v3, (char256)shift.v3, 2);\
        acc_out.v4 = v_i32_ash_b(acc_out.v4, (char256)shift.v4, 2);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 3597 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_i32_mul_and_ash_av_av_(acc_out, acc_in, scale, shift, tmp)\
        tmp = v_i32_mul_b(acc_in.v1, scale.v1, SW_KEEP_RS); acc_out.v1 = v_i32_ash_rhaz_b(tmp, (char256)shift.v1, 4);\
        tmp = v_i32_mul_b(acc_in.v2, scale.v2, SW_KEEP_RS); acc_out.v2 = v_i32_ash_rhaz_b(tmp, (char256)shift.v2, 4);\
        tmp = v_i32_mul_b(acc_in.v3, scale.v3, SW_KEEP_RS); acc_out.v3 = v_i32_ash_rhaz_b(tmp, (char256)shift.v3, 4);\
        tmp = v_i32_mul_b(acc_in.v4, scale.v4, SW_KEEP_RS); acc_out.v4 = v_i32_ash_rhaz_b(tmp, (char256)shift.v4, 4);
#else
# 3603 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_i32_mul_and_ash_av_av_() is not defined"
#endif
# 3605 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__gaudi__) || defined(__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3607 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define av_convert_av_s(acc, shift, source, round)\
        source = v_convert_uint32_to_u8_b(acc.v1, shift, 0, round, source);\
        source = v_convert_uint32_to_u8_b(acc.v2, shift, 1, round, source);\
        source = v_convert_uint32_to_u8_b(acc.v3, shift, 2, round, source);\
        source = v_convert_uint32_to_u8_b(acc.v4, shift, 3, round, source);
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 3613 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(32, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3614 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define av_convert_av_s(acc, shift, source, round)\
            source = v_convert_uint32_to_u8_all_b(acc, shift, round, source)
        #else
# 3617 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define av_convert_av_s(acc, shift, source, round)\
            source = v_convert_u32_to_u8_all_b(acc, shift, round, source, 1, 0)
        #endif
# 3620 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#else
# 3621 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#error "av_convert_av_s() is not defined"
#endif
# 3623 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        // int64 v_convert_i16_to_i32_b(char256 a);
        #define av_convert_to_i32_av(acc_in_u8, acc_out_i32) \
        acc_out_i32.v1 = v_convert_i16_to_i32_b((short128)acc_in_u8.v1);\
        acc_out_i32.v2 = v_convert_i16_to_i32_b((short128)acc_in_u8.v2);\
        acc_out_i32.v3 = v_convert_i16_to_i32_b((short128)acc_in_u8.v3);\
        acc_out_i32.v4 = v_convert_i16_to_i32_b((short128)acc_in_u8.v4);

        #define av_mul_v_v(a, b) \
                v_u8_mul_b(a, b)

        #define av_unpack_to_i32_v(input, acc_out) \
        acc_out.v1 = 0, acc_out.v2 = 0, acc_out.v3 = 0, acc_out.v4 = 0;\
        acc_out.v1 = v_u8_unpack_b(input, SW_GROUP_0 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_0, acc_out.v1, 1, 0);  \
        acc_out.v2 = v_u8_unpack_b(input, SW_GROUP_0 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_1, acc_out.v2, 1, 0); \
        acc_out.v3 = v_u8_unpack_b(input, SW_GROUP_1 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_0, acc_out.v3, 1, 0);  \
        acc_out.v4 = v_u8_unpack_b(input, SW_GROUP_1 | ((\
                SW_STRIDE_4)) | SW_GROUP_HALF_1, acc_out.v4, 1, 0);

        // COMPLEX LOGICAL INSTRUCTIONS
        #define av_max_av_s(acc0, acc1, scalar)\
           acc0.v1 = v_u32_max_b(acc1.v1, scalar);\
           acc0.v2 = v_u32_max_b(acc1.v2, scalar);\
           acc0.v3 = v_u32_max_b(acc1.v3, scalar);\
           acc0.v4 = v_u32_max_b(acc1.v4, scalar);

       #define av_max_av_av(acc0, acc1, acc2)\
           acc0.v1 = v_u32_max_b(acc1.v1, acc2.v1);\
           acc0.v2 = v_u32_max_b(acc1.v2, acc2.v2);\
           acc0.v3 = v_u32_max_b(acc1.v3, acc2.v3);\
           acc0.v4 = v_u32_max_b(acc1.v4, acc2.v4);

       #define av_min_av_s(acc0, acc1, scalar)\
           acc0.v1 = v_u32_min_b(acc1.v1, scalar);\
           acc0.v2 = v_u32_min_b(acc1.v2, scalar);\
           acc0.v3 = v_u32_min_b(acc1.v3, scalar);\
           acc0.v4 = v_u32_min_b(acc1.v4, scalar);

       #define av_min_av_av(acc0, acc1, acc2)\
           acc0.v1 = v_u32_min_b(acc1.v1, acc2.v1);\
           acc0.v2 = v_u32_min_b(acc1.v2, acc2.v2);\
           acc0.v3 = v_u32_min_b(acc1.v3, acc2.v3);\
           acc0.v4 = v_u32_min_b(acc1.v4, acc2.v4);

       #define v_gemmcast_32bit_to_f32_v(y_f64, x, v_scale_to_f32, v_scale_mul_zp) \
            v_gemmcast_u32_to_f32_v(y_f64, x, v_scale_to_f32, v_scale_mul_zp)

       #define v_gemmcast_f32_to_8bit_v(y_c256, x_f64, scale_to_int, zero_point, y_i32, lane_sel)\
            v_gemmcast_f32_to_u8_v(y_c256, x_f64, scale_to_int, zero_point, y_i32, lane_sel)

#endif
# 3677 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"



#if 0 /* disabled by -frewrite-includes */
#if defined(BFLOAT16)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3681 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3683 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
                #define DOUBLE_DEFINITION
        #endif
# 3685 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 128
        #define VECTOR_SIZE_LOG_2 7
        #define F_UINT_NUM_NUMBERS 65536.0

        typedef bfloat128         VECTOR;
        typedef bfloat128_pair_t  VECTOR_PAIR;
        typedef float128          ACC_VECTOR;
        typedef bf16              SCALAR;
        typedef VECTOR            VEC_INT;
        typedef SCALAR            INT;
        typedef ushort128         UVECTOR;
        typedef ushort128 UINTVECTOR;

        #define BFLOAT_MIN      -((bf16)1.0/(bf16)0.0) // -inf
        #define BFLOAT_MAX      ((bf16)1.0/(bf16)0.0) // +inf
        #define MIN_VAL         BFLOAT_MIN
        #define MINUS_INF       0xFF80
        #define PLUS_INF        0x7F80
        #define NAN             0x7FFF

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 3707 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_16
    #else
# 3709 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_2b_b()
    #endif
# 3711 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define INIT_ACC_VEC_INT(a) a.v1 = 0; a.v2 = 0;

        #define v_fclass_b(a)\
                v_bf16_fclass_b(a)

        #define s_add_s_s(a, b)\
                s_bf16_add(a, b)

        #define s_add_s_s_b(a, b, i, p, o)\
                s_bf16_add(a, b, 0, i, p, o)

        #define s_mov_s_b(a, s, p, pp) \
                s_bf16_mov(a, 0, s, p, pp)

        #define b_cmp_geq_s_s(a, b)\
                s_bf16_cmp_geq(a, b)

        #define b_cmp_geq_s_s_b(a, b, source, predicate, predicatePolarity)\
                s_bf16_cmp_geq(a, b, 0, source, predicate, predicatePolarity)

        #define b_cmp_less_s_s(a, b)\
                s_bf16_cmp_less(a, b)

        #define b_cmp_less_s_s_b(a, b, source, predicate, predicatePolarity)\
                s_bf16_cmp_less(a, b, 0, source, predicate, predicatePolarity)

        #define b_cmp_eq_s_s(a, b)\
                s_bf16_cmp_eq(a, b)

        #define b_cmp_neq_s_s(a, b)\
                s_bf16_cmp_neq(a, b)

        #define b_cmp_eq_s_s_b(a, b, source, predicate, predicatePolarity)\
                s_bf16_cmp_eq(a, b, 0, source, predicate, predicatePolarity)

        #define bv_cmp_eq_v_v(a, b) \
                from_bool128(v_bf16_cmp_eq_b(a, b))

        // bfloat128 v_bf16_ld_tnsr_b(int5 a, tensor b);
        #define v_ld_tnsr_i(a, b) \
                v_bf16_ld_tnsr_b(a, b)

        // bfloat128 v_bf16_ld_tnsr_b(int5 a, tensor b, 0, bfloat128 source,
        //                            bool predicate, bool predicatePolarity);
        #define v_ld_tnsr_b \
                v_bf16_ld_tnsr_b

        // bfloat128 v_bf16_ld_tnsr_b(int5 a, tensor b, 0, bfloat128 source, bool predicate, bool predicatePolarity);
        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity) \
                v_bf16_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_i_vb(a, b, source, predicate, predicatePolarity) \
                v_bf16_ld_tnsr_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_ld_g_a(a) \
                v_bf16_ld_g(a)

        //bfloat128 v_bf16_ld_tnsr_b(int5 a, int8_t b);
        #define v_ld_tnsr_reg_i_s(a, b) \
                v_bf16_ld_tnsr_b(a, b)

        // bfloat128 v_bf16_ld_tnsr_vb(int5 a, int8_t b, 0, bfloat128 source,
        //                 to_bool128(bool256 predicate), bool predicatePolarity);
        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_bf16_ld_tnsr_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        // bfloat128 v_bf16_ld_g(__global__ void* a, 0, bfloat128 source, bool predicate,
        // bool predicatePolarity);
        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_bf16_ld_g(a, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_low_i(coords, tnsr) \
                v_bf16_ld_tnsr_low_b(coords, tnsr)

        #define v_ld_tnsr_low_i_b(coords, tnsr, input, pred, o) \
                v_bf16_ld_tnsr_low_b(coords, tnsr, 0, input, pred, o)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_bf16_ld_tnsr_partial_b(coord, tnst, size, offset)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity) \
                v_bf16_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity)

        #define v_ld_tnsr_b \
                v_bf16_ld_tnsr_b

        #define v_not_v(a) \
                v_bf16_not_b(a)

        // void v_bf16_st_tnsr(int5 a, int8_t b, bfloat128 c);
        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_bf16_st_tnsr(a, b, c)

        // void v_bf16_st_tnsr(int5 a, int8_t b, bfloat128 c, 0, bool predicate,
        //                                                                  bool predicatePolarity);
        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_bf16_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        // void v_bf16_st_tnsr_low(int5 a, tensor b, float64 c, 0,
        //                                                  bool predicate, bool predicatePolarity);
        #define st_tnsr_low_i_v_b(coords, tnsr, c, predicate, predicatePolarity) \
                v_bf16_st_tnsr_low(coords, tnsr, c, 0, predicate, predicatePolarity) \

        #define v_st_tnsr_b \
                v_bf16_st_tnsr

        #define s_ld_g_a(a) \
                s_bf16_ld_g(a)

        #define s_ld_g_a_b(a, i, p, o) \
                s_bf16_ld_g(a, 0, i, p, o)

        #define s_st_g_a_s(a, b) \
                s_bf16_st_g(a, b)

        #define st_g_a_s_b(a, b, c, d) \
                s_bf16_st_g(a,b,0,c,d)


        #define v_mov_s(a) \
                (a)

        #define v_mov_v(a) \
                (a)

        #define v_mov_v_b(a, b, predicate, predicatePolarity)\
                v_bf16_mov_b(a, 0, b, predicate, predicatePolarity)

        #define v_mov_v_vb(a, b, predicate, predicatePolarity) \
                v_bf16_mov_vb(a, 0, b, to_bool128(predicate), predicatePolarity)

        #define v_mov_vb(a, sw, out, pred, pp) \
                v_bf16_mov_vb(a, sw, out, pred, pp)

        #define v_ui_shr_v_v(a, b) \
                v_u16_shr_b(a, (short128)b)

        // bfloat128 v_bf16_add_b(bfloat128 a, bfloat128 b, 0, bfloat128 source,
        //                                      bool predicate, bool predicatePolarity);
        #define v_add_v_v_b(a, b, source, predicate, predicatePolarity) \
                v_bf16_add_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_add_v_v(a, b, st) \
                v_bf16_add_b(a, b)

        #define v_add_v_v_vb(a, b, source, predicate, predicatePolarity) \
                v_bf16_add_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_uadd_v_v_vb(a, b, source, sw, predicate, predicatePolarity) \
                v_u16_add_vb(a, b, sw, source, to_bool128(predicate), predicatePolarity)

        // bfloat128 v_bf16_add_b(bfloat128 a, bf16 b);
        #define v_add_v_s(a, b, not_used) \
                v_bf16_add_b(a, b)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_bf16_add_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        // bfloat128 v_bf16_add_b(bfloat128 a, bf16 b);
        #define v_add_neg_v_s(a, b, not_used) \
                v_bf16_add_b(a, b)

        // bfloat128 v_bf16_sub_b(bfloat128 a, bf16 b, e_negation neg = 0 << 1);
        #define v_sub_v_s(a, b, not_used) \
                v_bf16_sub_b(a, b, SW_NO_NEG)

        #define v_sub_v_s_vb(a, b, source, switches, predicate, predicatePolarity) \
                v_bf16_sub_vb(a, b, switches << 1, source, to_bool128(predicate), predicatePolarity)

        // bfloat128 v_bf16_sub_b(bfloat128 a, bf16 b, e_negation neg = 1 << 1);
        #define v_sub_neg_v_s(a, b, not_used) \
                v_bf16_sub_b(a, b, SW_NEG)

        // bfloat128 v_bf16_sub_b(bfloat128 a, bfloat128 b, e_negation neg = 0 << 1);
        #define v_sub_v_v(a, b, not_used) \
                v_bf16_sub_b(a, b, SW_NO_NEG)

        // bfloat128 v_bf16_sub_b(bfloat128 a, bfloat128 b, e_negation neg = 1 << 1);
        #define v_sub_neg_v_v(a, b, not_used) \
                v_bf16_sub_b(a, b, SW_NEG)

        #define s_mul_s_s(a, b)\
                s_bf16_mul(a, b)

        // bfloat128 v_bf16_mul_b(bfloat128 a, bfloat128 b);
        #define v_mul_v_v(a, b) \
                v_bf16_mul_b(a, b)

        // bfloat128 v_bf16_mul_vb(bfloat128 a, bfloat128 b, 0, bfloat128 source,
        //                         to_bool128(bool256 predicate), bool predicatePolarity);
        #define v_mul_v_v_vb(a, b, source, predicate, predicatePolarity) \
                v_bf16_mul_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        // bfloat128 v_bf16_mul_b(bfloat128 a, bf16 b);
        #define v_mul_v_s(a, b) \
                v_bf16_mul_b(a, b)

        // bfloat128 v_bf16_mul_vb(bfloat128 a, bf16 b, 0, bfloat128 source,
        //                              to_bool128(bool256 predicate), bool predicatePolarity);
        #define v_mul_v_s_vb(a, b, source, predicate, predicatePolarity)\
           v_bf16_mul_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_mul_v_s_b(a, b, source, predicate, predicatePolarity)\
           v_bf16_mul_b(a, b, 0, source, predicate, predicatePolarity)

        // bfloat128 v_bf16_mac_b(bfloat128 a, bfloat128 b, bfloat128 source, (e_negation neg)<< 1);
        #define v_mul_acc32_b(a, b) v_bf16_mul_acc32_b(a, b)

        #define v_mac_acc32_vb v_bf16_mac_acc32_vb

        // bfloat128 v_bf16_mac_b(bfloat128 a, bfloat128 b, bfloat128 source, (e_negation neg) << 1, 1, 0);
        #define v_mac_v_v(a, b, source, neg) \
                v_bf16_mac_b(a, b, source, neg)

        // bfloat128 v_bf16_mac_vb(bfloat128 a, bfloat128 b, bfloat128 source,
        //            (e_negation neg) << 1, to_bool128(bool256 predicate), bool predicatePolarity);
        #define v_mac_v_v_vb(a, b, source, neg, predicate, predicatePolarity) \
                v_bf16_mac_vb(a, b, source, neg, to_bool128(predicate), predicatePolarity)

        #define v_mac_v_v_b(a, b, source, neg, predicate, predicatePolarity) \
                v_bf16_mac_b(a, b, source, neg, predicate, predicatePolarity)

        // bfloat128 v_bf16_mac_b(bfloat128 a, bf16 b, bfloat128 source, (e_negation neg) << 1);
        #define v_mac_v_s(a, b, source, neg) \
                v_bf16_mac_b(a, b, source, neg)

        // bfloat128 v_bf16_mac_b(bfloat128 a, bf16 b, bfloat128 source, (e_negation neg) << 1,
        //                                             bool predicate, bool predicatePolarity);
        #define v_mac_v_s_b(a, b, source, neg, predicate, predicatePolarity) \
                v_bf16_mac_b(a, b, source, neg, predicate, predicatePolarity)

        #define s_mac_s_s(a, b, source, neg) \
                s_bf16_mac(a, b, source, neg)

        // bfloat128 v_bf16_max_b(bfloat128 a, bf16 b);
        #define v_max_v_s(a, b) \
                v_bf16_max_b(a, b)

        // bfloat128 v_bf16_min_b(bfloat128 a, bfloat128 b);
        #define v_min_v_s(a, b) \
                v_bf16_min_b(a, b)

        // bfloat128 v_bf16_max_b(bfloat128 a, bfloat128 b);
        #define v_max_v_v(a, b) \
                v_bf16_max_b(a, b)

        #define v_max_v_v_b(a,b,source,predicate,predicatePolarity) \
                v_bf16_max_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_max_v_v_vb(a,b,source,predicate,predicatePolarity) \
                v_bf16_max_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        // bfloat128 v_bf16_min_b(bfloat128 a, bfloat128 b);
        #define v_min_v_v(a, b) \
                v_bf16_min_b(a, b)

        // void v_bf16_st_tnsr(int5 a, tensor b, bfloat128 c);
        #define st_tnsr_i_v(a, b, c) \
                v_bf16_st_tnsr(a, b, c)

        // void v_bf16_st_tnsr_low(int5 a, tensor b, bfloat128 c);
        #define st_tnsr_low_i_v(a, b, c) \
                v_bf16_st_tnsr_low(a, b, c)

        // void v_bf16_st_tnsr(int5 a, tensor b, bfloat128 c, 0, bool predicate,
        //                                                       bool predicatePolarity);
        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_bf16_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        // bfloat128 v_bf16_abs_b(bfloat128 a);
        #define v_abs_v(a) \
                v_bf16_abs_b(a)

        // void v_bf16_st_tnsr_rmw(int5 a, tensor b, bfloat128 c, MkRMW(e_rmw_datatype dataype,
        //                         e_rmw_op rmw_op, e_rmw_set rmw,
        //                         e_tnsr_dt_location tnsr_dt_location));
        #define st_tnsr_rmw_i_v(a, b, c, rmw_op, rmw, tnsr_dt_location)\
                v_bf16_st_tnsr_rmw(a, b, c, MkRMW(\
                    e_rmw_bf16, \
                    rmw_op, \
                    rmw, \
                    tnsr_dt_location\
                ), 0, 1, 0);

        #define st_tnsr_rmw_i_v_b(a, b, c, rmw_op, rmw, tnsr_dt_location, predicate, predicatePolarity)\
                v_bf16_st_tnsr_rmw(a, b, c, MkRMW(\
                    e_rmw_bf16, \
                    rmw_op, \
                    rmw, \
                    tnsr_dt_location), 0, \
                    predicate, predicatePolarity\
                );

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_bf16_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_bf16_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_bf16_st_tnsr_partial(n, t, v, s, f, 0, p, o)

        #define bv_cmp_grt_v_s(a, b) \
                from_bool128(v_bf16_cmp_grt_b(a, b))

        #define bv_cmp_grt_v_v(a, b) \
                from_bool128(v_bf16_cmp_grt_b(a, b))

        #define bv_cmp_grt_v_vb(a, b, c, d, e, f) \
                from_bool128(v_bf16_cmp_grt_b(a, b, c, d, e, f))

         #define bv_cmp_geq_v_v(a, b)\
                from_bool128(v_bf16_cmp_geq_b(a, b))

        #define bv_ucmp_geq_v_s(a, b) \
                from_bool128(v_u16_cmp_geq_b(a, b))

        #define bv_cmp_less_v_s(a, b) \
                from_bool128(v_bf16_cmp_less_b(a, b))

        #define bv_cmp_geq_v_s(a, b) \
                from_bool128(v_bf16_cmp_geq_b(a, b))

        #define bv_ucmp_less_v_s(a, b) \
                from_bool128(v_u16_cmp_less_b(a, b));

        #define bv_cmp_less_v_v(a, b) \
                from_bool128(v_bf16_cmp_less_b(a, b))

        #define bv_cmp_less_v_vb(a, b, c, d, e, f) \
                from_bool128(v_bf16_cmp_less_b(a, b, c, d, e, f))

        #define bv_cmp_leq_v_v(a, b) \
                from_bool128(v_bf16_cmp_leq_b(a, b))

        #define bv_cmp_neq_v_v(a, b)\
                from_bool128(v_bf16_cmp_neq_b(a, b))

        #define b_cmp_geq_s_s(a, b)\
                s_bf16_cmp_geq(a, b)

        #define v_shuffle_v_v(a, b) \
                v_bf16_shuffle_b(a, b, 0, a)

        //bfloat128 v_bf16_shuffle_vb(bfloat16 a, uchar256 b, 0, bfloat16 source,
        //                to_bool128(bool256 predicate), bool predicatePolarity);
        #define v_shuffle_v_v_vb(a, b, source, predicate, predicatePolarity) \
                v_bf16_shuffle_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_mov_dual_group_v(a, b, src, src_dual, dst_dual, wr_lower_group, wr_upper_group) \
                v_bf16_mov_dual_group_b(a, b, src_dual, dst_dual, MkWr(wr_lower_group,\
                                                                  wr_upper_group), src)

        #define v_mov_dual_group_v_vb(a, b, src, src_dual, dst_dual, wr_lower_group,    \
                                wr_upper_group, predicate, predicatePolarity)           \
                v_bf16_mov_dual_group_vb(a, b, src_dual, dst_dual, MkWr(wr_lower_group, \
                                wr_upper_group), src, to_bool128(predicate), predicatePolarity)

        #define v_mov_dual_group_all_v(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3) \
                v_bf16_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src)

        #define v_mov_group_v(a, b, src, grp_en, dual_grp_en) \
                v_bf16_mov_group_b(a, b, (dual_grp_en << 2) | grp_en, src)

        #define v_nearbyint_v(a, b) \
                v_bf16_nearbyint_b(a, b)

        // BINARY LOGICAL INSTRUCTIONS
        #define v_sel_grt_v_v_v_v(a, b, c, d) \
                v_bf16_sel_grt_bf16_b(a, b, c, d)

        #define v_sel_grt_v_v_v_v_b(a, b, c, d, source, predicate, predicatePolarity) \
                v_bf16_sel_grt_bf16_b(a, b, c, d, 0, source, predicate, predicatePolarity)

        #define v_sel_geq_v_v_v_v(a, b, c, d) \
                v_bf16_sel_geq_bf16_b(a, b, c, d)

        #define v_sel_less_v_v_v_v(a, b, c, d) \
                v_bf16_sel_less_bf16_b(a, b, c, d)

        #define v_sel_less_v_v_v_v_vb(a, b, c, d, i, p, o) \
                v_bf16_sel_less_bf16_vb(a, b, c, d, 0, i, to_bool128(p), o)

        #define v_sel_leq_v_v_v_v(a, b, c, d) \
                v_bf16_sel_leq_bf16_b(a, b, c, d)

        #define v_sel_eq_v_v_v_v(a, b, c, d) \
                v_bf16_sel_eq_bf16_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v(a, b, c, d) \
                v_bf16_sel_neq_bf16_b(a, b, c, d)

        #define v_sel_neq_v_s_v_v(a, b, c, d) \
                v_bf16_sel_neq_bf16_b(a, b, c, d)

        #define v_sel_grt_v_s_v_v(a, b, c, d) \
                v_bf16_sel_grt_bf16_b(a, b, c, d)

        #define v_sel_geq_v_s_v_v(a, b, c, d) \
                v_bf16_sel_geq_bf16_b(a, b, c, d)

        #define v_sel_less_v_s_v_v(a, b, c, d) \
                v_bf16_sel_less_bf16_b(a, b, c, d)

        #define v_sel_less_v_s_v_v_b(a, b, c, d, i, p, o) \
                v_bf16_sel_less_bf16_b(a, b, c, d, 0, i, p, o)

        #define v_sel_geq_v_s_v_v_b(a, b, c, d, i, p, o) \
                 v_bf16_sel_geq_bf16_b(a, b, c, d, 0, i, p, o)

        #define v_sel_leq_v_s_v_v(a, b, c, d) \
                v_bf16_sel_leq_bf16_b(a, b, c, d)

        #define v_sel_eq_v_s_v_v(a, b, c, d) \
                v_bf16_sel_eq_bf16_b(a, b, c, d)

        #define v_sel_neq_v_v_v_s(a, b, c, d) \
                v_bf16_sel_neq_bf16_b(a, b, c, d)

        #define v_sel_grt_v_v_v_s(a, b, c, d) \
                v_bf16_sel_grt_bf16_b(a, b, c, d)

        #define v_sel_geq_v_v_v_s(a, b, c, d) \
                v_bf16_sel_geq_bf16_b(a, b, c, d)

        #define v_sel_less_v_v_v_s(a, b, c, d) \
                v_bf16_sel_less_bf16_b(a, b, c, d)

        #define v_sel_leq_v_v_v_s(a, b, c, d) \
                v_bf16_sel_leq_bf16_b(a, b, c, d)

        #define v_sel_eq_v_v_v_s(a, b, c, d) \
                v_bf16_sel_eq_bf16_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v_vb(a, b, c, d, e, f, g) \
                v_bf16_sel_neq_bf16_vb(a, b, c, d, 0, e, to_bool128(f), g)

        #define bv_cmp_neq_v_v(a, b)\
                from_bool128(v_bf16_cmp_neq_b(a, b))

        #define v_or_v_v(a, b) \
                v_bf16_or_b(a, b)

        #define v_and_v_v(a, b) \
                v_bf16_and_b(a, b)

        #define v_xor_v_v(a, b) \
                v_bf16_xor_b(a, b)

        #define av_mac_acc32(a, b, acc, neg) \
                v_bf16_mac_acc32_b(a, b, acc, neg)

        #define av_mac_acc32_b(a, b, acc, neg, predicate, polarity) \
                v_bf16_mac_acc32_b(a, b, acc, neg, predicate, polarity)

        #define av_mul_acc32(a, b) \
                v_bf16_mul_acc32_b(a, b)

        #define av_mul_acc32_b(a, b, switch, income, predicate, polarity) \
                v_bf16_mul_acc32_b(a, b, switch, income, predicate, polarity)

        #define av_mac_acc_v_v(a, b, acc, neg) \
                v_bf16_mac_acc32_b(a, b, acc, neg)

        #define av_mac_acc_v_v_b(a, b, acc, neg, p, pp) \
                v_bf16_mac_acc32_b(a, b, acc, neg, p, pp)

        #define v_convert_from_f32_av_vb(a, i, rm, predicate, polarity) \
                v_convert_f32_to_bf16_all_vb(a, rm, i, to_bool128(predicate), polarity)

        #define v_convert_from_f32_av(a, rm) \
                v_convert_f32_to_bf16_all_b(a, rm)

        #define av_convert_to_f32_v_b(a, acc, predicate, polarity)\
                v_convert_bf16_to_f32_all_b(a, 0, acc, predicate, polarity);

        #define av_convert_to_f32_v(a)\
                v_convert_bf16_to_f32_all_b(a)

        #define v_convert_vec_to_f32_all_b(a, rm, income, pred, pp) \
                v_convert_bf16_to_f32_all_b(a, rm, income, pred, pp)

        #define v_convert_f32_to_vec_all_b(a, rm, income, pred, pp)\
                v_convert_f32_to_bf16_all_b(a, rm, income, pred, pp)

        #define v_convert_f32_to_vec_all(a, rm)\
                v_convert_f32_to_bf16_all_b(a, rm)

        #define v_convert_f32_to_vec_single_b(a, rm, income, pred, pp)\
                v_convert_f32_to_bf16_single_b(a, rm, income, pred, pp);

        #define s_convert_from_f32_s(src, rm) \
                s_convert_f32_to_bf16(src, rm)

        #define v_convert_from_i16_v(a, rm) \
                v_convert_i16_to_bf16_b(a, rm)

        #define s_convert_to_f32_s(src) \
                s_convert_bf16_to_f32(src, SW_CSR)

        // SPECIAL INSTRUCTIONS

        #define div(a, b) \
            div_bf16(a, b)

        #define log_fast(a) \
            log_bf16(a)

        #define log(a) \
            log_bf16(a)

        #define pow_fast(a, b) \
            pow_bf16(a, b)

        #define pow(a, b) \
            pow_bf16(a, b)

        #define exp_fast(a) \
            exp_fast_bf16(a)

        #define exp(a) \
            exp_bf16(a)

        #define sigmoid(a) \
            sigmoid_bf16(a)

        #define exp_dn_clamp(a) \
            exp_dn_clamp_bf16(a)

        #define reciprocal(a) \
            reciprocal_bf16(a)

        #define sqrt(a) \
            sqrt_bf16(a)

        #define v_extract_exp_v(vec, bias) \
            v_bf16_extract_exp_b(vec, bias)

        #define v_mov_s_vb(a, b, predicate, predicatePolarity) \
            v_bf16_mov_vb(a, 0, b, to_bool128(predicate), predicatePolarity)

        #define v_mov_s_b(a, s, p, pp) \
            v_bf16_mov_b(a, 0, s, p, pp)

        #define av_mov_zero(acc)\
            acc.v1 = 0;   acc.v2 = 0;

        #define av_init_val(acc, val)\
            acc.v1 = v_mov_s(val);   acc.v2 = v_mov_s(val);

        // MAC & convert  wrapper
        #define v_mac_acc32(a, b, accum, neg, nump) v_bf16_mac_acc32_b(a, b, accum, neg, nump)
        #define v_convert_f32_to_vec(a, rnd) v_convert_f32_to_bf16_all_b(a, rnd)

        #define av_convert_vec_to_f32(a) \
            v_convert_bf16_to_f32_all_b(a)

        #define v_reduce_max_v(a) v_bf16_reduce_max(a)
        #define v_reduce_min_v(a) v_bf16_reduce_min(a)
        #define v_reduce_add_v(a) v_bf16_reduce_add(a)
        #define mod(a, b) mod_bf16(a, b)
#endif
# 4276 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"



// UINT32   ************************************************************************
#if 0 /* disabled by -frewrite-includes */
#if defined(UINT32)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4281 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4283 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
                #define DOUBLE_DEFINITION
        #endif
# 4285 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 64

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4289 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_32
    #else
# 4291 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_4b_b()
    #endif
# 4293 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define v_shl_v_v(a, b) \
                v_u32_shl_b(a, (int64)b)

        #define v_shr_v_v(a, b) \
                v_u32_shr_b(a, (int64)b)

        #define v_not_v(a) \
                v_u32_not_b(a)

        #define v_ld_tnsr_i(a, b) \
                v_u32_ld_tnsr_b(a, b)

        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity) \
                v_u32_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_u32_ld_tnsr_partial_b(coord, tnst, size, offset)

        //int64 v_u32_ld_tnsr_b(int5 a, int8_t b);
        #define v_ld_tnsr_reg_i_s(a, b) \
                v_u32_ld_tnsr_b(a, b)

        //int64 v_u32_ld_tnsr_vb(int5 a, int8_t b, 0, int64 source, to_bool64(bool256 predicate),
        //                                                               bool predicatePolarity);
        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_u32_ld_tnsr_vb(a, b, 0, source, to_bool64(predicate), predicatePolarity)

        //int64 v_u32_ld_g(__global__ void* a, 0, int64 source, bool predicate,
        //                                                                bool predicatePolarity);
        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_u32_ld_g(a, 0, source, predicate, predicatePolarity)

        // void  v_u32_st_tnsr(int5 a, tensor b, int64 c);
        #define st_tnsr_i_v(a, b, c) \
                v_u32_st_tnsr(a, b, c)

        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_u32_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_u32_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_u32_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_u32_st_tnsr_partial(n, t, v, s, f, 0, p, o)

        // void v_u32_st_tnsr(int5 a, int8_t b, int64 c);
        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_u32_st_tnsr(a, b, c)

        // void v_u32_st_tnsr(int5 a, int8_t b, int64 c, 0, bool predicate,
        //                                                              bool predicatePolarity);
        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_u32_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_u32_add_vb(a, b, SW_SAT, source, to_bool64(predicate), predicatePolarity)

        #define v_add_v_v(a, b, st) \
                v_u32_add_b(a, b, st)

        #define v_add_v_v_b(a, b, source, predicate, predicatePolarity) \
                v_u32_add_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity) \
                v_u32_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                        polarity)

        typedef uint64           VECTOR;
        typedef uint128          ACC_VECTOR;
        typedef uint32_t         SCALAR;

        typedef VECTOR          VEC_INT;
        typedef ACC_VECTOR      ACC_VEC_INT;
        typedef SCALAR          INT;

        #define MAX_POSITIVE            (4294967295UL)
        #define UNSIGNED_PAIR_T         uint32_t_pair_t
        #define PAIR_T                  UNSIGNED_PAIR_T
        #define SCALAR_T                uint32_t
        #define UNSIGNED_SCALAR_T       uint32_t
        #define INT_STEP                31
        #define div_mod_i               div_mod_u32
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4381 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u32_udiv_step(a, s, 0, i)
        #endif
# 4383 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined( __gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4384 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u32_udiv_4step(a, s, 0, i)
        #endif
# 4386 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4387 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u32_udiv_4step(a, s, SW_X2_UDIV_4STEP, i)
        #endif
# 4389 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4390 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_udiv_step_s(i, a, s)  u32_udiv_both(a, s, SW_DIV_MODE_BOTH, i)
        #endif
# 4392 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define s_ld_g_a(a) \
                s_u32_ld_g(a)

        #define s_add_s_s_b(a, b, i, p, o)\
                s_u32_add(a, b, 0, i, p, o)

        #define s_st_g_a_s(a, s) \
                s_u32_st_g(a, s)

#endif
# 4402 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"




#if 0 /* disabled by -frewrite-includes */
#if defined(FLOAT16)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4407 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4409 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
                #define DOUBLE_DEFINITION
        #endif
# 4411 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define VECTOR_SIZE 128
        #define F_UINT_NUM_NUMBERS 65536.0

        typedef half128         VECTOR;
        typedef half128_pair_t  VECTOR_PAIR;
        typedef float128        ACC_VECTOR;
        typedef half            SCALAR;
        typedef VECTOR          VEC_INT;
        typedef SCALAR          INT;
        typedef ushort128       UVECTOR;

        #define FLOAT16_MIN      -((half)1.0/(half)0.0) // -inf
        #define FLOAT16_MAX      ((half)1.0/(half)0.0) // +inf
        #define MIN_VAL         FLOAT16_MIN
        #define MINUS_INF       0xFC00
        #define PLUS_INF        0x7C00
        #define NAN             0x7FFF

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4431 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_16
    #else
# 4433 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_2b_b()
    #endif
# 4435 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define INIT_ACC_VEC_INT(a) a.v1 = 0; a.v2 = 0;

        #define v_fclass_b(a)\
                v_f16_fclass_b(a)

        #define v_ld_tnsr_i(a, b) \
                v_f16_ld_tnsr_b(a, b)

        #define v_ld_tnsr_b \
                v_f16_ld_tnsr_b

        #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity) \
                v_f16_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_i_vb(a, b, source, predicate, predicatePolarity) \
                v_f16_ld_tnsr_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_ld_g_a(a) \
                v_f16_ld_g(a)

        #define v_ld_tnsr_reg_i_s(a, b) \
                v_f16_ld_tnsr_b(a, b)

        #define v_ld_tnsr_reg_i_s_vb(a, b, source, predicate, predicatePolarity) \
                v_f16_ld_tnsr_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
                v_f16_ld_g(a, 0, source, predicate, predicatePolarity)

        #define v_ld_tnsr_low_i(coords, tnsr) \
                v_f16_ld_tnsr_low_b(coords, tnsr)

        #define v_ld_tnsr_low_i_b(coords, tnsr, input, pred, o) \
                v_f16_ld_tnsr_low_b(coords, tnsr, 0, input, pred, o)

        #define v_ld_tnsr_partial_i(coord, tnst, size, offset) \
                v_f16_ld_tnsr_partial_b(coord, tnst, size, offset)

        #define v_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity) \
                v_f16_ld_tnsr_partial_b(coords, tnsr,  size, offset,switches, income, predicate, \
                                    polarity)

        #define v_ld_tnsr_b \
                v_f16_ld_tnsr_b

        #define v_not_v(a) \
                v_f16_not_b(a)

        #define st_tnsr_reg_i_s_v(a, b, c) \
                v_f16_st_tnsr(a, b, c)

        #define st_tnsr_reg_i_s_v_b(a, b, c, predicate, predicatePolarity) \
                v_f16_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_low_i_v_b(coords, tnsr, c, predicate, predicatePolarity) \
                v_f16_st_tnsr_low(coords, tnsr, c, 0, predicate, predicatePolarity) \

        #define v_st_tnsr_b \
                v_f16_st_tnsr

        #define s_ld_g_a(a) \
                s_f16_ld_g(a)

        #define s_ld_g_a_b(a, i, p, o) \
                s_f16_ld_g(a, 0, i, p, o)

        #define s_st_g_a_s(a, b) \
                s_f16_st_g(a, b)

        #define st_g_a_s_b(a, b, c, d) \
                s_f16_st_g(a, b, 0, c, d)

        #define av_mov_zero(acc)\
                acc.v1 = 0;   acc.v2 = 0;

        #define av_init_val(acc, val)\
                acc.v1 = v_mov_s(val);   acc.v2 = v_mov_s(val);

        #define v_mov_s(a) \
                (a)

        #define v_mov_v(a) \
                (a)

        #define v_mov_v_b(a, b, predicate, predicatePolarity)\
                v_f16_mov_b(a, 0, b, predicate, predicatePolarity)

        #define v_mov_v_vb(a, b, predicate, predicatePolarity) \
                v_f16_mov_vb(a, 0, b, to_bool128(predicate), predicatePolarity)

        #define v_mov_vb(a, sw, out, pred, pp) \
                v_f16_mov_vb(a, sw, out, pred, pp)

        #define v_ui_shr_v_v(a, b) \
                v_u16_shr_b(a, (short128)b)

        #define v_add_v_v_b(a, b, source, predicate, predicatePolarity) \
                v_f16_add_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_add_v_v(a, b, not_used) \
                v_f16_add_b(a, b)

        #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
                v_f16_add_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_add_v_v_vb(a, b, source, predicate, predicatePolarity) \
                v_f16_add_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_add_v_s(a, b, not_used) \
                v_f16_add_b(a, b)

        #define s_add_s_s_b(a, b, i, p, o)\
                s_f16_add(a, b, 0, i, p, o)

        #define v_add_neg_v_s(a, b, not_used) \
                v_f16_add_b(a, b)

        #define v_sub_v_s(a, b, not_used) \
                v_f16_sub_b(a, b, SW_NO_NEG)

        #define v_sub_v_s_vb(a, b, source, switches, predicate, predicatePolarity) \
                v_f16_sub_vb(a, b, switches << 1, source, to_bool128(predicate), predicatePolarity)

        #define v_sub_neg_v_s(a, b, not_used) \
                v_f16_sub_b(a, b, SW_NEG)

        #define v_sub_v_v(a, b, not_used) \
                v_f16_sub_b(a, b, SW_NO_NEG)

        #define v_sub_neg_v_v(a, b, not_used) \
                v_f16_sub_b(a, b, SW_NEG)

        #define s_mul_s_s(a, b)\
                s_f16_mul(a, b)

        #define v_mul_v_v(a, b) \
                v_f16_mul_b(a, b)

        #define v_mul_v_v_vb(a, b, source, predicate, predicatePolarity) \
                v_f16_mul_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_mul_v_s(a, b) \
                v_f16_mul_b(a, b)

        #define v_mul_v_s_vb(a, b, source, predicate, predicatePolarity)\
           v_f16_mul_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_mul_v_s_b(a, b, source, predicate, predicatePolarity)\
           v_f16_mul_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_mul_acc32_b(a, b) v_f16_mul_acc32_b(a, b)

        #define v_mac_acc32_vb v_f16_mac_acc32_vb

        #define v_mac_v_v(a, b, source, neg) \
                v_f16_mac_b(a, b, source, neg)

        #define v_mac_v_v_vb(a, b, source, neg, predicate, predicatePolarity) \
                v_f16_mac_vb(a, b, source, neg, to_bool128(predicate), predicatePolarity)

        #define v_mac_v_v_b(a, b, source, neg, predicate, predicatePolarity) \
                v_f16_mac_b(a, b, source, neg, predicate, predicatePolarity)

        #define v_mac_v_s(a, b, source, neg) \
                v_f16_mac_b(a, b, source, neg)

        #define v_mac_v_s_b(a, b, source, neg, predicate, predicatePolarity) \
                v_f16_mac_b(a, b, source, neg, predicate, predicatePolarity)

        #define s_mac_s_s(a, b, source, neg) \
                s_f16_mac(a, b, source, neg)

        #define v_max_v_s(a, b) \
                v_f16_max_b(a, b)

        #define v_min_v_s(a, b) \
                v_f16_min_b(a, b)

        #define v_max_v_v(a, b) \
                v_f16_max_b(a, b)

        #define v_max_v_v_b(a,b,source,predicate,predicatePolarity) \
                v_f16_max_b(a, b, 0, source, predicate, predicatePolarity)

        #define v_max_v_v_vb(a,b,source,predicate,predicatePolarity) \
                v_f16_max_vb(a, b, 0, source, to_bool128((bool256)(predicate)), predicatePolarity)

        #define v_min_v_v(a, b) \
                v_f16_min_b(a, b)

        #define st_tnsr_i_v(a, b, c) \
                v_f16_st_tnsr(a, b, c)

        #define st_g_a_s_b(a, b, c, d) \
                s_f16_st_g(a, b, 0, c, d)

        #define st_tnsr_low_i_v(a, b, c) \
                v_f16_st_tnsr_low(a, b, c)

        #define st_tnsr_i_v_b(a, b, c, predicate, predicatePolarity) \
                v_f16_st_tnsr(a, b, c, 0, predicate, predicatePolarity)

        #define st_tnsr_partial_i_v(a, b, c, size, offset) \
                v_f16_st_tnsr_partial(a, b, c, size, offset)

        #define st_tnsr_partial_i_v_b(a, b, c, size, offset, predicate, predicatePolarity) \
                v_f16_st_tnsr_partial(a, b, c, size, offset, 0, predicate, predicatePolarity)

        #define v_st_tnsr_partial(n, t, v, s, f, p, o) \
                v_f16_st_tnsr_partial(n, t, v, s, f, 0, p, o)

        #define v_abs_v(a) \
                v_f16_abs_b(a)
#ifndef __gaudib__
        #define st_tnsr_rmw_i_v(a, b, c, rmw_op, rmw, tnsr_dt_location)\
                v_f16_st_tnsr_rmw(a, b, c, MkRMW(\
                    RMW_DT_FP16, \
                    rmw_op, \
                    rmw, \
                    tnsr_dt_location\
                ), 0, 1, 0);
#endif // not suported at gaudib
# 4659 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define st_tnsr_rmw_i_v_b(a, b, c, op, rmw, tnsr_dt_location, predicate, predicatePolarity)\
                v_f16_st_tnsr_rmw(a, b, c, MkRMW(\
                    RMW_DT_FP16, \
                    op, \
                    rmw, \
                    tnsr_dt_location), 0, \
                    predicate, predicatePolarity\
                );
        #define bv_cmp_grt_v_s(a, b) \
                from_bool128(v_f16_cmp_grt_b(a, b))

        #define bv_cmp_grt_v_v(a, b) \
                from_bool128(v_f16_cmp_grt_b(a, b))

        #define bv_cmp_geq_v_s(a, b) \
                from_bool128(v_f16_cmp_geq_b(a, b))

        #define bv_cmp_less_v_s(a, b) \
                from_bool128(v_f16_cmp_less_b(a, b))

        #define bv_cmp_less_v_v(a, b) \
                from_bool128(v_f16_cmp_less_b(a, b))

        #define bv_cmp_leq_v_v(a, b) \
                from_bool128(v_f16_cmp_leq_b(a, b))

        #define bv_cmp_geq_v_v(a, b) \
                from_bool128(v_f16_cmp_geq_b(a, b))

        #define bv_cmp_neq_v_v(a, b)\
                from_bool128(v_f16_cmp_neq_b(a, b))

        #define bv_cmp_eq_v_v(a, b) \
                from_bool128(v_f16_cmp_eq_b(a, b))

        #define b_cmp_geq_s_s(a, b)\
                b_f16_cmp_geq_s_s(a, b)

        #define b_f16_cmp_geq_s_s_b(a, b, i, p, o) \
                s_f16_cmp_geq(a, b, 0, i, p, o)

        #define b_f16_cmp_geq_s_s(a, b) \
                b_f16_cmp_geq_s_s_b(a, b, 0, 1, 0)

        #define b_cmp_less_s_s(a, b)\
                s_f16_cmp_less(a, b)

        #define v_shuffle_v_v(a, b) \
                v_f16_shuffle_b(a, b, 0, a)

        #define v_shuffle_v_v_vb(a, b, source, predicate, predicatePolarity) \
            v_f16_shuffle_vb(a, b, 0, source, to_bool128(predicate), predicatePolarity)

        #define v_mov_dual_group_v(a, b, src, src_dual, dst_dual, wr_lower_group, wr_upper_group) \
                v_f16_mov_dual_group_b(a, b, src_dual, dst_dual, MkWr(wr_lower_group, wr_upper_group), src)

        #define v_mov_dual_group_v_vb(a, b, src, src_dual, dst_dual, wr_lower_group, \
                                                   wr_upper_group, predicate, predicatePolarity) \
                v_f16_mov_dual_group_vb(a, b, src_dual, dst_dual, MkWr(wr_lower_group, \
                                                   wr_upper_group), src, to_bool128(predicate), predicatePolarity)

        #define v_mov_dual_group_all_v(a, b, src, src_dual_0, src_dual_1, src_dual_2, src_dual_3, wr_0, wr_1, wr_2, wr_3) \
                v_f16_mov_dual_group_all_b(a, b, src_dual_0, src_dual_1, src_dual_2, src_dual_3, MkWrA(wr_0, wr_1, wr_2, wr_3), src)

        #define v_mov_group_v(a, b, src, grp_en, dual_grp_en) \
                v_f16_mov_group_b(a, b, dual_grp_en << 2 | grp_en, src)

        #define v_nearbyint_v(a, b) \
                v_f16_nearbyint_b(a, b)

        // BINARY LOGICAL INSTRUCTIONS
        #define v_sel_grt_v_v_v_v(a, b, c, d) \
                v_f16_sel_grt_f16_b(a, b, c, d)

        #define v_sel_grt_v_v_v_v_b(a, b, c, d, source, predicate, predicatePolarity) \
                v_f16_sel_grt_f16_b(a, b, c, d, 0, source, predicate, predicatePolarity)

        #define v_sel_geq_v_v_v_v(a, b, c, d) \
                v_f16_sel_geq_f16_b(a, b, c, d)

        #define v_sel_less_v_v_v_v(a, b, c, d) \
                v_f16_sel_less_f16_b(a, b, c, d)

        #define v_sel_leq_v_v_v_v(a, b, c, d) \
                v_f16_sel_leq_f16_b(a, b, c, d)

        #define v_sel_eq_v_v_v_v(a, b, c, d) \
                v_f16_sel_eq_f16_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v(a, b, c, d) \
                v_f16_sel_neq_f16_b(a, b, c, d)

        #define v_sel_neq_v_s_v_v(a, b, c, d) \
                v_16_sel_neq_f16_b(a, b, c, d, 0, 0, 1, 0)

        #define v_sel_grt_v_s_v_v(a, b, c, d) \
                v_f16_sel_grt_f16_b(a, b, c, d)

        #define v_sel_geq_v_s_v_v(a, b, c, d) \
                v_f16_sel_geq_f16_b(a, b, c, d)

        #define v_sel_less_v_s_v_v(a, b, c, d) \
                v_f16_sel_less_f16_b(a, b, c, d)

        #define v_sel_less_v_s_v_v_b(a, b, c, d, i, p, o) \
                v_f16_sel_less_f16_b(a, b, c, d, 0, i, p, o)

        #define v_sel_geq_v_s_v_v_b(a, b, c, d, i, p, o) \
                 v_f16_sel_geq_f16_b(a, b, c, d, 0, i, p, o)

        #define v_sel_leq_v_s_v_v(a, b, c, d) \
                v_f16_sel_leq_f16_b(a, b, c, d)

        #define v_sel_eq_v_s_v_v(a, b, c, d) \
                v_f16_sel_eq_f16_b(a, b, c, d)

        #define v_sel_neq_v_v_v_v_vb(a, b, c, d, e, f, g) \
                v_f16_sel_neq_f16_vb(a, b, c, d, 0, e, to_bool128(f), g)

        #define bv_cmp_neq_v_v(a, b)\
                from_bool128(v_f16_cmp_neq_b(a, b))

        #define v_or_v_v(a, b) \
                v_f16_or_b(a, b)

        #define v_and_v_v(a, b) \
                v_f16_and_b(a, b)

        #define v_xor_v_v(a, b) \
                v_f16_xor_b(a, b)

        #define v_extract_exp_v(vec, bias) \
            v_f16_extract_exp_b(vec, bias)

        #define v_mov_s_vb(a, b, predicate, predicatePolarity) \
            v_f16_mov_vb(a, 0, b, to_bool128(predicate), predicatePolarity)

        
#if 0 /* disabled by -frewrite-includes */
#if defined (__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4797 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define v_mov_s_b(a, s, p, pp) \
                v_bf16_mov_b((bfloat128)a, 0, (bfloat128)s, p, pp)
        #else
# 4800 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define v_mov_s_b(a, s, p, pp) \
                v_f16_mov_b(a, 0, s, p, pp)
        #endif
# 4803 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #define v_u16_f16_sel_grt_v_s_v_v(a, b, c, d) \
                v_f16_sel_grt_u16_b(a, b, c, d)

        #define av_mac_acc32(a, b, acc, neg) \
                v_f16_mac_acc32_b(a, b, acc, neg)

        #define av_mac_acc32_b(a, b, acc, neg, predicate, polarity) \
                v_f16_mac_acc32_b(a, b, acc, neg, predicate, polarity)\

        #define av_mul_acc32(a, b) \
                v_f16_mul_acc32_b(a, b)

        #define av_mul_acc32_b(a, b, switch, income, predicate, polarity) \
                v_f16_mul_acc32_b(a, b, switch, income, predicate, polarity)

        #define av_mac_acc_v_v(a, b, acc, neg) \
                v_f16_mac_acc32_b(a, b, acc, neg)

        #define av_mac_acc_v_v_b(a, b, acc, neg, p, pp) \
                v_f16_mac_acc32_b(a, b, acc, neg, p, pp)

        #define v_convert_from_f32_av(a, rm) \
                v_convert_f32_to_f16_all_b(a, rm)

        #define v_convert_from_f32_av_vb(a, i, rm, predicate, polarity) \
                v_convert_f32_to_f16_all_vb(a, rm, i, to_bool128(predicate), polarity)

        #define v_convert_f32_to_vec_all_b(a, rm, income, pred, pp)\
                v_convert_f32_to_f16_all_b(a, rm, income, pred, pp)

        #define v_convert_f32_to_vec_all(a, rm)\
                v_convert_f32_to_f16_all_b(a, rm)

        #define v_convert_f32_to_vec_single_b(a, rm, income, pred, pp)\
                v_convert_f32_to_f16_single_b(a, rm, income, pred, pp);

        #define v_convert_vec_to_f32_all_b(a, rm, income, pred, pp) \
                v_convert_f16_to_f32_all_b(a, rm, income, pred, pp)

        #define s_convert_from_f32_s(src, rm) \
                s_convert_f32_to_f16(src, rm)

        #define s_convert_to_f32_s(src) \
                s_convert_f16_to_f32(src, SW_CSR)

        #define av_convert_to_f32_v_b(a, acc, predicate, polarity)\
                v_convert_f16_to_f32_all_b(a, 0, acc, predicate, polarity)

        #define av_convert_to_f32_v(a)\
                v_convert_f16_to_f32_all_b(a)

        #define v_convert_from_i16_v(a, rm) \
                v_convert_i16_to_f16_b(a, rm)

        // Special Instructions

        #define exp(a) \
            exp_f16(a)

        #define sigmoid(a) \
            sigmoid_f16(a)

        #define exp_dn_clamp(a) \
            exp_f16(a)

        #define exp_fast(a) \
            exp_f16(a)

        #define sqrt(a) \
            sqrt_f16(a)

        #define pow(a, b) \
            pow_f16(a, b)

        #define pow_fast(a, b) \
            pow_f16(a, b)

        #define log(a) \
                log_f16(a)

        #define log_fast(a) \
            log_f16(a)

        #define reciprocal(a) \
            reciprocal_f16(a)

        #define b_cmp_eq_s_s(a, b)\
                b_f16_cmp_eq_s_s(a, b)

        #define b_cmp_eq_s_s_b(a, b, source, predicate, predicatePolarity) \
                b_f16_cmp_eq_s_s_b(a, b, source, predicate, predicatePolarity)

        #define b_cmp_geq_s_s_b(a, b, source, predicate, predicatePolarity)\
                b_f16_cmp_geq_s_s_b(a, b, source, predicate, predicatePolarity)

        #define v_reduce_max_v(a) v_f16_reduce_max(a)
        #define v_reduce_min_v(a) v_f16_reduce_min(a)
        #define v_reduce_add_v(a) v_f16_reduce_add(a)

#    ifdef __TPC_DROP_VERSION
#if 0 /* disabled by -frewrite-includes */
#        if __TPC_DROP_VERSION >= VERSION2DEC(16, 0, 1)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 4905 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
            #define v_mac_acc32(a, b, accum, neg, nump) v_f16_mac_acc32_b(a, b, accum, neg, nump)
            #define v_convert_f32_to_vec(a, rnd) v_convert_f32_to_f16_all_b(a, rnd)

            #define av_convert_vec_to_f32(a) \
                v_convert_f16_to_f32_all_b(a)
          #endif
# 4911 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #endif
# 4912 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#endif // FLOAT16
# 4913 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#ifdef __TPC_DROP_VERSION
  
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION >= VERSION2DEC(16, 0, 1)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 4916 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
    #define FLOAT16_ALREADY_FIXED_IN_tpc_defs
  #endif
# 4918 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#endif
# 4919 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

/* Define here f16 intrinsic wrappers equivalent to tpc-defs.h */
#ifdef FLOAT16
        #define b_f16_cmp_eq_s_s(a, b) \
                b_f16_cmp_eq_s_s_b(a, b, 0, 1, 0)

        #define b_f16_cmp_eq_s_s_b(a, b, i, p, o) \
                s_f16_cmp_eq(a, b, 0, i, p, o)

        #define b_f16_cmp_geq_s_s_b(a, b, i, p, o) \
                s_f16_cmp_geq(a, b, 0, i, p, o)
#endif
# 4931 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#ifndef FLOAT16_ALREADY_FIXED_IN_tpc_defs  // these function are already defined in tpc-defs.h
  #ifdef  FLOAT16
        #define s_convert_f32_to_f16(src, rm, income, pred, pol) \
                s_convert_f32_to_f16(src, rm, income, pred, pol) //Not working currently, LLVM-384

        #define s_convert_f32_to_f16(src, rm) \
                s_convert_f32_to_f16(src, rm)

        #define v_convert_f32_to_f16_all_b(a, rm, i, p, o) \
                v_convert_f32_to_f16_all_b(a, rm, i, p, o)

        #define v_convert_f32_to_f16_all_b(a, rm) \
                v_convert_f32_to_f16_all_b(a, rm)

        #define v_convert_f16_to_f32_all_b(a, 0, i, p, o) \
                v_convert_f16_to_f32_all_b(a, 0, i, p, o)

        #define v_convert_f16_to_f32_all_b(a) \
                v_convert_f16_to_f32_all_b(a)

        #define v_f16_st_tnsr(n, t, v, 0, p, o) \
                v_f16_st_tnsr(n, t, v, 0, p, o)

        #define v_f16_st_tnsr(n, t, v) \
                v_f16_st_tnsr(n, t, v)

        #define v_f16_mov_dual_group_b(a, b, s, d, MkWr(l, u), i, p, o) \
                v_f16_mov_dual_group_b(a, b, s, d, MkWr(l, u), i, p, o)

        #define v_f16_mov_dual_group_b(a, b, s, d, MkWr(l, u), i) \
                v_f16_mov_dual_group_b(a, b, s, d, MkWr(l, u), i)

        #define v_f16_mov_dual_group_all_b(a, b, s0, s1, s2, s3, MkWrA(w0, w1, w2, w3), i, p, o) \
                v_f16_mov_dual_group_all_b(a, b, s0, s1, s2, s3, MkWrA(w0, w1, w2, w3), i, p, o)

        #define v_f16_mov_dual_group_all_b(a, b, s0, s1, s2, s3, MkWrA(w0, w1, w2, w3), i) \
                v_f16_mov_dual_group_all_b(a, b, s0, s1, s2, s3, MkWrA(w0, w1, w2, w3), i)

        #define v_f16_mov_group_b(a, b, ((d) << 2) | g, i, p, o) \
                v_f16_mov_group_b(a, b, ((d) << 2) | g, i, p, o)

        #define v_f16_mov_group_b(a, b, ((d) << 2) | g, i) \
                v_f16_mov_group_b(a, b, ((d) << 2) | g, i)

        #define v_f16_shuffle_b(a, b, 0, a) \
                v_f16_shuffle_b(a, b, 0, a)

        #define v_f16_shuffle_b(a, b, 0, i, p, o) \
                v_f16_shuffle_b(a, b, 0, i, p, o)

        #define v_f16_max_vb(a, b, 0, i, to_bool128(p), o) \
                v_f16_max_vb(a, b, 0, i, to_bool128(p), o)

        #define v_f16_mac_acc32_b(a, b, acc, neg) \
                v_f16_mac_acc32_b(a, b, acc, neg)

        #define v_f16_mac_acc32_b(a, b, acc, neg, p, pol) \
                v_f16_mac_acc32_b(a, b, acc, neg, p, pol)

        // MAC Instruction
        #define v_f16_mac_acc32_vb(a, b, acc, neg, to_bool128(p), pol) \
                v_f16_mac_acc32_vb(a, b, acc, neg, to_bool128(p), pol)

        #define v_f16_mac_acc32_vb(a, b, acc, neg, to_bool128(p), pol) \
                v_f16_mac_acc32_vb(a, b, acc, neg, to_bool128(p), pol)

        #define v_f16_mac_acc32_b(a, b, acc, neg, p, pol) \
                v_f16_mac_acc32_b(a, b, acc, neg, p, pol)

        #define v_f16_mac_acc32_b(a, b, acc, neg) \
                v_f16_mac_acc32_b(a, b, acc, neg)

        #define v_mac_acc32(a, b, accum, neg, nump) v_f16_mac_acc32_b(a, b, accum, neg, nump)

        #define v_convert_f32_to_vec(a, rnd) v_convert_f32_to_f16_all_b(a, rnd)

        #define av_convert_vec_to_f32(a) \
            v_convert_f16_to_f32_all_b(a)

        #define v_convert_f16_to_i16_b(a, rm, i, p, o) \
                v_convert_f16_to_i16_b(a, rm, i, p, o)

        #define v_convert_f16_to_i16_b(a, rm) \
                v_convert_f16_to_i16_b(a, rm)

        #define v_convert_i16_to_f16_b(a, rm, i, p, o) \
                v_convert_i16_to_f16_b(a, rm, i, p, o)

        #define v_convert_i16_to_f16_b(a, rm) \
                v_convert_i16_to_f16_b(a, rm)

        #define v_f16_ld_tnsr_b(n, t, 0, i, p, o)    v_f16_ld_tnsr_b(n, t, 0, i, p, o)
        #define v_f16_ld_tnsr_b(n, t)               v_f16_ld_tnsr_b(n, t)
        #define v_f16_st_tnsr(n, t, v, a)           v_f16_st_tnsr(n, t, v, a)
        #define v_f16_st_tnsr(n, t, v, 0, p, o)    v_f16_st_tnsr(n, t, v, 0, p, o)
        #define v_f16_st_tnsr(n, t, v)            v_f16_st_tnsr(n, t, v)
        #define v_f16_st_tnsr(n, t, v)      v_f16_st_tnsr(n, t, v)
        #define v_f16_ld_g(a, 0, i, p, o)          v_f16_ld_g(a, 0, i, p, o)
        #define v_f16_ld_g(a)                     v_f16_ld_g(a)

    #endif
# 5033 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
#endif //FLOAT16 tpc-defs.h
# 5034 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(FLOAT8)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 5036 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
    
#if 0 /* disabled by -frewrite-includes */
#if defined(VECTOR_SIZE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 5037 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define DOUBLE_DEFINITION
    #endif
# 5039 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

    #define VECTOR_SIZE 256

    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 5043 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID V_LANE_ID_8
    #else
# 5045 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
        #define V_LANE_ID read_lane_id_1b_b()
    #endif
# 5047 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

    // SINGLE LOAD AND STORE INSTRUCTIONS
    // minihalf256 v_h8_ld_tnsr_b(int5 a, tensor b);
    #define v_ld_tnsr_i(a, b) v_h8_ld_tnsr_b(a, b)

    #define v_ld_tnsr_i_b(a, b, source, predicate, predicatePolarity) \
        v_h8_ld_tnsr_b(a, b, 0, source, predicate, predicatePolarity)

    #define v_ld_g_a_b(a, source, predicate, predicatePolarity) \
        v_h8_ld_g(a, 0, source, predicate, predicatePolarity)

    // void  v_h8_st_tnsr(int5 a, tensor b, minihalf256 c);
    #define st_tnsr_i_v(a, b, c) v_h8_st_tnsr(a, b, c)

    // SINGLE ARITHMETIC INSTRUCTIONS
    // minihalf256 v_h8_abs_b(minihalf256 a);
    #define v_abs_v(a) v_h8_abs_b(a)

    // minihalf256 v_h8_add_b(minihalf256 a, minihalf256 b, e_saturation st, minihalf256 source,
    // bool predicate, bool predicatePolarity);
    #define v_add_v_v(a, b, st) v_h8_add_b(a, b, st)

    // minihalf256 v_h8_add_b(minihalf256 a, minihalf b, e_saturation st);
    #define v_add_v_s(a, b, st) v_h8_add_b(a, b, st)

    #define v_add_v_s_vb(a, b, source, predicate, predicatePolarity) \
        v_h8_add_vb(a, b, SW_SAT, source, predicate, predicatePolarity)

typedef minihalf256 VECTOR;
typedef float256    ACC_VECTOR;
typedef minihalf    SCALAR;
typedef VECTOR      VEC_INT;
typedef SCALAR      INT;
typedef uchar256    UVECTOR;
typedef uchar256    UINTVECTOR;

#endif
# 5084 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"


#if 0 /* disabled by -frewrite-includes */
#if defined(DOUBLE_DEFINITION) ||  \
    (!defined(UINT8)  && !defined(INT8)  && !defined(INT16) && !defined(UINT16) && \
     !defined(UINT32) && !defined(INT32) && !defined(BFLOAT16) && !defined(FLOAT32) && !defined(FLOAT16) && \
     !defined(FLOAT8) && !defined(INT4_TO_INT8) && !defined(UINT4_TO_UINT8) && !defined(INT8_TO_INT4) && \
     !defined(UINT8_TO_UINT4) && !defined(INT4_TO_INT16) && !defined(UINT4_TO_UINT16))
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 5091 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

        #error INT32, UINT32, INT16, INT16, INT8, UINT8 FLOAT32, BFLOAT16, FLOAT16 \
                INT4_TO_INT8, UINT4_TO_UINT8, INT8_TO_INT4, UINT8_TO_UINT4, INT4_TO_INT16, UINT4_TO_UINT16\
                      IS NOT DEFINED OR BOTH DEFINED AT THE SAME TIME
#endif
# 5096 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"

#endif // #ifndef _CONFIG_KERNELS_TYPE_H
# 5098 "/home/acherkasov/ws/tpc_kernels/kernels/common/config_kernels_type.h"
# 15 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h" 2
#if 0 /* expanded by -frewrite-includes */
#include "cast_helper.h"
#endif /* expanded by -frewrite-includes */
# 15 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
# 1 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h" 1
/*****************************************************************************
* Copyright (C) 2020 HabanaLabs, Ltd.
* All Rights Reserved.
*
* Unauthorized copying of this file, via any medium is strictly prohibited.
* Proprietary and confidential.
*
* Authors:
* Sergei Gorenko <sergei.gorenko@p-product.com>
* Subhankar Paul <spaul@habana.ai>
* Pyotr Brysin <pyotr.brysin@p-product.com>
******************************************************************************
*/
#ifndef CAST_HELPER_H_
#define CAST_HELPER_H_

#ifdef __gaudi2__
    #define ROUND_MODE             SW_CSR // round mode from CONV_ROUND_CSR
    #define CONV_ROUND_CSR_OFFSET  0xCA8
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif __goya2__
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 21 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
    #define ROUND_MODE             SW_CSR // round mode from CONV_ROUND_CSR
    #define CONV_ROUND_CSR_OFFSET  0xCA8
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined (__gaudib__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 24 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
    #define ROUND_MODE  SW_CSR     // round mode from ROUND_CSR
    #define CSR_OFFSET  0x8FC   // gaudi don't have unique round csr register
#else
# 27 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
    #ifdef ROUND_HALF_NE
        #define ROUND_MODE SW_RHNE
    
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined ROUND_DOWN
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 30 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
        #define ROUND_MODE SW_RD
    
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined ROUND_UP
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 32 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
        #define ROUND_MODE SW_RU
    
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined ROUND_ZERO
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 34 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
        #define ROUND_MODE SW_RZ
    
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined ROUND_DEFAULT
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 36 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
        #define ROUND_MODE SW_RHNE
    #else
# 38 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
        #define ROUND_MODE SW_RHNE
    #endif
# 40 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

#endif
# 42 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 44 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
char256 cast_16bits_to_i8_lin_order(char256 x0, char256 x1)
{
    char256 t = 0, y = 0;

    y = v_i8_pack_b(x0, SW_GROUP_0 | SW_STRIDE_2, y);
    y = v_i8_pack_b(x0, SW_GROUP_1 | SW_STRIDE_2, y);

    // 0..15, 16..31
    y = v_i8_mov_dual_group_b(y, 0xFFFFFFFF, 1, 0, MkWr(0, 1), y);
    // 0..15, 16..31, 32..47
    y = v_i8_mov_dual_group_b(y, 0xFFFFFFFF, 2, 1, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63
    y = v_i8_mov_dual_group_b(y, 0xFFFFFFFF, 3, 1, MkWr(0, 1), y);

    t = v_i8_pack_b((char256)x1, SW_GROUP_0 | SW_STRIDE_2, t);
    t = v_i8_pack_b((char256)x1, SW_GROUP_1 | SW_STRIDE_2, t);
    // 0..15, 16..31, 32..47, 48..63, 64..79
    y = v_i8_mov_dual_group_b(t, 0xFFFFFFFF, 0, 2, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95
    y = v_i8_mov_dual_group_b(t, 0xFFFFFFFF, 1, 2, MkWr(0, 1), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111
    y = v_i8_mov_dual_group_b(t, 0xFFFFFFFF, 2, 3, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111, 112..127
    y = v_i8_mov_dual_group_b(t, 0xFFFFFFFF, 3, 3, MkWr(0, 1), y);

    return y;
}
#else //defined(__gaudi__) || defined(__goya2__)
# 72 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
char256 cast_16bits_to_i8_lin_order(char256 x0, char256 x1)
{
    char256 t = 0, y = 0;

    y = v_i8_pack_b(x0, SW_GROUP_0 | SW_STRIDE_2, y);
    y = v_i8_pack_b(x0, SW_GROUP_1 | SW_STRIDE_2, y);

    // 0..15, 16..31, 32..47,
    y = v_i8_mov_dual_group_all_b(y, 0xFFFFFFFF, 1, 2, 3, 0, MkWrA(0b10, 0b01, 0b00, 0b00), y);
    // 0..15, 16..31, 32..47, 48..63
    y = v_i8_mov_dual_group_b(y, 0xFFFFFFFF, 3, 1, MkWr(0, 1), y);

    t = v_i8_pack_b(x1, SW_GROUP_0 | SW_STRIDE_2, t);
    t = v_i8_pack_b(x1, SW_GROUP_1 | SW_STRIDE_2, t);

    // 0..15, 16..31, 32..47, 48..63, 64..79, 96..111
    y = v_i8_mov_dual_group_all_b(t, 0xFFFFFFFF, 1, 3, 0, 2, MkWrA(0b00, 0b00, 0b01, 0b01), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111, 112..127
    y = v_i8_mov_dual_group_all_b(t, 0xFFFFFFFF, 0, 2, 1, 3, MkWrA(0b00, 0b00, 0b10, 0b10), y);

    return y;
}

uchar256 cast_16bits_to_u8_lin_order(uchar256 x0, uchar256 x1)
{
    uchar256 t = 0, y = 0;

    y = v_u8_pack_b(x0, SW_GROUP_0 | SW_STRIDE_2, y);
    y = v_u8_pack_b(x0, SW_GROUP_1 | SW_STRIDE_2, y);

    // 0..15, 16..31, 32..47,
    y = v_u8_mov_dual_group_all_b(y, 0xFFFFFFFF, 1, 2, 3, 0, MkWrA(0b10, 0b01, 0b00, 0b00), y);
    // 0..15, 16..31, 32..47, 48..63
    y = v_u8_mov_dual_group_b(y, 0xFFFFFFFF, 3, 1, MkWr(0, 1), y);

    t = v_u8_pack_b(x1, SW_GROUP_0 | SW_STRIDE_2, t);
    t = v_u8_pack_b(x1, SW_GROUP_1 | SW_STRIDE_2, t);

    // 0..15, 16..31, 32..47, 48..63, 64..79, 96..111
    y = v_u8_mov_dual_group_all_b(t, 0xFFFFFFFF, 1, 3, 0, 2, MkWrA(0b00, 0b00, 0b01, 0b01), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111, 112..127
    y = v_u8_mov_dual_group_all_b(t, 0xFFFFFFFF, 0, 2, 1, 3, MkWrA(0b00, 0b00, 0b10, 0b10), y);

    return y;
}

//uchar256 cast_u16_to_u8_lin_order(ushort128 x0, ushort128 x1)
//{
//    return cast_16bits_to_u8_lin_order((uchar256)x0, (uchar256)x1);
//}

#endif
# 124 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

uchar256 cast_u16_to_u8_lin_order(ushort128 x0, ushort128 x1)
{
    return convert_ushort256_to_uchar256({x0, x1}, SW_LINEAR);
}

char256 cast_i16_to_i8_lin_order(short128 x0, short128 x1)
{
#ifdef __goya2__
    return cast_16bits_to_i8_lin_order((char256)x0, (char256)x1);
#else
# 135 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
    // TODO: goya2/elementwise/unary/cast_i8_to_i4_gemmlowp.c
    return convert_short256_to_char256({x0, x1}, SW_LINEAR);
#endif
# 138 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
}

uchar256 cast_i16_to_u8_lin_order(short128 x0, short128 x1)
{
#ifdef __goya2__
    return (uchar256)cast_16bits_to_i8_lin_order((char256)x0, (char256)x1);
#else
# 145 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
    // TODO: goya2/elementwise/unary/cast_u8_to_u4_gemmlowp.c
    return convert_short256_to_uchar256({x0, x1}, SW_LINEAR);
#endif
# 148 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
}

#if 0 /* disabled by -frewrite-includes */
#if defined(__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 151 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
char256 cast_lin_i16_to_i8_swizzle_order(short128 x0, short128 x1)
{
    return convert_short256_to_char256({x0, x1}, SW_RHNE);
}

char256 cast_lin_u16_to_i8_swizzle_order(ushort128 x0, ushort128 x1)
{
    return convert_ushort256_to_char256({x0, x1}, SW_RHNE);
}

uchar256 cast_lin_u16_to_u8_swizzle_order(ushort128 x0, ushort128 x1)
{
   return convert_ushort256_to_uchar256({x0, x1}, SW_RHNE);

}
#endif
# 167 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

// x0, x1 - unpacked short128 which actually int64 values
#ifdef __goya__
short128 cast_32bits_to_i16_lin_order(short128 x0, short128 x1)
{
    short128 t = 0, y = 0;

    y = v_i16_pack_b(x0, SW_GROUP_0 | SW_STRIDE_2, y);
    y = v_i16_pack_b(x0, SW_GROUP_1 | SW_STRIDE_2, y);
    // 0..15, 16..31
    y = v_i16_mov_dual_group_b(y, 0xFFFFFFFF, 1, 0, MkWr(0, 1), y);
    // 0..15, 16..31, 32..47
    y = v_i16_mov_dual_group_b(y, 0xFFFFFFFF, 2, 1, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63
    y = v_i16_mov_dual_group_b(y, 0xFFFFFFFF, 3, 1, MkWr(0, 1), y);

    t = v_i16_pack_b(x1, SW_GROUP_0 | SW_STRIDE_2, t);
    t = v_i16_pack_b(x1, SW_GROUP_1 | SW_STRIDE_2, t);
    // 0..15, 16..31, 32..47, 48..63, 64..79
    y = v_i16_mov_dual_group_b(t, 0xFFFFFFFF, 0, 2, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95
    y = v_i16_mov_dual_group_b(t, 0xFFFFFFFF, 1, 2, MkWr(0, 1), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111
    y = v_i16_mov_dual_group_b(t, 0xFFFFFFFF, 2, 3, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111, 112..127
    y = v_i16_mov_dual_group_b(t, 0xFFFFFFFF, 3, 3, MkWr(0, 1), y);

    return y;
}
#else //__gaudi__ or __goya2_
# 197 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
short128 cast_32bits_to_i16_lin_order(short128 x0, short128 x1)
{
    short128 t = 0, y = 0;

    y = v_i16_pack_b(x0, SW_GROUP_0 | SW_STRIDE_2, y);
    y = v_i16_pack_b(x0, SW_GROUP_1 | SW_STRIDE_2, y);
    // 0..15, 16..31, 32..47,
    y = v_i16_mov_dual_group_all_b(y, 0xFFFFFFFF, 1, 2, 3, 0, MkWrA(0b10, 0b01, 0b00, 0b00), y);
    // 0..15, 16..31, 32..47, 48..63
    y = v_i16_mov_dual_group_b(y, 0xFFFFFFFF, 3, 1, MkWr(0, 1), y);

    t = v_i16_pack_b(x1, SW_GROUP_0 | SW_STRIDE_2, t);
    t = v_i16_pack_b(x1, SW_GROUP_1 | SW_STRIDE_2, t);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 96..111
    y = v_i16_mov_dual_group_all_b(t, 0xFFFFFFFF, 1, 3, 0, 2, MkWrA(0b00, 0b00, 0b01, 0b01), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111, 112..127
    y = v_i16_mov_dual_group_all_b(t, 0xFFFFFFFF, 0, 2, 1, 3, MkWrA(0b00, 0b00, 0b10, 0b10), y);

    return y;
}
#endif
# 218 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

// shift <= 0
#if 0 /* disabled by -frewrite-includes */
#if defined(__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 221 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
short128 cast_lin_i32_to_i16_swizzle_order(int128 x, int shift)
{
    return int_convert_int128_to_short128(x, shift, SW_RHNE);
}
#endif
# 226 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

// shift <= 0
short128 cast_i32_to_i16_lin_order(int64 x0, int64 x1, int shift)
{
    return int_convert_int128_to_short128({x0, x1}, shift, SW_RHNE | SW_LINEAR);
}

#if 0 /* disabled by -frewrite-includes */
#if defined(__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 234 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
short128 cast_lin_f32_to_i16_swizzle_order(float128 x, float scaleToInt)
{
    x.v1 = v_f32_mul_b(x.v1, scaleToInt);
    x.v2 = v_f32_mul_b(x.v2, scaleToInt);
    return convert_float128_to_short128(x, ROUND_MODE);
}
#endif
# 241 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

short128 cast_f32_to_i16_lin_order(float64 x0, float64 x1, float scaleToInt)
{
    float128 x;
    x.v1 = v_f32_mul_b(x0, scaleToInt);
    x.v2 = v_f32_mul_b(x1, scaleToInt);
    return convert_float128_to_short128(x, ROUND_MODE|SW_LINEAR);
}

ushort128 cast_f32_to_u16_lin_order(float64 x0, float64 x1, float scaleToInt)
{
    float128 x;
    x.v1 = v_f32_max_b(0.0, v_f32_mul_b(x0, scaleToInt));
    x.v2 = v_f32_max_b(0.0, v_f32_mul_b(x1, scaleToInt));
    return convert_float128_to_ushort128(x, ROUND_MODE|SW_LINEAR);
}

ushort128 cast_f32_to_u16_lin_order_without_scale(float64 x0, float64 x1)
{
    float128 x;
    x.v1 = v_f32_min_b(0x0000FFFF, v_f32_max_b(0.0, x0));
    x.v2 = v_f32_min_b(0x0000FFFF, v_f32_max_b(0.0, x1));
    return convert_float128_to_ushort128(x, ROUND_MODE|SW_LINEAR);
}

#ifdef __goya2__
ushort128 cast_lin_f32_to_u16_swizzle_order(float64 x0, float64 x1)
{
    return convert_float128_to_ushort128({x0, x1}, ROUND_MODE);
}
#endif
# 272 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

#ifdef __gaudi2__
ushort128 cast_lin_f32_to_u16_swizzle_order(float64 x0, float64 x1, float scaleToInt)
{
    float128 t;
    t.v1 = v_f32_mul_b(x0, scaleToInt);
    t.v2 = v_f32_mul_b(x1, scaleToInt);
    return convert_float128_to_ushort128(t, ROUND_MODE);
}
#endif
# 282 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
////////////////////////////////////////////////////////////////////////////////////////////////////

// x0, x1, x2, x3 - unpacked char256 which actually int64 values
char256 cast_32bits_to_i8_lin_order(char256 x0, char256 x1, char256 x2, char256 x3)
{
    char256 t = 0, y = 0;

    // 0..7
    y = v_i8_pack_b(x0, SW_GROUP_0 | SW_STRIDE_4, y);
    // 0..15
    y = v_i8_pack_b(x0, SW_GROUP_1 | SW_STRIDE_4, y);
    // 0..15, 16..31
    y = v_i8_mov_dual_group_b(y, 0xFFFF0000, 1, 0, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47
    y = v_i8_mov_dual_group_b(y, 0x0000FFFF, 2, 0, MkWr(0, 1), y);
    // 0..15, 16..31, 32..47, 48..63
    y = v_i8_mov_dual_group_b(y, 0xFFFF0000, 3, 0, MkWr(0, 1), y);

    // 64..71
    t = v_i8_pack_b(x1, SW_GROUP_0 | SW_STRIDE_4, t);
    // 64..79
    t = v_i8_pack_b(x1, SW_GROUP_1 | SW_STRIDE_4, t);
    // 0..15, 16..31, 32..47, 48..63, 64..79
    y = v_i8_mov_dual_group_b(t, 0x0000FFFF, 0, 1, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95
    y = v_i8_mov_dual_group_b(t, 0xFFFF0000, 1, 1, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111
    y = v_i8_mov_dual_group_b(t, 0x0000FFFF, 2, 1, MkWr(0, 1), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111, 112..127
    y = v_i8_mov_dual_group_b(t, 0xFFFF0000, 3, 1, MkWr(0, 1), y);

    // 128..137
    t = v_i8_pack_b(x2, SW_GROUP_0 | SW_STRIDE_4, t);
    // 128..143
    t = v_i8_pack_b(x2, SW_GROUP_1 | SW_STRIDE_4, t);
    // 0..143
    y = v_i8_mov_dual_group_b(t, 0x0000FFFF, 0, 2, MkWr(1, 0), y);
    // 0..159
    y = v_i8_mov_dual_group_b(t, 0xFFFF0000, 1, 2, MkWr(1, 0), y);
    // 0..175
    y = v_i8_mov_dual_group_b(t, 0x0000FFFF, 2, 2, MkWr(0, 1), y);
    // 0..191
    y = v_i8_mov_dual_group_b(t, 0xFFFF0000, 3, 2, MkWr(0, 1), y);

    // 192..199
    t = v_i8_pack_b(x3, SW_GROUP_0 | SW_STRIDE_4, t);
    // 192..207
    t = v_i8_pack_b(x3, SW_GROUP_1 | SW_STRIDE_4, t);
    // 0..207
    y = v_i8_mov_dual_group_b(t, 0x0000FFFF, 0, 3, MkWr(1, 0), y);
    // 0..223
    y = v_i8_mov_dual_group_b(t, 0xFFFF0000, 1, 3, MkWr(1, 0), y);
    // 0..239
    y = v_i8_mov_dual_group_b(t, 0x0000FFFF, 2, 3, MkWr(0, 1), y);
    // 0..255
    y = v_i8_mov_dual_group_b(t, 0xFFFF0000, 3, 3, MkWr(0, 1), y);

    return y;
}

// x0, x1, x2, x3 - unpacked char256 which actually int64 values
uchar256 cast_32bits_to_u8_lin_order(uchar256 x0, uchar256 x1, uchar256 x2, uchar256 x3)
{
    uchar256 t = 0, y = 0;

    // 0..7
    y = v_u8_pack_b(x0, SW_GROUP_0 | SW_STRIDE_4, y);
    // 0..15
    y = v_u8_pack_b(x0, SW_GROUP_1 | SW_STRIDE_4, y);
    // 0..15, 16..31
    y = v_u8_mov_dual_group_b(y, 0xFFFF0000, 1, 0, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47
    y = v_u8_mov_dual_group_b(y, 0x0000FFFF, 2, 0, MkWr(0, 1), y);
    // 0..15, 16..31, 32..47, 48..63
    y = v_u8_mov_dual_group_b(y, 0xFFFF0000, 3, 0, MkWr(0, 1), y);

    // 64..71
    t = v_u8_pack_b(x1, SW_GROUP_0 | SW_STRIDE_4, t);
    // 64..79
    t = v_u8_pack_b(x1, SW_GROUP_1 | SW_STRIDE_4, t);
    // 0..15, 16..31, 32..47, 48..63, 64..79
    y = v_u8_mov_dual_group_b(t, 0x0000FFFF, 0, 1, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95
    y = v_u8_mov_dual_group_b(t, 0xFFFF0000, 1, 1, MkWr(1, 0), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111
    y = v_u8_mov_dual_group_b(t, 0x0000FFFF, 2, 1, MkWr(0, 1), y);
    // 0..15, 16..31, 32..47, 48..63, 64..79, 80..95, 96..111, 112..127
    y = v_u8_mov_dual_group_b(t, 0xFFFF0000, 3, 1, MkWr(0, 1), y);

    // 128..137
    t = v_u8_pack_b(x2, SW_GROUP_0 | SW_STRIDE_4, t);
    // 128..143
    t = v_u8_pack_b(x2, SW_GROUP_1 | SW_STRIDE_4, t);
    // 0..143
    y = v_u8_mov_dual_group_b(t, 0x0000FFFF, 0, 2, MkWr(1, 0), y);
    // 0..159
    y = v_u8_mov_dual_group_b(t, 0xFFFF0000, 1, 2, MkWr(1, 0), y);
    // 0..175
    y = v_u8_mov_dual_group_b(t, 0x0000FFFF, 2, 2, MkWr(0, 1), y);
    // 0..191
    y = v_u8_mov_dual_group_b(t, 0xFFFF0000, 3, 2, MkWr(0, 1), y);

    // 192..199
    t = v_u8_pack_b(x3, SW_GROUP_0 | SW_STRIDE_4, t);
    // 192..207
    t = v_u8_pack_b(x3, SW_GROUP_1 | SW_STRIDE_4, t);
    // 0..207
    y = v_u8_mov_dual_group_b(t, 0x0000FFFF, 0, 3, MkWr(1, 0), y);
    // 0..223
    y = v_u8_mov_dual_group_b(t, 0xFFFF0000, 1, 3, MkWr(1, 0), y);
    // 0..239
    y = v_u8_mov_dual_group_b(t, 0x0000FFFF, 2, 3, MkWr(0, 1), y);
    // 0..255
    y = v_u8_mov_dual_group_b(t, 0xFFFF0000, 3, 3, MkWr(0, 1), y);

    return y;
}

char256 cast_i32_to_i8_lin_order(int64 x0, int64 x1, int64 x2, int64 x3)
{
    return convert_int256_to_char256({x0, x1, x2, x3}, SW_LINEAR);
}

uchar256 cast_i32_to_u8_lin_order(int64 x0, int64 x1, int64 x2, int64 x3)
{
    return convert_int256_to_uchar256({x0, x1, x2, x3}, SW_LINEAR);
}

uchar256 cast_u32_to_u8_lin_order(uint64 x0, uint64 x1, uint64 x2, uint64 x3)
{
    return convert_uint256_to_uchar256({x0, x1, x2, x3}, SW_LINEAR);
}

char256 cast_u32_to_i8_lin_order(uint64 x0, uint64 x1, uint64 x2, uint64 x3)
{
    return convert_uint256_to_char256({x0, x1, x2, x3}, SW_LINEAR);
}

#if 0 /* disabled by -frewrite-includes */
#if defined(__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 421 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
char256 cast_lin_i32_to_i8_swizzle_order(int64 x0, int64 x1, int64 x2, int64 x3)
{
    return convert_int256_to_char256({x0, x1, x2, x3}, 0);
}

char256 cast_lin_f32_to_i8_swizzle_order(float64 x0, float64 x1, float64 x2, float64 x3)
{
    return convert_float256_to_char256({x0, x1, x2, x3}, ROUND_MODE);
}

uchar256 cast_lin_f32_to_u8_swizzle_order(float64 x0, float64 x1, float64 x2, float64 x3)
{
    return convert_float256_to_uchar256({x0, x1, x2, x3}, ROUND_MODE);
}
#endif
# 436 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

char256 cast_f32_to_i8_lin_order(float64 x0, float64 x1, float64 x2, float64 x3)
{
    return convert_float256_to_char256({x0, x1, x2, x3}, ROUND_MODE | SW_LINEAR);
}

uchar256 cast_f32_to_u8_lin_order(float64 x0, float64 x1, float64 x2, float64 x3)
{
    return convert_float256_to_uchar256({x0, x1, x2, x3}, ROUND_MODE | SW_LINEAR);
}

#if 0 /* disabled by -frewrite-includes */
#if defined(__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 448 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
char256 cast_lin_bf16_to_i8_swizzle_order(bfloat128 x0, bfloat128 x1)
{
    return convert_bfloat256_to_char256({x0, x1}, ROUND_MODE);
}
#endif
# 453 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

#if 0 /* disabled by -frewrite-includes */
#if defined (__goya2__) || defined (__gaudi__) || defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 455 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
char256 cast_bf16_to_i8_lin_order(bfloat128 x0, bfloat128 x1)
{
    return convert_bfloat256_to_char256({x0, x1}, ROUND_MODE | SW_LINEAR);
}

#ifdef __gaudi2__
uchar256 cast_lin_bf16_to_u8_swizzle_order(bfloat128 x0, bfloat128 x1)
{
    return convert_bfloat256_to_uchar256({x0, x1}, ROUND_MODE);
}
#endif
# 466 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

uchar256 cast_bf16_to_u8_lin_order(bfloat128 x0, bfloat128 x1)
{
    return convert_bfloat256_to_uchar256({x0, x1}, ROUND_MODE | SW_LINEAR);
}
#endif //__goya2__ || __gaudi__ || __gaudi2__
# 472 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

#if 0 /* disabled by -frewrite-includes */
#if defined (__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 474 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
char256 cast_lin_f16_to_i8_swizzle_order(half128 x0, half128 x1)
{
    return convert_half256_to_char256({x0, x1}, ROUND_MODE);
}

char256 cast_f16_to_i8_lin_order(half128 x0, half128 x1)
{
    return convert_half256_to_char256({x0, x1}, ROUND_MODE | SW_LINEAR);
}

uchar256 cast_f16_to_u8_lin_order(half128 x0, half128 x1)
{
    return convert_half256_to_uchar256({x0, x1}, ROUND_MODE | SW_LINEAR);
}

#ifdef __gaudi2__
uchar256 cast_lin_f16_to_u8_swizzle_order(half128 x0, half128 x1)
{
    return convert_half256_to_uchar256({x0, x1}, ROUND_MODE);
}
#endif // __gaudi2__
# 495 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
#endif // __greco_plus__
# 496 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

////////////////////////////////////////////////////////////////////////////////////////////////////

short128_pair_t cast_i8_to_i16_lin_order(char256 x)
{
#ifdef __gaudi2__
    return v_convert_i8_to_i16_all_b(x, SW_RHNE);
#else
# 504 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
    // TODO: performance_1/WhereI8CondFwd5DimBF16Test.where_i8_cond_fwd_bf16/gaudi2__cond_256x4x8x2x1_Xfm_256x4x8x2x1_Yfm_256x4x8x2x1
    // TODO: performance_2/WhereI8CondFwd3DimBF16Test.where_i8_cond_fwd_bf16/gaudi2__cond_256x4x8x0x0_Xfm_256x4x8x0x0_Yfm_256x4x8x0x0
    // TODO: performance_3/WhereI8CondFwd2DimBF16Test.where_i8_cond_fwd_bf16/gaudi2__cond_256x4x0x0x0_Xfm_256x4x0x0x0_Yfm_256x4x0x0x0
    // TODO: performance_4/WhereI8CondFwd1DimBF16Test.where_i8_cond_fwd_bf16/gaudi2__cond_256x0x0x0x0_Xfm_256x0x0x0x0_Yfm_256x0x0x0x0
    // TODO: performance_1/WhereI8CondBwd5DimBF16Test.where_bwd_bf16/gaudi2__cond_256x4x1x1x1_Xfm_256x4x1x1x1_Yfm_256x4x1x1x1
    // TODO: performance_2/WhereI8CondBwd3DimBF16Test.where_bwd_bf16/gaudi2__cond_256x4x8x0x0_Xfm_256x4x8x0x0_Yfm_256x4x8x0x0
    // TODO: performance_3/WhereI8CondBwd2DimBF16Test.where_bwd_bf16/gaudi2__cond_256x4x0x0x0_Xfm_256x4x0x0x0_Yfm_256x4x0x0x0
    // TODO: performance_4/WhereI8CondBwd1DimBF16Test.where_bwd_bf16/gaudi2__cond_256x0x0x0x0_Xfm_256x0x0x0x0_Yfm_256x0x0x0x0
    return convert_char256_to_short256(x, SW_LINEAR | SW_RHNE);
#endif
# 514 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
}

short128_pair_t cast_u8_to_i16_lin_order(uchar256 x)
{
    return convert_uchar256_to_short256(x, SW_LINEAR | SW_RHNE);
}

ushort128_pair_t cast_i8_to_u16_lin_order(char256 x)
{
    return convert_char256_to_ushort256(x, SW_LINEAR | SW_RHNE);
}

ushort128_pair_t cast_u8_to_u16_lin_order(uchar256 x)
{
    return convert_uchar256_to_ushort256(x, SW_LINEAR | SW_RHNE);
}

////////////////////////////////////////////////////////////////////////////////////////////////////

#ifdef __goya__
// Cast short128 into int128
short128_pair_t cast_i16_to_32bits_lin_order(short128 x)
{
    short128_pair_t y;
    short128 t_h;

    // 0..15, 32..47, 64..79, 96..111
    y.v1 = v_i16_unpack_b(x, SW_GROUP_0 |
                SW_STRIDE_2 | SW_GROUP_HALF_0, 0/*y.v1*/);
    // 16..31, 48..63, 80..95, 112..127
    y.v2 = v_i16_unpack_b(x, SW_GROUP_1 |
                SW_STRIDE_2 | SW_GROUP_HALF_0, 0/*y.v2*/);

    t_h = y.v1;

    // 0..15, 16..31
    y.v1 = v_i16_mov_dual_group_b(y.v2, 0xFFFFFFFF, 0, 1, MkWr(1, 1), y.v1);
    // 0..15, 16..31, 32..47
    y.v1 = v_i16_mov_dual_group_b(t_h, 0xFFFFFFFF, 1, 2, MkWr(1, 1), y.v1);
    // 0..15, 16..31, 32..47, 48..63
    y.v1 = v_i16_mov_dual_group_b(y.v2, 0xFFFFFFFF, 1, 3, MkWr(1, 1), y.v1);

    // 64..79, 80..95
    y.v2 = v_i16_mov_dual_group_b(t_h, 0xFFFFFFFF, 2, 0, MkWr(1, 1), y.v2);
    // 64..79, 80..95, 96..111
    y.v2 = v_i16_mov_dual_group_b(y.v2, 0xFFFFFFFF, 2, 1, MkWr(1, 1), y.v2);
    // 64..79, 80..95, 96..111, 112..127
    y.v2 = v_i16_mov_dual_group_b(t_h, 0xFFFFFFFF, 3, 2, MkWr(1, 1), y.v2);

    return y;
}
#else // __gaudi__ or __goya2__
# 566 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
// Cast short128 into int128
short128_pair_t cast_i16_to_32bits_lin_order(short128 x)
{
    short128_pair_t t, y;

    // 16..31, 0..15 || 48..63, 32..47 || 80..95, 64..79  || 112..127, 96..111
    t.v1 =
      v_i16_mov_group_b(x, 0xFFFFFFFF, 63, t.v1);
    // 0..15, 16..31 || 32..47, 80..95 || 32..47, 80..95  || 96..111, 112..127
    t.v2 =
      v_i16_mov_dual_group_all_b(x, 0xFFFFFFFF, 0, 2, 1, 3, MkWrA(0b11, 0b10, 0b01, 0b11), t.v2);
    // 0..15, 64..79 || 16..31, 80..95 || 32..47, 96..111 || 48..63, 112..127
    t.v2 =
      v_i16_mov_dual_group_all_b(t.v1, 0xFFFFFFFF, 2, 0, 3, 1, MkWrA(0b10, 0b01, 0b10, 0b01), t.v2);

    y.v1 = v_i16_unpack_b(t.v2, SW_GROUP_0 |
                   SW_STRIDE_2 | SW_GROUP_HALF_0, 0/*y.v1*/);
    y.v2 = v_i16_unpack_b(t.v2, SW_GROUP_1 |
                   SW_STRIDE_2 | SW_GROUP_HALF_0, 0/*y.v1*/);

    return y;
}
#endif
# 589 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
#ifdef __gaudib__
// Cast short128 into int128
short128 cast_i16_to_32bits(bfloat128 x)
{
    bfloat128 t;

    t = v_bf16_unpack_b (x, SW_GROUP_0 | SW_STRIDE_2 |SW_GROUP_HALF_0 |
                                                            SW_UNPACK_LANE_0 , (bfloat128)0, 1, 0);
    t = v_bf16_unpack_b (x, SW_GROUP_1 | SW_STRIDE_2 | SW_GROUP_HALF_0 |
                                                            SW_UNPACK_LANE_1 , t, 1, 0);

    //EVEN lanes:
    short128 y = v_i16_mov_dual_group_unpack_b((short128)t, 0x33333333,0, 0, 1, 1,
                                                    SW_UNPACK_EVEN_LANES |
                                                    SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 |
                                                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 |
                                                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 |
                                                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3,
                                                    (short128)0, 1, 0);

    //ODD Lanes:
    y = v_i16_mov_dual_group_unpack_b((short128)t, 0xCCCCCCCC, 2, 2, 3, 3,
                                                    SW_UNPACK_ODD_LANES |
                                                    SW_WR_LOWER_GROUP0 | SW_WR_UPPER_GROUP0 |
                                                    SW_WR_LOWER_GROUP1 | SW_WR_UPPER_GROUP1 |
                                                    SW_WR_LOWER_GROUP2 | SW_WR_UPPER_GROUP2 |
                                                    SW_WR_LOWER_GROUP3 | SW_WR_UPPER_GROUP3,
                                                    y, 1, 0);

    return y;
}
#endif
# 621 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

// Cast short128 into int128
#if 0 /* disabled by -frewrite-includes */
#if defined(__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 624 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
int128 cast_lin_i16_to_i32_swizzle_order(short128 x, int shiftToI32)
{
    int128 y = convert_short128_to_int128(x, 0);
    y.v1 = v_i32_ash_b(y.v1, shiftToI32, 2);
    y.v2 = v_i32_ash_b(y.v2, shiftToI32, 2);
    return y;
}

uint128 cast_lin_i16_to_u32_swizzle_order(short128 x, int shiftToI32)
{
    uint128 y = convert_short128_to_uint128(x, 0);
    y.v1 = v_u32_ash_b(y.v1, shiftToI32, 2);
    y.v2 = v_u32_ash_b(y.v2, shiftToI32, 2);
    return y;
}

int128 cast_lin_u16_to_i32_swizzle_order(ushort128 x, int shiftToI32)
{
    int128 y = convert_ushort128_to_int128(x, 0);
    y.v1 = v_i32_ash_b(y.v1, shiftToI32, 2);
    y.v2 = v_i32_ash_b(y.v2, shiftToI32, 2);
    return y;
}

uint128 cast_lin_u16_to_u32_swizzle_order(ushort128 x, int shiftToI32)
{
    uint128 y = convert_ushort128_to_uint128(x, 0);
    y.v1 = v_u32_ash_b(y.v1, shiftToI32, 2);
    y.v2 = v_u32_ash_b(y.v2, shiftToI32, 2);
    return y;
}
#endif
# 656 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

int64_pair_t cast_i16_to_i32_lin_order(short128 x, int shiftToI32)
{
    int64_pair_t y = convert_short128_to_int128(x, SW_LINEAR);
    y.v1 = v_i32_ash_b(y.v1, shiftToI32, 2);
    y.v2 = v_i32_ash_b(y.v2, shiftToI32, 2);
    return y;
}

// Cast short128 into int128
int64_pair_t cast_i16_to_i32_lin_order_no_shift(short128 x)
{
    return convert_short128_to_int128(x, SW_LINEAR);
}

// Cast short128 into float128
#if 0 /* disabled by -frewrite-includes */
#if defined(__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 673 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
float64_pair_t cast_swizzle_i16_to_f32_lin_order(short128 x, float scaleToFloat)
{
    float128 y = convert_short128_to_float128(x, SW_RHNE);
    y.v1 = v_f32_mul_b(y.v1, scaleToFloat);
    y.v2 = v_f32_mul_b(y.v2, scaleToFloat);
    return y;
}
#endif
# 681 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

float64_pair_t cast_i16_to_f32_lin_order(short128 x, float scaleToFloat)
{
    float128 y = convert_short128_to_float128(x, SW_LINEAR);
    y.v1 = v_f32_mul_b(y.v1, scaleToFloat);
    y.v2 = v_f32_mul_b(y.v2, scaleToFloat);
    return y;
}

// Cast ushort128 into float128
float64_pair_t cast_u16_to_f32_lin_order(ushort128 x, float scaleToFloat)
{
    float128 y = convert_ushort128_to_float128(x, SW_LINEAR);
    y.v1 = v_f32_mul_b(y.v1, scaleToFloat);
    y.v2 = v_f32_mul_b(y.v2, scaleToFloat);
    return y;
}

// Cast ushort128 into float128
float64_pair_t cast_u16_to_f32_lin_order_without_scale(ushort128 x)
{
#if 0 /* disabled by -frewrite-includes */
#if 0
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 703 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
    float64_pair_t   y;
    short128_pair_t  t;

    // Convert short128 to int128
    t = cast_i16_to_32bits_lin_order((short128)x);

    // Zeroing high 16 bits
    t.v1 = (short128)v_u32_and_b((uint64)t.v1, 0x0000FFFF);

    // Convert to float high part
    y.v1 = v_convert_i32_to_f32_b((int64)t.v1);

    // Zeroing high 16 bits
    t.v2 = (short128)v_u32_and_b((uint64)t.v2, 0x0000FFFF);

    // Convert to float low part
    y.v2 = v_convert_i32_to_f32_b((int64)t.v2);

    return y;

#endif // 0
# 724 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
    // TODO: goya2/image_processing/resize_image_bicubic_u16.c
    return convert_ushort128_to_float128(x, SW_LINEAR);
}

////////////////////////////////////////////////////////////////////////////////////////////////////

#ifdef __goya__
// Cast char256 into int256
int256 cast_i8_to_32bits_lin_order(char256 x)
{
    int256 y;
    int64 t0, t1, t2;

    // 0..15, 64..79, 128..143, 192..207
    y.v1 = (int64) v_i8_unpack_b(x, SW_GROUP_0 |
                        SW_STRIDE_4 | SW_GROUP_HALF_0, 0/*x00*/);

    // 16..31, 80..95, 144..159, 208..223
    t1 = (int64) v_i8_unpack_b(x, SW_GROUP_0 |
                      SW_STRIDE_4 | SW_GROUP_HALF_1, 0/*x01*/);

    // 32..47, 96..111, 160..175, 224..239
    t2 = (int64) v_i8_unpack_b(x, SW_GROUP_1 |
                      SW_STRIDE_4 | SW_GROUP_HALF_0, 0/*x02*/);

    // 48..63, 112..127, 176..191, 240..255
    y.v4 = (int64) v_i8_unpack_b(x, SW_GROUP_1 |
                        SW_STRIDE_4 | SW_GROUP_HALF_1, 0/*x03*/);


    /////
    // 0..15
    t0 = y.v1;

    // 0..15, 16..31
    y.v1 = v_i32_mov_dual_group_b(t1, 0xFFFFFFFF, 0, 1, MkWr(1, 1), y.v1);

    // 0..15, 16..31, 32..47, 48..63
    y.v1 = v_i32_mov_dual_group_b(t2, 0xFFFFFFFF, 0, 2, MkWr(1, 1), y.v1);

    // 0..15, 64..79, 128..143, 192..207
    y.v1 = v_i32_mov_dual_group_b(y.v4, 0xFFFFFFFF, 0, 3, MkWr(1, 1), y.v1);


    /////
    // 64..79
    y.v2 = v_i32_mov_dual_group_b(t0, 0xFFFFFFFF, 1, 0, MkWr(1, 1), y.v2);

    // 64..79, 80..95
    y.v2 = v_i32_mov_dual_group_b(t1, 0xFFFFFFFF, 1, 1, MkWr(1, 1), y.v2);

    // 64..79, 80..95, 96..111
    y.v2 = v_i32_mov_dual_group_b(t2, 0xFFFFFFFF, 1, 2, MkWr(1, 1), y.v2);

    // 64..79, 80..95, 96..111, 112..127
    y.v2 = v_i32_mov_dual_group_b(y.v4, 0xFFFFFFFF, 1, 3, MkWr(1, 1), y.v2);


    /////
    // 128..143
    y.v3 = v_i32_mov_dual_group_b(t0, 0xFFFFFFFF, 2, 0, MkWr(1, 1), y.v3);

    // 128..143, 144..159
    y.v3 = v_i32_mov_dual_group_b(t1, 0xFFFFFFFF, 2, 1, MkWr(1, 1), y.v3);

    // 128..143, 144..159, 160..175
    y.v3 = v_i32_mov_dual_group_b(t2, 0xFFFFFFFF, 2, 2, MkWr(1, 1), y.v3);

    // 128..143, 144..159, 160..175, 176..191
    y.v3 = v_i32_mov_dual_group_b(y.v4, 0xFFFFFFFF, 2, 3, MkWr(1, 1), y.v3);


    /////
    // 192..207
    y.v4 = v_i32_mov_dual_group_b(t0, 0xFFFFFFFF, 3, 0, MkWr(1, 1), y.v4);

    // 192..207, 208..223
    y.v4 = v_i32_mov_dual_group_b(t1, 0xFFFFFFFF, 3, 1, MkWr(1, 1), y.v4);

    // 192..207, 208..223, 224..239
    y.v4 = v_i32_mov_dual_group_b(t2, 0xFFFFFFFF, 3, 2, MkWr(1, 1), y.v4);

    return y;
}
#else // __gaudi__ || __goya2__
# 809 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
// Cast char256 into int256
int256 cast_i8_to_32bits_lin_order(char256 x)
{
    int256 y;
    int64 t0, t1;

    // 0..15, 64..79, 128..143, 192..207
    y.v1 = (int64) v_i8_unpack_b(x, SW_GROUP_0 |
                        SW_STRIDE_4 | SW_GROUP_HALF_0, 0/*x00*/);

    // 16..31, 80..95, 144..159, 208..223
    y.v2 = (int64) v_i8_unpack_b(x, SW_GROUP_0 |
                        SW_STRIDE_4 | SW_GROUP_HALF_1, 0/*x01*/);

    // 32..47, 96..111, 160..175, 224..239
    y.v3 = (int64) v_i8_unpack_b(x, SW_GROUP_1 |
                        SW_STRIDE_4 | SW_GROUP_HALF_0, 0/*x02*/);

    // 48..63, 112..127, 176..191, 240..255
    y.v4 = (int64) v_i8_unpack_b(x, SW_GROUP_1 |
                        SW_STRIDE_4 | SW_GROUP_HALF_1, 0/*x03*/);


    /////
    t0 = y.v1;

    // 0..15, 16..31, 128..143, 144..159
    y.v1 = v_i32_mov_dual_group_all_b(y.v2, 0xFFFFFFFF, 1, 0, 3, 2,
                                                           MkWrA(0b00, 0b11, 0b00, 0b11), y.v1);

    // 64..79, 80..95, 192..207, 208..223
    y.v2 = v_i32_mov_dual_group_all_b(t0, 0xFFFFFFFF, 1, 0, 3, 2,
                                                           MkWrA(0b11, 0b00, 0b11, 0b00), y.v2);

    t1 = y.v3;

    // 32..47, 48..63, 160..175, 176..191
    y.v3 = v_i32_mov_dual_group_all_b(y.v4, 0xFFFFFFFF, 1, 0, 3, 2,
                                                           MkWrA(0b00, 0b11, 0b00, 0b11), y.v3);

    // 96..111, 112..127, 224..239, 240..255
    y.v4 = v_i32_mov_dual_group_all_b(t1, 0xFFFFFFFF, 1, 0, 3, 2,
                                                           MkWrA(0b11, 0b00, 0b11, 0b00), y.v4);


    /////
    t0 = y.v1;

    // 0..15, 16..31, 32..47, 48..63
    y.v1 = v_i32_mov_dual_group_all_b(y.v3, 0xFFFFFFFF, 2, 3, 0, 1,
                                                           MkWrA(0b00, 0b00, 0b11, 0b11), y.v1);

    t1 = y.v2;

    // 64..79, 80..95, 96..111, 112..127
    y.v2 = v_i32_mov_dual_group_all_b(y.v4, 0xFFFFFFFF, 2, 3, 0, 1,
                                                           MkWrA(0b00, 0b00, 0b11, 0b11), y.v2);

    // 128..143, 144..159, 160..175, 176..191
    y.v3 = v_i32_mov_dual_group_all_b(t0, 0xFFFFFFFF, 2, 3, 0, 1,
                                                           MkWrA(0b11, 0b11, 0b00, 0b00), y.v3);

    // 192..207, 208..223, 224..239, 240..255
    y.v4 = v_i32_mov_dual_group_all_b(t1, 0xFFFFFFFF, 2, 3, 0, 1,
                                                           MkWrA(0b11, 0b11, 0b00, 0b00), y.v4);

    return y;
}
#endif // __gaudi__
# 878 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

// Cast uchar256 into uint256
uint256 cast_u8_to_32bits_lin_order(uchar256 x)
{
    int256 t = cast_i8_to_32bits_lin_order((char256)x);

    uint256 y;
    y.v1 = (uint64)t.v1;
    y.v2 = (uint64)t.v2;
    y.v3 = (uint64)t.v3;
    y.v4 = (uint64)t.v4;

    return y;
}

////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__greco_plus__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 896 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
short256 cast_i8_to_16bits_lin_order(char256 x)
{
    short256 y;
    short128 t;

    // 0..31, 64..95, 128..159, 192..223,
    y.v1 = (short128) v_i8_unpack_b(x, SW_GROUP_0 |
                          SW_STRIDE_2 | SW_GROUP_HALF_0, 0);
    // 32..63, 96..127, 160..191, 224..255
    y.v2 = (short128) v_i8_unpack_b(x, SW_GROUP_1 |
                          SW_STRIDE_2 | SW_GROUP_HALF_0, 0);

    t = y.v1;

    //0..31, x..x, 64..95, x..x
    y.v1 = v_i16_mov_dual_group_b(y.v1, 0xFFFFFFFF, 1, 2, MkWr(1, 1), y.v1);
    //0..31, 32..63, 64..95, 96..127
    y.v1 = v_i16_mov_dual_group_all_b(y.v2, 0xFFFFFFFF, 2, 0, 3, 1,
                                                        MkWrA(0b00, 0b11, 0b00, 0b11), y.v1);

    // x..x, 160..191, x..x, 224..255
    y.v2 = v_i16_mov_dual_group_b(y.v2, 0xFFFFFFFF, 2, 1, MkWr(1, 1), y.v2);
    // 128..159, 160..191, 192..223, 224..255
    y.v2 = v_i16_mov_dual_group_all_b(t, 0xFFFFFFFF, 2, 0, 3, 1,
                                                        MkWrA(0b11, 0b00, 0b11, 0b00), y.v2);

    return y;
}
#else
# 925 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
short256 cast_i8_to_16bits_lin_order(char256 x)
{
    short256 y;
    short128 t;

    // 0..31, 64..95, 128..159, 192..223,
    y.v1 = (short128) v_i8_unpack_b(x, SW_GROUP_0 |
                          SW_STRIDE_2 | SW_GROUP_HALF_0, 0);
    // 32..63, 96..127, 160..191, 224..255
    y.v2 = (short128) v_i8_unpack_b(x, SW_GROUP_1 |
                          SW_STRIDE_2 | SW_GROUP_HALF_0, 0);

    t = y.v1;

    //0..31, x..x, 64..95
    y.v1 = v_i16_mov_dual_group_b(y.v1, 0xFFFFFFFF, 1, 2, MkWr(1, 1), y.v1);
    //0..31, 32..63, 64..95
    y.v1 = v_i16_mov_dual_group_b(y.v2, 0xFFFFFFFF, 0, 1, MkWr(1, 1), y.v1);
    //0..31, 32..63, 64..95, 96..127
    y.v1 = v_i16_mov_dual_group_b(y.v2, 0xFFFFFFFF, 1, 3, MkWr(1, 1), y.v1);

    // x..x, 160..191, x..x, 224..255
    y.v2 = v_i16_mov_dual_group_b(y.v2, 0xFFFFFFFF, 2, 1, MkWr(1, 1), y.v2);
    // 128..159, 160..191, x..x, 224..255
    y.v2 = v_i16_mov_dual_group_b(t, 0xFFFFFFFF, 2, 0, MkWr(1, 1), y.v2);
    // 128..159, 160..191, 192..223, 224..255
    y.v2 = v_i16_mov_dual_group_b(t, 0xFFFFFFFF, 3, 2, MkWr(1, 1), y.v2);

    return y;
}
#endif //defined(__gaudi__) || defined(__goya2__)
# 956 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

ushort256 cast_u8_to_16bits_lin_order(uchar256 x)
{
    short256 t = cast_i8_to_16bits_lin_order((char256)x);

    ushort256 y;
    y.v1 = (ushort128)t.v1;
    y.v2 = (ushort128)t.v2;

    return y;
}

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 969 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
minihalf256 cast_lin_f32_to_f8_swizzle_order(float64 x0, float64 x1, float64 x2, float64 x3)
{
    return convert_float256_to_minihalf256({x0, x1, x2, x3}, ROUND_MODE);
}

minihalf256 cast_lin_bf16_to_f8_swizzle_order(bfloat128 x0, bfloat128 x1)
{
    return convert_bfloat256_to_minihalf256({x0, x1}, ROUND_MODE);
}
#endif
# 979 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
//////////////////////////////////////////////////////////////////////////////////////////////////

#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 982 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
uint64 cast_f32_to_f16(float64 x0)
{
#define EXP_SHIFT_FP32          23
#define EXP_MASK_FP32           0xFF
#define MANTISSA_MASK_FP32      0x7fffff
#define SIGN_SHIFT_FP16         15
#define FUNC_ID_FP32_TO_FP16    8
     uint64_pair_t c1c2 = {0, 0};
     uint64 exp = v_u32_shr_b(*(uint64 *)&x0, EXP_SHIFT_FP32);
     exp = v_u32_and_b(exp, EXP_MASK_FP32);
     c1c2 = v_u32_lookup_2c(exp, FUNC_ID_FP32_TO_FP16, SW_BV32, (uint64_pair_t){0});
     uint64 mant = v_u32_and_b(*(uint64 *)&x0, MANTISSA_MASK_FP32);
#ifdef ENABLE_LFSR
      uint64 mant_mask = v_u32_lookup_1c(exp, FUNC_ID_FP32_TO_FP16, SW_BV32, 0);
      uint64 round = v_u32_and_b(mant_mask, mant);
      bool256 pred1 = from_bool64(v_u32_cmp_neq_b(round, 0));
    
#if 0 /* disabled by -frewrite-includes */
#if __TPC_DROP_VERSION < VERSION2DEC(45, 0, 0)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 999 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
      char256 c_lfsr = LFSR;
    #else
# 1001 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
      char256 c_lfsr = read_lfsr_b();
    #endif
# 1003 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
      uint64 lfsr64 = *(uint64*)&c_lfsr;
      // cmp        pred1 = (y >= LFSR) //for rounding
      pred1 = from_bool64(v_u32_cmp_geq_vb(mant, lfsr64, 0, to_bool64(pred1), to_bool64(pred1)));
#endif
# 1007 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
     mant = v_u32_shr_b(mant, *(int64 *)&c1c2.v2);
#ifdef ENABLE_LFSR
      // add        z = z + 1, pred1 //only if need round
     mant = v_u32_add_vb(mant, 1, 0, mant, to_bool64(pred1));
#endif
# 1012 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
     uint64 res0 = v_u32_add_b(mant, c1c2.v1, 0);
     bool256 sign_pred  =  from_bool64(v_i32_cmp_less_b(*(int64*)&x0, 0));
     res0 = v_u32_or_vb(res0, (1 << SIGN_SHIFT_FP16), 0, res0, to_bool64(sign_pred));
     return res0;
}

float64 cast_f16_to_f32(uint64 x0_u32)
{
#define SIGN_BITS_FP16          15
#define SIGN_BITS_FP32          31
#define EXP_BITS_FP16_TO_FP32   13
#define EXP_BITS_FP32           23
#define EXP_MASK_FP16           0x7c00
#define MAGIC                   0x38800000
#define EXP_ADJUST              (127 - 15)
#define EXP_EXTRA_ADJUST        (128 - 16)
     const int64 magic_int64 = MAGIC;
     float64 magic = *(float64*)&magic_int64;
     uint64 sign = v_u32_and_b(x0_u32, (1 << SIGN_BITS_FP16));
     uint64 res = v_u32_and_b(x0_u32, ~(1 << SIGN_BITS_FP16));
     res = v_u32_shl_b(res, EXP_BITS_FP16_TO_FP32);
     uint64 exp = v_u32_and_b(res, ((EXP_MASK_FP16 << EXP_BITS_FP16_TO_FP32)));
     res = v_u32_add_b(res, (EXP_ADJUST << EXP_BITS_FP32), 0, res);
     bool256 pred0  = from_bool64(v_u32_cmp_eq_b(exp, (EXP_MASK_FP16 << EXP_BITS_FP16_TO_FP32)));
     res = v_u32_add_vb(res, (EXP_EXTRA_ADJUST << EXP_BITS_FP32),
                                                       0, res, to_bool64(pred0));
     pred0  = from_bool64(v_u32_cmp_eq_b(exp, 0));
     res = v_u32_add_vb(res, (1 << EXP_BITS_FP32), 0, res, to_bool64(pred0));

     float64 y = *(float64*)&res;
     y = v_f32_sub_vb(y, magic, 0, y, to_bool64(pred0));
     res = *(uint64*)&y;
     pred0 = from_bool64(v_u32_cmp_eq_b(sign, (1 << SIGN_BITS_FP16)));
     res = v_u32_or_vb(res, (1 << SIGN_BITS_FP32), 0, res, to_bool64(pred0));
     y = *(float64*)&res;

     return y;
}

#endif
# 1052 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__dali__) || defined(__gaudi__) || defined(__gaudib__) ||  defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1054 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
ushort128 cast_u32_to_u16_lin_order(uint64 x0, uint64 x1, int shift)
{
    return uint_convert_uint128_to_ushort128({x0, x1}, shift, SW_LINEAR);
}
#endif
# 1059 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"

uint64_pair_t cast_u16_to_u32_lin_order(ushort128 x, int shiftToI32)
{
    uint64_pair_t y = convert_ushort128_to_uint128(x, SW_LINEAR);
    y.v1 = v_u32_ash_b(y.v1, shiftToI32, 2);
    y.v2 = v_u32_ash_b(y.v2, shiftToI32, 2);
    return y;
}

float64 v_convert_u32_to_f32(uint64 vec_in)
{
    return convert_uint64_to_float64(vec_in, ROUND_MODE);
}

uint64 v_convert_f32_to_u32(float64 vec_in)
{
    return convert_float64_to_uint64(vec_in, ROUND_MODE);
}

#endif //CAST_HELPER_H_
# 1079 "/home/acherkasov/ws/tpc_kernels/kernels/common/cast_helper.h"
# 16 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h" 2
#if 0 /* expanded by -frewrite-includes */
#include "special_all.h"
#endif /* expanded by -frewrite-includes */
# 16 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
# 1 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h" 1
/*****************************************************************************
 * Copyright (C) 2017 HabanaLabs, Ltd.
 * All Rights Reserved.
 *
 * Unauthorized copying of this file, via any medium is strictly prohibited.
 * Proprietary and confidential.
 *
 * Authors:
 * Alexander Semenov <asemenov@unipro.ru>
 * Dmytrey Salnikov <dmytro.salnikov@p-product.com>
 ******************************************************************************
 */
#ifndef __SPECIAL_ALL_H__
#define __SPECIAL_ALL_H__
////////////////////////////////// COMMON FP32 MACROS ////////////////////////////////////

#define false 0
#define true 1

#ifdef __goya__
    #define c1c2_fid_exp  e_i16_exp_nep
    #define c0_fid_exp    e_i16_exp_nep
    #define c1c2_fid_sig  e_i16_sigmoid
    #define c1c2_fid_tanh e_i16_tanh

    #define c1c2_fid_rcp e_i16_rcp
    #define c0_fid_rcp   e_i16_rcp
    #define c0_fid_sig   e_i16_sigmoid
    #define c0_fid_tanh  e_i16_tanh

    inline short128_pair_t v_i16_lookup_coeff_c1c2_v(
                                     short128 interval, short128_pair_t coeff, e_function_id fid)
    {
        coeff = v_i16_lookup_c1c2(*(ushort128*)&interval, fid, SW_BV16_LOW, coeff);
        coeff = v_i16_lookup_c1c2(*(ushort128*)&interval, fid, SW_BV16_HIGH, coeff);
        return coeff;
    }

    inline short128 v_i16_lookup_coeff_c0_v(short128 interval, short128 coeff, e_function_id fid)
    {
        coeff = v_i16_lookup_c0(*(ushort128*)&interval, fid, SW_BV16_LOW, coeff);
        coeff = v_i16_lookup_c0(*(ushort128*)&interval, fid, SW_BV16_HIGH, coeff);
        return coeff;
    }
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 46 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    #define c1c2_fid_exp  e_i16_exp_neg
    #define c0_fid_exp    e_i16_exp_neg_c0
    #define c1c2_fid_sig  e_i16_sigmoid
    #define c1c2_fid_tanh e_i16_tanh

    #define c1c2_fid_rcp e_i16_rcp
    #define c0_fid_rcp   e_i16_rcp_c0
    #define c0_fid_sig   e_i16_sigmoid_c0
    #define c0_fid_tanh  e_i16_tanh_c0

    
#if 0 /* disabled by -frewrite-includes */
#if defined (__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 57 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
        #define LU_DT16   SW_BV16
    
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 59 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
        //Disable the SW_X2 switch temporarily for gaudi2
        #define LU_DT16   (SW_BV16)
    #endif
# 62 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    inline short128_pair_t  v_i16_lookup_coeff_c1c2_v(short128 interval, short128_pair_t coeff, e_function_id fid)
    {
        coeff = v_i16_lookup_2c(*(ushort128*)&interval, fid, LU_DT16, (short256){0});
        return coeff;
    }

    inline short128 v_i16_lookup_coeff_c0_v(short128 interval, short128 coeff, e_function_id fid)
    {
        coeff = v_i16_lookup_1c(*(ushort128*)&interval, fid, LU_DT16, (short128){0});
        return coeff;
    }

#endif
# 76 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

// LOOKUP_AND_MAC is defined as macros due to their use
// of FUNC_ID and COEFF_TAB_SHIFT - constant integer values that needs to be
// known during compilation.
// LOOKUP_AND_MAC VPU ops = 4
#if 0 /* disabled by -frewrite-includes */
#if !defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 82 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

#define LOOKUP_AND_MAC(INTERVALS, VALUE, RESULT)                                            \
    {                                                                                       \
        float64        C0 = v_f32_lookup_1c(INTERVALS, FUNC_ID, SW_BV32, (float64){0} );    \
        float64_pair_t C1C2;                                                                \
        C1C2 = v_f32_lookup_2c(INTERVALS, FUNC_ID, SW_BV32, (float64_pair_t){0} );          \
                                                                                            \
        RESULT = C1C2.v1;                                                                   \
        RESULT = v_f32_mac_b(C1C2.v2, VALUE, RESULT, (false) << 1);                         \
        C0     = v_f32_mac_b(RESULT, VALUE, C0, (false) << 1);                              \
        RESULT = C0;                                                                        \
    }

#else
# 96 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

#define LOOKUP_AND_MAC(INTERVALS, VALUE, RESULT)                                            \
    {                                                                                       \
        float64        C0 = v_f32_lookup_c0(INTERVALS, FUNC_ID, SW_BV32, (float64){0} );    \
        float64_pair_t C1C2;                                                                \
        C1C2 = v_f32_lookup_c1c2(INTERVALS, FUNC_ID, SW_BV32, (float64_pair_t){0} );        \
                                                                                            \
        RESULT = C1C2.v1;                                                                   \
        RESULT = v_f32_mac_b(C1C2.v2, VALUE, RESULT, (false) << 1);                         \
        C0     = v_f32_mac_b(RESULT, VALUE, C0, (false) << 1);                              \
        RESULT = C0;                                                                        \
    }

#endif
# 110 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

// calc_reduced_value VPU ops = LOOKUP_AND_MAC VPU ops + 2 = 6
// calc_reduced_value() is defined as templated due to it use
// of FUNC_VARIANT, FUNC_ID and COEFF_TAB_SHIFT - constant integer values that needs to be
// known during compilation.
template <int FUNC_VARIANT, int COEFF_TAB_SHIFT, int FUNC_ID>
float64 calc_reduced_value(float64 INPUT_VAL)
{
    uint64_float64_pair_t all_coeffs_tab;
    all_coeffs_tab = v_f32_get_lut_entry_and_interval_start_b(
                                    INPUT_VAL, COEFF_TAB_SHIFT, (FUNC_VARIANT) << 13);
    uint64  intervals = all_coeffs_tab.v1;
    float64 value     = INPUT_VAL - all_coeffs_tab.v2;

    // LOOKUP_AND_MAC
#if 0 /* disabled by -frewrite-includes */
#if !defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 126 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64        C0 = v_f32_lookup_1c(intervals, FUNC_ID, SW_BV32, (float64){0} );
    float64_pair_t C1C2;
    C1C2 = v_f32_lookup_2c(intervals, FUNC_ID, SW_BV32, (float64_pair_t){0} );
#else
# 130 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64        C0 = v_f32_lookup_c0(intervals, FUNC_ID, SW_BV32, (float64){0} );
    float64_pair_t C1C2;
    C1C2 = v_f32_lookup_c1c2(intervals, FUNC_ID, SW_BV32, (float64_pair_t){0} );
#endif
# 134 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    float64 result = C1C2.v1;
    result = v_f32_mac_b(C1C2.v2, value, result, (false) << 1);
    result = v_f32_mac_b(result, value, C0, (false) << 1);

    return result;
}

#define UNIT_VAL         0x3f800000
#define SIGNIFICAND_MASK 0x007fffff
#define EXPONENT_MASK    0x7f800000
#define NAN_FP32         0x7fffffff
#define PLUS_INF_FP32    0x7f800000
#define MINUS_INF_FP32   0xff800000
#define EXP_LOWER        0xc2aeac50
#define EXP_UPPER        0x42b17218
#define FLT_MIN          0x800000
#define FLT_MAX          0x7f7fffff
#define M_UNIT_EXP       0xc0800000

const static float PIF     = 3.141592653589793238;                       // pi
const static float PIINV   = 0.318309886183790671538;                    // 1/pi
const float        MAXNUMF = 3.4028234663852885981170418348451692544e38; // max 32 bit fp value
const static float LS2PI   = 0.91893853320467274178;

//////////////////////////////////////// EXP_F32 //////////////////////////////////////////////////
float64 exp_fast_f32(float64 input)
{
    const int COEFF_TAB_SHIFT = 17; // 23 - (m = 6);
    const int FUNC_ID         = e_fp32_pow2;

    const float ln_2_1 = 0.693359375;
    const float ln_2_2 = -2.12194440e-4;
    const float log2_e = 1.44269502;

    float64 result = 0.5;
    result         = v_f32_mac_b(input, log2_e, result, (false) << 1);    // 1

    int64 floor = v_convert_f32_to_i32_b(result, SW_RHNE);  // 2
    result      = v_convert_i32_to_f32_b(floor, SW_RHNE);   // 3

    float64 x_reduced = input;
    x_reduced = v_f32_mac_b(result, ln_2_1, x_reduced, (true) << 1);      // 4
    x_reduced = v_f32_mac_b(result, ln_2_2, x_reduced, (true) << 1);      // 5
    x_reduced *= log2_e;                                                  // 6

    bool256 x_red_geq_0 = from_bool64(v_f32_cmp_geq_b(x_reduced, 0.0f));  // 7
    int64   exponent    = 0;
    exponent = v_f32_extract_exp_vb(x_reduced, false, exponent, to_bool64(x_red_geq_0)); // 8
    exponent = v_i32_min_vb(-exponent, 24, 0, exponent, to_bool64(x_red_geq_0));         // 9, 10

    int64 pos_significand = 0;
    pos_significand = v_i32_and_vb(*((int64*)&x_reduced),\
                             SIGNIFICAND_MASK, 0, pos_significand, to_bool64(x_red_geq_0));   // 11
    pos_significand =
        v_i32_or_vb(pos_significand, 8388608, 0, pos_significand, to_bool64(x_red_geq_0));   // 12
    pos_significand =
        v_i32_shr_vb(pos_significand, exponent, 0, pos_significand, to_bool64(x_red_geq_0)); // 13
    pos_significand =
        v_i32_or_vb(pos_significand, UNIT_VAL, 0, pos_significand, to_bool64(x_red_geq_0)); // 14
    result = *((float64*)&pos_significand);                                                 // 15

    result                = v_f32_add_vb(x_reduced, 2.0f, 0, result, to_bool64(x_red_geq_0), 1); // 16
    int64 neg_significand = 0;
    neg_significand       = v_i32_and_vb(*((int64*)&result), SIGNIFICAND_MASK, 0, neg_significand, \
                                                                 to_bool64(x_red_geq_0), 1); // 17
    uint64 neg_add = 0;
    neg_add = v_u32_sel_eq_i32_vb(neg_significand, 0, 0, 1, 0, neg_add, to_bool64(x_red_geq_0), 1);

    result = calc_reduced_value<e_func_variant_default, COEFF_TAB_SHIFT, FUNC_ID>(result); // 19, 20, 21
                                                               // 22, 22, 23
    exponent = v_f32_extract_exp_b(result, true);              // 24
    exponent += floor - neg_add;                               // 25
    result = v_f32_form_fp_num_ie_b((char256)exponent, result, result, SW_EXP_IS_NUM); // 26

    return result;
}

// exp_f32 VPU ops = exp_fast_f32 VPU ops + 3 = 26+3 = 29
float64 exp_f32(float64 input)
{

    float64 result = exp_fast_f32(input);

    // ====================================
    //  Processing special values: spec.exp values, +-inf, nan

    const int64 exp_lower = EXP_LOWER;
    const int64 exp_upper = EXP_UPPER;
    const int64 plus_inf  = PLUS_INF_FP32;

    result = v_f32_sel_leq_f32_b(input, *((float64*)&exp_lower), 0.0f, result);
    result =
        v_f32_sel_geq_f32_b(input, *((float64*)&exp_upper), *((float64*)&plus_inf), result);
    result = v_f32_sel_grt_u32_b(*((uint64*)&input) & NAN_FP32, PLUS_INF_FP32, input, result);

    // ====================================
    return result;
}

/////////////////////////////////////// RECIP_F32 /////////////////////////////////////////////////

float64 reciprocal_fast_f32(float64 input)
{
    const int COEFF_TAB_SHIFT = 16; // 23 - (m = 7);
    const int FUNC_ID         = e_fp32_rcp;

    const char zero_exp = 0;
    float64    result  = v_f32_form_fp_num_ie_b( \
                       zero_exp, input, input, SW_ADD_BIAS | SW_FORCE_SIGN0 | SW_EXP_IS_NUM); // 1
    result = calc_reduced_value<e_func_variant_default, COEFF_TAB_SHIFT, FUNC_ID>(result);                      // 2, 3, 4
                                                                                    // 5, 6, 7
#if 0 /* disabled by -frewrite-includes */
#if defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 247 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    result = v_f32_form_fp_num_b(input, input, result, SW_ADD_BIAS | SW_POST_RECIP);
#else
# 249 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    int64 res_exp =
        (*((int64*)&result) & EXPONENT_MASK) - (*((int64*)&input) & EXPONENT_MASK);      // 8, 9, 10
    result = v_f32_form_fp_num_b(*((float64*)&res_exp), input, result, SW_ADD_BIAS);     // 11

    float64 signed_zero = v_f32_sel_less_f32_b(input, 0.0f, -0.0f, 0.0f);                // 12
    result              = v_f32_sel_leq_i32_b(res_exp, M_UNIT_EXP, signed_zero, result); // 13
#endif
# 256 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    return result;
}

float64 reciprocal_f32(float64 input)
{
    float64 result = reciprocal_fast_f32(input); // 13

    // ====================================
    //  Processing special values: denorm, +-0. +-inf, nan
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 267 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64       abs_x         = v_f32_abs_b(input);
    float64       abs_result    = v_f32_abs_b(result);
    const uint64  flt_min       = FLT_MIN;
    const float64 flt_min_fp32  = *((float64*)&flt_min);
    const uint64  flt_max       = FLT_MAX;
    const float64 flt_max_fp32  = *((float64*)&flt_max);
    const uint64  plus_inf      = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64  nan_int       = NAN_FP32;
    const float64 nan_fp32      = *((float64*)&nan_int);

    abs_result = v_f32_sel_less_f32_b(abs_x, flt_min_fp32, plus_inf_fp32, abs_result); // 14
    abs_result = v_f32_sel_grt_f32_b(abs_x, flt_max_fp32, 0.0f, abs_result);           // 15

    abs_result =
        v_f32_sel_grt_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, abs_result); // 16
    result = v_f32_form_fp_num_b(abs_result, input, abs_result, 0x0);                 // 17

#else // !__goya__
# 286 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    float64 fclass = v_f32_fclass_b(input);                               // 14
    result         = v_f32_calc_fp_special_b(fclass, fclass, e_fp_recip, result); // 15
#endif
# 290 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    // ====================================

    return result;
}

//////////////////////////// COMMON SQRT_F32 / RSQRT_F32/ /////////////////////////////////////
// BASE_SQRT_FUNC VPU Ops = calc_reduced_value + 3 = 6+3=9

#ifdef BASE_SQRT_FUNC // there is redefinition under tpc_special.h (under compiler)
    #undef BASE_SQRT_FUNC
#endif
# 301 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
#define BASE_SQRT_FUNC(INPUT_VAL, EXPONENT, RESULT)                                               \
    {                                                                                             \
        EXPONENT = v_f32_extract_exp_b(INPUT_VAL, false);                                         \
        RESULT   = v_f32_form_fp_num_ie_b(                                                        \
            (char256)(EXPONENT & 1), INPUT_VAL, INPUT_VAL, SW_EXP_IS_NUM | SW_ADD_BIAS, 0, 1, 0); \
        RESULT = calc_reduced_value<e_func_variant_sqrt_rsqrt, COEFF_TAB_SHIFT, FUNC_ID>(RESULT); \
    }

//////////////////////////////////////// SQRT_F32 /////////////////////////////////////////////////
float64 sqrt_fast_f32(float64 input)
{
    const int COEFF_TAB_SHIFT = 17; // 23 - (m = 6);
    const int FUNC_ID         = e_fp32_sqrt;
    float64   result;
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 316 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    result = v_f32_form_fp_num_b(input, input, input, SW_FORCE_SIGN0 | SW_PRE_SQRT_RSQRT);
    result = calc_reduced_value<e_func_variant_sqrt_rsqrt, COEFF_TAB_SHIFT, FUNC_ID>(result);
    result = v_f32_form_fp_num_b(input, result, result, SW_FORCE_SIGN0 | SW_POST_SQRT);
#else
# 320 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    int64 exponent;
    BASE_SQRT_FUNC(input, exponent, result) // 9

    exponent       = *((int64*)&result) + ((exponent >> 1) << 23); // 10, 11, 12
    result         = *((float64*)&exponent);
    result         = v_f32_sel_eq_f32_b(input, 0.0f, 0.0f, result); // 13
#endif
# 327 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    return result;
}

float64 sqrt_f32(float64 input)
{
    float64 result = sqrt_fast_f32(input); // 13

    // ====================================
    //  Processing special values: <0. +inf, nan

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 338 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    const uint64  plus_inf      = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64  nan_int       = NAN_FP32;
    const float64 nan_fp32      = *((float64*)&nan_int);

    result =
        v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, plus_inf_fp32, result);  // 14
    result = v_f32_sel_grt_u32_b(*((uint64*)&input), PLUS_INF_FP32, nan_fp32, result); // 15
    result = v_f32_sel_eq_f32_b(input, -0.0f, -0.0f, result);                          // 16
#else // !__goya__
# 348 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64 fclass = v_f32_fclass_b(input);                               // 14
    result         = v_f32_calc_fp_special_b(fclass, fclass, e_fp_sqrt, result);  // 15
#endif
# 351 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    // ====================================

    return result;
}

//////////////////////////////////////// RSQRT_F32 /////////////////////////////////////////////////
float64 rsqrt_fast_f32(float64 input)
{
    const int COEFF_TAB_SHIFT = 16; // 23 - (m = 7);
    const int FUNC_ID         = e_fp32_rsqrt;
    float64   result;
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 363 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    result = v_f32_form_fp_num_b(input, input, input, SW_FORCE_SIGN0 | SW_PRE_SQRT_RSQRT);
    result = calc_reduced_value<e_func_variant_sqrt_rsqrt, COEFF_TAB_SHIFT, FUNC_ID>(result);
    result = v_f32_form_fp_num_b(input, result, result, SW_FORCE_SIGN0 | SW_POST_RSQRT);
    return result;
#else
# 369 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    int64 exponent;
    BASE_SQRT_FUNC(input, exponent, result) // 9

    exponent = *((int64*)&result) - ((exponent >> 1) << 23); // 10, 11, 12
    result   = *((float64*)&exponent);                       // 13
    return result;
#endif
# 376 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
}

float64 rsqrt_f32(float64 input)
{
    float64 result = rsqrt_fast_f32(input); // 13

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 383 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
                                            // ====================================
    //  Processing special values: <=0. +inf, nan
    const uint64  plus_inf      = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);

    const uint64  minus_inf      = MINUS_INF_FP32;
    const float64 minus_inf_fp32 = *((float64*)&minus_inf);

    const uint64  nan_int  = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_eq_f32_b(input, 0.0f, plus_inf_fp32, result); // 14
    // result = v_f32_sel_less_f32_b(input, 0.0f, nan_fp32, result);
    result = v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, 0.0f, result);      // 15
    result = v_f32_sel_grt_u32_b(*((uint64*)&input), PLUS_INF_FP32, nan_fp32, result); // 16
    result = v_f32_sel_eq_f32_b(input, -0.0f, minus_inf_fp32, result);                 // 17
// ====================================
#else
# 401 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64 fclass   = v_f32_fclass_b(input);
    result           = v_f32_calc_fp_special_b(fclass, fclass, e_fp_rsqrt, result);
#endif
# 404 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    return result;
}

float64 rsqrt_quake_f32(float64 input)
{
    int64   constValue   = 0x5f3759df;
    float64 constnegHalf = -0.5f;
    float64 constHalf    = 0.5f;
    int64   initialGuess = *(int64*)&input;

    initialGuess = constValue - v_i32_shr_b(initialGuess, 1);

    float64 invSqrtVal = *(float64*)&initialGuess;
    float64 half_input = constnegHalf * input;

    for (int i = 0; i < 3; i++)
    {
        float64 x_sqr  = invSqrtVal * invSqrtVal;
        float64 in_bra = v_f32_mac_b(half_input, x_sqr, constHalf, SW_NO_NEG);
        invSqrtVal     = v_f32_mac_b(invSqrtVal, in_bra, invSqrtVal, SW_NO_NEG);
    }

    return invSqrtVal;
}

float64 reciprocal_cephes_fast_f32(float64 input)
{
    float64     result, temp0, temp1, temp2;
    const float a = 2.58586f;
    const float b = -5.81818f;
    const float c = 4.24242f;

    int64 significand = 0;
    significand       = v_i32_and_b(*((int64*)&input), SIGNIFICAND_MASK);
    significand       = v_i32_or_b(significand, 0x3f000000);
    result            = *((float64*)&significand);

    int64 exponent = 0;
    exponent       = v_i32_shr_b(*((int64*)&input), 23);
    exponent       = v_i32_and_b(exponent, 0x000000ff);
    exponent -= 0x7e;

    temp0 = v_f32_mac_b(result, a, b);
    temp1 = v_f32_mac_b(result, temp0, c);
    temp2 = v_f32_mac_b(-result, temp1, 2);
    temp2 *= temp1;
    temp0 = v_f32_mac_b(-result, temp2, 2);
    temp0 *= temp2;

    int64 exp = v_i32_shr_b(*((int64*)&temp0), 23);
    exp       = v_i32_and_b(exp, 0x000000ff);
    exp       = v_i32_add_b(exp, -exponent);
    exp       = v_i32_and_b(exp, 0xff);
    result    = v_f32_form_fp_num_ie_b((char256)exp, input, temp0, SW_EXP_IS_NUM);

    return result;
}

float64 reciprocal_cephes_f32(float64 input)
{
    float64 result = reciprocal_cephes_fast_f32(input);

    // ====================================
    //  Processing special values: denorm, +-0. +-inf, nan
    float64 abs_x = v_f32_abs_b(input);

    const uint64  flt_max      = FLT_MAX;
    const float64 flt_max_fp32 = *((float64*)&flt_max);

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 475 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64       abs_result    = v_f32_abs_b(result);
    const uint64  flt_min       = FLT_MIN;
    const float64 flt_min_fp32  = *((float64*)&flt_min);
    const uint64  plus_inf      = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64  nan_int       = NAN_FP32;
    const float64 nan_fp32      = *((float64*)&nan_int);

    abs_result = v_f32_sel_less_f32_b(abs_x, flt_min_fp32, plus_inf_fp32, abs_result);
    abs_result = v_f32_sel_geq_f32_b(abs_x, flt_max_fp32, 0.0f, abs_result);
    abs_result = v_f32_sel_grt_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, abs_result);

    result = v_f32_form_fp_num_b(abs_result, input, abs_result, 0x0);
#else
# 489 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64 fclass   = v_f32_fclass_b(input);
    result           = v_f32_calc_fp_special_b(fclass, fclass, e_fp_recip, result);
    result           = v_f32_sel_geq_f32_b(abs_x, flt_max_fp32, 0.0f, result);
#endif
# 493 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    // ====================================

    return result;
}

float64 div_cephes_fast_f32(float64 input_x, float64 input_y)
{
    return input_x * reciprocal_cephes_fast_f32(input_y);
}

float64 div_cephes_f32(float64 input_x, float64 input_y)
{
    float64 result = input_x * reciprocal_cephes_f32(input_y);

// ====================================
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 509 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    //  Processing special values: 0, +-inf, nan
    const uint64  flt_min       = FLT_MIN;
    const float64 flt_min_fp32  = *((float64*)&flt_min);
    const uint64  nan_int       = NAN_FP32;
    const float64 nan_fp32      = *((float64*)&nan_int);
    const uint64  plus_inf      = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);

    float64 abs_x = v_f32_abs_b(input_x);
    float64 abs_y = v_f32_abs_b(input_y);

    // x == nan?
    result = v_f32_sel_grt_f32_b(abs_x, plus_inf_fp32, nan_fp32, result);

    // sign_x ^ sign_y; (sign_x ^ sign_y) | plus_inf
    int64         sign_res = (((*((int64*)&input_x)) >> 31) ^ ((*((int64*)&input_y)) >> 31)) << 31;
    const float64 sign_res_fp32 = *((float64*)&sign_res);

    // x ==    +-inf?
    float64 inf_x_y = v_f32_or_b(sign_res_fp32, plus_inf_fp32);
    bool256 inf_x   = from_bool64(v_f32_cmp_eq_b(abs_x, plus_inf_fp32));
    result = v_f32_sel_eq_f32_vb(abs_y, plus_inf_fp32, nan_fp32, inf_x_y, 0,
                                                                        result, to_bool64(inf_x));

    // x == +-0?
    bool256 zero_x = from_bool64(v_f32_cmp_less_b(abs_x, flt_min_fp32));
    result         = v_f32_sel_less_f32_vb(abs_y, flt_min_fp32, nan_fp32, sign_res_fp32, 0,
                                                                        result, to_bool64(zero_x));

#else
# 539 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64 fclass_x = v_f32_fclass_b(input_x);
    float64 fclass_y = v_f32_fclass_b(input_y);
    result           = v_f32_calc_fp_special_b(fclass_x, fclass_y, e_fp_div, result);
#endif
# 543 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    // ====================================

    return result;
}
//////////////////////////////////////// LOG2_F32 GAUDI ///////////////////////////////////////////

/*
    uint32_t mantissa_bits        = (input_bits & mantissa_mask);          --> 1 AND
    int32_t  input_exponent       = ((input_bits & exponent_mask) >> 23)- (126 | ((swap_bit &
(mantissa_bits ^ swap_bit))>>22)); --> 1 EXTRACT_EXP.UNBIASED, 1 CMP_EQ.MASK_EQ_ZERO, 1 ADD uint32_t
segment              = mantissa_bits>>17; --> 1 GET_LUT_ENTRY float*   poly                 =
(float*) ctable[segment]; --> 1 LOOKUP_2C, 1 LOOKUP_1C uint32_t base_bits            = half_bits |
((swap_bit & (mantissa_bits ^ swap_bit))<<1); --> 1 OR (using predicate from CMP_EQ above) uint32_t
bias                 = segment << 17 | bias_bit; --> 1 SHL, 1 OR float    bias_as_float        =
bits_to_fp32(bias | base_bits); --> 1 OR float    input_normalized     = bits_to_fp32(mantissa_bits
| base_bits) - bias_as_float; --> 1 OR, 1 SUB float    input_seminormalized =
bits_to_fp32(mantissa_bits | base_bits); --> already calculated float    result_poly          =
poly[1] + poly[2]*input_normalized;  --> 1 MAC result_poly = result_poly*input_normalized+poly[0];
--> 1 MAC float    result               = result_poly * (input_seminormalized - 1); --> 1 SUB, 1 MUL
    result+=((float)input_exponent); --> 1 CONVERT, 1 ADD
// check for special cases
--> 1 FP_CLASS, 1 CALC_FP_SPECIAL
*/
#if 0 /* disabled by -frewrite-includes */
#if defined(__gaudi__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 568 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    #define UNIT_VAL         0x3f800000
    #define SIGNIFICAND_MASK 0x007fffff
    #define EXPONENT_MASK    0x7f800000
    #define NAN_FP32         0x7fffffff
    #define PLUS_INF_FP32    0x7f800000
    #define MINUS_INF_FP32   0xff800000
    #define EXP_LOWER        0xc2aeac50
    #define EXP_UPPER        0x42b17218
    #define FLT_MIN          0x800000
    #define FLT_MAX          0x7f7fffff
    #define M_UNIT_EXP       0xc0800000
    #define BIAS_BIT         (1 << 16)

inline float64 log2_lut_f32(float64 input)
{
    #define FUNC_ID_F32_LOG2_APPROX1 281
    int64 mantissa_bits = v_i32_and_b(*((int64*)&input), SIGNIFICAND_MASK);
    // int32_t  input_exponent       = ((input_bits & exponent_mask) >> 23)- (126 | ((swap_bit &
    // (mantissa_bits ^ swap_bit))>>22)); --> 1 EXTRACT_EXP.UNBIASED, 1 CMP_EQ.MASK_EQ_ZERO, 1 ADD
    int64 exponent = v_f32_extract_exp_b(input);

    int64   bit22 = v_i32_shr_b(mantissa_bits, 22);
    bool256 pred  = from_bool64(v_i32_cmp_eq_b(bit22, 1));
    exponent      = v_i32_add_vb(exponent, 1, 0, exponent, to_bool64(pred));
    // uint32_t base_bits            = half_bits | ((swap_bit & (mantissa_bits ^ swap_bit))<<1); -->
    // 1 OR (using predicate from CMP_EQ above)
    int64 base_bits = 0x3f000000;
    base_bits       = v_i32_or_vb(base_bits, 8388608, 0, base_bits, to_bool64(pred), 1);
    //  uint32_t segment              = mantissa_bits>>17; --> 1 GET_LUT_ENTRY
    // float*   poly                 = (float*) ctable[segment]; --> 1 LOOKUP_2C, 1 LOOKUP_1C
    int64  lut_index_i64 = v_i32_shr_b(mantissa_bits, 17);
    uint64 lut_index     = *(uint64*)&lut_index_i64;

    uint64_pair_t c1c2   = {0, 0};
    uint64        c0_int = v_u32_lookup_1c(lut_index, FUNC_ID_F32_LOG2_APPROX1, SW_BV32, 0);
    c1c2 = v_u32_lookup_2c(lut_index, FUNC_ID_F32_LOG2_APPROX1, SW_BV32, (uint64_pair_t){0});
    int64 segment = v_i32_shl_b(lut_index_i64, 17);
    int64 bias    = v_i32_or_b(segment, BIAS_BIT);
    bias          = v_i32_or_b(bias, base_bits);
    // float    bias_as_float        = bits_to_fp32(bias | base_bits); --> 1 OR
    float64 bias_as_float =
        *(float64*)&bias; // v_f32_or_b(*(float64*)&bias, *(float64*)&base_bits);
    // float    input_normalized     = bits_to_fp32(mantissa_bits | base_bits) - bias_as_float; -->
    // 1 OR, 1 SUB
    float64 input_seminormalized = v_f32_or_b(*(float64*)&mantissa_bits, *(float64*)&base_bits);
    float64 input_normalized =
        v_f32_sub_b(input_seminormalized, bias_as_float, 0);
    float64 poly_res = *(float64*)&c1c2.v1;
    poly_res         = v_f32_mac_b(input_normalized, *(float64*)&c1c2.v2, poly_res);
    poly_res         = v_f32_mac_b(poly_res, input_normalized, *(float64*)&c0_int);
    input_normalized = v_f32_sub_b(input_seminormalized, 1, 0);
    float64 result   = v_convert_i32_to_f32_b(exponent, SW_RHNE);
    result           = v_f32_mac_b(input_normalized, poly_res, result);
    float64 fclass   = v_f32_fclass_b(input);
    return v_f32_calc_fp_special_b(fclass, fclass, e_fp_log, result);
}
#endif
# 625 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
/*
float64 log_f32(float64 input)
{//  log32_Gaudi
    const float ln_2 = 0.69314718056;      // 0x3f317218
    int64 exponent = v_f32_extract_exp_b(input, false);
    float64 fl_exponent = v_convert_i32_to_f32_b(exponent, SW_RHNE) ;
    const char zero_exp = 0;
    float64 result = v_f32_form_fp_num_ie_b(zero_exp, input, input, SW_EXP_IS_NUM|SW_ADD_BIAS);
    bool256 zero_exp_pred = from_bool64(v_i32_cmp_eq_b(exponent, 0));
    float64 tmp_result = result;

    const int COEFF_TAB_SHIFT = 16;             // 23 - (m = 7)
    const int FUNC_ID = e_fp32_log2;

    uint64_float64_pair_t all_coeffs_tab;
    all_coeffs_tab = v_f32_get_lut_entry_and_interval_start_b(result, COEFF_TAB_SHIFT,
                                                              e_func_variant_default << 13);

    uint64 intervals = all_coeffs_tab.v1;
    intervals = v_u32_add_vb(intervals, 128, 0, intervals, to_bool64(zero_exp_pred), 1);
    float64 value = result - all_coeffs_tab.v2;
    LOOKUP_AND_MAC(intervals, value, result)

    float64 res_minus_one = tmp_result - 1.0f;
    result = v_f32_mul_vb(res_minus_one, result, 0, result, to_bool64(zero_exp_pred));

    result += fl_exponent;
    result *= ln_2;

// ====================================
//  Processing special values: <=0, +-inf, nan
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);
    const uint64 minus_inf = MINUS_INF_FP32;
    const float64 minus_inf_fp32 = *((float64*)&minus_inf);
    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_less_f32_b(input, 0.0f, nan_fp32, result);
    result = v_f32_sel_eq_f32_b(input, 0.0f, minus_inf_fp32, result);
    result = v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, plus_inf_fp32, result);
    result = v_f32_sel_grt_i32_b(*((int64*)&input), PLUS_INF_FP32, nan_fp32, result);
// ====================================

    return result;
} //  log_f32_Gaudi
*/
//////////////////////////////////////// LOG_F32 CEPHES///////////////////////////////////////////
float64 log_fast_f32(float64 input)
{
    //  log32_cephes: log(1+x) = x - 0.5 x**2 + x**3 P(x)
    const float log2_e_m_1            = 0.44269504088896340735992; // log2(e) - 1.0
    const float ln_2                  = 0.69314718056;             // ln(2)        (0x3f317218)
    const float one_sqrt_2            = 0.70710677;                // 1/sqrt(2)    (0x3f3504f3)
    const float coeffs[] = {7.0376836292E-2,
                                         -1.1514610310E-1,
                                         1.1676998740E-1,
                                         -1.2420140846E-1,
                                         1.4249322787E-1,
                                         -1.6668057665E-1,
                                         2.0000714765E-1,
                                         -2.4999993993E-1,
                                         3.3333331174E-1};
    const int   poly_tab_size         = sizeof(coeffs)/sizeof(coeffs[0]);

    int64      exponent    = v_f32_extract_exp_b(input, false) + 1; // 1, 2
    const char exp_126     = 126;
    float64    fraction    = v_f32_form_fp_num_ie_b(exp_126, input, input, SW_EXP_IS_NUM); // 3
    float64    fl_exponent = v_convert_i32_to_f32_b(exponent, SW_RHNE);      // 4

    float64 diff      = fraction - one_sqrt_2;                                             // 5
    int64   diff_sign = v_i32_shr_b((*(int64*)&diff), 31);                                 // 6
    exponent -= diff_sign;                                                                 // 7
    fl_exponent          = v_convert_i32_to_f32_b(exponent, SW_RHNE);        // 8
    float64 fl_diff_sign = v_convert_i32_to_f32_b(diff_sign, SW_RHNE);       // 9
    fraction += fl_diff_sign * fraction - 1.0f;                                            // 10, 11

    float64 x_sqr = fraction * fraction; // 12
    float64 poly  = coeffs[0];
    for (int i = 1; i < poly_tab_size; i++)                          // 13, 14, 15, 16
        poly = v_f32_mac_b(poly, fraction, coeffs[i], (false) << 1); // 17, 18, 19, 20

    float64 tailor = fraction * (x_sqr * poly); // 21, 22
    tailor -= 0.5 * x_sqr;                      // 23

    float64 result = tailor * log2_e_m_1; // 24
    result += fraction * log2_e_m_1;      // 25
    result += tailor;                     // 26
    result += fraction;                   // 27

    result += fl_exponent; // 28
    result *= ln_2;        // 29

    return result;
}

float64 log_f32(float64 input)
{
    float64 result = log_fast_f32(input); // 29
// ====================================
//  Processing special values: <=0, +-inf, nan
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 727 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    const uint64  plus_inf       = PLUS_INF_FP32;
    const float64 plus_inf_fp32  = *((float64*)&plus_inf);
    const uint64  minus_inf      = MINUS_INF_FP32;
    const float64 minus_inf_fp32 = *((float64*)&minus_inf);
    const uint64  nan_int        = NAN_FP32;
    const float64 nan_fp32       = *((float64*)&nan_int);

    result = v_f32_sel_less_f32_b(input, 0.0f, nan_fp32, result);     // 30
    result = v_f32_sel_eq_f32_b(input, 0.0f, minus_inf_fp32, result); // 31
    result =
        v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, plus_inf_fp32, result); // 32
    result = v_f32_sel_grt_i32_b(*((int64*)&input), PLUS_INF_FP32, nan_fp32, result); // 33

#else
# 741 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    float64 fclass = v_f32_fclass_b(input);
    result         = v_f32_calc_fp_special_b(fclass, fclass, e_fp_log, result);
#endif
# 745 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    // ====================================

    return result;
} // log_f32_cephes
//   Special log values:
//     x < 0.0 -> return nan
//     x = -inf -> return nan
//   x = -0.0 -> return nan
//   x = 0.0 -> return -inf
//   x = +inf -> return +inf
//     x = nan -> return nan

//////////////////////////////////////// LOG_1P_F32 ///////////////////////////////////////////
float64 log1p_f32(float64 input)
{
    float64 v_ones = 1;
    const float threshold = 5e-3;
    bool256 grt, less, pred;

    float64 temp, output_1, output;

    // threshold comparison
    grt  = from_bool64(v_f32_cmp_grt_b(input, -threshold));
    less = from_bool64(v_f32_cmp_less_b(input, threshold));
    pred = v_i1_and_b(grt, less);

    // x * ( 1 - (0.5 * x))
    temp = v_f32_mac_b(input, 0.5, v_ones, SW_NEG);
    output_1 = v_f32_mul_b(input, temp);


    // log( 1 + x )
    temp   = v_f32_add_b(v_ones, input);
    output = log_f32(temp);

    output = v_f32_mov_vb(output_1, 0, output, to_bool64(pred));

    return output;
}

////////////////////////////////// COMMON SIN_COS_F32 //////////////////////////////////////
// 23 + 4 = 27
#define SIN_COS_CALC(SIN_X_COND)                                                              \
    const float four_by_pi = 1.27323949;       /* 4/pi = 0x3fa2f983 */                        \
    const float pi4_1      = 7.85156250e-01;   /* pi/4 = 0x3f490000 */                        \
    const float pi4_2      = 2.41875648498e-4; /* 0x397da000 */                               \
    const float pi4_3      = 3.7748949774e-8;  /* 0x3fa2f983*/                                \
                                                                                              \
    float64 abs_x        = v_f32_abs_b(input);                                                \
    float64 fl_pi4_shift = abs_x * four_by_pi;                                                \
    int64   pi4_shift    = v_convert_f32_to_i32_b(fl_pi4_shift, SW_RD);          \
    pi4_shift += pi4_shift & 1; /* Shift x in [-pi/4, +pi/4] */                               \
    fl_pi4_shift          = v_convert_i32_to_f32_b(pi4_shift, SW_RHNE);         \
    float64 reduced_x     = abs_x;                                                            \
    reduced_x             = v_f32_mac_b(fl_pi4_shift, pi4_1, reduced_x, (true) << 1);         \
    reduced_x             = v_f32_mac_b(fl_pi4_shift, pi4_2, reduced_x, (true) << 1);         \
    reduced_x             = v_f32_mac_b(fl_pi4_shift, pi4_3, reduced_x, (true) << 1);         \
    float64 abs_reduced_x = v_f32_abs_b(reduced_x);                                           \
                                                                                              \
    int64   pi2_shift     = (pi4_shift >> 1) & 3; /* remove shift by 2*pi: x in [0, 2*pi) */  \
    float64 fl_sign_shift = v_convert_i32_to_f32_b(pi2_shift & 2, SW_RHNE);     \
    sign_res -= fl_sign_shift * sign_res; /* x>pi? -> shift by pi: cos(pi-x) = -cos(x) */     \
    pi2_shift -= pi2_shift & 2;           /* remove shift by pi -> pi2_shift in [0, 1] */     \
                                                                                              \
    const int COEFF_TAB_SHIFT = 17; /* 23 - (m = 6) */                                        \
    const int FUNC_ID         = e_fp32_sin_cos;                                               \
                                                                                              \
    bool256               sin_x = from_bool64(v_i32_cmp_eq_b(pi2_shift, SIN_X_COND));         \
    uint64_float64_pair_t all_coeffs_tab;                                                     \
    all_coeffs_tab = v_f32_get_lut_entry_and_interval_start_b(                                \
        abs_reduced_x, COEFF_TAB_SHIFT, (e_func_variant_sin_cos) << 13,                       \
                                     (uint64_float64_pair_t){0}, 1, 0);                       \
    uint64 intervals = all_coeffs_tab.v1;                                                     \
    intervals        = v_u32_add_vb(intervals, 64, 0, intervals,                \
                                    to_bool64(sin_x), 1);                                     \
    float64 value    = abs_reduced_x - all_coeffs_tab.v2;                                     \
    float64 result;                                                                           \
    LOOKUP_AND_MAC(intervals, value, result) /* 4 VPU ops*/                                   \
                                                                                              \
    result = v_f32_mul_vb(abs_reduced_x, result, 0, result, to_bool64(sin_x));



float64 process_sin_cos_special_values(float64 input, float64 abs_x)    // it takes 5 VPU ops
{
    float64 result;
    const uint64  nan_int          = NAN_FP32;
    const float64 nan_fp32         = *((float64*)&nan_int);
    const float   sin_max_arg      = s_convert_i32_to_f32(0xffffff, SW_RHNE << 16),
                sin_accuracy_limit = s_convert_i32_to_f32(0x2000, SW_RHNE << 16);

    result = v_f32_sel_grt_f32_b(abs_x, sin_accuracy_limit, 0.0f, input);
    result = v_f32_sel_grt_f32_b(abs_x, sin_max_arg, nan_fp32, result);
    result = v_f32_sel_geq_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, result);
    return result;
}

// #endif

//   Special sin/cos values:
// x = -inf -> return nan
// x -= -0.0 -> return +1.0
// x = +0.0 -> return +1.0
// x = +inf -> return nan
// x = nan -> return nan
// x > sin_max_arg (= 1 << 24 - 1) -> return nan
// x > sin_accuracy_limit (= 1 << 13) -> return 0.0f

//////////////////////////////////////// COS_F32 /////////////////////////////////////////////////
// 29 VPU ops
float64 cos_fast_f32(float64 input)
{
    float64 sign_res = 1.0f;
    SIN_COS_CALC(1) // 27 VPU ops

    sign_res =
        v_f32_sel_grt_f32_vb(reduced_x, 0.0f, -sign_res, sign_res, 0, sign_res, to_bool64(sin_x));
    result = v_f32_sel_less_f32_b(sign_res, 0.0f, -result, result); // 29

    return result;
}
// 29 VPU ops + abs + process_sin_cos_special_values() = 29 + 1 + 5 = 35 VPU ops
float64 cos_f32(float64 input)
{
    float64 abs_x  = v_f32_abs_b(input);
    float64 result = cos_fast_f32(input);
    // ====================================
    //  Processing special values: +-inf, nan, sin/cos limits

    result = process_sin_cos_special_values(result, abs_x);
    // const uint64 nan_int = NAN_FP32;
    // const float64 nan_fp32 = *((float64*)&nan_int);
    // const float sin_max_arg = s_convert_i32_to_f32(0xffffff, SW_RHNE);
    // const float sin_accuracy_limit = s_convert_i32_to_f32(0x2000, SW_RHNE);

    // result = v_f32_sel_grt_f32_b(abs_x, sin_accuracy_limit, 0.0f, result);
    // result = v_f32_sel_grt_f32_b(abs_x, sin_max_arg, nan_fp32, result);
    // result = v_f32_sel_geq_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, result);

    // ====================================

    return result;
}

//////////////////////////////////////// SIN_F32 /////////////////////////////////////////////////
// sin_fast_f32 VPU ops = 30
float64 sin_fast_f32(float64 input)
{
    float64 sign_res = v_f32_sel_grt_f32_b(input, 0.0f, 1.0f, -1.0f); // 1
    SIN_COS_CALC(0)                                                         // 2...28

    sign_res =
        v_f32_sel_less_f32_vb(reduced_x, 0.0f, -sign_res, sign_res, 0, sign_res, to_bool64(sin_x));
    result = v_f32_sel_less_f32_b(sign_res, 0.0f, -result, result); // 30
    return result;
}

// sin_f32 VPU ops = sin_fast_f32 VPU ops + ABS + SIN_SPECIAL_VALUES = 30+1+5=36
float64 sin_f32(float64 input)
{
    float64 abs_x  = v_f32_abs_b(input);
    float64 result = sin_fast_f32(input);
    // ====================================
    //  Processing special values: +-inf, nan, sin/cos limits

    result = process_sin_cos_special_values(result, abs_x);
    // ====================================

    return result;
}

//////////////////////////////////////// DIV_F32 /////////////////////////////////////////////////
float64 div_fast_f32(float64 input_x, float64 input_y)
{
    float64 result = input_x * reciprocal_fast_f32(input_y); // 13+1=14

    return result;
}

float64 div_f32(float64 input_x, float64 input_y)
{
    float64 result = input_x * reciprocal_f32(input_y); // 13, 14

// ====================================
//  Processing special values: 0, +-inf, nan
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 932 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    const uint64  flt_min       = FLT_MIN;
    const float64 flt_min_fp32  = *((float64*)&flt_min);
    const uint64  nan_int       = NAN_FP32;
    const float64 nan_fp32      = *((float64*)&nan_int);
    const uint64  plus_inf      = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);

    float64 abs_x = v_f32_abs_b(input_x); // 15
    float64 abs_y = v_f32_abs_b(input_y); // 16

    // x == nan?
    result = v_f32_sel_grt_f32_b(abs_x, plus_inf_fp32, nan_fp32, result); // 17

    // sign_x ^ sign_y; (sign_x ^ sign_y) | plus_inf
    int64 sign_res = (((*((int64*)&input_x)) >> 31) ^ ((*((int64*)&input_y)) >> 31))
                     << 31; // 18, 19, 20, 21
    const float64 sign_res_fp32 = *((float64*)&sign_res);

    // x ==    +-inf?
    float64 inf_x_y = v_f32_or_b(sign_res_fp32, plus_inf_fp32); // 22
    bool256 inf_x   = from_bool64(v_f32_cmp_eq_b(abs_x, plus_inf_fp32));    // 23
    result          = v_f32_sel_eq_f32_vb(abs_y, plus_inf_fp32, nan_fp32, inf_x_y, 0, result,
                                                                            to_bool64(inf_x));
    // x == +-0?
    bool256 zero_x = from_bool64(v_f32_cmp_less_b(abs_x, flt_min_fp32)); // 25
    result         = v_f32_sel_less_f32_vb(abs_y, flt_min_fp32, nan_fp32, sign_res_fp32, 0, result,
                                                                            to_bool64(zero_x));

#else
# 961 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    float64 fclass_x = v_f32_fclass_b(input_x);
    float64 fclass_y = v_f32_fclass_b(input_y);
    result           = v_f32_calc_fp_special_b(fclass_x, fclass_y, e_fp_div, result);
#endif
# 966 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    // ====================================
    return result;
}

// Simlified scalar division (x / y) Markstein's algorithm, very efficient in case of y is actually
// integer values. It assumes that rc (reciprocal of y) comes from outside
float div_fast_f32_s(float x, float y, float rc)
{
    float q = x * rc;

    // Lines below should be called if x isn't +INF or -INF. For simlicity corresponding cheking is
    // missed
    x = s_f32_mac(y, q, x, SW_NEG);
    q = s_f32_mac(x, rc, q, SW_NO_NEG);

    return q;
}

//////////////////////////////////////// TANH_F32 /////////////////////////////////////////////////

float64 tanh_fast_abs_in_f32(float64 input, float64 abs_x)
{
    const int COEFF_TAB_SHIFT = 17; // 23 - (m = 6);
    const int FUNC_ID         = e_fp32_tanh;

    int64   exponent = v_f32_extract_exp_b(input, false);           // 1
    bool256 neg_exp  = from_bool64(v_i32_cmp_less_b(exponent, 0));  // 2

    float64 result;
    result = calc_reduced_value<e_func_variant_tanh, COEFF_TAB_SHIFT, FUNC_ID>(abs_x);  // 3, 4, 5
                                                                         // 6, 7, 8
    result = v_f32_mul_vb(result, abs_x, 0, result, to_bool64(neg_exp)); // 9

    bool256 greq_8 = from_bool64(v_f32_cmp_geq_b(abs_x, 8.0f)); // 10
    result =
        v_f32_sel_less_f32_vb(abs_x, 9.0f, 0.999999881f, result, 0, result, to_bool64(greq_8));// 11
    result = v_f32_sel_geq_f32_b(abs_x, 9.0f, 1.0f, result);                                   // 12

    result = v_f32_form_fp_num_b(result, input, result, 0x0); // 13
    return result;
}

float64 tanh_fast_f32(float64 input)
{
    float64 abs_x  = v_f32_abs_b(input);                 // 1
    float64 result = tanh_fast_abs_in_f32(input, abs_x); // 14

    return result;
}

float64 tanh_f32(float64 input)
{
    float64 abs_x  = v_f32_abs_b(input);                 // 1
    float64 result = tanh_fast_abs_in_f32(input, abs_x); // 15
                                                         // ====================================
                                                         //  Processing special values: nan
    const uint64  nan_int  = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_grt_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, result); // 16
    // ====================================

    return result;
}

//////////////////////////////////////// ERF_F32 /////////////////////////////////////////////////

inline float64 erf_fast_abs_in_f32(float64 input, float64 abs_x)
{
    const int COEFF_TAB_SHIFT = 17; // 23 - (m = 6);
#if 0 /* disabled by -frewrite-includes */
#if defined (__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1037 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    const int FUNC_ID         = 9; //e_fp32_erf
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined (__goya2__)  || defined (__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 1039 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    const int FUNC_ID        = 8;
#else
# 1041 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    const int FUNC_ID        = 6;
#endif
# 1043 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    abs_x = v_f32_mul_b(abs_x, 2);            // 1

    int64   exponent = v_f32_extract_exp_b(abs_x, false);           // 2
    bool256 neg_exp  = from_bool64(v_i32_cmp_less_b(exponent, 0));  // 3

    float64 result;
    result = calc_reduced_value<e_func_variant_tanh, COEFF_TAB_SHIFT, FUNC_ID>(abs_x);  // 4, 5, 6
                                                                         // 7, 8, 9
    result = v_f32_mul_vb(result, abs_x, 0, result, to_bool64(neg_exp)); // 10

    result = v_f32_sel_geq_f32_b(abs_x, 8.0f, 1.0f, result);                                   // 11

    result = v_f32_form_fp_num_b(result, input, result, 0x0); // 12
    return result;
}

inline float64 erf_f32(float64 input)
{

    float64 abs_x  = v_f32_abs_b(input);                 // 1
    float64 result = erf_fast_abs_in_f32(input, abs_x); // 13

    // ====================================
    //  Processing special values: nan
    const uint64  nan_int  = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    result = v_f32_sel_grt_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, result); // 14
    // ====================================

    return result;
}

//////////////////////////////////////// POW2_F32 //////////////////////////////////////////////////

float64 pow2_fast_f32(float64 input)
{
    float c0 = 0.999999999996072;
    float c1 = 0.6931471807715933;
    float c2 = 0.24022650769193007;
    float c3 = 5.5504096708578914e-2;
    float c4 = 9.618103173481352e-3;
    float c5 = 1.3335229931409013e-3;
    float c6 = 1.5436099684915775e-4;
    float c7 = 1.4593978816731232e-5;


    float64 int_part  =  v_f32_nearbyint_b(input, SW_RHNE);
    float64 x_frac    =  v_f32_sub_b(input, int_part, SW_NO_NEG);
    int64 output_exp  =  v_convert_f32_to_i32_b(int_part, SW_RD);
    output_exp        =  v_i32_shl_b(output_exp, 23);

    float64 result = v_f32_mac_b(x_frac, c7, c6, (false) << 1);
    result = v_f32_mac_b(result, x_frac, c5, (false) << 1);
    result = v_f32_mac_b(result, x_frac, c4, (false) << 1);
    result = v_f32_mac_b(result, x_frac, c3, (false) << 1);
    result = v_f32_mac_b(result, x_frac, c2, (false) << 1);
    result = v_f32_mac_b(result, x_frac, c1, (false) << 1);
    result = v_f32_mac_b(result, x_frac, c0, (false) << 1);

    int64 result_i = v_i32_add_b(*((int64*)&result), output_exp);

    return (*((float64*)&result_i));
}

float64 pow2_f32(float64 input)
{
    float64 result = pow2_fast_f32(input); // 27

    const float64 pow2_lower = -126.0f;
    const float64 pow2_upper = 128.0f;

    const uint64  plus_inf      = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64*)&plus_inf);

    result = v_f32_sel_less_f32_b(input, pow2_lower, 0.0f, result);         // 28
    result = v_f32_sel_geq_f32_b(input, pow2_upper, plus_inf_fp32, result); // 29

    // ====================================
    //  Processing special values: spec.exp values, +-inf, nan
    // #if defined( __goya__)
#if 0 /* disabled by -frewrite-includes */
#if !defined(__gaudi__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 1126 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    const uint64  flt_max      = FLT_MAX;
    const float64 flt_max_fp32 = *((float64*)&flt_max);

    result = v_f32_sel_less_f32_b(input, -flt_max_fp32, 0.0f, result);        // 30
    result = v_f32_sel_geq_f32_b(input, flt_max_fp32, plus_inf_fp32, result); // 31

    result = v_f32_sel_grt_u32_b(*((uint64*)&input) & NAN_FP32, PLUS_INF_FP32, input, result); // 32

#else
# 1135 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    float64 fclass = v_f32_fclass_b(input);
    result         = v_f32_calc_fp_special_b(fclass, fclass, e_fp_exp, result);
#endif
# 1139 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    // ====================================

    return result;
}

//////////////////////////////////////// LOG2_F32 CEPHES///////////////////////////////////////////
float64 log2_fast_f32(float64 input)
{
    float c0 = 0.4426950418502187;
    float c1 = -0.7213473519984839;
    float c2 = 0.4808979006360545;
    float c3 = -0.36069642444986055;
    float c4 = 0.2885852710432246;
    float c5 = -0.23963658298926194;
    float c6 = 0.20429601566601588;
    float c7 = -0.19061264270595252;
    float c8 = 0.18782670108945348;
    float c9 = -0.11297489106108768;

    int64 exponent = v_f32_extract_exp_b(input, 1);
    int64 mantissa = v_i32_and_b(*((int64 *)&input), 0x007fffff);
    int64 exp_126_or_127 = v_i32_sel_grt_u32_b(*((uint64 *)&mantissa), 0x003504f3, 126, 127);

    float64 argument = v_f32_form_fp_num_ie_b((char256)exp_126_or_127, 0, input, SW_EXP_IS_NUM);

    argument = v_f32_sub_b(argument, 1.0, SW_NO_NEG);

    float64 result = v_f32_mac_b(argument, c9, c8, (false) << 1);
    result = v_f32_mac_b(result, argument, c7, (false) << 1);
    result = v_f32_mac_b(result, argument, c6, (false) << 1);
    result = v_f32_mac_b(result, argument, c5, (false) << 1);
    result = v_f32_mac_b(result, argument, c4, (false) << 1);
    result = v_f32_mac_b(result, argument, c3, (false) << 1);
    result = v_f32_mac_b(result, argument, c2, (false) << 1);
    result = v_f32_mac_b(result, argument, c1, (false) << 1);
    result = v_f32_mac_b(result, argument, c0, (false) << 1);

    result = v_f32_mac_b(result, argument, argument, (false) << 1);

    exponent = v_i32_sub_b(exponent, exp_126_or_127, SW_NO_NEG);

    float64 fexponent = v_convert_i32_to_f32_b(exponent, SW_RHNE);

    result = v_f32_add_b(result, fexponent);

    return result;
}

float64 log2_f32(float64 input)
{
    float64 result = log2_fast_f32(input);
// ====================================
//  Processing special values: <=0, +-inf, nan
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 1193 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    const uint64  plus_inf       = PLUS_INF_FP32;
    const float64 plus_inf_fp32  = *((float64*)&plus_inf);
    const uint64  minus_inf      = MINUS_INF_FP32;
    const float64 minus_inf_fp32 = *((float64*)&minus_inf);
    const uint64  nan_int        = NAN_FP32;
    const float64 nan_fp32       = *((float64*)&nan_int);

    result = v_f32_sel_less_f32_b(input, 0.0f, nan_fp32, result);
    result = v_f32_sel_eq_f32_b(input, 0.0f, minus_inf_fp32, result);
    result = v_f32_sel_eq_u32_b(*((uint64*)&input), PLUS_INF_FP32, plus_inf_fp32, result);
    result = v_f32_sel_grt_i32_b(*((int64*)&input), PLUS_INF_FP32, nan_fp32, result);
#else
# 1205 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64 fclass = v_f32_fclass_b(input);
    result         = v_f32_calc_fp_special_b(fclass, fclass, e_fp_log, result);
#endif
# 1208 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    // ====================================

    return result;
}

//////////////////////////////////////// POW_F32 //////////////////////////////////////////////////
float64 pow_fast_f32(float64 base, float64 exp)
{
    /*

    The starting point is an algorithm a^b = pow2(b*log2(a))

    The problem with this algorithm is the accuracy, limited by
    the format itself. Example:

    100^3 = 1000000

    float log2(100) = 0x40D49A78
    pow2(3*log2(100))        = 999999.7 (0x497423FB) (-5ulp)
    pow2(3*(log2(100)+1ulp)) = 10000001 (0x49742414) (+16ulp)

    Both fp32 approximation of log2(100) nor next neighboring value
    used as an argument of pow2 cannot yield the right result, 1000000.
    It is just impossible to find a fp32 value x so that pow2(x)=1000000.

    To overcome this problem, the logarithm is calculated with a better
    precision, so that p*log2(a) = res1+res2, where res2<=res1*2^(-23), so that
    res1 and res2 together exceeds the range of 23 mantissas.

    Having these 2 numbers, the result is calculated as

    pow2(res1+res2) = pow2(res1)*(1+log(2)*res2)

    The second part comes from Taylor series, which is sufficient here.



    The full algorithm is calculated in following steps:

    Step 1:
         Any FP number is kept in a form x=2^N*m, where m is between 1 and 2
         Thus, log2(x)=N+log2(m). This operation requires extracting exponent
    and mantissa from the number.

    Step 2:
         The old trick is, instead of calculating log between 1 and 2,
         calculate it between 1/sqrt(2) and sqrt(2). Then, the central
         point of the polynomial expansion is 1 instead of 1.5

         All m (mantissa) larger than sqrt(2) are mapped into 0.707 -> 1
         range. Specifically, such mantissa values are filled with exponent 126,
         otherwise 127.

    Step 3:
         For accuracy reasons, the polynomial approximates (log(x+1)/x)-1
         Thus, from value obtained in step 2 a unity is subtracted.



    Step 4:
         Having log(x+1)/x-1, we must recover log(x+1). This is, however
         done using extended arithmetic. Every value is represented
         as x_hi and x_lo, so that x_hi+x_lo offers 46 instead of 23 mantissa
         bits.

         In step 4a: 1 is added to the result
         In step 4b: (x-1)*b (b is the second argument of pow) is calculated.
    Two "simple" fp 32 numbers yields a pair of hi and lo part. In step 4c: 4b
    is multiplied by 1.44 (1/log 2), to have log2 instead log In step 4d:
    (log(x+1)+1) is multiplied by (x*b),  extended number multiplication In step
    4e: N (step 1) is multiplied by b In step 4f : results of 4e and 4d are
    added

         Yes, this algorithm is complicated.

    Step 5:
         pow2 of what was in step4 calculated is calculated.

    Step 6:
         all specials are checked.

   We do not have to care about denormals
   Finally  it appeared, that our computational units units flush denormals to 0.*/

    /*************************************Step 1*********************************/

    int64 exponent = v_f32_extract_exp_b(base, 1);
    int64 mantissa = v_i32_and_b(*((int64 *)&base), 0x007fffff);

    /****************************Step 2*******************************************/

    int64 exp_126_or_127 =
        v_i32_sel_grt_u32_b(*((uint64 *)&mantissa), 0x003504f3, 126, 127);
    float64 argument = v_f32_form_fp_num_ie_b((char256)exp_126_or_127, 0, base, SW_EXP_IS_NUM);

    /****************************Step 3*******************************************/

    argument = v_f32_sub_b(argument, 1.0, SW_NO_NEG);

    float c0 = 6.662906615328978e-10;
    float c1 = -0.4999998832421357;
    float c2 = 0.3333330239630823;
    float c3 = -0.2500157096453624;
    float c4 = 0.20003206697520598;
    float c5 = -0.16610342185918298;
    float c6 = 0.14160720725029344;
    float c7 = -0.13212261586005078;
    float c8 = 0.13019154833424432;
    float c9 = -7.83082272733082e-2;

    float w1 = 1.4426950216293335;
    float w2 = 1.92596298909109e-8;

    float64 result = v_f32_mac_b(argument, c9, c8, (false) << 1);
    result = v_f32_mac_b(result, argument, c7, (false) << 1);
    result = v_f32_mac_b(result, argument, c6, (false) << 1);
    result = v_f32_mac_b(result, argument, c5, (false) << 1);
    result = v_f32_mac_b(result, argument, c4, (false) << 1);
    result = v_f32_mac_b(result, argument, c3, (false) << 1);
    result = v_f32_mac_b(result, argument, c2, (false) << 1);
    result = v_f32_mac_b(result, argument, c1, (false) << 1);
    result = v_f32_mac_b(result, argument, c0, (false) << 1);

    exponent = v_i32_sub_b(exponent, exp_126_or_127, SW_NO_NEG);
    float64 fexponent = v_convert_i32_to_f32_b(exponent, SW_RHNE);

    /****************************Step  4a*******************************************/
    float64 res_plus_1_h = v_f32_add_b(result, 1);
    //(1 - res_plus_1_h) + result;
    float64 res_plus_1_l = v_f32_sub_b(1.0, res_plus_1_h, SW_NO_NEG);
    res_plus_1_l = v_f32_add_b(res_plus_1_l, result);

    /****************************Step 4b*******************************************/
    float64 arg_times_b_h = argument * exp;
    float64 arg_times_b_l = v_f32_mac_b(exp, argument, arg_times_b_h, (true) << 1);

    /****************************Step 4c*******************************************/
    float64 tmp1_h = arg_times_b_h * w1;
    float64 tmp1_l = v_f32_mac_b(w1, arg_times_b_h, tmp1_h, (true) << 1);
    float64 tmp2_1 = v_f32_mac_b(w2, arg_times_b_h, tmp1_l, (true) << 1);
    float64 tmp2_2 = v_f32_mac_b(w1, arg_times_b_l, tmp2_1, (false) << 1);
    float64 z_h = v_f32_sub_b(tmp1_h, tmp2_2, SW_NO_NEG); //tmp1_h - tmp2_2;
    //(tmp1_h - z_h) - tmp2_2;
    float64 z_l = v_f32_sub_b(tmp1_h, z_h, SW_NO_NEG);
    z_l = v_f32_sub_b(z_l, tmp2_2, SW_NO_NEG);

    /****************************Step 4d*******************************************/

    float64 left1_h_ = res_plus_1_h * z_h;
    float64 left1_l_ = v_f32_mac_b(z_h, res_plus_1_h, left1_h_, (true) << 1);
    float64 left1_3a = v_f32_mac_b(z_l, res_plus_1_h, left1_l_, (true) << 1);
    float64 left1_3b = v_f32_mac_b(z_h, res_plus_1_l, left1_3a, (true) << 1);
    float64 left_h = v_f32_sub_b(left1_h_, left1_3b, SW_NO_NEG); //left1_h_ - left1_3b;
    //(left1_h_ - left_h) - left1_3b;
    float64 left_l = v_f32_sub_b(left1_h_, left_h, SW_NO_NEG);
    left_l = v_f32_sub_b(left_l, left1_3b, SW_NO_NEG);
    /****************************Step 4d*******************************************/

    float64 right_h = exp * fexponent;
    float64 right_l = v_f32_mac_b(fexponent, exp, right_h, (true) << 1);

    /****************************Step 4f*******************************************/

    float64 r = v_f32_add_b(right_h, left_h); //right_h + left_h;
    //(((right_h - r) + left_h) + left_l) - right_l;
    float64 s = v_f32_sub_b(right_h, r, SW_NO_NEG);
    s = v_f32_add_b(s, left_h);
    s = v_f32_add_b(s, left_l);
    s = v_f32_sub_b(s, right_l, SW_NO_NEG);
    float64 res1 = v_f32_add_b(r, s); //r + s;
    //(r - res1) + s;
    float64 res2 = v_f32_sub_b(r, res1, SW_NO_NEG);
    res2 = v_f32_add_b(res2, s);
    /*
    After 45 cycles we have high and low part of the logarithm.
    res1, and res2.

    Time for step 5

   */

    float64 exp_arg_int = v_f32_nearbyint_b(res1, SW_RHNE);
    float64 exp_arg_frac = res1 - exp_arg_int;

    float e0 = 0.999999999996072;
    float e1 = 0.6931471807715933;
    float e2 = 0.24022650769193007;
    float e3 = 5.5504096708578914e-2;
    float e4 = 9.618103173481352e-3;
    float e5 = 1.3335229931409013e-3;
    float e6 = 1.5436099684915775e-4;
    float e7 = 1.4593978816731232e-5;

    int64 output_exp = v_convert_f32_to_i32_b(exp_arg_int, SW_RD);
    output_exp = v_i32_sel_less_i32_b(output_exp, -126, -126, output_exp);

    result = v_f32_mac_b(exp_arg_frac, e7, e6, (false) << 1);
    result = v_f32_mac_b(result, exp_arg_frac, e5, (false) << 1);
    result = v_f32_mac_b(result, exp_arg_frac, e4, (false) << 1);
    result = v_f32_mac_b(result, exp_arg_frac, e3, (false) << 1);
    result = v_f32_mac_b(result, exp_arg_frac, e2, (false) << 1);
    result = v_f32_mac_b(result, exp_arg_frac, e1, (false) << 1);
    result = v_f32_mac_b(result, exp_arg_frac, e0, (false) << 1);

    output_exp = v_i32_shl_b(output_exp, 23);
    int64 result_i = v_i32_add_b(*((int64 *)&result), output_exp);

    float64 we1 = 0.6931471824645996;

    float64 hi = we1 * res2;

    float64 result2 = v_f32_mac_b(hi, *((float64 *)&result_i), *((float64 *)&result_i),
                                                                                    (false) << 1);
    /****************************Step 6*******************************************/

    /* all special cases we must care about :  */
#if 0 /* disabled by -frewrite-includes */
#if !defined(__gaudi2__) || defined (ENABLE_ALL_CHECKS_POW)// Temporary fix until LLVM-1709 is fixed
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 1425 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    // if (res1<=-126) -> result2 = 0;
    result2 = v_f32_sel_leq_f32_b(res1, -126, 0, result2);
#endif
# 1428 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    // if (a==1) ->result2=1;
    result2 = v_f32_sel_eq_f32_b(base, 1, 1, result2);

    // flip for integer negative arguments
    bool256 predAlessthanZero = from_bool64(v_f32_cmp_less_b(base, 0));

    float64 flooredB = v_f32_nearbyint_b(exp, SW_RD);

    bool256 predFlooredB = from_bool64(v_f32_cmp_eq_b(flooredB, exp));

    int64 expInt = v_convert_f32_to_i32_b(exp, SW_RD);

    int64 expIntCmpOne = v_i32_and_b(expInt, 1);

    bool256 predBCmpOne = from_bool64(v_i32_cmp_eq_b(expIntCmpOne, 1));

    bool256 predResult = v_i1_and_b(predAlessthanZero, predFlooredB);

    predResult = v_i1_and_b(predResult, predBCmpOne);

    result2 = v_f32_sub_vb(0, result2, 0, result2, to_bool64(predResult));


    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64 *)&nan_int);
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64 *)&plus_inf);
    //overflow case
    result2 = v_f32_sel_geq_f32_b(res1, 129, plus_inf_fp32, result2);
    //NaN special case
    result2 = v_f32_sel_grt_u32_b(*((uint64 *)&result2) & NAN_FP32, PLUS_INF_FP32, plus_inf_fp32,
                                                                                         result2);
    //when base < 0 and exp is fractional
    bool256 predFlooredexp = from_bool64(v_f32_cmp_neq_b(flooredB, exp));
    predFlooredexp = v_i1_and_b(predAlessthanZero, predFlooredexp);
    result2 = v_f32_mov_vb(nan_fp32, 0, result2, to_bool64(predFlooredexp));

    // all other corner cases are handled by
    // fp_calcl_special
    return result2;
}

float64 pow_f32(float64 base, float64 exp)
{

    float64 result = pow_fast_f32(base, exp); // 62

    // if exp = 1
    result = v_f32_sel_eq_f32_b(exp, 1.0f, base, result); // 64

    const uint64 flt_max = FLT_MAX;
    const float64 flt_max_fp32 = *((float64 *)&flt_max);
    const uint64 plus_inf = PLUS_INF_FP32;
    const float64 plus_inf_fp32 = *((float64 *)&plus_inf);

    float64 abs_base = v_f32_abs_b(base); // 65

    bool256 pred0 = from_bool64(v_f32_cmp_leq_b(exp, -flt_max_fp32)); // 67
    result = v_f32_sel_grt_f32_vb(abs_base, 1.0f, 0.0f, result, 0, result, to_bool64(pred0)); // 68
    result = v_f32_sel_less_f32_vb(abs_base, 1.0f, plus_inf_fp32, result, 0, result,
                                                                          to_bool64(pred0));  // 69

    bool256 pred1 = from_bool64(v_f32_cmp_geq_b(exp, flt_max_fp32)); // 70
    result = v_f32_sel_grt_f32_vb(abs_base, 1.0f, plus_inf_fp32, result, 0, result,
                                                                           to_bool64(pred1));  // 71
    result = v_f32_sel_less_f32_vb(abs_base, 1.0f, 0.0f, result, 0, result, to_bool64(pred1)); // 72

    bool256 pred2 = from_bool64(v_f32_cmp_less_b(base, -flt_max_fp32)); // 73
    result = v_f32_sel_grt_f32_vb(exp, 0.0f, plus_inf_fp32, result, 0, result, to_bool64(pred2));
    result = v_f32_sel_less_f32_vb(exp, 0.0f, 0.0f, result, 0, result, to_bool64(pred2));    // 75

    bool256 pred3 = from_bool64(v_f32_cmp_geq_b(base, flt_max_fp32));                        // 76
    result = v_f32_sel_grt_f32_vb(exp, 1.0f, plus_inf_fp32, result, 0, result, to_bool64(pred3));


#if 0 /* disabled by -frewrite-includes */
#if !defined(__goya__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 1504 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
    float64 fclass_x = v_f32_fclass_b(base); // 65
    float64 fclass_y = v_f32_fclass_b(exp);  // 66
    result =
        v_f32_calc_fp_special_b(fclass_x, fclass_y, e_fp_pow, result); // 67
#else
# 1509 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    const uint64 nan_int = NAN_FP32;
    const float64 nan_fp32 = *((float64 *)&nan_int);

    // handling case when base = 0
    bool256 pred5 = from_bool64(v_f32_cmp_eq_b(base, 0)); // 76
    result = v_f32_sel_grt_f32_vb(exp, 0.0f, 0.0f, result, 0, result, to_bool64(pred5)); // 78
    result = v_f32_sel_less_f32_vb(exp, 0.0f, plus_inf_fp32, result, 0, result,
                                                                     to_bool64(pred5)); // 79

    // handling case when base = inf
    bool256 pred6 = from_bool64(v_f32_cmp_eq_b(base, plus_inf_fp32)); // 76
    result = v_f32_sel_grt_f32_vb(exp, 0.0f, plus_inf_fp32, result, 0, result,
                                                                     to_bool64(pred6)); // 78
    result =
        v_f32_sel_less_f32_vb(exp, 0.0f, 0.0f, result, 0, result, to_bool64(pred6));

    // handling case when base = nan
    result = v_f32_sel_grt_u32_b(*((uint64 *)&base) & NAN_FP32, PLUS_INF_FP32, nan_fp32, result);
    // handling case when exp = nan
    result = v_f32_sel_grt_u32_b(*((uint64 *)&exp) & NAN_FP32, PLUS_INF_FP32, nan_fp32, result);


#endif
# 1533 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    return result;
}

// quantized versions of special function is available only on Goya
#ifdef __goya__
//////////////////////////////////////// EXP_I8 //////////////////////////////////////////////////
// Maximal Input exponentX is -4
// valid input range (-8,0)
// Result is in under quantization factor of -7. Range (0,1)
inline char256 exp_i8(char256 x, char shift)
{
    char256        x00_abs;
    char256        x00_shr;
    char256        x00_and;
    char256_pair_t y00 = {0};

    char intervalShift     = -3 - shift;
    char intervalStartMask = ((1 << intervalShift) - 1);

    // char256 norm_shift = (-7 + shift) - (-7);
    char256 norm_shift = shift;

    x00_abs = v_i8_abs_b(x);
    x00_shr = v_i8_shr_b(x00_abs, intervalShift);
    x00_and = v_i8_and_b(x00_abs, intervalStartMask);

    y00 = v_i8_lookup_c1c2(*(uchar256*)&x00_shr, 40, SW_BV8_0, y00);
    y00 = v_i8_lookup_c1c2(*(uchar256*)&x00_shr, 40, SW_BV8_1, y00);
    y00 = v_i8_lookup_c1c2(*(uchar256*)&x00_shr, 40, SW_BV8_2, y00);
    y00 = v_i8_lookup_c1c2(*(uchar256*)&x00_shr, 40, SW_BV8_3, y00);

    y00.v1 = v_i8_msac_b(y00.v2, x00_and, norm_shift, 0, SW_NORMALIZE_AB | 2, y00.v1);

    return y00.v1;
}

inline short128 exp_i16_128_entries(short128 x, short shift)
{
    short128        x00_abs;
    short128        x00_shr;
    short128        x00_and;
    short128_pair_t y00 = {0};

    short intervalShift     = -2 - shift;
    short intervalStartMask = ((1 << intervalShift) - 1);

    // Exponent normalization ( (-16 + -11) - (-15)) = 15-27 = -12
    short shift_lp = -1 + shift;

    // Exponent normalization ( (-15 + -11) - (-15)) = 15-26 = -11
    short shift_hp = shift;

    x00_abs = v_i16_abs_b(x);
    x00_shr = v_i16_shr_b(x00_abs, intervalShift);
    x00_and = v_i16_and_b(x00_abs, intervalStartMask);

    y00 = v_i16_lookup_c1c2(*(ushort128*)&x00_shr, e_i16_exp_nep_128, SW_BV16_LOW, y00);
    y00 = v_i16_lookup_c1c2(*(ushort128*)&x00_shr, e_i16_exp_nep_128, SW_BV16_HIGH, y00);

    y00.v1 = v_i16_msac_b(y00.v2, x00_and, shift_lp, 0, SW_NORMALIZE_AB | 2, y00.v1);

    y00.v2 = v_i16_lookup_c0(*(ushort128*)&x00_shr, e_i16_exp_nep_128, SW_BV16_LOW, y00.v2);
    y00.v2 =
        v_i16_lookup_c0(*(ushort128*)&x00_shr, e_i16_exp_nep_128, SW_BV16_HIGH, y00.v2);

    y00.v2 = v_i16_msac_b(y00.v1, x00_and, shift_hp, 0, SW_NORMALIZE_AB | 2, y00.v2);

    return y00.v2;
}

//////////////////////////////////////////////////GELU 16///////////////////////////////////////////
// Maximal input exponent is -13
// Result is under quantization factor of -13
inline short128 gelu_minus_relu_int16(short128 x, int expX, short intervalShift)
{
    // GELU_SHIFT_MAX
    short128        xAbs; // abs
    ushort128       xShr; // shift
    short128        xAnd; // and
    short128_pair_t y = {0};

    // qC2 = -16, qC1 = -16, qC0 = -17
    // const int qC2 = -16;
    const int qC1 = -16;
    const int qC0 = -17;

    // input scale down, to fit into LUT range of 64(*3) elements (power(2,6)),
    // E.g. s16bQ13 >> 9 = S7bQ4 == use all(except sign) upper 6 bits as indices to LUT

    unsigned short intervalStartMask = ((1 << intervalShift) - 1);

    xAbs = v_i16_abs_b(x);
    xShr = v_u16_shr_b(*(ushort128*)&xAbs, intervalShift);
    xAnd = v_i16_and_b(xAbs, intervalStartMask);

    // For C1 and C2
    y = v_i16_lookup_c1c2(*(ushort128*)&xShr, e_i16_gelu_minus_relu, SW_BV16_LOW, y);
    y = v_i16_lookup_c1c2(*(ushort128*)&xShr, e_i16_gelu_minus_relu, SW_BV16_HIGH, y);

    //  Exponent normalization:
    // (-16 + expX) - shiftLp = -16 ==> shiftLp = expX
    short shiftLp = expX;
    //  c2 *  x  +  c1
    y.v1 = v_i16_msac_b(y.v2, xAnd, shiftLp, 0, SW_NORMALIZE_AB | 2, y.v1);

    // C0
    y.v2 = v_i16_lookup_c0(*(ushort128*)&xShr, e_i16_gelu_minus_relu, SW_BV16_LOW, y.v2);
    y.v2 = v_i16_lookup_c0(*(ushort128*)&xShr, e_i16_gelu_minus_relu, SW_BV16_HIGH, y.v2);

    // Exponent normalization: (-16 + expX) - shiftHp = -17
    // shiftHp = -16 - expX + 17 = expX + 1
    const int preShiftHp = qC1 - qC0;
    short     shiftHp    = expX + preShiftHp;

    // ( (C2*x+C1), x, shift, 0, C0 ) => (C2 * x + C1) * x  + C0
    y.v2 = v_i16_msac_b(y.v1, xAnd, shiftHp, 0, SW_NORMALIZE_AB | 2, y.v2);

    return y.v2;
}

// Function call when input Q factor is less than Q13 (i.e. expX > -13)
inline short128 gelu_gt_m13_i16(short128 x,
                                int      expX,
                                int      expXminusY,
                                int      expXForGeluMinusRelu,
                                short    intervalShift,
                                int      fourQOfX)
{
    short128 input_for_gelu_minus_relu = 0;
    short128 reluAns                   = v_i16_max_b(x, 0);
    char     inputShift                = expX - expXForGeluMinusRelu;

    const int qC0 = -17;

    short128 xAbs = v_i16_abs_b(x);

    // since our approximation only till [-4,4), and only at higher Q than Q13, we can exceed our
    // range, we check at this condition we don't get out of range, and we reset the values in case
    // we did

    bool256 xAbsLtfourQOfX = from_bool128(v_i16_cmp_less_b(xAbs, fourQOfX));
    input_for_gelu_minus_relu =
        v_i16_ash_vb(x, inputShift, 2, input_for_gelu_minus_relu, to_bool128(xAbsLtfourQOfX));

    xAbs = gelu_minus_relu_int16(input_for_gelu_minus_relu, expXForGeluMinusRelu, intervalShift);

    //(geluMinusRelu + relu)
    // Exponent normalization: -17 + 0 - finalShift = expX ==> finalShift = -17 - expX
    short finalShift = qC0 - expX;

    //(C2 * x + C1) * x + C0 , 1 , expX, 0, reluAns) = ((C2 * x + C1) * x + C0) * 1 + reluAns
    reluAns = v_i16_msac_b(xAbs, 1, finalShift, 0, SW_NORMALIZE_AB | 2, reluAns);

    reluAns = v_i16_ash_b(reluAns, expXminusY, 2);

    return reluAns;
}

// Function call when input Q factor is greater than or equal to Q13, but less than or equal to Q17
// (i.e. expX <= -13 && expX >= -17)
inline short128 gelu_geq_m17_leq_m13_i16(short128 x, int expX, int expXminusY, short intervalShift)
{
    short128 input_for_gelu_minus_relu = x;
    short128 reluAns                   = v_i16_max_b(x, 0);

    const int qC0 = -17;

    short128 gelu_minus_relu_ans;

    gelu_minus_relu_ans = gelu_minus_relu_int16(input_for_gelu_minus_relu, expX, intervalShift);

    //(geluMinusRelu + relu)
    // Exponent normalization: -17 + 0 - finalShift = expX ==> finalShift = -17 - expX
    short finalShift = qC0 - expX;

    //(C2 * x + C1) * x + C0 , 1 , expX, 0, reluAns) = ((C2 * x + C1) * x + C0) * 1 + reluAns
    reluAns = v_i16_msac_b(gelu_minus_relu_ans, 1, finalShift, 0, SW_NORMALIZE_AB | 2, reluAns);

    reluAns = v_i16_ash_b(reluAns, expXminusY, 2);

    return reluAns;
}

// Function call when input Q factor is greater than Q17
// (i.e. expX < -17)
inline short128 gelu_lt_m17_i16(short128 x, int expX, int expC0minusY, short intervalShift)
{
    short128 input_for_gelu_minus_relu = x;
    short128 reluAns                   = v_i16_max_b(x, 0);

    const int qC0 = -17;

    short128 gelu_minus_relu_ans;

    gelu_minus_relu_ans = gelu_minus_relu_int16(input_for_gelu_minus_relu, expX, intervalShift);

    //(geluMinusRelu + relu)
    // Exponent normalization: -17 + 0 - finalShift = expX ==> finalShift = -17 - expX
    short finalShift = expX - qC0;

    //(C2 * x + C1) * x + C0 , 1 , expX, 0, reluAns) = ((C2 * x + C1) * x + C0) * 1 + reluAns
    reluAns = v_i16_msac_b(reluAns, 1, finalShift, 0, SW_NORMALIZE_AB | 2, gelu_minus_relu_ans);

    reluAns = v_i16_ash_b(reluAns, expC0minusY, 2);

    return reluAns;
}
#endif //#ifdef __goya__
# 1742 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__goya2__) || defined(__gaudi2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 1744 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
//////////////////////////////////////// EXP_I16 //////////////////////////////////////////////////
// Maximal input exponentX is -11
// valid input range (-16,0)
// Result is in under quantization factor of -15. Range (0,1)
inline short128 exp_i16(short128 x, short shift)
{
    short128        x00_abs;
    short128        x00_shr;
    short128        x00_and;
    short128_pair_t y00 = {0};

    short intervalShift     = -2 - shift;
    short intervalStartMask = ((1 << intervalShift) - 1);

    // qC2 = -16 , qC1 =  -15, qc0 = -15

    // Exponent normalization ( (-16 + -11) - (-15)) = 15 - 27 = -12
    short shift_lp = -1 + shift;

    // Exponent normalization ( (-15 + -11) - (-15)) = 15 - 26 = -11
    short shift_hp = shift;

    //(C2 * x + C1) * x  + C0
    x00_abs = v_i16_abs_b(x);
    x00_shr = v_i16_shr_b(x00_abs, intervalShift);
    x00_and = v_i16_and_b(x00_abs, intervalStartMask);

    y00 = v_i16_lookup_coeff_c1c2_v(x00_shr, y00, c1c2_fid_exp);
    y00.v1 = v_i16_msac_b(y00.v2, x00_and, shift_lp, 0, SW_NORMALIZE_AB | 2, y00.v1);

    y00.v2 = v_i16_lookup_coeff_c0_v(x00_shr, y00.v2, c0_fid_exp);
    y00.v2 = v_i16_msac_b(y00.v1, x00_and, shift_hp, 0, SW_NORMALIZE_AB | 2, y00.v2);

    return y00.v2;
}
///////////////////////////////////// reciprocal_i16 ///////////////////////////////////////////////
inline short128 reciprocal_i16(short128 x, short expX)
{
    short           shift = expX;
    short128        x00_shr;
    short128        x00_and;
    short128_pair_t y00           = {0};
    bool256         bRangeReduced = {0};

    short fourFlex         = 4 << (-expX);
    short fourFlexMinusOne = fourFlex - 1;

    short          intervalShift     = -4 - expX;
    unsigned short intervalStartMask = (1 << intervalShift) - 1;

    // if (x >= fourFlex)  // 4 << (-expX)
    //     x = x >> 2;
    char cmp_pred = ((-expX) < 13); // if exp >=  13, we get overflow,
                                    // so need to avoid this situations
    bRangeReduced =
                from_bool128(v_i16_cmp_geq_b(x, fourFlex, 0, to_bool128(bRangeReduced), cmp_pred));

    x = v_i16_ash_vb(x, -2, 2, x, to_bool128(bRangeReduced));
    x = v_i16_min_vb(x, fourFlexMinusOne, 0, x, to_bool128(bRangeReduced));

    x00_shr = v_i16_shr_b(x, intervalShift);
    x00_and = v_i16_and_b(x, intervalStartMask);

    y00 = v_i16_lookup_coeff_c1c2_v(x00_shr, y00, c1c2_fid_rcp);
    y00.v1 = v_i16_msac_b(y00.v2, x00_and, shift, 0, SW_NORMALIZE_AB | 2, y00.v1);

    y00.v2 = v_i16_lookup_coeff_c0_v(x00_shr, y00.v2, c0_fid_rcp);
    y00.v2 = v_i16_msac_b(y00.v1, x00_and, shift, 0, SW_NORMALIZE_AB | 2, y00.v2);
    y00.v2 = v_i16_ash_vb(y00.v2, -2, 2, y00.v2, to_bool128(bRangeReduced));

    return y00.v2;
}

//////////////////////////////////////// SIGMOID_I16 //////////////////////////////////////////////
// Maximal input exponentX is expected to be (-12)
// Valid input range (-8,8)
// output exponent -15
inline short128
sigmoid_i16(short128 input,
            short    sigmoidIntervalShift,     // -3 - exponentX
            short    sigmoidIntervalStartMask, // (1 << tanhIntervalShift)-1
            char     sigmoidMSAC0diffABToC,    // exponentSigmoidC2 + exponentX - exponentSigmoidC1
            char     sigmoidMSAC1diffABToC     // exponentSigmoidC1 + exponentX - exponentSigmoidC0)
)
{
    short128 absX     = v_i16_abs_b(input);
    short128 interval = v_i16_shr_b(absX, sigmoidIntervalShift);

    absX &= sigmoidIntervalStartMask;
    short128_pair_t lookupResC1C2 = {0};
    short128 C0 = 0;

    lookupResC1C2 = v_i16_lookup_coeff_c1c2_v(interval, lookupResC1C2, c1c2_fid_sig);
    C0 = v_i16_lookup_coeff_c0_v(interval, C0, c0_fid_sig);

        short128 C1 = lookupResC1C2.v1;
    short128     C2 = lookupResC1C2.v2;
    // MSACs come here
    char256 shiftABToC = sigmoidMSAC0diffABToC;
    C1                 = v_i16_msac_b(C2, absX, shiftABToC, 0, SW_NORMALIZE_AB | 2, C1);
    shiftABToC         = sigmoidMSAC1diffABToC;
    C0                 = v_i16_msac_b(C1, absX, shiftABToC, 0, SW_NORMALIZE_AB | 2, C0, 0, 1);

    bool256 isNegative = from_bool128(v_i16_cmp_less_b(input, 0));

    ushort128 quantizedOnes = 32768;
    ushort128 ushortC0 = v_u16_sub_vb(quantizedOnes, *(ushort128*)&C0,
                                        0, *(ushort128*)&C0, to_bool128(isNegative));
    return *(short128*)&ushortC0;
}

//////////////////////////////////////// TANH_I16 /////////////////////////////////////////////////
// Maximal input exponentX is expected to be (-12)
// Valid input range (-8,8)
// Output exponent -15
inline short128 tanh_i16(short128 input,
                         short    tanhIntervalShift,     // -3 - exponentX
                         short    tanhIntervalStartMask, // (1 << tanhIntervalShift)-1
                         char     tanhMSAC0diffABToC, // exponentTanhC2 + exponentX - exponentTanhC1
                         char     tanhMSAC1diffABToC  // exponentTanhC1 + exponentX - exponentTanhC0
)
{
    short128 absX     = v_i16_abs_b(input);
    short128 interval = v_i16_shr_b(absX, tanhIntervalShift);

    absX &= tanhIntervalStartMask;

    short128_pair_t lookupResC1C2 = {0};
    short128 C0 = 0;
    lookupResC1C2 = v_i16_lookup_coeff_c1c2_v(interval, lookupResC1C2, c1c2_fid_tanh);
    C0 = v_i16_lookup_coeff_c0_v(interval, C0, c0_fid_tanh);

        short128 C1 = lookupResC1C2.v1;
    short128     C2 = lookupResC1C2.v2;
    // MSACs come here
    char256 shiftABToC = tanhMSAC0diffABToC;
    C1                 = v_i16_msac_b(C2, absX, shiftABToC, 0, SW_NORMALIZE_AB | 2, C1);
    shiftABToC         = tanhMSAC1diffABToC;
    C0                 = v_i16_msac_b(C1, absX, shiftABToC, 0, SW_NORMALIZE_AB | 2, C0, 0, 1);

    bool256 isNegative = from_bool128(v_i16_cmp_less_b(input, 0));

    short128 zerosVec = 0;

    // If the input was negative, subtract the result from zero, negating the result
    C0 = v_i16_sub_vb(zerosVec, C0, 0, C0, to_bool128(isNegative));

    return C0;
}

#endif //#if defined(__goya__) || defined(__goya2__)
# 1895 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
//////////////////////////////////////////////////GELU F32//////////////////////////////////////////
#if 0 /* disabled by -frewrite-includes */
#if defined(__goya__) || defined(__goya2__)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 1897 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
float64 v_gelu_f32(float64 x, float c0, float c1)
{
    // gelu(x) = 0.5x(1 + tanh(sqrt(2/pi)*(x + 0.044715x^3)))
    // = 0.5x + 0.5x * tanh(x(c0 + c1x^2)), where
    // c0 = sqrt(2/pi), c1 = sqrt(2/pi) * 0.044715
    // v = tanh(x(c0 + c1x^2))
    // w = 0.5x
    // so that gelu(x) = w*v + w

    // Compute v = tanh(x(c0 + c1x^2))
    // y = x^2
    // z = c1*y+c0
    // u = x * z
    // v = tanh(u)
    float64 y = v_f32_mul_b(x, x);
    float64 z = v_f32_mac_b(y, c1, c0, SW_NO_NEG);
    float64 u = v_f32_mul_b(x, z);
    float64 v = v_tanh_f32(u);

    // Compute w = 0.5x
    float64 w = v_f32_mul_b(x, 0.5);

    // Compute g = w*v + w
    float64 g = v_f32_mac_b(w, v, w, SW_NO_NEG);

    return g;
}

#endif //#ifdef __goya__
# 1926 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
//////////////////////////////////////// rcp_I16 /////////////////////////////////////////////////
// Maximal input exponentX is expected to be (-11)
// Valid input range (1,16)
// output exponent -15

///////////////////////////////////// EXP_CEPHES_F32 //////////////////////////////////////////////
float64 exp_cephes_fast_f32(float64 input)
{
    const float   ln_2_1 = 0.693359375;
    const float   ln_2_2 = -2.12194440e-4;
    const float   log2_e = 1.44269504088896341;
    const float64 c6     = .49998858346161135;
    const float64 c5     = 0.1666634537038239;
    const float64 c4     = 4.191878872870153e-2;
    const float64 c3     = 8.380148765026943e-3;

    float64 z = 0.5;
    z         = v_f32_mac_b(input, log2_e, z, (false) << 1);

    z = v_f32_nearbyint_b(z, SW_RD);

    float64 x_reduced = input;
    x_reduced         = v_f32_mac_b(z, ln_2_1, x_reduced, (true) << 1);
    x_reduced         = v_f32_mac_b(z, ln_2_2, x_reduced, (true) << 1);

    float64 result;
    float64 x_plus1 = 1.0;
    result          = v_f32_mac_b(x_reduced, c3, c4, (false) << 1);
    result          = v_f32_mac_b(result, x_reduced, c5, (false) << 1);
    result          = v_f32_mac_b(result, x_reduced, c6, (false) << 1);
    result          = v_f32_mac_b(result, x_reduced, x_plus1, (false) << 1);
    result          = v_f32_mac_b(result, x_reduced, x_plus1, (false) << 1);

    // x_plus1 = v_f32_add_b(x_reduced, x_plus1);
    // result = v_f32_mac_b(result, sqr_x, x_plus1, (false) << 1);

    int64 res_i32 = *(int64*)&result;

    int64 z_i32 = v_convert_f32_to_i32_b(z, SW_RD);
    z_i32       = v_i32_shl_b(z_i32, 23);
    res_i32     = v_i32_add_b(res_i32, z_i32);

    result = *(float64*)&res_i32;

    return result;
}

float64 exp_cephes_f32(float64 input)
{
    float64 result = exp_cephes_fast_f32(input);
    // ====================================
    //  Processing special values: spec.exp values, +-inf, nan

    const float64 exp_lower = -87.336;
    const float64 exp_upper = 88.722;
    const int64   plus_inf  = PLUS_INF_FP32;

    result = v_f32_sel_leq_f32_b(input, exp_lower, 0.0f, result);
    result = v_f32_sel_geq_f32_b(input, exp_upper, *((float64*)&plus_inf), result);
    result = v_f32_sel_grt_u32_b(*((uint64*)&input) & NAN_FP32, PLUS_INF_FP32, input, result);
    // ====================================

    return result;
}

//////////////////////////////////////// SIGMOID_F32 //////////////////////////////////////////////
inline float64 sigmoid_f32(float64 input)
{ // sigmoid(x) = 0.5 * (tanh(0.5*x)+1) instead of (div_f32(1.0, (1.0 + exp_cephes_f32(-input))));
    float64 x   = v_f32_mul_b(input, 0.5f); // 1
    float64 res = 0.5f;
    x           = tanh_f32(x);                                // 17
    res         = v_f32_mac_b(x, 0.5f, res, SW_NO_NEG); // 18

    return res;
}

///////////////////////////////////// ASIN CEPHES F32 /////////////////////////////////////////////
float64 asin_cephes_f32(float64 input)
{
    float64 x, abs_x;
    float64 z = 0, result = 0;

    uint64  nan_int  = NAN_FP32;
    float64 nan_fp32 = *((float64*)&nan_int);

    const float64 c1    = 4.2163199048E-2;
    const float64 c2    = 2.4181311049E-2;
    const float64 c3    = 4.5470025998E-2;
    const float64 c4    = 7.4953002686E-2;
    const float64 c5    = 1.6666752422E-1;
    const float64 PIO2F = 1.5707963267948966192;

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0));

    abs_x = v_f32_abs_b(input);

    bool256 lt_one  = from_bool64(v_f32_cmp_leq_b(abs_x, 1));
    bool256 gt_half = from_bool64(v_f32_cmp_grt_b(abs_x, 0.5));

    // Predicate is set for elements > 0.5 and <= 1.0
    bool256 pred0 = v_i1_and_b(lt_one, gt_half);

    bool256 lt_half      = from_bool64(v_f32_cmp_leq_b(abs_x, 0.5));
    bool256 gt_min_const = from_bool64(v_f32_cmp_geq_b(abs_x, 1.0e-4));

    // Predicate is set for elements >= 1.0e-4 and <= 0.5
    bool256 pred1 = v_i1_and_b(lt_half, gt_min_const);

    bool256 ele_in_range = v_i1_or_b(pred0, pred1);
    bool256 ele_lt_zero  = v_i1_and_b(ele_in_range, lt_zero);

    // 0.5 * (1.0 - a);
    z = v_f32_mov_vb(0.5, 0, z, to_bool64(pred0));
    z = v_f32_mac_vb(abs_x, 0.5, z, (true) << 1, to_bool64(pred0));
    x = sqrt_f32(z);

    x = v_f32_mov_vb(abs_x, 0, x, to_bool64(pred1));
    z = v_f32_mul_vb(x, x, 0, z, to_bool64(pred1));

    result        = v_f32_mac_b(c1, z, c2);
    result        = v_f32_mac_b(result, z, c3);
    result        = v_f32_mac_b(result, z, c4);
    result        = v_f32_mac_b(result, z, c5);
    float64 temp0 = v_f32_mul_b(z, x);
    result        = v_f32_mac_b(result, temp0, x);

    result = v_f32_add_vb(result, result, 0, result, to_bool64(pred0));
    result = v_f32_sub_vb(PIO2F, result, 0, result, to_bool64(pred0));

    // sign < 0
    result = v_f32_mul_vb(result, -1, 0, result, to_bool64(ele_lt_zero));

    // abs(input) > 1.0
    result = v_f32_mov_vb(nan_fp32, 0, result, to_bool64(lt_one), 1);

    // abs(input) < 1.0e-4
    result = v_f32_mov_vb(input, 0, result, to_bool64(gt_min_const), 1);

    return result;
}

///////////////////////////////////// ACOS CEPHES F32 /////////////////////////////////////////////
float64 acos_cephes_f32(float64 input)
{
    float64     x, acc = 0, scale_const = -2;
    const float PIF   = 3.141592653589793238;
    const float PIO2F = 1.5707963267948966192;

    float64 abs_x = v_f32_abs_b(input);

    bool256 leq_one = from_bool64(v_f32_cmp_leq_b(abs_x, 1));
    bool256 gt_half = from_bool64(v_f32_cmp_grt_b(abs_x, 0.5));

    // Predicate is set if abs(input) is > 0.5 and <= 1.0
    bool256 pred0 = v_i1_and_b(leq_one, gt_half);

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0));
    // Predicate is set if input element is < -0.5
    bool256 pred1 = v_i1_and_b(pred0, lt_zero);

    // Calculate 0.5 * (1.0 - x) when 0.5 < abs(input) <= 1.0
    x = v_f32_mov_vb(0.5, 0, abs_x, to_bool64(pred0));
    x = v_f32_mac_vb(abs_x, 0.5, x, (true) << 1, to_bool64(pred0));

    x = sqrt_f32(x);
    x = v_f32_mov_vb(input, 0, x, to_bool64(gt_half), 1);

    // Call Arcsin implementation
    x = asin_cephes_f32(x);

    acc = v_f32_mov_vb(PIF, 0, acc, to_bool64(pred1));
    acc = v_f32_mov_vb(PIO2F, 0, acc, to_bool64(gt_half), 1);

    scale_const = v_f32_mov_vb(1, 0, scale_const, to_bool64(gt_half), 1);
    scale_const = v_f32_mov_vb(2, 0, scale_const, to_bool64(pred1));

    acc = v_f32_mac_b(scale_const, x, acc, (true) << 1);

    const uint64  nan_int  = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);
    acc                    = v_f32_mov_vb(nan_fp32, 0, acc, to_bool64(leq_one), 1);
    return acc;
}

///////////////////////////////////// ATAN_CEPHES_F32 /////////////////////////////////////////////

float64 atan_cephes_f32(float64 input)
{
    const float PI_2      = 1.5707963267948966192; // pi/2
    const float PI_4      = 0.7853981633974483096; // pi/4
    const float TAN_3PI_8 = 2.414213562373095;     // tan(3pi/8)
    const float TAN_PI_8  = 0.4142135623730950;    // tan(pi/8)

    const float C1 = 8.05374449538e-2;
    const float C2 = -1.38776856032e-1;
    const float C3 = 1.99777106478e-1;
    const float C4 = -3.33329491539e-1;

    float64 y, res;

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0.0));
    input           = v_f32_abs_b(input);

    // if input > TAN_PI_8
    float64 minus_one = v_f32_sub_b(input, 1.0);
    float64 plus_one  = v_f32_add_b(input, 1.0);
    float64 div_res   = div_f32(minus_one, plus_one);

    y   = v_f32_sel_grt_f32_b(input, TAN_PI_8, PI_4, 0);
    res = v_f32_sel_grt_f32_b(input, TAN_PI_8, div_res, input);

    // if input > TAN_3PI_8
    float64 neg_one = -1.0;
    div_res         = div_f32(neg_one, input);

    y     = v_f32_sel_grt_f32_b(input, TAN_3PI_8, PI_2, y);
    input = v_f32_sel_grt_f32_b(input, TAN_3PI_8, div_res, res);

    float64 z = v_f32_mul_b(input, input);
    res       = v_f32_mac_b(C1, z, C2);
    res       = v_f32_mac_b(res, z, C3);
    res       = v_f32_mac_b(res, z, C4);
    res       = v_f32_mul_b(res, input);
    res       = v_f32_mac_b(res, z, input);

    y = v_f32_add_b(res, y);

    // if input < 0 -> y = -y
    y = v_f32_sub_vb(y, 0.0, 2, y, to_bool64(lt_zero));

    return y;
}

///////////////////////////////////// TAN_CEPHES_F32 /////////////////////////////////////////////

float64 tan_cephes_f32(float64 input)
{
    const float DP1       = -0.78515625;
    const float DP2       = -2.4187564849853515625e-4;
    const float DP3       = -3.77489497744594108e-8;
    const float FOPI      = 1.27323954473516; /* 4/pi */
    const float lossth    = 8192.0;
    const float low_range = 1.0e-4;

    const float C1 = 9.38540185543E-3;
    const float C2 = 3.11992232697E-3;
    const float C3 = 2.44301354525E-2;
    const float C4 = 5.34112807005E-2;
    const float C5 = 1.33387994085E-1;
    const float C6 = 3.33331568548E-1;

    float64 y, z, sqr_z;
    int64   j, j_and_1, j_and_2;

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0.0));
    input           = v_f32_abs_b(input);

    float64 res = v_f32_mul_b(FOPI, input);
    y           = v_f32_nearbyint_b(res, 65536);

    // convert res f32 to i32 to perform bitwise operation
    j = v_convert_f32_to_i32_b(res, 65536);

    // if (j & 1)
    j_and_1     = v_i32_and_b(j, 1);
    bool256 j_1 = from_bool64(v_i32_cmp_eq_b(j_and_1, 1));
    j           = v_i32_add_vb(j, 1, 0, j, to_bool64(j_1));
    y           = v_f32_add_vb(y, 1, 0, y, to_bool64(j_1));

    z = v_f32_mac_b(DP1, y, input);
    z = v_f32_mac_b(DP2, y, z);
    z = v_f32_mac_b(DP3, y, z);

    sqr_z = v_f32_mul_b(z, z);

    bool256 leq_low = from_bool64(v_f32_cmp_leq_b(input, low_range));

    y = v_f32_mac_b(C1, sqr_z, C2);
    y = v_f32_mac_b(y, sqr_z, C3);
    y = v_f32_mac_b(y, sqr_z, C4);
    y = v_f32_mac_b(y, sqr_z, C5);
    y = v_f32_mac_b(y, sqr_z, C6);
    y = v_f32_mul_b(y, z);
    y = v_f32_mac_b(y, sqr_z, z);

    // if (input <= low_range), y = z
    y = v_f32_mov_vb(z, 0, y, to_bool64(leq_low));

    float64 neg_inv_y = div_fast_f32(-1.0, y);

    // if (j & 2)
    j_and_2     = v_i32_and_b(j, 2);
    bool256 j_2 = from_bool64(v_i32_cmp_eq_b(j_and_2, 2));
    y           = v_f32_mov_vb(neg_inv_y, 0, y, to_bool64(j_2));

    // if (input < 0), input = -input
    y = v_f32_sub_vb(y, 0.0, 2, y, to_bool64(lt_zero));

    // if (abs(input) > lossth), y = 0
    bool256 b_lossth = from_bool64(v_f32_cmp_grt_b(input, lossth));
    y                = v_f32_mov_vb(0.0, 0, y, to_bool64(b_lossth));

    return y;
}

///////////////////////////////////// ASINH_F32 /////////////////////////////////////////////
float64 asinh_f32(float64 input)
{
    float C1 = 2.0122003309E-2;
    float C2 = -4.2699340972E-2;
    float C3 = 7.4847586088E-2;
    float C4 = -1.6666288134E-1;

    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0.0));
    input           = v_f32_abs_b(input);

    float64 z = v_f32_mul_b(input, input);

    float64 res;
    res = v_f32_mac_b(C1, z, C2);
    res = v_f32_mac_b(res, z, C3);
    res = v_f32_mac_b(res, z, C4);
    res = v_f32_mul_b(res, input);
    res = v_f32_mac_b(res, z, input);

    z = v_f32_add_b(z, 1.0);
    z = sqrt_f32(z);
    z = v_f32_add_b(z, input);
    z = log_f32(z);

    bool256 geq_half = from_bool64(v_f32_cmp_geq_b(input, 0.5));
    res              = v_f32_mov_vb(z, 0, res, to_bool64(geq_half));

    // sign < 0
    res = v_f32_mul_vb(res, -1, 0, res, to_bool64(lt_zero));

    return res;
}

///////////////////////////////////// ACOSH_F32 /////////////////////////////////////////////
float64 acosh_f32(float64 input)
{
    float C1     = 1.7596881071E-3;
    float C2     = -7.5272886713E-3;
    float C3     = 2.6454905019E-2;
    float C4     = -1.1784741703E-1;
    float C5     = 1.4142135263E0;
    float LOGE2F = 0.693147180559945309;

    bool256 lt_one = from_bool64(v_f32_cmp_less_b(input, 1.0));

    float64 z = v_f32_sub_b(input, 1.0);

    bool256 geq_half  = from_bool64(v_f32_cmp_geq_b(z, 0.5));
    bool256 grt_limit = from_bool64(v_f32_cmp_grt_b(input, 1500));

    // if z < 0.5
    float64 res;
    res = v_f32_mac_b(C1, z, C2);
    res = v_f32_mac_b(res, z, C3);
    res = v_f32_mac_b(res, z, C4);
    res = v_f32_mac_b(res, z, C5);

    float64 sqrt_z = sqrt_fast_f32(z);

    res = v_f32_mul_b(res, sqrt_z);

    // if z >= 0.5
    float64 plus_one = v_f32_add_b(input, 1);
    z                = v_f32_mul_b(z, plus_one);
    z                = sqrt_f32(z);
    z                = v_f32_add_b(z, input);
    z                = log_f32(z);

    res = v_f32_mov_vb(z, 0, res, to_bool64(geq_half));

    // if input > 1500
    z = log_f32(input);
    z = v_f32_add_b(z, LOGE2F);

    res = v_f32_mov_vb(z, 0, res, to_bool64(grt_limit));

    const uint64  nan_int  = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    res = v_f32_mov_vb(nan_fp32, 0, res, to_bool64(lt_one));

    return res;
}

///////////////////////////////////// ATANH_F32 /////////////////////////////////////////////
float64 atanh_f32(float64 input)
{
    float C1 = 1.81740078349E-1;
    float C2 = 8.24370301058E-2;
    float C3 = 1.46691431730E-1;
    float C4 = 1.99782164500E-1;
    float C5 = 3.33337300303E-1;

    // if input < 0.5
    float64 z   = v_f32_mul_b(input, input);
    float64 res = v_f32_mac_b(C1, z, C2);
    res         = v_f32_mac_b(res, z, C3);
    res         = v_f32_mac_b(res, z, C4);
    res         = v_f32_mac_b(res, z, C5);
    res         = v_f32_mul_b(res, input);
    res         = v_f32_mac_b(res, z, input);

    // if input >= 0.5
    float64 one_plus  = v_f32_add_b(1, input);
    float64 one_minus = v_f32_sub_b(1, input);
    z                 = div_fast_f32(one_plus, one_minus);
    z                 = log_fast_f32(z);
    z                 = v_f32_mul_b(z, 0.5);

    float64 abs_in   = v_f32_abs_b(input);
    bool256 geq_half = from_bool64(v_f32_cmp_geq_b(abs_in, 0.5));
    res              = v_f32_mov_vb(z, 0, res, to_bool64(geq_half));

    const uint64  inf_int = PLUS_INF_FP32;
    const float64 inf_f   = *((float64*)&inf_int);
    const uint64  nan_int = NAN_FP32;
    const float64 nan_f   = *((float64*)&nan_int);

    bool256 geq_one = from_bool64(v_f32_cmp_geq_b(abs_in, 1.0));

    float64 gt_range = v_f32_sel_less_f32_b(input, 0, -inf_f, inf_f);
    gt_range         = v_f32_sel_grt_f32_b(abs_in, 1.0, nan_f, gt_range);
    res              = v_f32_mov_vb(gt_range, 0, res, to_bool64(geq_one));

    return res;
}

///////////////////////////////////// SINH_F32 /////////////////////////////////////////////
float64 sinh_cephes_f32(float64 input)
{
    const float maxlogf = 88.0;

    const float C1 = 2.03721912945E-4;
    const float C2 = 8.33028376239E-3;
    const float C3 = 1.66667160211E-1;

    float64 abs_val, temp_1, temp_2, result_1, result_2, final_res = 0.0f;
    bool256 lt_zero = from_bool64(v_f32_cmp_less_b(input, 0.0));

    abs_val        = v_f32_abs_b(input);
    bool256 gt_one = from_bool64(v_f32_cmp_grt_b(abs_val, 1.0));

    // abs_val > 1.0

    result_1 = exp_cephes_f32(abs_val);
    temp_1   = v_f32_mul_vb(result_1, 0.5, 0, result_1, to_bool64(gt_one));
    temp_2   = div_f32(0.5, result_1);
    result_1 = v_f32_sub_vb(temp_1, temp_2, 0, result_1, to_bool64(gt_one));

    bool256 pred0 = v_i1_and_b(gt_one, lt_zero);
    result_1      = v_f32_mul_vb(result_1, -1, 0, result_1, to_bool64(pred0));

    // abs_val <= 1.0

    temp_1   = v_f32_mul_b(input, input);
    result_2 = v_f32_mac_b(C1, temp_1, C2);
    result_2 = v_f32_mac_b(result_2, temp_1, C3);
    result_2 = v_f32_mul_b(result_2, temp_1);
    result_2 = v_f32_mac_b(result_2, input, input);

    final_res = v_f32_mov_vb(result_1, 0, final_res, to_bool64(gt_one));
    final_res = v_f32_mov_vb(result_2, 0, final_res, to_bool64(gt_one), 1);

    const int64 plus_inf  = PLUS_INF_FP32;
    const int64 minus_inf = MINUS_INF_FP32;

    // abs_val > maxlog

    bool256 gt_maxlog = from_bool64(v_f32_cmp_grt_b(abs_val, maxlogf));
    final_res = v_f32_sel_grt_f32_vb(input, 0.0, *((float64*)&plus_inf), *((float64*)&minus_inf),
                                     0, final_res, to_bool64(gt_maxlog));

    return final_res;
}
///////////////////////////////////// COSH_F32 /////////////////////////////////////////////
float64 cosh_cephes_f32(float64 input)
{
    const float maxlogf = 88.0;

    float64 recip, result;

    input = v_f32_abs_b(input);

    result = exp_cephes_f32(input);

    // z + ( 1 / z )

    recip  = reciprocal_f32(result);
    result = v_f32_add_b(result, recip);

    result = v_f32_mul_b(result, 0.5);

    // v_f32_abs_) > maxlog

    bool256 gt_maxlog = from_bool64(v_f32_cmp_grt_b(input, maxlogf));

    const int64 plus_inf = PLUS_INF_FP32;

    result = v_f32_mov_vb(*(float64*)&plus_inf, 0, result, to_bool64(gt_maxlog));

    return result;
}
///////////////////////////////////// MOD_F32 /////////////////////////////////////////////
float64 mod_fast_f32(float64 input_x, float64 input_y)
{
    float64 abs_x        = v_f32_abs_b(input_x);
    float64 abs_y        = v_f32_abs_b(input_y);
    float64 div_result   = div_f32(abs_x, abs_y);
    float64 round_result = v_f32_nearbyint_b(div_result, SW_RHNE);
    float64 mul_result   = v_f32_mul_b(round_result, abs_y);
    float64 result       = v_f32_sub_b(abs_x, mul_result);

    bool256 bpredv = from_bool64(v_f32_cmp_less_b(result, 0.0));
    result         = v_f32_add_vb(result, abs_y, 0, result, to_bool64(bpredv));
    result         = v_f32_form_fp_num_b(result, input_x, result, 0x0);
#ifdef REM_OP
    bool256 bpredv0 = from_bool64(v_f32_cmp_neq_b(result, 0.0));
    bool256 bpredv1 = from_bool64(v_f32_cmp_less_b(result, 0.0));
    bool256 bpredv2 = from_bool64(v_f32_cmp_less_b(input_y, 0.0));
    bool256 pred1   = v_i1_xor_b(bpredv1, bpredv2, 0, bpredv1, 1, 0);
    bool256 pred2   = v_i1_and_b(bpredv0, pred1, 0, bpredv1, 1, 0);
    result          = v_f32_add_vb(result, input_y, 0, result, to_bool64(pred2));
#endif
# 2455 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"

    return result;
}

float64 mod_f32(float64 input_x, float64 input_y)
{
    float64 result = mod_fast_f32(input_x, input_y);

    //  Processing special values: +-0, +-inf, nan
    const uint64  nan_int  = NAN_FP32;
    const float64 nan_fp32 = *((float64*)&nan_int);

    float64 abs_x = v_f32_abs_b(input_x);
    float64 abs_y = v_f32_abs_b(input_y);

    // x or y == nan return nan
    result = v_f32_sel_grt_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, result);
    result = v_f32_sel_grt_u32_b(*((uint64*)&abs_y), PLUS_INF_FP32, nan_fp32, result);
    // x == +-inf return nan
    result = v_f32_sel_eq_u32_b(*((uint64*)&abs_x), PLUS_INF_FP32, nan_fp32, result);
    // y == +-0 return nan
    result = v_f32_sel_eq_u32_b(*((uint64*)&abs_y), 0.0, nan_fp32, result);
    // y == +-inf and x is finite return x
    bool256 x_finite = from_bool64(v_u32_cmp_neq_b(*((uint64*)&abs_x), PLUS_INF_FP32));
    result           = v_f32_sel_eq_u32_vb(*((uint64*)&abs_y), PLUS_INF_FP32, input_x, result,
                                           0, result, to_bool64(x_finite));

    return result;
}

///////////////////////////////////// EXPM1_F32 /////////////////////////////////////////////
float64 expm1_f32(float64 input)
{
    const float boundval = 5e-1;

    const uint64  flt_min      = FLT_MIN;
    const float64 flt_min_fp32 = *((float64*)&flt_min);
    const float64 flt_minus_min_fp32 = -1.f*flt_min_fp32;
    float64       output = 0, temp1 = 0, temp2 = 0, temp3;

    // Checking boundary

    bool256 leq_bv = from_bool64(v_f32_cmp_leq_b(input, boundval));
    bool256 geq_bv = from_bool64(v_f32_cmp_geq_b(input, -boundval));
    bool256 pred0  = v_i1_and_b(leq_bv, geq_bv);

    // Cases within boundary

    output = v_f32_mul_vb(input, 0.5, 0, output, to_bool64(pred0));
    output = tanh_f32(output);

    temp1  = v_f32_mul_vb(output, 2, 0, temp1, to_bool64(pred0));
    temp2  = v_f32_sub_vb(1, output, 0, temp2, to_bool64(pred0));
    output = div_f32(temp1, temp2);

    // Cases outside boundary

    temp3  = exp_f32(input);
    output = v_f32_sub_vb(temp3, 1, 0, output, to_bool64(pred0), 1);

    // Special case of min float

    bool256 pred_fmin = from_bool64(v_f32_cmp_eq_b(input, flt_min_fp32));
    output            = v_f32_mov_vb(input, 0, output, to_bool64(pred_fmin));

    // Special case of minus min float

    bool256 pred_minus_fmin = from_bool64(v_f32_cmp_eq_b(input, flt_minus_min_fp32));
    output            = v_f32_mov_vb(input, 0, output, to_bool64(pred_minus_fmin));

    return output;
}

//////////////////////////////////////// GAMMA_F32 ////////////////////////////////////////////////
/********************polynomial evaluation function***************************/
float64 polevlf(float64 xval, float* coef, int N)
{
    float64 ans, x;
    float*  p;
    x   = xval;
    p   = coef;
    ans = *p++;
    for (int i = 0; i < N; i++)
    {
        float64 nxt_coeff = *p++;
        ans               = v_f32_mac_b(ans, x, nxt_coeff);
    }
    return (ans);
}
/**************polynomial evaluation function end****************************/

// coefficients of the polynomial approximating gamma(2+x), (0<x<1)

static float P[] = {
    1.536830450601906E-003,
    5.397581592950993E-003,
    4.130370201859976E-003,
    7.232307985516519E-002,
    8.203960091619193E-002,
    4.117857447645796E-001,
    4.227867745131584E-001,
    9.999999822945073E-001,
};

/*****************GAMMA FUNCTION STARTS*******************/
float64 gammaf(float64 xx)
{
    float64 p, q, x, z, nz;
    bool256 direction, pred_negative;
    bool256 sgngamf;

    x = xx;
    /* using 'leq' rather than 'less' because zero gets the same treatment as -ve
       integers*/
    pred_negative = from_bool64(v_f32_cmp_leq_b(x, 0.0));

    /******************If negative predicate****************/
    q                    = v_f32_abs_b(x);                                 // abs value
    int64 ptemp          = v_convert_f32_to_i32_b(q, SW_RD);        // flooring
    p                    = v_convert_i32_to_f32_b(ptemp, SW_RHNE); // p is the floored
    bool256 pred_integer = from_bool64(v_f32_cmp_eq_b(p, q));
    bool256 pred_neg_integer = v_i1_and_b(pred_negative, pred_integer);
    int64   odd = v_i32_and_b(ptemp, 1);   // is the part before the decimal even or odd?
    sgngamf     = from_bool64(v_i32_cmp_eq_b(odd, 0)); // if even, the gamma function sign is
                                             // -ve

    nz              = v_f32_sub_b(q, p); // nz = q - p
    bool256 pred_nz = from_bool64(v_f32_cmp_grt_b(nz, 0.5));
    p               = v_f32_add_b(p, 1.0);
    nz              = v_f32_sub_vb(q, p, 0, nz, to_bool64(pred_nz)); // if nz > 0.5 nz = q - (p + 1)

    nz = sin_fast_f32(v_f32_mul_b(nz, PIF));
    nz = v_f32_mul_b(q, nz); // nz = q * sin (pi*nz)

    nz = v_f32_abs_b(nz); // absolute value
    x  = q;
    /*********If negative predicate end**************************************/
    direction = from_bool64(v_f32_cmp_less_b(x, 2.0));
    z         = 1.0;

    // recurrence reduction for values  from 3-35
    for (int i = 0; i < 32; i++)
    {
        bool256 pred_geq_3 = from_bool64(v_f32_cmp_geq_b(x, 3.0));
        x                  = v_f32_add_vb(x, -1.0, 0, x, to_bool64(pred_geq_3));
        z                  = v_f32_mul_vb(z, x, 0, z, to_bool64(pred_geq_3));
    }
    // recurrence reduction for values  from 0-2
    for (int i = 0; i < 2; i++)
    {
        bool256 pred_less_thn_2 = from_bool64(v_f32_cmp_less_b(x, 2.0));
        z                       = v_f32_mul_vb(z, x, 0, z, to_bool64(pred_less_thn_2));
        x                       = v_f32_add_vb(x, 1.0, 0, x, to_bool64(pred_less_thn_2));
    }

    /* for values less than 2, we have to divide, not multiply for the recurrence
       relation*/
    float64 ztemp = reciprocal_fast_f32(z);
    z             = v_f32_mov_vb(ztemp, 0, z, to_bool64(direction));

    /* whole numbers get reduced to 2; their gammas have already been calculated
       since gamma(2) = 1*/
    bool256 pred_neq_2 = from_bool64(v_f32_cmp_neq_b(x, 2.0));
    x                  = v_f32_add_b(x, -2.0); // pol approx for gamma(x+2) , 0<x<1
    ztemp              = polevlf(x, P, 7);
    ztemp              = v_f32_mul_b(ztemp, z);
    z                  = v_f32_mov_vb(ztemp, 0, z, to_bool64(pred_neq_2));

    //-ve arguments reflection formula : gamma (-z) = pi/(sin(pi*-z)*(z)*gamma(z))
    ztemp = v_f32_mul_b(nz, z);
    ztemp = v_f32_mul_b(ztemp, PIINV);
    ztemp = reciprocal_fast_f32(ztemp);
    ztemp = v_f32_mul_vb(ztemp, -1.0, 0, ztemp, to_bool64(sgngamf));
    ztemp = v_f32_mov_vb(MAXNUMF, 0, ztemp, to_bool64(pred_neg_integer));

    z = v_f32_mov_vb(ztemp, 0, z, to_bool64(pred_negative));
    return (z);
}
/*****************GAMMA FUNCTION ENDS*********************/

//////////////////////////////////////// GAMMALN_F32 /////////////////////////////////////////////

// coefficients of the polynomial approximating gammaln, (0<x<1)

/* gammaln(x+2), -0.5 < x < 0.5 */
static float B[] = {6.055172732649237E-004,
                    -1.311620815545743E-003,
                    2.863437556468661E-003,
                    -7.366775108654962E-003,
                    2.058355474821512E-002,
                    -6.735323259371034E-002,
                    3.224669577325661E-001,
                    4.227843421859038E-001};

/* gammaln(x+1), -0.25 < x < 0.25 */
static float C[] = {1.369488127325832E-001,
                    -1.590086327657347E-001,
                    1.692415923504637E-001,
                    -2.067882815621965E-001,
                    2.705806208275915E-001,
                    -4.006931650563372E-001,
                    8.224670749082976E-001,
                    -5.772156501719101E-001};

/****************GAMMALN FUNCTION STARTS**********************/
float64 Gammalnf(float64 xx)
{
    float64 p, q, z, x, nz;
    bool256 direction, pred_negative;

    x = xx;
    /* using 'leq' rather than 'less' because zero gets the same treatment as -ve
       integers*/
    pred_negative = from_bool64(v_f32_cmp_leq_b(x, 0.0));

    /******************If negative predicate************************************/
    q           = v_f32_abs_b(x);                                         // abs value
    int64 ptemp = v_convert_f32_to_i32_b(q, SW_RD);                // flooring
    p           = v_convert_i32_to_f32_b(ptemp, SW_RHNE);         // p is the floored
    bool256 pred_neg_integer = from_bool64(v_f32_cmp_eq_b(p, q));                   // integer
    pred_neg_integer = v_i1_and_b(pred_negative, pred_neg_integer); // negative integer

    nz              = v_f32_sub_b(q, p); // nz = q - p
    bool256 pred_nz = from_bool64(v_f32_cmp_grt_b(nz, 0.5));
    p               = v_f32_add_b(p, 1.0);
    nz              = v_f32_sub_vb(p, q, 0, nz, to_bool64(pred_nz)); // if nz > 0.5 nz = (p + 1) - q

    nz = v_f32_mul_b(nz, PIF);
    nz = sin_fast_f32(nz);
    nz = v_f32_mul_b(q, nz); // nz = q * sin (pi*nz)

    nz = v_f32_mul_b(nz, PIINV);
    nz = log_fast_f32(nz);
    nz = v_f32_mul_b(nz, -1); // z = -logf( PIINV*z )

    x = q;
    /*****If negative predicate end**************************************/
    q             = LS2PI; // stirling formula for large arguments
    q             = v_f32_sub_b(q, x);
    float64 xtemp = v_f32_add_b(x, -0.5);
    xtemp         = v_f32_mul_b(xtemp, log_fast_f32(x));
    q             = v_f32_add_b(q, xtemp);

    bool256 pred_10000 = from_bool64(v_f32_cmp_less_b(x, 1.0e004));
    z                  = reciprocal_fast_f32(x);
    p                  = v_f32_mul_b(z, z); // polynomial error correction for 6.5 < x < 10000
    xtemp              = v_f32_mul_b(p, 6.789774945028216E-004);
    xtemp              = v_f32_add_b(xtemp, -2.769887652139868E-003);
    xtemp              = v_f32_mul_b(xtemp, p);
    xtemp              = v_f32_add_b(xtemp, 8.333316229807355E-002);
    xtemp              = v_f32_mul_b(xtemp, z);
    q                  = v_f32_add_vb(q, xtemp, 0, q, to_bool64(pred_10000));
    // x values less than 6.5
    bool256 pred_less_6point5 = from_bool64(v_f32_cmp_less_b(x, 6.5));
    direction                 = from_bool64(v_f32_cmp_less_b(x, 1.5));
    z                         = 1.0;
    xtemp                     = x;

    // 2.5 < x < 6.5
    for (int i = 0; i < 4; i++)
    {
        bool256 pred_grt_2point5 = from_bool64(v_f32_cmp_grt_b(xtemp, 2.5));
        xtemp                    = v_f32_add_vb(xtemp, -1.0, 0, xtemp, to_bool64(pred_grt_2point5));
        z                        = v_f32_mul_vb(z, xtemp, 0, z, to_bool64(pred_grt_2point5));
    }

    x = xtemp;

    bool256 pred_btw_1p25_1p5 = from_bool64(v_f32_cmp_geq_b(x, 1.25));
    pred_btw_1p25_1p5         = v_i1_and_b(pred_btw_1p25_1p5, direction); // 1.25-1.5
    bool256 flex_pred         = from_bool64(v_f32_cmp_geq_b(x, 0.75));
    flex_pred                 = v_i1_and_b(flex_pred, direction); // 0.75 - 1.5
    z                         = v_f32_mul_vb(z, x, 0, z, to_bool64(pred_btw_1p25_1p5));

                                // doing the subtraction for 0.75 to 1.5
    bool256 pred_less_0point75 = from_bool64(v_f32_cmp_less_b(x, 0.75));
    x                          = v_f32_add_vb(x, -1.0, 0, x, to_bool64(flex_pred));

    bool256 pred_btw_0p75_1p25 =
        v_i1_and_b(v_i1_not_b(pred_btw_1p25_1p5), flex_pred); // 0.75-1.25

    float64 ztemp = z;

    // 0 - 0.75
    for (int i = 0; i < 2; i++)
    {
        bool256 pred_less_thn_1p5 = from_bool64(v_f32_cmp_less_b(xtemp, 1.5));
        ztemp = v_f32_mul_vb(ztemp, xtemp, 0, ztemp, to_bool64(pred_less_thn_1p5));
        xtemp = v_f32_add_vb(xtemp, 1.0, 0, xtemp, to_bool64(pred_less_thn_1p5));
    }
    z = v_f32_mov_vb(ztemp, 0, z, to_bool64(pred_less_0point75));
    x = v_f32_mov_vb(xtemp, 0, x, to_bool64(pred_less_0point75));

    x = v_f32_add_vb(x, -2.0, 0, x, to_bool64(flex_pred), 1);

    // Polevlf using C for 0.75-1.25. B everywhere else
    p             = polevlf(x, B, 7);
    ztemp         = polevlf(x, C, 7);
    p             = v_f32_mov_vb(ztemp, 0, p, to_bool64(pred_btw_0p75_1p25));
    p             = v_f32_mul_b(x, p);
    float64 qtemp = log_fast_f32(z);

    qtemp = v_f32_mul_vb(qtemp, -1.0, 0, qtemp, to_bool64(direction));
    qtemp = v_f32_add_b(p, qtemp);
    q     = v_f32_mov_vb(qtemp, 0, q, to_bool64(pred_less_6point5));
    /* B and C polynomial approximations are only used for arguments with
     magnitude less than 6.5 if x's were all positive, we have the gammaln here*/

    // Handling negative Arguments

    ztemp = v_f32_sub_b(nz, q); //(nz = nz - w)
    ztemp = v_f32_mov_vb(
        MAXNUMF, 0, ztemp, to_bool64(pred_neg_integer));     // neg. integers and 0 have inf gammaln
    q = v_f32_mov_vb(ztemp, 0, q, to_bool64(pred_negative)); // moving only for negative arguments

    return q;
}
/*****GAMMALN FUNCTION ENDS************************************/


//////////////////////////////////////// LOG_SUM_EXP_F32 ///////////////////////////////////////////
float64 log_sum_exp_f32(float64 a, float64 b)
{
#define FLOAT_MIN      (-1.0/0.0) // -inf
    bool64 flag, aInf, bInf;
    float64 y, diffExp, tmp;

    // if (a > b)
    //     return a + log1p(exp(b - a));
    // else
    //     return b + log1p(exp(a - b));

    flag    = v_f32_cmp_grt_b(a, b);
    diffExp = v_f32_sub_b(a, b);
    diffExp = v_f32_sub_vb(b, a, 0, diffExp, flag, 0);
    tmp     = log1p_f32(exp_f32(diffExp));
    y       = v_f32_add_b(b, tmp);
    y       = v_f32_add_vb(a, tmp, 0, y, flag, 0);

    // if (a == -std::numeric_limits<float>::infinity())
    //     return b;
    // else if (b == -std::numeric_limits<float>::infinity())
    //     return a;

    aInf = v_f32_cmp_eq_b(a, FLOAT_MIN);
    y    = v_f32_mov_vb(b, 0, y, aInf, 0);

    bInf = v_f32_cmp_eq_b(b, FLOAT_MIN);
    y    = v_f32_mov_vb(a, 0, y, bInf, 0);

    return y;
}

// Remove all pre-processor definitions
#undef SIN_COS_CALC
#undef LOOKUP_AND_MAC
#undef false
#undef true
#undef UNIT_VAL
#undef SIGNIFICAND_MASK
#undef EXPONENT_MASK
#undef NAN_FP32
#undef PLUS_INF_FP32
#undef MINUS_INF_FP32
#undef EXP_LOWER
#undef EXP_UPPER
#undef FLT_MIN
#undef FLT_MAX
#undef M_UNIT_EXP

#endif // __SPECIAL_ALL_H__
# 2826 "/home/acherkasov/ws/tpc_kernels/kernels/common/special_all.h"
# 17 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h" 2


#define kTableSize (1 << 10)

#define CUBIC_MODE_GRID_LENGTH 4
#define LOAD_Y_COFF(coeffIdx) \
    yCoeff##coeffIdx = s_f32_ld_g(yCoeffAddr##coeffIdx); \
    yCoeffVec[coeffIdx] = yCoeff##coeffIdx; \

#define LOAD_X_COFF(coeffIdx) \
    xCoeff##coeffIdx = s_f32_ld_g(xCoeffAddr##coeffIdx); \
    xCoeffVec[coeffIdx] = xCoeff##coeffIdx; \

#ifdef FLOAT32
    #define VECTOR_ACC                  VECTOR
    #define CONVERT_UP(a)               a
    #define CONVERT_DOWN(a)             a
    #define v_ops_mac_v(acc_out, in1, in2) \
        acc_out = v_f32_mac_b(in1, in2, acc_out, SW_NO_NEG);

#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(BFLOAT16) || defined(FLOAT16) || defined(UINT16)
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 38 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
    #define VECTOR_ACC                  float128
    #define v_ops_mac_v(acc_out, in1, in2) \
        (acc_out).v1 = v_f32_mac_b(in1.v1, in2, (acc_out).v1, SW_NO_NEG); \
        (acc_out).v2 = v_f32_mac_b(in1.v2, in2, (acc_out).v2, SW_NO_NEG);

    #ifdef BFLOAT16
        #define CONVERT_UP(a)           v_convert_bf16_to_f32_all_b(a)
        #define CONVERT_DOWN(a)         v_convert_f32_to_bf16_all_b(a)
    
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(FLOAT16)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 47 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
        #define CONVERT_UP(a)           v_convert_f16_to_f32_all_b(a)
        #define CONVERT_DOWN(a)         v_convert_f32_to_f16_all_b(a)
    
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(UINT16)
#endif
#endif /* disabled by -frewrite-includes */
#elif 1 /* evaluated by -frewrite-includes */
# 50 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
        #define CONVERT_UP(a)           cast_u16_to_f32_lin_order_without_scale(a)
        #define CONVERT_DOWN(a)         cast_f32_to_u16_lin_order_without_scale(a.v1, a.v2)
    #endif
# 53 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"

#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(UINT8) || defined(INT8)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 55 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
    #define VECTOR_ACC                  float256
    #define v_ops_mac_v(acc_out, in1, in2) \
        (acc_out).v1 = v_f32_mac_b(in1.v1, in2, (acc_out).v1, SW_NO_NEG); \
        (acc_out).v2 = v_f32_mac_b(in1.v2, in2, (acc_out).v2, SW_NO_NEG); \
        (acc_out).v3 = v_f32_mac_b(in1.v3, in2, (acc_out).v3, SW_NO_NEG); \
        (acc_out).v4 = v_f32_mac_b(in1.v4, in2, (acc_out).v4, SW_NO_NEG);

    #ifdef INT8
        #define CONVERT_UP(a)     v_convert_i8_to_f32_all_b(a)
        #define CONVERT_DOWN(a)   v_convert_f32_to_i8_all_b(a)
    
#if 0 /* disabled by -frewrite-includes */
#if 0
#elif defined(UINT8)
#endif
#endif /* disabled by -frewrite-includes */
#elif 0 /* evaluated by -frewrite-includes */
# 66 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
        #define CONVERT_UP(a)     v_convert_u8_to_f32_all_b(a)
        #define CONVERT_DOWN(a)   cast_lin_f32_to_u8_swizzle_order((a).v1, (a).v2, (a).v3, (a).v4)
    #endif
# 69 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
#endif
# 70 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"

#define HALF_PIXEL_MODE                 (0)
#define PYTORCH_HALF_PIXEL_MODE         (1)
#define ALIGN_CORNERS_MODE              (2)
#define ASYMMETRIC_MODE                 (3)
#define TF_HALF_PIXEL_FOR_NN_MODE       (4)

void main(tensor ifm,
          tensor ofm,
#ifndef DYNAMIC_SHAPE
          tensor xCoeff,
          tensor yCoeff,
#endif
# 83 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
#if 0 /* disabled by -frewrite-includes */
#if defined (DYNAMIC_SHAPE) && defined (TF_COMPATIBLE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 84 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
          tensor cubicCoeffTable,
#endif
# 86 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
          tensor reciprocalLut,
          const int coordMode,
          const int minSizeValue,
          float coordScaleWidth,
          float coordBiasWidth,
          float coordScaleHeight,
          float coordBiasHeight,
          float coordScaleBatch,
          float coordBiasBatch,
          const bool isHalfPixelMode,
          const float cubicCoeffA,
          const bool excludeOutside)
{
    const int depth    = 0;
    const int width    = 1;
    const int height   = 2;
    const int batch    = 3;

    const int5 indexSpaceStart = get_index_space_offset();
    const int5 indexSpaceEnd   = get_index_space_size() + indexSpaceStart;

    const int depthStep   = VECTOR_SIZE;
    const int depthStart  = indexSpaceStart[depth] * depthStep;
    const int depthEnd    = indexSpaceEnd[depth] * depthStep;

    const int widthStep   = 1;
    const int widthStart  = indexSpaceStart[width] * widthStep;
    const int widthEnd    = indexSpaceEnd[width] * widthStep;

    const int heightStep  = 1;
    const int heightStart = indexSpaceStart[height] * heightStep;
    const int heightEnd   = indexSpaceEnd[height] * heightStep;
#ifndef  NCWH_LAYOUT
    const int batchStep   = 1;
    const int batchStart  = indexSpaceStart[batch] * batchStep;
    const int batchEnd    = indexSpaceEnd[batch] * batchStep;

    const int fifthDim = 4;

    const int  fifthDimStep      = 1;
    const int  fifthDimStart     = indexSpaceStart[fifthDim];
    const int  fifthDimEnd       = s_i32_max(indexSpaceEnd[fifthDim], 1);
#endif
# 129 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"



    const int inputWidthSize   = get_dim_size(ifm, width);
    const int inputHeightSize  = get_dim_size(ifm, height);
    const int inputWidthIdx    = inputWidthSize - 1;
    const int inputHeightIdx   = inputHeightSize - 1;
    const int outputWidthSize  = get_dim_size(ofm, width);
    const int outputHeightSize = get_dim_size(ofm, height);

    if (coordMode == ALIGN_CORNERS_MODE)
    {
        int5 lutCoords  = {outputWidthSize - minSizeValue};
        float recip     = s_f32_ld_g(gen_addr(lutCoords, reciprocalLut));
        coordScaleWidth = (float)inputWidthIdx * recip;

        lutCoords[0]     = outputHeightSize - minSizeValue;
        recip            = s_f32_ld_g(gen_addr(lutCoords, reciprocalLut));
        coordScaleHeight = (float)inputHeightIdx * recip;
    }

    if (coordMode == PYTORCH_HALF_PIXEL_MODE/* || coordMode == ALIGN_CORNERS_MODE*/)
    {
        coordScaleWidth  = (outputWidthSize  == 1) ? 0.f : coordScaleWidth;
        coordBiasWidth   = (outputWidthSize  == 1) ? 0.f : coordBiasWidth;
        coordScaleHeight = (outputHeightSize == 1) ? 0.f : coordScaleHeight;
        coordBiasHeight  = (outputHeightSize == 1) ? 0.f : coordBiasHeight;
    }

    int5 ifmCoords= {0}, ofmCoords = {0};

    float xIdxFrac, yIdxFrac, xStep, yStep;
#if 0 /* disabled by -frewrite-includes */
#if !defined(DYNAMIC_SHAPE) || defined (TF_COMPATIBLE)
#endif
#endif /* disabled by -frewrite-includes */
#if 1 /* evaluated by -frewrite-includes */
# 162 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
    float yCoeff0, yCoeff1, yCoeff2, yCoeff3, xCoeff0, xCoeff1, xCoeff2, xCoeff3;
#endif
# 164 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
#if 0 /* disabled by -frewrite-includes */
#if defined (DYNAMIC_SHAPE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 165 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
    float64 tmp;
#endif
# 167 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
    float64 yCoeffVec[CUBIC_MODE_GRID_LENGTH], xCoeffVec[CUBIC_MODE_GRID_LENGTH];
    int yInt, xInt;
    VECTOR inputData;

    float beta = 0.f;
    beta = s_f32_mov(0.5, 0, beta, isHalfPixelMode);

#ifndef  NCWH_LAYOUT
    #pragma loop_taken
    for (int f = fifthDimStart; f < fifthDimEnd; f += fifthDimStep)
    {
        ofmCoords[fifthDim] = f;
        ifmCoords[fifthDim] = f;
#endif
# 181 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
        #pragma loop_taken
        for (int d = depthStart; d < depthEnd; d += depthStep)
        {
            ofmCoords[depth] = d;
            ifmCoords[depth] = d;
    #ifndef  NCWH_LAYOUT
            #pragma loop_taken
            for (int b = batchStart; b < batchEnd; b += batchStep)
            {
                    ofmCoords[batch] = b;
                    ifmCoords[batch] = b;
    #else
# 193 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                    ofmCoords[batch] = 0;
                    ifmCoords[batch] = 0;
    #endif
# 196 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"

                #pragma loop_taken
                for (int h = heightStart; h < heightEnd; h += heightStep)
                {
                    ofmCoords[height] = h;

                    yStep    = (float)h + beta;
                    yIdxFrac = yStep * coordScaleHeight + coordBiasHeight;
                    yInt     = s_convert_f32_to_i32(yIdxFrac, SW_RD) - 1;

    #ifndef DYNAMIC_SHAPE
                    int5 yCoeffCoords = {0,h,0,0,0};
                    __global__ void *yCoeffAddr0 = gen_addr(yCoeffCoords, yCoeff); yCoeffCoords[0] += 1;
                    __global__ void *yCoeffAddr1 = gen_addr(yCoeffCoords, yCoeff); yCoeffCoords[0] += 1;
                    __global__ void *yCoeffAddr2 = gen_addr(yCoeffCoords, yCoeff); yCoeffCoords[0] += 1;
                    __global__ void *yCoeffAddr3 = gen_addr(yCoeffCoords, yCoeff);

                    LOAD_Y_COFF(0)
                    LOAD_Y_COFF(1)
                    LOAD_Y_COFF(2)
                    LOAD_Y_COFF(3)
    #else
# 218 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined (TF_COMPATIBLE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 219 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                    float yIdxInt = s_f32_nearbyint(yIdxFrac, SW_RD);
                    float delta    = yIdxFrac - yIdxInt;
                    int offset = s_convert_f32_to_i32( delta * kTableSize, SW_RHNE);
                    int5 coeffCoords = {0, 0, 0, 0, 0};

                    coeffCoords[0] = offset * 2 + 1;
                    __global__ void *yCoeffAddr0 = gen_addr(coeffCoords, cubicCoeffTable);

                    coeffCoords[0] = offset * 2;
                    __global__ void *yCoeffAddr1 = gen_addr(coeffCoords, cubicCoeffTable);

                    coeffCoords[0] = (kTableSize - offset) * 2;
                    __global__ void *yCoeffAddr2 = gen_addr(coeffCoords, cubicCoeffTable);

                    coeffCoords[0] = (kTableSize - offset) * 2 + 1;
                    __global__ void *yCoeffAddr3 = gen_addr(coeffCoords, cubicCoeffTable);

                    LOAD_Y_COFF(0)
                    LOAD_Y_COFF(1)
                    LOAD_Y_COFF(2)
                    LOAD_Y_COFF(3)
        #else
# 241 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                    float yIdxInt = s_f32_nearbyint(yIdxFrac, SW_RD);
                    float sAbs    = s_f32_abs(yIdxFrac - yIdxInt);

                    yCoeffVec[0] =
                        ((cubicCoeffA * (sAbs + 1) - 5 * cubicCoeffA) * (sAbs + 1) + 8 * cubicCoeffA) *
                        (sAbs + 1) - 4 * cubicCoeffA;
                    yCoeffVec[1] =
                        ((cubicCoeffA + 2) * sAbs - (cubicCoeffA + 3)) * sAbs * sAbs + 1;
                    yCoeffVec[2] =
                        ((cubicCoeffA + 2) * (1 - sAbs) - (cubicCoeffA + 3)) * (1 - sAbs) * (1 - sAbs) + 1;
                    yCoeffVec[3] =
                        ((cubicCoeffA * (2 - sAbs) - 5 * cubicCoeffA) * (2 - sAbs) + 8 * cubicCoeffA) *
                        (2 - sAbs) - 4 * cubicCoeffA;

        #endif
# 256 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                    if (excludeOutside)
                    {
                        float64 yVal = yIdxInt - 1.f;

                        yCoeffVec[0] = v_f32_sel_less_f32_b(yVal, 0, 0, yCoeffVec[0]);
                        yCoeffVec[0] = v_f32_sel_geq_f32_b(yVal, inputHeightSize, 0, yCoeffVec[0]);
                        yVal        += 1.f;

                        yCoeffVec[1] = v_f32_sel_less_f32_b(yVal, 0, 0, yCoeffVec[1]);
                        yCoeffVec[1] = v_f32_sel_geq_f32_b(yVal, inputHeightSize, 0, yCoeffVec[1]);
                        yVal        += 1.f;

                        yCoeffVec[2] = v_f32_sel_less_f32_b(yVal, 0, 0, yCoeffVec[2]);
                        yCoeffVec[2] = v_f32_sel_geq_f32_b(yVal, inputHeightSize, 0, yCoeffVec[2]);
                        yVal        += 1.f;

                        yCoeffVec[3] = v_f32_sel_less_f32_b(yVal, 0, 0, yCoeffVec[3]);
                        yCoeffVec[3] = v_f32_sel_geq_f32_b(yVal, inputHeightSize, 0, yCoeffVec[3]);

                        tmp           = yCoeffVec[0] + yCoeffVec[1] + yCoeffVec[2] + yCoeffVec[3];
                        tmp           = reciprocal_fast_f32(tmp);
                        yCoeffVec[0] *= tmp;
                        yCoeffVec[1] *= tmp;
                        yCoeffVec[2] *= tmp;
                        yCoeffVec[3] *= tmp;
                    }
    #endif
# 283 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                    #pragma loop_taken
                    for (int w = widthStart; w < widthEnd; w += widthStep)
                    {
                        ofmCoords[width] = w;

                        xStep    = (float)w + beta;
                        xIdxFrac = xStep * coordScaleWidth + coordBiasWidth;
                        xInt     = s_convert_f32_to_i32(xIdxFrac, SW_RD) - 1;

    #ifndef DYNAMIC_SHAPE
                        int5 xCoeffCoords = {0,w,0,0,0};
                        __global__ void *xCoeffAddr0 = gen_addr(xCoeffCoords, xCoeff);
                                                                xCoeffCoords[0] += 1;
                        __global__ void *xCoeffAddr1 = gen_addr(xCoeffCoords, xCoeff);
                                                                xCoeffCoords[0] += 1;
                        __global__ void *xCoeffAddr2 = gen_addr(xCoeffCoords, xCoeff);
                                                                xCoeffCoords[0] += 1;
                        __global__ void *xCoeffAddr3 = gen_addr(xCoeffCoords, xCoeff);

                        LOAD_X_COFF(0)
                        LOAD_X_COFF(1)
                        LOAD_X_COFF(2)
                        LOAD_X_COFF(3)
    #else
# 307 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
        
#if 0 /* disabled by -frewrite-includes */
#if defined (TF_COMPATIBLE)
#endif
#endif /* disabled by -frewrite-includes */
#if 0 /* evaluated by -frewrite-includes */
# 308 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                        float xIdxInt = s_f32_nearbyint(xIdxFrac, SW_RD);
                        float delta    = xIdxFrac - xIdxInt;

                        int offset = s_convert_f32_to_i32( delta * kTableSize, SW_RHNE);

                        int5 coeffCoords = {0, 0, 0, 0, 0};

                        coeffCoords[0] = offset * 2 + 1;
                        __global__ void *xCoeffAddr0 = gen_addr(coeffCoords, cubicCoeffTable);

                        coeffCoords[0] = offset * 2;
                        __global__ void *xCoeffAddr1 = gen_addr(coeffCoords, cubicCoeffTable);

                        coeffCoords[0] = (kTableSize - offset) * 2;
                        __global__ void *xCoeffAddr2 = gen_addr(coeffCoords, cubicCoeffTable);

                        coeffCoords[0] = (kTableSize - offset) * 2 + 1;
                        __global__ void *xCoeffAddr3 = gen_addr(coeffCoords, cubicCoeffTable);

                        LOAD_X_COFF(0)
                        LOAD_X_COFF(1)
                        LOAD_X_COFF(2)
                        LOAD_X_COFF(3)
        #else
# 332 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                        float xIdxInt = s_f32_nearbyint(xIdxFrac, SW_RD);
                        sAbs          = s_f32_abs(xIdxFrac - xIdxInt);

                        xCoeffVec[0] =
                            ((cubicCoeffA * (sAbs + 1) - 5 * cubicCoeffA) * (sAbs + 1) + 8 * cubicCoeffA) *
                            (sAbs + 1) - 4 * cubicCoeffA;
                        xCoeffVec[1] =
                            ((cubicCoeffA + 2) * sAbs - (cubicCoeffA + 3)) * sAbs * sAbs + 1;
                        xCoeffVec[2] =
                            ((cubicCoeffA + 2) * (1 - sAbs) - (cubicCoeffA + 3)) * (1 - sAbs) * (1 - sAbs) + 1;
                        xCoeffVec[3] =
                            ((cubicCoeffA * (2 - sAbs) - 5 * cubicCoeffA) * (2 - sAbs) + 8 * cubicCoeffA) *
                            (2 - sAbs) - 4 * cubicCoeffA;

        #endif
# 347 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                        if (excludeOutside)
                        {
                            float64 xVal = xIdxInt - 1.f;

                            xCoeffVec[0] = v_f32_sel_less_f32_b(xVal, 0, 0, xCoeffVec[0]);
                            xCoeffVec[0] = v_f32_sel_geq_f32_b(xVal, inputWidthSize, 0, xCoeffVec[0]);
                            xVal        += 1.f;

                            xCoeffVec[1] = v_f32_sel_less_f32_b(xVal, 0, 0, xCoeffVec[1]);
                            xCoeffVec[1] = v_f32_sel_geq_f32_b(xVal, inputWidthSize, 0, xCoeffVec[1]);
                            xVal        += 1.f;

                            xCoeffVec[2] = v_f32_sel_less_f32_b(xVal, 0, 0, xCoeffVec[2]);
                            xCoeffVec[2] = v_f32_sel_geq_f32_b(xVal, inputWidthSize, 0, xCoeffVec[2]);
                            xVal        += 1.f;

                            xCoeffVec[3] = v_f32_sel_less_f32_b(xVal, 0, 0, xCoeffVec[3]);
                            xCoeffVec[3] = v_f32_sel_geq_f32_b(xVal, inputWidthSize, 0, xCoeffVec[3]);

                            tmp           = xCoeffVec[0] + xCoeffVec[1] + xCoeffVec[2] + xCoeffVec[3];
                            tmp           = reciprocal_fast_f32(tmp);
                            xCoeffVec[0] *= tmp;
                            xCoeffVec[1] *= tmp;
                            xCoeffVec[2] *= tmp;
                            xCoeffVec[3] *= tmp;
                        }
    #endif
# 374 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
                        VECTOR_ACC result = {0};

                        int yVal = yInt;
                        for (int i = 0; i < CUBIC_MODE_GRID_LENGTH; i++)
                        {
                            int xVal = xInt;
                            int hIdx = s_i32_max(0, s_i32_min(yVal, inputHeightIdx));
                            ifmCoords[height] = hIdx;
                            VECTOR_ACC xInterpolationRes = {0};

                            for (int k = 0; k < CUBIC_MODE_GRID_LENGTH; k++)
                            {
                                int wIdx = s_i32_max(0, s_i32_min(xVal, inputWidthIdx));
                                ifmCoords[width] = wIdx;
                                inputData = v_ld_tnsr_i(ifmCoords, ifm);

                                VECTOR_ACC inputDataTemp;
                                inputDataTemp = CONVERT_UP(inputData);

                                v_ops_mac_v(xInterpolationRes, inputDataTemp, xCoeffVec[k]);
                                xVal++;
                            }

                            v_ops_mac_v(result, xInterpolationRes, yCoeffVec[i]);
                            yVal++;
                        }
                        st_tnsr_i_v(ofmCoords, ofm, CONVERT_DOWN(result));
                    }
                }
    #ifndef  NCWH_LAYOUT
            }
    #endif
# 406 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
        }
#ifndef NCWH_LAYOUT
    }
#endif
# 410 "/home/acherkasov/ws/tpc_kernels/kernels/common/misc/resize_bicubic.h"
}
# 16 "/home/acherkasov/ws/kr.o2/src/kernels/goya2/image_processing/resize_image_bicubic_u16.c" 2
    #undef NCWH_LAYOUT
#undef UINT16
